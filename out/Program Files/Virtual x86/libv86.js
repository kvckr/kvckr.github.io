(function(){"use strict";var t=t||{};t.scope={},t.ASSUME_ES5=!1,t.ASSUME_NO_NATIVE_MAP=!1,t.ASSUME_NO_NATIVE_SET=!1,t.SIMPLE_FROUND_POLYFILL=!1,t.ISOLATE_POLYFILLS=!1,t.FORCE_POLYFILL_PROMISE=!1,t.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1,t.defineProperty=t.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(t,e,i){return t==Array.prototype||t==Object.prototype||(t[e]=i.value),t},t.getGlobal=function(t){t=["object"==typeof globalThis&&globalThis,t,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var e=0;e<t.length;++e){var i=t[e];if(i&&i.Math==Math)return i}throw Error("Cannot find global object")},t.global=t.getGlobal(this),t.IS_SYMBOL_NATIVE="function"==typeof Symbol&&"symbol"==typeof Symbol("x"),t.TRUST_ES6_POLYFILLS=!t.ISOLATE_POLYFILLS||t.IS_SYMBOL_NATIVE,t.polyfills={},t.propertyToPolyfillSymbol={},t.POLYFILL_PREFIX="$jscp$";t.polyfill=function(e,i,s,r){i&&(t.ISOLATE_POLYFILLS?t.polyfillIsolated(e,i,s,r):t.polyfillUnisolated(e,i,s,r))},t.polyfillUnisolated=function(e,i,s,r){for(s=t.global,e=e.split("."),r=0;r<e.length-1;r++){var a=e[r];if(!(a in s))return;s=s[a]}(i=i(r=s[e=e[e.length-1]]))!=r&&null!=i&&t.defineProperty(s,e,{configurable:!0,writable:!0,value:i})},t.polyfillIsolated=function(e,i,s,r){var a=e.split(".");e=1===a.length,r=a[0],r=!e&&r in t.polyfills?t.polyfills:t.global;for(var n=0;n<a.length-1;n++){var o=a[n];if(!(o in r))return;r=r[o]}a=a[a.length-1],null!=(i=i(s=t.IS_SYMBOL_NATIVE&&"es6"===s?r[a]:null))&&(e?t.defineProperty(t.polyfills,a,{configurable:!0,writable:!0,value:i}):i!==s&&(void 0===t.propertyToPolyfillSymbol[a]&&(s=1e9*Math.random()>>>0,t.propertyToPolyfillSymbol[a]=t.IS_SYMBOL_NATIVE?t.global.Symbol(a):t.POLYFILL_PREFIX+s+"$"+a),t.defineProperty(r,t.propertyToPolyfillSymbol[a],{configurable:!0,writable:!0,value:i})))},t.polyfill("globalThis",(function(e){return e||t.global}),"es_2020","es3"),t.polyfill("String.prototype.trimRight",(function(t){return t||function(){return this.replace(/[\s\xa0]+$/,"")}}),"es_2019","es3");var e=2,i=16,s=32,r=64,a=128,n=256,o=512,h=2048,_=4096,d=8192,c=16384,u=32768,p=65536,l=131072,f=262144,m=524288,g=1048576,y=2097152,b=4194304,v=8388608,w=[[1,""],[e,"CPU"],[u,"DISK"],[4,"FPU"],[8,"MEM"],[i,"DMA"],[s,"IO"],[r,"PS2"],[a,"PIC"],[n,"VGA"],[o,"PIT"],[1024,"MOUS"],[h,"PCI"],[_,"BIOS"],[d,"FLOP"],[c,"SERI"],[p,"RTC"],[l,"HPET"],[f,"ACPI"],[m,"APIC"],[g,"NET"],[y,"VIO"],[b,"9P"],[v,"SB16"]],k=1,x=4,A=16,q=64,E=128,I=256,R=512,C=1024,S=2048,z=0,D=1,T=2,U=3,O=4,P=5,L=6,M=7,F=0,N=1,B=2,W=3,G=4,j=5,V=17,H=1<<V,K=-2147483648,X=32,Y=49152,Q=900,J=1024,$=0,Z=1,tt=2;function et(t,e){function i(t){return t=t.toString(16),"#"+"0".repeat(6-t.length)+t}function s(t,e,i,s){t.style.width="",t.style.height="",s&&(t.style.transform="");var r=t.getBoundingClientRect();s?t.style.transform=(1===e?"":" scaleX("+e+")")+(1===i?"":" scaleY("+i+")"):(0==e%1&&0==i%1?(d.style.imageRendering="crisp-edges",d.style.imageRendering="pixelated",d.style["-ms-interpolation-mode"]="nearest-neighbor"):(d.style.imageRendering="",d.style["-ms-interpolation-mode"]=""),0!=(s=window.devicePixelRatio||1)%1&&(e/=s,i/=s)),1!==e&&(t.style.width=r.width*e+"px"),1!==i&&(t.style.height=r.height*i+"px")}console.assert(t,"1st argument must be a DOM container");var r,a,n,o,h,_,d=t.getElementsByTagName("canvas")[0],c=d.getContext("2d",{alpha:!1}),u=t.getElementsByTagName("div")[0],p=document.createElement("div"),l=1,f=1,m=1,g=!1,y=!1,b=this;t=new Uint16Array([199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]);for(var v,w=new Uint16Array([32,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660]),k=[],x=0;256>x;x++)v=127<x?t[x-128]:32>x?w[x]:x,k[x]=String.fromCharCode(v);c.imageSmoothingEnabled=!1,p.style.position="absolute",p.style.backgroundColor="#ccc",p.style.width="7px",p.style.display="inline-block",u.style.display="block",d.style.display="none",this.bus=e,e.register("screen-set-mode",(function(t){this.set_mode(t)}),this),e.register("screen-fill-buffer-end",(function(t){this.update_buffer(t)}),this),e.register("screen-put-char",(function(t){this.put_char(t[0],t[1],t[2],t[3],t[4])}),this),e.register("screen-update-cursor",(function(t){this.update_cursor(t[0],t[1])}),this),e.register("screen-update-cursor-scanline",(function(t){this.update_cursor_scanline(t[0],t[1])}),this),e.register("screen-clear",(function(){this.clear_screen()}),this),e.register("screen-set-size-text",(function(t){this.set_size_text(t[0],t[1])}),this),e.register("screen-set-size-graphical",(function(t){this.set_size_graphical(t[0],t[1],t[2],t[3])}),this),this.init=function(){this.set_size_text(80,25),this.timer()},this.make_screenshot=function(){const t=new Image;if(g)t.src=d.toDataURL("image/png");else{const e=[9,16],s=document.createElement("canvas");s.width=h*e[0],s.height=_*e[1];const n=s.getContext("2d");n.imageSmoothingEnabled=!1,n.font=window.getComputedStyle(u).font,n.textBaseline="top";for(let t=0;t<h;t++)for(let s=0;s<_;s++){const r=3*(s*h+t);n.fillStyle=i(o[r+1]),n.fillRect(t*e[0],s*e[1],e[0],e[1]),n.fillStyle=i(o[r+2]),n.fillText(k[o[r]],t*e[0],s*e[1])}"none"!==p.style.display&&(n.fillStyle=p.style.backgroundColor,n.fillRect(a*e[0],r*e[1]+parseInt(p.style.marginTop,10)-1,parseInt(p.style.width,10),parseInt(p.style.height,10))),t.src=s.toDataURL("image/png")}try{window.open("").document.write(t.outerHTML)}catch(t){}},this.put_char=function(t,e,i,s,r){t<_&&e<h&&(e=3*(t*h+e),ls(0<=i&&256>i),o[e]=i,o[e+1]=s,o[e+2]=r,n[t]=1)},this.timer=function(){y||requestAnimationFrame(g?q:A)};var A=function(){for(var t=0;t<_;t++)n[t]&&(b.text_update_row(t),n[t]=0);this.timer()}.bind(this),q=function(){this.bus.send("screen-fill-buffer"),this.timer()}.bind(this);this.destroy=function(){y=!0},this.set_mode=function(t){(g=t)?(u.style.display="none",d.style.display="block"):(u.style.display="block",d.style.display="none")},this.clear_screen=function(){c.fillStyle="#000",c.fillRect(0,0,d.width,d.height)},this.set_size_text=function(t,e){if(t!==h||e!==_){for(n=new Int8Array(e),o=new Int32Array(t*e*3),h=t,_=e;u.childNodes.length>e;)u.removeChild(u.firstChild);for(;u.childNodes.length<e;)u.appendChild(document.createElement("div"));for(t=0;t<e;t++)this.text_update_row(t);s(u,l,f,!0)}},this.set_size_graphical=function(t,e,i,r){ct&&(t=i,e=r),d.style.display="block",d.width=t,d.height=e,m=640>=t&&2*t<window.innerWidth&&2*t<window.innerHeight?2:1,s(d,l*m,f*m,!1)},this.set_scale=function(t,e){s(u,l=t,f=e,!0),s(d,l*m,f*m,!1)},this.set_scale(l,f),this.update_cursor_scanline=function(t,e){32&t?p.style.display="none":(p.style.display="inline",p.style.height=Math.min(15,e-t)+"px",p.style.marginTop=Math.min(15,t)+"px")},this.update_cursor=function(t,e){t===r&&e===a||(n[t]=1,n[r]=1,r=t,a=e)},this.text_update_row=function(t){for(var e,s=3*t*h,n=u.childNodes[t],_=document.createElement("div"),d=0;d<h;){var c=document.createElement("span"),l=o[s+1],f=o[s+2];for(c.style.backgroundColor=i(l),c.style.color=i(f),e="";d<h&&o[s+1]===l&&o[s+2]===f;){var m=o[s];if(e+=k[m],ls(k[m]),d++,s+=3,t===r){if(d===a)break;if(d===a+1){_.appendChild(p);break}}}c.textContent=e,_.appendChild(c)}n.parentNode.replaceChild(_,n)},this.update_buffer=function(t){ct?(c.strokeStyle="#0F0",c.lineWidth=4,t.forEach((t=>{c.strokeRect(t.buffer_x,t.buffer_y,t.buffer_width,t.buffer_height)})),c.lineWidth=1):t.forEach((t=>{c.putImageData(t.image_data,t.screen_x-t.buffer_x,t.screen_y-t.buffer_y,t.buffer_x,t.buffer_y,t.buffer_width,t.buffer_height)}))},this.init()}const it=0,st=254;const rt=2,at=Object.freeze(["shared","exclusive","unlock"]);function nt(t,e,i){this.fs=t,this.bus=i,this.configspace_tagname=[104,111,115,116,57,112],this.configspace_taglen=this.configspace_tagname.length,this.VERSION="9P2000.L",this.msize=this.BLOCKSIZE=8192,this.replybuffer=new Uint8Array(2*this.msize),this.replybuffersize=0,this.fids=[],this.virtio=new as(e,{name:"virtio-9p",pci_id:48,device_id:4169,subsystem_device_id:9,common:{initial_port:43008,queues:[{size_supported:32,notify_offset:0}],features:[it,ts,Zi,$i],on_driver_ok:()=>{}},notification:{initial_port:43264,single_handler:!1,handlers:[t=>{if(0!==t)ls(!1,"Virtio9P Notified for non-existent queue: "+t+" (expected queue_id of 0)");else{for(;this.virtqueue.has_request();)t=this.virtqueue.pop_request(),this.ReceiveRequest(t);this.virtqueue.notify_me_after(0)}}]},isr_status:{initial_port:42752},device_specific:{initial_port:42496,struct:[{bytes:2,name:"mount tag length",read:()=>this.configspace_taglen,write:t=>{}}].concat(yt.range(st).map((t=>({bytes:1,name:"mount tag name "+t,read:()=>this.configspace_tagname[t]||0,write:t=>{}}))))}}),this.virtqueue=this.virtio.queues[0]}nt.prototype.get_state=function(){var t=[];return t[0]=this.configspace_tagname,t[1]=this.configspace_taglen,t[2]=this.virtio,t[3]=this.VERSION,t[4]=this.BLOCKSIZE,t[5]=this.msize,t[6]=this.replybuffer,t[7]=this.replybuffersize,t[8]=this.fids.map((function(t){return[t.inodeid,t.type,t.uid,t.dbg_name]})),t[9]=this.fs,t},nt.prototype.set_state=function(t){this.configspace_tagname=t[0],this.configspace_taglen=t[1],this.virtio.set_state(t[2]),this.virtqueue=this.virtio.queues[0],this.VERSION=t[3],this.BLOCKSIZE=t[4],this.msize=t[5],this.replybuffer=t[6],this.replybuffersize=t[7],this.fids=t[8].map((function(t){return{inodeid:t[0],type:t[1],uid:t[2],dbg_name:t[3]}})),this.fs.set_state(t[9])},nt.prototype.Createfid=function(t,e,i,s){return{inodeid:t,type:e,uid:i,dbg_name:s}},nt.prototype.update_dbg_name=function(t,e){for(const i of this.fids)i.inodeid===t&&(i.dbg_name=e)},nt.prototype.Reset=function(){this.fids=[]},nt.prototype.BuildReply=function(t,e,i){ls(0<=i,"9P: Negative payload size"),Br.Marshall(["w","b","h"],[i+7,t+1,e],this.replybuffer,0),i+7>=this.replybuffer.length&&Nr.Debug("Error in 9p: payloadsize exceeds maximum length"),this.replybuffersize=i+7},nt.prototype.SendError=function(t,e,i){e=Br.Marshall(["w"],[i],this.replybuffer,7),this.BuildReply(6,t,e)},nt.prototype.SendReply=function(t){ls(0<=this.replybuffersize,"9P: Negative replybuffersize"),t.set_next_blob(this.replybuffer.subarray(0,this.replybuffersize)),this.virtqueue.push_reply(t),this.virtqueue.flush_replies()},nt.prototype.ReceiveRequest=async function(t){var e=new Uint8Array(t.length_readable);t.get_next_blob(e);var i={offset:0},s=Br.Unmarshall(["w","b","h"],e,i),r=s[0],a=s[1],n=s[2];switch(a){case 8:r=this.fs.GetTotalSize(),e=this.fs.GetSpace(),(s=[16914839])[1]=this.BLOCKSIZE,s[2]=Math.floor(e/s[1]),s[3]=s[2]-Math.floor(r/s[1]),s[4]=s[2]-Math.floor(r/s[1]),s[5]=this.fs.CountUsedInodes(),s[6]=this.fs.CountFreeInodes(),s[7]=0,s[8]=256,r=Br.Marshall("wwddddddw".split(""),s,this.replybuffer,7),this.BuildReply(a,n,r),this.SendReply(t);break;case 112:case 12:var o=(s=Br.Unmarshall(["w","w"],e,i))[0];i=s[1],Nr.Debug("[open] fid="+o+", mode="+i),e=this.fids[o].inodeid;var h=this.fs.GetInode(e);Nr.Debug("file open "+this.fids[o].dbg_name),s=this.fs.OpenInode(e,i),this.fs.AddEvent(this.fids[o].inodeid,function(){Nr.Debug("file opened "+this.fids[o].dbg_name+" tag:"+n);var e=[];e[0]=h.qid,e[1]=this.msize-24,Br.Marshall(["Q","w"],e,this.replybuffer,7),this.BuildReply(a,n,17),this.SendReply(t)}.bind(this));break;case 70:if(e=(s=Br.Unmarshall(["w","w","s"],e,i))[0],o=s[1],r=s[2],Nr.Debug("[link] dfid="+e+", name="+r),0>(s=this.fs.Link(this.fids[e].inodeid,this.fids[o].inodeid,r))){r="",-1===s?r="Operation not permitted":(r="Unknown error: "+-s,ls(!1,"[link]: Unexpected error code: "+-s)),this.SendError(n,r,-s),this.SendReply(t);break}this.BuildReply(a,n,0),this.SendReply(t);break;case 16:s=Br.Unmarshall(["w","s","s","w"],e,i),o=s[0],r=s[1],e=s[2],s=s[3],Nr.Debug("[symlink] fid="+o+", name="+r+", symgt="+e+", gid="+s),e=this.fs.CreateSymlink(r,this.fids[o].inodeid,e),(h=this.fs.GetInode(e)).uid=this.fids[o].uid,h.gid=s,Br.Marshall(["Q"],[h.qid],this.replybuffer,7),this.BuildReply(a,n,13),this.SendReply(t);break;case 18:s=Br.Unmarshall("wswwww".split(""),e,i),o=s[0],r=s[1],i=s[2],e=s[3];var _=s[4];s=s[5],Nr.Debug("[mknod] fid="+o+", name="+r+", major="+e+", minor="+_),e=this.fs.CreateNode(r,this.fids[o].inodeid,e,_),(h=this.fs.GetInode(e)).mode=i,h.uid=this.fids[o].uid,h.gid=s,Br.Marshall(["Q"],[h.qid],this.replybuffer,7),this.BuildReply(a,n,13),this.SendReply(t);break;case 22:s=Br.Unmarshall(["w"],e,i),o=s[0],h=this.fs.GetInode(this.fids[o].inodeid),Nr.Debug("[readlink] fid="+o+" name="+this.fids[o].dbg_name+" target="+h.symlink),r=Br.Marshall(["s"],[h.symlink],this.replybuffer,7),this.BuildReply(a,n,r),this.SendReply(t);break;case 72:s=Br.Unmarshall(["w","s","w","w"],e,i),o=s[0],r=s[1],i=s[2],s=s[3],Nr.Debug("[mkdir] fid="+o+", name="+r+", mode="+i+", gid="+s),e=this.fs.CreateDirectory(r,this.fids[o].inodeid),(h=this.fs.GetInode(e)).mode=i|Ur,h.uid=this.fids[o].uid,h.gid=s,Br.Marshall(["Q"],[h.qid],this.replybuffer,7),this.BuildReply(a,n,13),this.SendReply(t);break;case 14:s=Br.Unmarshall(["w","s","w","w","w"],e,i),o=s[0],r=s[1],e=s[2],i=s[3],s=s[4],this.bus.send("9p-create",[r,this.fids[o].inodeid]),Nr.Debug("[create] fid="+o+", name="+r+", flags="+e+", mode="+i+", gid="+s),e=this.fs.CreateFile(r,this.fids[o].inodeid),this.fids[o].inodeid=e,this.fids[o].type=1,this.fids[o].dbg_name=r,(h=this.fs.GetInode(e)).uid=this.fids[o].uid,h.gid=s,h.mode=i,Br.Marshall(["Q","w"],[h.qid,this.msize-24],this.replybuffer,7),this.BuildReply(a,n,17),this.SendReply(t);break;case 52:s=Br.Unmarshall("wbwddws".split(""),e,i),o=s[0],e=s[2],r=0===s[4]?1/0:s[4],r=this.fs.DescribeLock(s[1],s[3],r,s[5],s[6]),Nr.Debug("[lock] fid="+o+", type="+at[r.type]+", start="+r.start+", length="+r.length+", proc_id="+r.proc_id),s=this.fs.Lock(this.fids[o].inodeid,r,e),Br.Marshall(["b"],[s],this.replybuffer,7),this.BuildReply(a,n,1),this.SendReply(t);break;case 54:s=Br.Unmarshall("wbddws".split(""),e,i),o=s[0],r=0===s[3]?1/0:s[3],r=this.fs.DescribeLock(s[1],s[2],r,s[4],s[5]),Nr.Debug("[getlock] fid="+o+", type="+at[r.type]+", start="+r.start+", length="+r.length+", proc_id="+r.proc_id),(s=this.fs.GetLock(this.fids[o].inodeid,r))||((s=r).type=rt),r=Br.Marshall(["b","d","d","w","s"],[s.type,s.start,1/0===s.length?0:s.length,s.proc_id,s.client_id],this.replybuffer,7),this.BuildReply(a,n,r),this.SendReply(t);break;case 24:if(s=Br.Unmarshall(["w","d"],e,i),o=s[0],h=this.fs.GetInode(this.fids[o].inodeid),Nr.Debug("[getattr]: fid="+o+" name="+this.fids[o].dbg_name+" request mask="+s[1]),!h||h.status===Or){Nr.Debug("getattr: unlinked"),this.SendError(n,"No such file or directory",2),this.SendReply(t);break}s[0]|=4096,s[0]=s[1],s[1]=h.qid,s[2]=h.mode,s[3]=h.uid,s[4]=h.gid,s[5]=h.nlinks,s[6]=h.major<<8|h.minor,s[7]=h.size,s[8]=this.BLOCKSIZE,s[9]=Math.floor(h.size/512+1),s[10]=h.atime,s[11]=0,s[12]=h.mtime,s[13]=0,s[14]=h.ctime,s[15]=0,s[16]=0,s[17]=0,s[18]=0,s[19]=0,Br.Marshall("dQwwwddddddddddddddd".split(""),s,this.replybuffer,7),this.BuildReply(a,n,153),this.SendReply(t);break;case 26:s=Br.Unmarshall("wwwwwddddd".split(""),e,i),o=s[0],h=this.fs.GetInode(this.fids[o].inodeid),Nr.Debug("[setattr]: fid="+o+" request mask="+s[1]+" name="+this.fids[o].dbg_name),1&s[1]&&(h.mode=s[2]),2&s[1]&&(h.uid=s[3]),4&s[1]&&(h.gid=s[4]),16&s[1]&&(h.atime=Math.floor((new Date).getTime()/1e3)),32&s[1]&&(h.mtime=Math.floor((new Date).getTime()/1e3)),64&s[1]&&(h.ctime=Math.floor((new Date).getTime()/1e3)),128&s[1]&&(h.atime=s[6]),256&s[1]&&(h.mtime=s[8]),8&s[1]&&await this.fs.ChangeSize(this.fids[o].inodeid,s[5]),this.BuildReply(a,n,0),this.SendReply(t);break;case 50:s=Br.Unmarshall(["w","d"],e,i),o=s[0],this.BuildReply(a,n,0),this.SendReply(t);break;case 40:case 116:if(s=Br.Unmarshall(["w","d","w"],e,i),o=s[0],r=s[1],_=s[2],h=this.fs.GetInode(this.fids[o].inodeid),40==a&&Nr.Debug("[treaddir]: fid="+o+" offset="+r+" count="+_),116==a&&Nr.Debug("[read]: fid="+o+" ("+this.fids[o].dbg_name+") offset="+r+" count="+_+" fidtype="+this.fids[o].type),!h||h.status===Or){Nr.Debug("read/treaddir: unlinked"),this.SendError(n,"No such file or directory",2),this.SendReply(t);break}if(2==this.fids[o].type)for(h.caps.length<r+_&&(_=h.caps.length-r),s=0;s<_;s++)this.replybuffer[11+s]=h.caps[r+s];else this.fs.OpenInode(this.fids[o].inodeid,void 0),s=this.fids[o].inodeid,_=Math.min(_,this.replybuffer.length-11),h.size<r+_?_=h.size-r:40==a&&(_=this.fs.RoundToDirentry(s,r+_)-r),r>h.size&&(_=0),this.bus.send("9p-read-start",[this.fids[o].dbg_name]),s=await this.fs.Read(s,r,_),this.bus.send("9p-read-end",[this.fids[o].dbg_name,_]),s&&this.replybuffer.set(s,11);Br.Marshall(["w"],[_],this.replybuffer,7),this.BuildReply(a,n,4+_),this.SendReply(t);break;case 118:if(s=Br.Unmarshall(["w","d","w"],e,i),o=s[0],r=s[1],_=s[2],s=this.fids[o].dbg_name,Nr.Debug("[write]: fid="+o+" ("+s+") offset="+r+" count="+_+" fidtype="+this.fids[o].type),2===this.fids[o].type){this.SendError(n,"Setxattr not supported",95),this.SendReply(t);break}await this.fs.Write(this.fids[o].inodeid,r,_,e.subarray(i.offset)),this.bus.send("9p-write-end",[s,_]),Br.Marshall(["w"],[_],this.replybuffer,7),this.BuildReply(a,n,4),this.SendReply(t);break;case 74:if(i=(s=Br.Unmarshall(["w","s","w","s"],e,i))[0],_=s[1],r=s[2],e=s[3],Nr.Debug("[renameat]: oldname="+_+" newname="+e),0>(s=await this.fs.Rename(this.fids[i].inodeid,_,this.fids[r].inodeid,e))){r="",-2===s?r="No such file or directory":-1===s?r="Operation not permitted":-39===s?r="Directory not empty":(r="Unknown error: "+-s,ls(!1,"[renameat]: Unexpected error code: "+-s)),this.SendError(n,r,-s),this.SendReply(t);break}_t&&(s=this.fs.Search(this.fids[r].inodeid,e),this.update_dbg_name(s,e)),this.BuildReply(a,n,0),this.SendReply(t);break;case 76:if(i=(s=Br.Unmarshall(["w","s","w"],e,i))[0],r=s[1],e=s[2],Nr.Debug("[unlink]: dirfd="+i+" name="+r+" flags="+e),-1==(o=this.fs.Search(this.fids[i].inodeid,r))){this.SendError(n,"No such file or directory",2),this.SendReply(t);break}if(0>(s=this.fs.Unlink(this.fids[i].inodeid,r))){r="",-39===s?r="Directory not empty":-1===s?r="Operation not permitted":(r="Unknown error: "+-s,ls(!1,"[unlink]: Unexpected error code: "+-s)),this.SendError(n,r,-s),this.SendReply(t);break}this.BuildReply(a,n,0),this.SendReply(t);break;case 100:s=Br.Unmarshall(["w","s"],e,i),Nr.Debug("[version]: msize="+s[0]+" version="+s[1]),this.msize=s[0],r=Br.Marshall(["w","s"],[this.msize,this.VERSION],this.replybuffer,7),this.BuildReply(a,n,r),this.SendReply(t);break;case 104:s=Br.Unmarshall(["w","w","s","s","w"],e,i),o=s[0],r=s[4],Nr.Debug("[attach]: fid="+o+" afid="+function(t){return bt(t)}(s[1])+" uname="+s[2]+" aname="+s[3]),this.fids[o]=this.Createfid(0,1,r,""),h=this.fs.GetInode(this.fids[o].inodeid),Br.Marshall(["Q"],[h.qid],this.replybuffer,7),this.BuildReply(a,n,13),this.SendReply(t),this.bus.send("9p-attach");break;case 108:s=Br.Unmarshall(["h"],e,i),Nr.Debug("[flush] "+n),this.BuildReply(a,n,0),this.SendReply(t);break;case 110:s=Br.Unmarshall(["w","w","h"],e,i),o=s[0],_=s[1];var d=s[2];if(Nr.Debug("[walk]: fid="+s[0]+" nwfid="+s[1]+" nwname="+d),0==d){this.fids[_]=this.Createfid(this.fids[o].inodeid,1,this.fids[o].uid,this.fids[o].dbg_name),Br.Marshall(["h"],[0],this.replybuffer,7),this.BuildReply(a,n,2),this.SendReply(t);break}for(r=[],s=0;s<d;s++)r.push("s");i=Br.Unmarshall(r,e,i),e=this.fids[o].inodeid,r=9;var c=0;for(Nr.Debug("walk in dir "+this.fids[o].dbg_name+" to: "+i.toString()),s=0;s<d;s++){if(-1==(e=this.fs.Search(e,i[s]))){Nr.Debug("Could not find: "+i[s]);break}r+=Br.Marshall(["Q"],[this.fs.GetInode(e).qid],this.replybuffer,r),c++,this.fids[_]=this.Createfid(e,1,this.fids[o].uid,i[s])}Br.Marshall(["h"],[c],this.replybuffer,7),this.BuildReply(a,n,r-7),this.SendReply(t);break;case 120:s=Br.Unmarshall(["w"],e,i),Nr.Debug("[clunk]: fid="+s[0]),this.fids[s[0]]&&0<=this.fids[s[0]].inodeid&&(await this.fs.CloseInode(this.fids[s[0]].inodeid),this.fids[s[0]].inodeid=-1,this.fids[s[0]].type=-1),this.BuildReply(a,n,0),this.SendReply(t);break;case 32:s=Br.Unmarshall(["w","s","d","w"],e,i),o=s[0],r=s[1],i=s[2],e=s[3],Nr.Debug("[txattrcreate]: fid="+o+" name="+r+" attr_size="+i+" flags="+e),this.fids[o].type=2,this.BuildReply(a,n,0),this.SendReply(t);break;case 30:s=Br.Unmarshall(["w","w","s"],e,i),o=s[0],r=s[2],Nr.Debug("[xattrwalk]: fid="+s[0]+" newfid="+s[1]+" name="+s[2]),this.SendError(n,"Setxattr not supported",95),this.SendReply(t);break;default:Nr.Debug("Error in Virtio9p: Unknown id "+a+" received"),Nr.Abort()}};var ot=!1,ht=!1,_t=!1,dt=-577&~y&~b&~a&-17&~c&~g&-8193&~u&~n&-8388609,ct=ot&&!1,ut=ot&&!1,pt=1e6;function lt(t){this.ports=[],this.cpu=t;for(var e=0;65536>e;e++)this.ports[e]=this.create_empty_entry();var i=t.memory_size[0];for(e=0;e<<V<i;e++)t.memory_map_read8[e]=t.memory_map_write8[e]=void 0,t.memory_map_read32[e]=t.memory_map_write32[e]=void 0;this.mmap_register(i,4294967296-i,(function(t){return us("Read from unmapped memory space, addr="+bt(t>>>0,8),s),255}),(function(t,e){us("Write to unmapped memory space, addr="+bt(t>>>0,8)+" value="+bt(e,2),s)}),(function(t){return us("Read from unmapped memory space, addr="+bt(t>>>0,8),s),-1}),(function(t,e){us("Write to unmapped memory space, addr="+bt(t>>>0,8)+" value="+bt(e>>>0,8),s)}))}lt.prototype.create_empty_entry=function(){return{read8:this.empty_port_read8,read16:this.empty_port_read16,read32:this.empty_port_read32,write8:this.empty_port_write,write16:this.empty_port_write,write32:this.empty_port_write,device:void 0}},lt.prototype.empty_port_read8=function(){return 255},lt.prototype.empty_port_read16=function(){return 65535},lt.prototype.empty_port_read32=function(){return-1},lt.prototype.empty_port_write=function(t){},lt.prototype.register_read=function(t,e,i,s,r){if(ls("number"==typeof t),ls("object"==typeof e),ls(!i||"function"==typeof i),ls(!s||"function"==typeof s),ls(!r||"function"==typeof r),ls(i||s||r),ot){var a=function(i){return ls(!1,"Overlapped read"+i+" "+bt(t,4)+" ("+e.name+")"),-1>>>32-i|0};i||(i=a.bind(this,8)),s||(s=a.bind(this,16)),r||(r=a.bind(this,32))}i&&(this.ports[t].read8=i),s&&(this.ports[t].read16=s),r&&(this.ports[t].read32=r),this.ports[t].device=e},lt.prototype.register_write=function(t,e,i,s,r){if(ls("number"==typeof t),ls("object"==typeof e),ls(!i||"function"==typeof i),ls(!s||"function"==typeof s),ls(!r||"function"==typeof r),ls(i||s||r),ot){var a=function(i){ls(!1,"Overlapped write"+i+" "+bt(t)+" ("+e.name+")")};i||(i=a.bind(this,8)),s||(s=a.bind(this,16)),r||(r=a.bind(this,32))}i&&(this.ports[t].write8=i),s&&(this.ports[t].write16=s),r&&(this.ports[t].write32=r),this.ports[t].device=e},lt.prototype.register_read_consecutive=function(t,e,i,s,r,a){function n(){return i.call(this)|s.call(this)<<8}ls(4===arguments.length||6===arguments.length),r&&a?(this.register_read(t,e,i,n,(function(){return i.call(this)|s.call(this)<<8|r.call(this)<<16|a.call(this)<<24})),this.register_read(t+1,e,s),this.register_read(t+2,e,r,(function(){return r.call(this)|a.call(this)<<8})),this.register_read(t+3,e,a)):(this.register_read(t,e,i,n),this.register_read(t+1,e,s))},lt.prototype.register_write_consecutive=function(t,e,i,s,r,a){function n(t){i.call(this,255&t),s.call(this,t>>8&255)}ls(4===arguments.length||6===arguments.length),r&&a?(this.register_write(t,e,i,n,(function(t){i.call(this,255&t),s.call(this,t>>8&255),r.call(this,t>>16&255),a.call(this,t>>>24)})),this.register_write(t+1,e,s),this.register_write(t+2,e,r,(function(t){r.call(this,255&t),a.call(this,t>>8&255)})),this.register_write(t+3,e,a)):(this.register_write(t,e,i,n),this.register_write(t+1,e,s))},lt.prototype.mmap_read32_shim=function(t){var e=this.cpu.memory_map_read8[t>>>V];return e(t)|e(t+1)<<8|e(t+2)<<16|e(t+3)<<24},lt.prototype.mmap_write32_shim=function(t,e){var i=this.cpu.memory_map_write8[t>>>V];i(t,255&e),i(t+1,e>>8&255),i(t+2,e>>16&255),i(t+3,e>>>24)},lt.prototype.mmap_register=function(t,e,i,r,a,n){for(us("mmap_register addr="+bt(t>>>0,8)+" size="+bt(e,8),s),ls(0==(t&H-1)),ls(e&&0==(e&H-1)),a||(a=this.mmap_read32_shim.bind(this)),n||(n=this.mmap_write32_shim.bind(this)),t>>>=V;0<e;t++)this.cpu.memory_map_read8[t]=i,this.cpu.memory_map_write8[t]=r,this.cpu.memory_map_read32[t]=a,this.cpu.memory_map_write32[t]=n,e-=H},lt.prototype.port_write8=function(t,e){var i=this.ports[t];return i.write8===this.empty_port_write&&us("write8 port #"+bt(t,4)+" <- "+bt(e,2)+this.get_port_description(t),s),i.write8.call(i.device,e)},lt.prototype.port_write16=function(t,e){var i=this.ports[t];return i.write16===this.empty_port_write&&us("write16 port #"+bt(t,4)+" <- "+bt(e,4)+this.get_port_description(t),s),i.write16.call(i.device,e)},lt.prototype.port_write32=function(t,e){var i=this.ports[t];return i.write32===this.empty_port_write&&us("write32 port #"+bt(t,4)+" <- "+bt(e>>>0,8)+this.get_port_description(t),s),i.write32.call(i.device,e)},lt.prototype.port_read8=function(t){var e=this.ports[t];return e.read8===this.empty_port_read8&&us("read8 port  #"+bt(t,4)+this.get_port_description(t),s),ls(256>(e=e.read8.call(e.device)),"8 bit port returned large value: "+bt(t)),e},lt.prototype.port_read16=function(t){var e=this.ports[t];return e.read16===this.empty_port_read16&&us("read16 port  #"+bt(t,4)+this.get_port_description(t),s),ls(65536>(e=e.read16.call(e.device))&&0<=e,"16 bit port returned large value: "+bt(t)),e},lt.prototype.port_read32=function(t){var e=this.ports[t];return e.read32===this.empty_port_read32&&us("read32 port  #"+bt(t,4)+this.get_port_description(t),s),ls((0|(t=e.read32.call(e.device)))===t),t};var ft={4:"PORT_DMA_ADDR_2",5:"PORT_DMA_CNT_2",10:"PORT_DMA1_MASK_REG",11:"PORT_DMA1_MODE_REG",12:"PORT_DMA1_CLEAR_FF_REG",13:"PORT_DMA1_MASTER_CLEAR",32:"PORT_PIC1_CMD",33:"PORT_PIC1_DATA",64:"PORT_PIT_COUNTER0",65:"PORT_PIT_COUNTER1",66:"PORT_PIT_COUNTER2",67:"PORT_PIT_MODE",96:"PORT_PS2_DATA",97:"PORT_PS2_CTRLB",100:"PORT_PS2_STATUS",112:"PORT_CMOS_INDEX",113:"PORT_CMOS_DATA",128:"PORT_DIAG",129:"PORT_DMA_PAGE_2",146:"PORT_A20",160:"PORT_PIC2_CMD",161:"PORT_PIC2_DATA",178:"PORT_SMI_CMD",179:"PORT_SMI_STATUS",212:"PORT_DMA2_MASK_REG",214:"PORT_DMA2_MODE_REG",218:"PORT_DMA2_MASTER_CLEAR",240:"PORT_MATH_CLEAR",368:"PORT_ATA2_CMD_BASE",496:"PORT_ATA1_CMD_BASE",632:"PORT_LPT2",744:"PORT_SERIAL4",760:"PORT_SERIAL2",884:"PORT_ATA2_CTRL_BASE",888:"PORT_LPT1",1e3:"PORT_SERIAL3",1008:"PORT_FD_BASE",1010:"PORT_FD_DOR",1012:"PORT_FD_STATUS",1013:"PORT_FD_DATA",1014:"PORT_HD_DATA",1015:"PORT_FD_DIR",1016:"PORT_SERIAL1",3320:"PORT_PCI_CMD",3321:"PORT_PCI_REBOOT",3324:"PORT_PCI_DATA",1026:"PORT_BIOS_DEBUG",1296:"PORT_QEMU_CFG_CTL",1297:"PORT_QEMU_CFG_DATA",45056:"PORT_ACPI_PM_BASE",45312:"PORT_SMB_BASE",35072:"PORT_BIOS_APM"};function mt(t,e){this.stopping=this.running=!1,this.tick_counter=0,this.worker=null,this.cpu=new fs(t,e,(()=>{this.idle&&this.next_tick(0)})),this.bus=t,t.register("cpu-init",this.init,this),t.register("cpu-run",this.run,this),t.register("cpu-stop",this.stop,this),t.register("cpu-restart",this.restart,this),this.register_yield()}if(lt.prototype.get_port_description=function(t){return ft[t]?"  ("+ft[t]+")":""},mt.prototype.run=function(){this.stopping=!1,this.running||(this.running=!0,this.bus.send("emulator-started")),this.next_tick(0)},mt.prototype.do_tick=function(){if(this.stopping||!this.running)this.stopping=this.running=!1,this.bus.send("emulator-stopped");else{this.idle=!1;var t=this.cpu.main_run();this.next_tick(t)}},mt.prototype.next_tick=function(t){const e=++this.tick_counter;this.idle=!0,this.yield(t,e)},mt.prototype.yield_callback=function(t){t===this.tick_counter&&this.do_tick()},mt.prototype.stop=function(){this.running&&(this.stopping=!0)},mt.prototype.destroy=function(){this.unregister_yield()},mt.prototype.restart=function(){this.cpu.reset_cpu(),this.cpu.load_bios()},mt.prototype.init=function(t){this.cpu.init(t,this.bus),this.bus.send("emulator-ready")},"undefined"!=typeof process)mt.prototype.yield=function(t,e){1>t?global.setImmediate((t=>this.yield_callback(t)),e):setTimeout((t=>this.yield_callback(t)),t,e)},mt.prototype.register_yield=function(){},mt.prototype.unregister_yield=function(){};else if("undefined"!=typeof Worker){function Vr(){globalThis.onmessage=function(t){const e=t.data.t;1>e?postMessage(t.data.tick):setTimeout((()=>postMessage(t.data.tick)),e)}}mt.prototype.register_yield=function(){const t=URL.createObjectURL(new Blob(["("+Vr.toString()+")()"],{type:"text/javascript"}));this.worker=new Worker(t),this.worker.onmessage=t=>this.yield_callback(t.data),URL.revokeObjectURL(t)},mt.prototype.yield=function(t,e){this.worker.postMessage({t,tick:e})},mt.prototype.unregister_yield=function(){this.worker.terminate(),this.worker=null}}else mt.prototype.yield=function(t){setTimeout((()=>{this.do_tick()}),t)},mt.prototype.register_yield=function(){},mt.prototype.unregister_yield=function(){};if(mt.prototype.save_state=function(){return this.cpu.save_state()},mt.prototype.restore_state=function(t){return this.cpu.restore_state(t)},"object"==typeof performance&&performance.now)mt.microtick=performance.now.bind(performance);else if("function"==typeof require){const{performance:Hr}=require("perf_hooks");mt.microtick=Hr.now.bind(Hr)}else mt.microtick="object"==typeof process&&process.hrtime?function(){var t=process.hrtime();return 1e3*t[0]+t[1]/1e6}:Date.now;var gt=gt||{};gt.exportSymbol=function(){},gt.exportProperty=function(){};var yt=yt||{};function bt(t,e){return t=t?t.toString(16):"","0x"+yt.pad0(t.toUpperCase(),e||1)}if(yt.pads=function(t,e){return(t||0===t?t+"":"").padEnd(e," ")},yt.pad0=function(t,e){return(t||0===t?t+"":"").padStart(e,"0")},yt.zeros=function(t){return Array(t).fill(0)},yt.range=function(t){return Array.from(Array(t).keys())},yt.view=function(t,e,i,s){return new Proxy({},{get:function(r,a,n){return"function"==typeof(n=(r=new t(e.buffer,i,s))[a])?n.bind(r):(ls(/^\d+$/.test(a)||"buffer"===a||"length"===a||"BYTES_PER_ELEMENT"===a||"byteOffset"===a),n)},set:function(r,a,n,o){return ls(/^\d+$/.test(a)),new t(e.buffer,i,s)[a]=n,!0}})},"undefined"!=typeof crypto&&crypto.getRandomValues){let Kr=new Int32Array(1);yt.get_rand_int=function(){return crypto.getRandomValues(Kr),Kr[0]}}else if("undefined"!=typeof require){const Xr=require("crypto");yt.get_rand_int=function(){return Xr.randomBytes(4).readInt32LE(0)}}else ls(!1,"Unsupported platform: No cryptographic random values");function vt(t){var e,i,s=new Uint8Array(t);ls(0==(t&t-1)),this.length=0,this.push=function(e){this.length!==t&&this.length++,s[i]=e,i=i+1&t-1},this.shift=function(){if(this.length){var i=s[e];return e=e+1&t-1,this.length--,i}return-1},this.peek=function(){return this.length?s[e]:-1},this.clear=function(){this.length=i=e=0},this.clear()}function wt(t){this.size=t,this.data=new Float32Array(t),this.length=this.end=this.start=0,ls(0==(t&t-1))}function kt(t){this.data=[],this.index=0,this.size=t}function xt(t,e){t instanceof Array||(t=[t]),function(t,e){var i=document.createElement("a");i.download=e,i.href=window.URL.createObjectURL(t),i.dataset.downloadurl=["application/octet-stream",i.download,i.href].join(":"),document.createEvent?(t=document.createEvent("MouseEvent"),t.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(t)):i.click(),window.URL.revokeObjectURL(i.href)}(t=new Blob(t),e)}!function(){if("function"==typeof Math.clz32)yt.int_log2_byte=function(t){return ls(0<t),ls(256>t),31-Math.clz32(t)},yt.int_log2=function(t){return ls(0<t),31-Math.clz32(t)};else{for(var t=new Int8Array(256),e=0,i=-2;256>e;e++)e&e-1||i++,t[e]=i;yt.int_log2_byte=function(e){return ls(0<e),ls(256>e),t[e]},yt.int_log2=function(e){ls(0<(e>>>=0));var i=e>>>16;if(i){var s=i>>>8;return s?24+t[s]:16+t[i]}return(s=e>>>8)?8+t[s]:t[e]}}}(),wt.prototype.push=function(t){this.length===this.size?this.start=this.start+1&this.size-1:this.length++,this.data[this.end]=t,this.end=this.end+1&this.size-1},wt.prototype.shift=function(){if(this.length){var t=this.data[this.start];return this.start=this.start+1&this.size-1,this.length--,t}},wt.prototype.shift_block=function(t){var e=new Float32Array(t);t>this.length&&(t=this.length);var i=this.start+t,s=this.data.subarray(this.start,i);return e.set(s),i>=this.size&&(i-=this.size,e.set(this.data.subarray(0,i),s.length)),this.start=i,this.length-=t,e},wt.prototype.peek=function(){if(this.length)return this.data[this.start]},wt.prototype.clear=function(){this.length=this.end=this.start=0},kt.prototype.add=function(t){this.data[this.index]=t,this.index=(this.index+1)%this.size},kt.prototype.toArray=function(){return[].slice.call(this.data,this.index).concat([].slice.call(this.data,0,this.index))},kt.prototype.clear=function(){this.data=[],this.index=0},kt.prototype.set=function(t){this.data=t,this.index=0},yt.Bitmap=function(t){"number"==typeof t?this.view=new Uint8Array(t+7>>3):t instanceof ArrayBuffer?this.view=new Uint8Array(t):ls(!1,"v86util.Bitmap: Invalid argument")},yt.Bitmap.prototype.set=function(t,e){const i=t>>3;t=1<<(7&t),this.view[i]=e?this.view[i]|t:this.view[i]&~t},yt.Bitmap.prototype.get=function(t){return this.view[t>>3]>>(7&t)&1},yt.Bitmap.prototype.get_buffer=function(){return this.view.buffer},yt.load_file="undefined"==typeof XMLHttpRequest?function(t,e){let i=require("fs");e.range?(ls(!e.as_json),i.open(t,"r",((t,s)=>{if(t)throw t;let r=e.range.length;var a=Buffer.allocUnsafe(r);i.read(s,a,0,r,e.range.start,((t,n)=>{if(t)throw t;ls(n===r),e.done&&e.done(new Uint8Array(a)),i.close(s,(t=>{if(t)throw t}))}))}))):i.readFile(t,{encoding:e.as_json?"utf-8":null},(function(i,s){i?console.log("Could not read file:",t,i):(i=s,i=e.as_json?JSON.parse(i):new Uint8Array(i).buffer,e.done(i))}))}:function t(e,i,s){function r(){const r=s||0;setTimeout((()=>{t(e,i,r+1)}),1e3*([1,1,2,3,5,8,13,21][r]||34))}var a=new XMLHttpRequest;if(a.open(i.method||"get",e,!0),a.responseType=i.as_json?"json":"arraybuffer",i.headers)for(var n=Object.keys(i.headers),o=0;o<n.length;o++){var h=n[o];a.setRequestHeader(h,i.headers[h])}i.range&&(n=i.range.start,a.setRequestHeader("Range","bytes="+n+"-"+(n+i.range.length-1)),a.onreadystatechange=function(){200===a.status&&a.abort()}),a.onload=function(t){4===a.readyState&&(200!==a.status&&206!==a.status?(console.error("Loading the image "+e+" failed (status %d)",a.status),500<=a.status&&600>a.status&&r()):a.response&&i.done&&i.done(a.response,a))},a.onerror=function(t){console.error("Loading the image "+e+" failed",t),r()},i.progress&&(a.onprogress=function(t){i.progress(t)}),a.send(null)},yt.read_sized_string_from_mem=function(t,e,i){return String.fromCharCode(...new Uint8Array(t.buffer,e>>>0,i>>>0))},function(){function t(t){ls(t instanceof ArrayBuffer),this.buffer=t,this.byteLength=t.byteLength,this.onprogress=this.onload=void 0}function e(t,e,i){this.filename=t,this.byteLength=e,this.block_cache=new Map,this.block_cache_is_write=new Set,this.fixed_chunk_size=i,this.cache_reads=!!i,this.onprogress=this.onload=void 0}function i(t,e,i,s){const r=t.match(/(.*)(\..*)/);r?(this.basename=r[1],this.extension=r[2]):(this.basename=t,this.extension=""),this.basename.endsWith("/")||(this.basename+="-"),this.block_cache=new Map,this.block_cache_is_write=new Set,this.byteLength=e,this.fixed_chunk_size=i,this.partfile_alt_format=!!s,this.cache_reads=!!i,this.onprogress=this.onload=void 0}function s(t){this.file=t,this.byteLength=t.size,1073741824<t.size&&console.warn("SyncFileBuffer: Allocating buffer of "+(t.size>>20)+" MB ..."),this.buffer=new ArrayBuffer(t.size),this.onprogress=this.onload=void 0}function r(t){this.file=t,this.byteLength=t.size,this.block_cache=new Map,this.block_cache_is_write=new Set,this.onprogress=this.onload=void 0}yt.SyncBuffer=t,yt.AsyncXHRBuffer=e,yt.AsyncXHRPartfileBuffer=i,yt.AsyncFileBuffer=r,yt.SyncFileBuffer=s,t.prototype.load=function(){this.onload&&this.onload({buffer:this.buffer})},t.prototype.get=function(t,e,i){ls(t+e<=this.byteLength),i(new Uint8Array(this.buffer,t,e))},t.prototype.set=function(t,e,i){ls(t+e.byteLength<=this.byteLength),new Uint8Array(this.buffer,t,e.byteLength).set(e),i()},t.prototype.get_buffer=function(t){t(this.buffer)},t.prototype.get_state=function(){const t=[];return t[0]=this.byteLength,t[1]=new Uint8Array(this.buffer),t},t.prototype.set_state=function(t){this.byteLength=t[0],this.buffer=t[1].slice().buffer},e.prototype.load=function(){void 0!==this.byteLength?this.onload&&this.onload(Object.create(null)):a(this.filename,((t,e)=>{if(t)throw Error("Cannot use: "+this.filename+". "+t);ls(0<=e),this.byteLength=e,this.onload&&this.onload(Object.create(null))}))},e.prototype.get_from_cache=function(t,e){var i=e/256;t/=256;for(var s=0;s<i;s++)if(!this.block_cache.get(t+s))return;if(1===i)return this.block_cache.get(t);for(e=new Uint8Array(e),s=0;s<i;s++)e.set(this.block_cache.get(t+s),256*s);return e},e.prototype.get=function(t,e,i){ls(t+e<=this.byteLength),ls(0==t%256),ls(0==e%256),ls(e);var s=this.get_from_cache(t,e);if(s)i(s);else{var r=t,a=e;this.fixed_chunk_size&&(r=t-t%this.fixed_chunk_size,a=Math.ceil((t-r+e)/this.fixed_chunk_size)*this.fixed_chunk_size),yt.load_file(this.filename,{done:function(s){s=new Uint8Array(s),this.handle_read(r,a,s),i(r===t&&a===e?s:s.subarray(t-r,t-r+e))}.bind(this),range:{start:r,length:a}})}},e.prototype.set=function(t,e,i){var s=e.length;ls(t+e.byteLength<=this.byteLength),ls(0==t%256),ls(0==s%256),ls(s),t/=256,s/=256;for(var r=0;r<s;r++){var a=this.block_cache.get(t+r);if(void 0===a)a=e.slice(256*r,256*(r+1)),this.block_cache.set(t+r,a);else{const t=e.subarray(256*r,256*(r+1));ls(a.byteLength===t.length),a.set(t)}this.block_cache_is_write.add(t+r)}i()},e.prototype.handle_read=function(t,e,i){t/=256,e/=256;for(var s=0;s<e;s++){const e=this.block_cache.get(t+s);e?i.set(e,256*s):this.cache_reads&&this.block_cache.set(t+s,i.slice(256*s,256*(s+1)))}},e.prototype.get_buffer=function(t){t()},e.prototype.get_state=function(){const t=[],e=[];for(let[t,i]of this.block_cache)ls(isFinite(t)),this.block_cache_is_write.has(t)&&e.push([t,i]);return t[0]=e,t},e.prototype.set_state=function(t){t=t[0],this.block_cache.clear(),this.block_cache_is_write.clear();for(let[e,i]of t)ls(isFinite(e)),this.block_cache.set(e,i),this.block_cache_is_write.add(e)},i.prototype.load=function(){void 0===this.byteLength&&ls(!1),this.onload&&this.onload(Object.create(null))},i.prototype.get=function(t,e,i){ls(t+e<=this.byteLength),ls(0==t%256),ls(0==e%256),ls(e);var s=this.get_from_cache(t,e);if(s)i(s);else if(this.fixed_chunk_size){const a=Math.floor(t/this.fixed_chunk_size),n=t-a*this.fixed_chunk_size;ls(0<=n);const o=Math.ceil((n+e)/this.fixed_chunk_size),h=new Uint8Array(o*this.fixed_chunk_size);let _=0;for(let t=0;t<o;t++){var r=(a+t)*this.fixed_chunk_size;s=this.partfile_alt_format?this.basename+(a+t+"").padStart(8,"0")+this.extension:this.basename+r+"-"+(r+this.fixed_chunk_size)+this.extension,(r=this.get_from_cache(r,this.fixed_chunk_size))?(h.set(r,t*this.fixed_chunk_size),_++,_===o&&(s=h.subarray(n,n+e),i(s))):yt.load_file(s,{done:function(s){var r=t*this.fixed_chunk_size;s=new Uint8Array(s),this.handle_read((a+t)*this.fixed_chunk_size,0|this.fixed_chunk_size,s),h.set(s,r),_++,_===o&&(r=h.subarray(n,n+e),i(r))}.bind(this)})}}else yt.load_file(this.basename+t+"-"+(t+e)+this.extension,{done:function(s){ls(s.byteLength===e),s=new Uint8Array(s),this.handle_read(t,e,s),i(s)}.bind(this)})},i.prototype.get_from_cache=e.prototype.get_from_cache,i.prototype.set=e.prototype.set,i.prototype.handle_read=e.prototype.handle_read,i.prototype.get_state=e.prototype.get_state,i.prototype.set_state=e.prototype.set_state,s.prototype.load=function(){this.load_next(0)},s.prototype.load_next=function(t){var e=new FileReader;if(e.onload=function(e){e=new Uint8Array(e.target.result),new Uint8Array(this.buffer,t).set(e),this.load_next(t+4194304)}.bind(this),this.onprogress&&this.onprogress({loaded:t,total:this.byteLength,lengthComputable:!0}),t<this.byteLength){var i=this.file.slice(t,Math.min(t+4194304,this.byteLength));e.readAsArrayBuffer(i)}else this.file=void 0,this.onload&&this.onload({buffer:this.buffer})},s.prototype.get=t.prototype.get,s.prototype.set=t.prototype.set,s.prototype.get_buffer=t.prototype.get_buffer,s.prototype.get_state=t.prototype.get_state,s.prototype.set_state=t.prototype.set_state,r.prototype.load=function(){this.onload&&this.onload(Object.create(null))},r.prototype.get=function(t,e,i){ls(0==t%256),ls(0==e%256),ls(e);var s=this.get_from_cache(t,e);s?i(s):((s=new FileReader).onload=function(s){s=new Uint8Array(s.target.result),this.handle_read(t,e,s),i(s)}.bind(this),s.readAsArrayBuffer(this.file.slice(t,t+e)))},r.prototype.get_from_cache=e.prototype.get_from_cache,r.prototype.set=e.prototype.set,r.prototype.handle_read=e.prototype.handle_read,r.prototype.get_state=e.prototype.get_state,r.prototype.set_state=e.prototype.set_state,r.prototype.get_buffer=function(t){t()},r.prototype.get_as_file=function(t){for(var e=[],i=Array.from(this.block_cache.keys()).sort((function(t,e){return t-e})),s=0,r=0;r<i.length;r++){var a=i[r],n=this.block_cache.get(a);ls((a*=256)>=s),a!==s&&(e.push(this.file.slice(s,a)),s=a),e.push(n),s+=n.length}return s!==this.file.size&&e.push(this.file.slice(s)),ls((t=new File(e,t)).size===this.file.size),t};var a="undefined"==typeof XMLHttpRequest?function(t,e){require("fs").stat(t,((t,i)=>{t?e(t):e(null,i.size)}))}:function(t,e){yt.load_file(t,{done:(t,i)=>{t=i.getResponseHeader("Content-Range")||"",(i=t.match(/\/(\d+)\s*$/))?e(null,+i[1]):e("`Range: bytes=...` header not supported (Got `"+t+"`)")},headers:{Range:"bytes=0-0"}})}}();var At=2048,qt=512;function Et(t,e,i,s,r,a){this.master=new It(this,t,e,s,r,0,a),this.slave=new It(this,t,i,!1,r,1,a),this.current_interface=this.master,this.cpu=t,0===r?(this.ata_port=496,this.irq=14,this.pci_id=240):1===r?(this.ata_port=368,this.irq=15,this.pci_id=248):ls(!1,"IDE device with nr "+r+" ignored",u),this.ata_port_high=516|this.ata_port,this.master_port=46080,this.pci_space=[134,128,16,112,5,0,160,2,0,128,1,1,0,0,0,0,255&this.ata_port|1,this.ata_port>>8,0,0,255&this.ata_port_high|1,this.ata_port_high>>8,0,0,0,0,0,0,0,0,0,0,255&this.master_port|1,this.master_port>>8,0,0,0,0,0,0,0,0,0,0,67,16,212,130,0,0,0,0,0,0,0,0,0,0,0,0,this.irq,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_bars=[{size:8},{size:4},void 0,void 0,{size:16}],this.name="ide"+r,this.device_control=2,t.io.register_read(7|this.ata_port,this,(function(){return us("lower irq",u),this.cpu.device_lower_irq(this.irq),this.read_status()})),t.io.register_read(2|this.ata_port_high,this,this.read_status),t.io.register_write(2|this.ata_port_high,this,this.write_control),t.io.register_read(0|this.ata_port,this,(function(){return this.current_interface.read_data(1)}),(function(){return this.current_interface.read_data(2)}),(function(){return this.current_interface.read_data(4)})),t.io.register_read(1|this.ata_port,this,(function(){return us("Read error: "+bt(255&this.current_interface.error)+" slave="+(this.current_interface===this.slave),u),255&this.current_interface.error})),t.io.register_read(2|this.ata_port,this,(function(){return us("Read bytecount: "+bt(255&this.current_interface.bytecount),u),255&this.current_interface.bytecount})),t.io.register_read(3|this.ata_port,this,(function(){return us("Read sector: "+bt(255&this.current_interface.sector),u),255&this.current_interface.sector})),t.io.register_read(4|this.ata_port,this,(function(){return us("Read 1F4: "+bt(255&this.current_interface.cylinder_low),u),255&this.current_interface.cylinder_low})),t.io.register_read(5|this.ata_port,this,(function(){return us("Read 1F5: "+bt(255&this.current_interface.cylinder_high),u),255&this.current_interface.cylinder_high})),t.io.register_read(6|this.ata_port,this,(function(){return us("Read 1F6",u),255&this.current_interface.drive_head})),t.io.register_write(0|this.ata_port,this,(function(t){this.current_interface.write_data_port8(t)}),(function(t){this.current_interface.write_data_port16(t)}),(function(t){this.current_interface.write_data_port32(t)})),t.io.register_write(1|this.ata_port,this,(function(t){us("1F1/lba_count: "+bt(t),u),this.master.lba_count=65535&(this.master.lba_count<<8|t),this.slave.lba_count=65535&(this.slave.lba_count<<8|t)})),t.io.register_write(2|this.ata_port,this,(function(t){us("1F2/bytecount: "+bt(t),u),this.master.bytecount=65535&(this.master.bytecount<<8|t),this.slave.bytecount=65535&(this.slave.bytecount<<8|t)})),t.io.register_write(3|this.ata_port,this,(function(t){us("1F3/sector: "+bt(t),u),this.master.sector=65535&(this.master.sector<<8|t),this.slave.sector=65535&(this.slave.sector<<8|t)})),t.io.register_write(4|this.ata_port,this,(function(t){us("1F4/sector low: "+bt(t),u),this.master.cylinder_low=65535&(this.master.cylinder_low<<8|t),this.slave.cylinder_low=65535&(this.slave.cylinder_low<<8|t)})),t.io.register_write(5|this.ata_port,this,(function(t){us("1F5/sector high: "+bt(t),u),this.master.cylinder_high=65535&(this.master.cylinder_high<<8|t),this.slave.cylinder_high=65535&(this.slave.cylinder_high<<8|t)})),t.io.register_write(6|this.ata_port,this,(function(t){var e=16&t;us("1F6/drive: "+bt(t,2),u),e?(us("Slave",u),this.current_interface=this.slave):this.current_interface=this.master,this.master.drive_head=t,this.slave.drive_head=t,this.master.is_lba=this.slave.is_lba=t>>6&1,this.master.head=this.slave.head=15&t})),this.dma_command=this.dma_status=this.prdt_addr=0,t.io.register_write(7|this.ata_port,this,(function(t){us("lower irq",u),this.cpu.device_lower_irq(this.irq),this.current_interface.ata_command(t)})),t.io.register_read(4|this.master_port,this,void 0,void 0,this.dma_read_addr),t.io.register_write(4|this.master_port,this,void 0,void 0,this.dma_set_addr),t.io.register_read(this.master_port,this,this.dma_read_command8,void 0,this.dma_read_command),t.io.register_write(this.master_port,this,this.dma_write_command8,void 0,this.dma_write_command),t.io.register_read(2|this.master_port,this,this.dma_read_status),t.io.register_write(2|this.master_port,this,this.dma_write_status),t.io.register_read(8|this.master_port,this,(function(){return us("DMA read 0x8",u),0})),t.io.register_read(10|this.master_port,this,(function(){return us("DMA read 0xA",u),0})),t.devices.pci.register_device(this),ot&&Object.seal(this)}function It(t,e,i,s,r,a,n){this.device=t,this.bus=n,this.nr=r,this.cpu=e,this.buffer=i,this.sector_size=s?At:qt,this.is_atapi=s,this.cylinder_count=this.sectors_per_track=this.head_count=this.sector_count=0,this.buffer&&(this.sector_count=this.buffer.byteLength/this.sector_size,this.sector_count!==(0|this.sector_count)&&(us("Warning: Disk size not aligned with sector size",u),this.sector_count=Math.ceil(this.sector_count)),s?(this.head_count=1,this.sectors_per_track=0):(this.head_count=16,this.sectors_per_track=63),this.cylinder_count=this.sector_count/this.head_count/this.sectors_per_track,this.cylinder_count!==(0|this.cylinder_count)&&(us("Warning: Rounding up cylinder count. Choose different head number",u),this.cylinder_count=Math.floor(this.cylinder_count)),(t=e.devices.rtc).cmos_write(Qt,t.cmos_read(Qt)|1<<4*this.nr),t.cmos_write(Xt,15&t.cmos_read(Xt)|240),e=Yt,t.cmos_write(e+0,255&this.cylinder_count),t.cmos_write(e+1,this.cylinder_count>>8&255),t.cmos_write(e+2,255&this.head_count),t.cmos_write(e+3,255),t.cmos_write(e+4,255),t.cmos_write(e+5,200),t.cmos_write(e+6,255&this.cylinder_count),t.cmos_write(e+7,this.cylinder_count>>8&255),t.cmos_write(e+8,255&this.sectors_per_track)),this.stats={sectors_read:0,sectors_written:0,bytes_read:0,bytes_written:0,loading:!1},this.buffer=i,this.drive_head=this.head=this.cylinder_high=this.cylinder_low=this.lba_count=this.sector=this.bytecount=this.is_lba=0,this.status=80,this.sectors_per_drq=128,this.data_pointer=this.error=0,this.data=new Uint8Array(65536),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.data_end=this.data_length=0,this.current_atapi_command=this.current_command=-1,this.last_io_id=this.write_dest=0,this.in_progress_io_ids=new Set,this.cancelled_io_ids=new Set,Object.seal(this)}Et.prototype.read_status=function(){if(this.current_interface.buffer){var t=this.current_interface.status;return us("ATA read status: "+bt(t,2),u),t}return 0},Et.prototype.write_control=function(t){us("set device control: "+bt(t,2)+" interrupts "+(2&t?"disabled":"enabled"),u),4&t&&(us("Reset via control port",u),this.cpu.device_lower_irq(this.irq),this.master.device_reset(),this.slave.device_reset()),this.device_control=t},Et.prototype.dma_read_addr=function(){return us("dma get address: "+bt(this.prdt_addr,8),u),this.prdt_addr},Et.prototype.dma_set_addr=function(t){us("dma set address: "+bt(t,8),u),this.prdt_addr=t},Et.prototype.dma_read_status=function(){return us("DMA read status: "+bt(this.dma_status),u),this.dma_status},Et.prototype.dma_write_status=function(t){us("DMA set status: "+bt(t),u),this.dma_status&=~(6&t)},Et.prototype.dma_read_command=function(){return this.dma_read_command8()|this.dma_read_status()<<16},Et.prototype.dma_read_command8=function(){return us("DMA read command: "+bt(this.dma_command),u),this.dma_command},Et.prototype.dma_write_command=function(t){us("DMA write command: "+bt(t),u),this.dma_write_command8(255&t),this.dma_write_status(t>>16&255)},Et.prototype.dma_write_command8=function(t){us("DMA write command8: "+bt(t),u);let e=this.dma_command;if(this.dma_command=9&t,(1&e)!=(1&t))if(0==(1&t))this.dma_status&=-2;else switch(this.dma_status|=1,this.current_interface.current_command){case 37:case 200:this.current_interface.do_ata_read_sectors_dma();break;case 202:case 53:this.current_interface.do_ata_write_sectors_dma();break;case 160:this.current_interface.do_atapi_dma();break;default:us("Spurious dma command write, current command: "+bt(this.current_interface.current_command),u),ls(!1)}},Et.prototype.push_irq=function(){0==(2&this.device_control)&&(us("push irq",u),this.dma_status|=4,this.cpu.device_raise_irq(this.irq))},Et.prototype.get_state=function(){var t=[];return t[0]=this.master,t[1]=this.slave,t[2]=this.ata_port,t[3]=this.irq,t[4]=this.pci_id,t[5]=this.ata_port_high,t[6]=this.master_port,t[7]=this.name,t[8]=this.device_control,t[9]=this.prdt_addr,t[10]=this.dma_status,t[11]=this.current_interface===this.master,t[12]=this.dma_command,t},Et.prototype.set_state=function(t){this.master.set_state(t[0]),this.slave.set_state(t[1]),this.ata_port=t[2],this.irq=t[3],this.pci_id=t[4],this.ata_port_high=t[5],this.master_port=t[6],this.name=t[7],this.device_control=t[8],this.prdt_addr=t[9],this.dma_status=t[10],this.current_interface=t[11]?this.master:this.slave,this.dma_command=t[12]},It.prototype.device_reset=function(){this.is_atapi?(this.status=0,this.sector=this.error=this.bytecount=1,this.cylinder_low=20,this.cylinder_high=235):(this.status=81,this.sector=this.error=this.bytecount=1,this.cylinder_high=this.cylinder_low=0),this.cancel_io_operations()},It.prototype.push_irq=function(){this.device.push_irq()},It.prototype.ata_command=function(t){if(us("ATA Command: "+bt(t)+" slave="+(this.drive_head>>4&1),u),this.buffer)switch(this.current_command=t,this.error=0,t){case 8:us("ATA device reset",u),this.data_length=this.data_end=this.data_pointer=0,this.device_reset(),this.push_irq();break;case 16:this.status=80,this.cylinder_low=0,this.push_irq();break;case 248:this.status=80,t=this.sector_count-1,this.sector=255&t,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.drive_head=240&this.drive_head|t>>24&15,this.push_irq();break;case 39:this.status=80,t=this.sector_count-1,this.sector=255&t,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.sector|=t>>24<<8&65280,this.push_irq();break;case 32:case 36:case 41:case 196:this.ata_read_sectors(t);break;case 48:case 52:case 57:case 197:this.ata_write_sectors(t);break;case 144:this.push_irq(),this.error=257,this.status=80;break;case 145:case 222:this.status=80,this.push_irq();break;case 160:this.is_atapi&&(this.status=88,this.data_allocate(12),this.data_end=12,this.bytecount=1,this.push_irq());break;case 161:us("ATA identify packet device",u),this.is_atapi?(this.create_identify_packet(),this.status=88,this.cylinder_low=20,this.cylinder_high=235):this.status=65,this.push_irq();break;case 198:us("Logical sectors per DRQ Block: "+bt(255&this.bytecount),u),this.sectors_per_drq=255&this.bytecount,this.status=80,this.push_irq();break;case 37:case 200:this.ata_read_sectors_dma(t);break;case 53:case 202:this.ata_write_sectors_dma(t);break;case 64:us("read verify sectors",u),this.status=80,this.push_irq();break;case 218:us("Unimplemented: get media status",u),this.status=65,this.error=4,this.push_irq();break;case 224:us("ATA standby immediate",u),this.status=80,this.push_irq();break;case 225:us("ATA idle immediate",u),this.status=80,this.push_irq();break;case 231:us("ATA flush cache",u),this.status=80,this.push_irq();break;case 236:if(us("ATA identify device",u),this.is_atapi){this.status=65,this.error=4,this.push_irq();break}this.create_identify_packet(),this.status=88,this.push_irq();break;case 234:us("flush cache ext",u),this.status=80,this.push_irq();break;case 239:us("set features: "+bt(255&this.bytecount),u),this.status=80,this.push_irq();break;case 245:us("security freeze lock",u),this.status=80,this.push_irq();break;case 249:us("Unimplemented: set max address",u),this.status=65,this.error=4;break;default:ls(!1,"New ATA cmd on 1F7: "+bt(t),u),this.status=65,this.error=4}else us("abort: No buffer",u),this.error=4,this.status=65,this.push_irq()},It.prototype.atapi_handle=function(){switch(us("ATAPI Command: "+bt(this.data[0])+" slave="+(this.drive_head>>4&1),u),this.data_pointer=0,this.current_atapi_command=this.data[0],this.current_atapi_command){case 0:us("test unit ready",u),this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 3:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88,this.data[0]=240,this.data[2]=5,this.data[7]=8;break;case 18:var t=this.data[4];this.status=88,us("inquiry: "+bt(this.data[1],2)+" length="+t,u),this.data.set([5,128,1,49,31,0,0,0,83,79,78,89,32,32,32,32,67,68,45,82,79,77,32,67,68,85,45,49,48,48,48,32,49,46,49,97]),this.data_end=this.data_length=Math.min(36,t);break;case 26:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88;break;case 30:case 81:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 37:t=this.sector_count-1,this.data_set(new Uint8Array([t>>24&255,t>>16&255,t>>8&255,255&t,0,0,this.sector_size>>8&255,255&this.sector_size])),this.data_end=this.data_length,this.status=88;break;case 40:1&this.lba_count?this.atapi_read_dma(this.data):this.atapi_read(this.data);break;case 66:t=this.data[8],this.data_allocate(Math.min(8,t)),this.data_end=this.data_length,us("read q subcode: length="+t,u),this.status=88;break;case 67:t=this.data[8]|this.data[7]<<8;var e=this.data[9]>>6;this.data_allocate(t),this.data_end=this.data_length,us("read toc: "+bt(e,2)+" length="+t+" "+(2&this.data[1])+" "+bt(this.data[6]),u),0===e?(t=this.sector_count,this.data.set(new Uint8Array([0,18,1,1,0,20,1,0,0,0,0,0,0,22,170,0,t>>24,t>>16&255,t>>8&255,255&t]))):1===e?this.data.set(new Uint8Array([0,10,1,1,0,0,0,0,0,0,0,0])):ls(!1,"Unimplemented format: "+e),this.status=88;break;case 70:t=this.data[8]|this.data[7]<<8,t=Math.min(t,32),this.data_allocate(t),this.data_end=this.data_length,this.data[0]=t-4>>24&255,this.data[1]=t-4>>16&255,this.data[2]=t-4>>8&255,this.data[3]=t-4&255,this.data[6]=8,this.data[10]=3,this.status=88;break;case 82:us("Unimplemented ATAPI command: "+bt(this.data[0]),u),this.status=81,this.data_length=0,this.error=80;break;case 90:t=this.data[8]|this.data[7]<<8,e=this.data[2],us("mode sense: "+bt(e)+" length="+t,u),42===e&&this.data_allocate(Math.min(30,t)),this.data_end=this.data_length,this.status=88;break;case 189:this.data_allocate(this.data[9]|this.data[8]<<8),this.data_end=this.data_length,this.data[5]=1,this.status=88;break;case 74:this.status=81,this.data_length=0,this.error=80,us("Unimplemented ATAPI command: "+bt(this.data[0]),u);break;case 190:us("Unimplemented ATAPI command: "+bt(this.data[0]),u),this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;default:this.status=81,this.data_length=0,this.error=80,us("Unimplemented ATAPI command: "+bt(this.data[0]),u),ls(!1)}this.bytecount=-8&this.bytecount|2,0==(128&this.status)&&this.push_irq(),0==(128&this.status)&&0===this.data_length&&(this.bytecount|=1,this.status&=-9)},It.prototype.do_write=function(){this.status=80,ls(this.data_length<=this.data.length);var t=this.data.subarray(0,this.data_length);ls(0==this.data_length%512),this.ata_advance(this.current_command,this.data_length/512),this.push_irq(),this.buffer.set(this.write_dest,t,(function(){})),this.report_write(this.data_length)},It.prototype.atapi_read=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],i=t[7]<<8|t[8];t=t[1];var s=i*this.sector_size,r=e*this.sector_size;us("CD read lba="+bt(e)+" lbacount="+bt(i)+" bytecount="+bt(s)+" flags="+bt(t),u),this.data_length=0;var a=this.cylinder_high<<8&65280|255&this.cylinder_low;us(bt(this.cylinder_high,2)+" "+bt(this.cylinder_low,2),u),this.cylinder_low=this.cylinder_high=0,65535===a&&a--,a>s&&(a=s),r>=this.buffer.byteLength?(ls(!1,"CD read: Outside of disk  end="+bt(r+s)+" size="+bt(this.buffer.byteLength),u),this.status=255,this.push_irq()):0===s?(this.status=80,this.data_pointer=0):(s=Math.min(s,this.buffer.byteLength-r),this.status=208,this.report_read_start(),this.read_buffer(r,s,(t=>{us("cd read: data arrived",u),this.data_set(t),this.status=88,this.bytecount=-8&this.bytecount|2,this.push_irq(),this.data_end=a&=-4,this.data_end>this.data_length&&(this.data_end=this.data_length),this.cylinder_low=255&this.data_end,this.cylinder_high=this.data_end>>8&255,this.report_read_end(s)})))},It.prototype.atapi_read_dma=function(t){var e=t[2]<<24|t[3]<<16|t[4]<<8|t[5],i=t[7]<<8|t[8];t=t[1];var s=i*this.sector_size,r=e*this.sector_size;us("CD read DMA lba="+bt(e)+" lbacount="+bt(i)+" bytecount="+bt(s)+" flags="+bt(t),u),r>=this.buffer.byteLength?(ls(!1,"CD read: Outside of disk  end="+bt(r+s)+" size="+bt(this.buffer.byteLength),u),this.status=255,this.push_irq()):(this.status=208,this.report_read_start(),this.read_buffer(r,s,(t=>{us("atapi_read_dma: Data arrived"),this.report_read_end(s),this.status=88,this.bytecount=-8&this.bytecount|2,this.data_set(t),this.do_atapi_dma()})))},It.prototype.do_atapi_dma=function(){if(0==(1&this.device.dma_status))us("do_atapi_dma: Status not set",u);else if(0==(8&this.status))us("do_atapi_dma: DRQ not set",u);else{us("atapi dma transfer len="+this.data_length,u);var t=this.device.prdt_addr,e=0,i=this.data;do{var s=this.cpu.read32s(t),r=this.cpu.read16(t+4),a=128&this.cpu.read8(t+7);if(r||(r=65536),us("dma read dest="+bt(s)+" count="+bt(r)+" datalen="+bt(this.data_length),u),this.cpu.write_blob(i.subarray(e,Math.min(e+r,this.data_length)),s),t+=8,(e+=r)>=this.data_length&&!a){us("leave early end="+ +a+" offset="+bt(e)+" data_length="+bt(this.data_length)+" cmd="+bt(this.current_command),u);break}}while(!a);us("end offset="+e,u),this.status=80,this.device.dma_status&=-2,this.bytecount=-8&this.bytecount|3,this.push_irq()}},It.prototype.read_data=function(t){if(this.data_pointer<this.data_end){ls(this.data_pointer+t-1<this.data_end),ls(0==this.data_pointer%t,bt(this.data_pointer)+" "+t);var e=1===t?this.data[this.data_pointer]:2===t?this.data16[this.data_pointer>>>1]:this.data32[this.data_pointer>>>2];return this.data_pointer+=t,0==(this.data_pointer&(0==(4095&this.data_end)?4095:255))&&us("Read 1F0: "+bt(this.data[this.data_pointer],2)+" cur="+bt(this.data_pointer)+" cnt="+bt(this.data_length),u),this.data_pointer>=this.data_end&&this.read_end(),e}return us("Read 1F0: empty",u),this.data_pointer+=t,0},It.prototype.read_end=function(){if(us("read_end cmd="+bt(this.current_command)+" data_pointer="+bt(this.data_pointer)+" end="+bt(this.data_end)+" length="+bt(this.data_length),u),160===this.current_command)if(this.data_end===this.data_length)this.status=80,this.bytecount=-8&this.bytecount|3,this.push_irq();else{this.status=88,this.bytecount=-8&this.bytecount|2,this.push_irq();var t=this.cylinder_high<<8&65280|255&this.cylinder_low;this.data_end+t>this.data_length?(this.cylinder_low=this.data_length-this.data_end&255,this.cylinder_high=this.data_length-this.data_end>>8&255,this.data_end=this.data_length):this.data_end+=t,us("data_end="+bt(this.data_end),u)}else this.error=0,this.data_pointer>=this.data_length?this.status=80:(196===this.current_command||41===this.current_command?ls(0==(t=Math.min(this.sectors_per_drq,(this.data_length-this.data_end)/512))%1):(ls(32===this.current_command||36===this.current_command),t=1),this.ata_advance(this.current_command,t),this.data_end+=512*t,this.status=88),this.push_irq()},It.prototype.write_data_port=function(t,e){ls(0==this.data_pointer%e),this.data_pointer>=this.data_end?us("Redundant write to data port: "+bt(t)+" count="+bt(this.data_end)+" cur="+bt(this.data_pointer),u):((0==(this.data_pointer+e&(0==(4095&this.data_end)?4095:255))||20>this.data_end)&&us("Data port: "+bt(t>>>0)+" count="+bt(this.data_end)+" cur="+bt(this.data_pointer),u),1===e?this.data[this.data_pointer++]=t:2===e?(this.data16[this.data_pointer>>>1]=t,this.data_pointer+=2):(this.data32[this.data_pointer>>>2]=t,this.data_pointer+=4),ls(this.data_pointer<=this.data_end),this.data_pointer===this.data_end&&this.write_end())},It.prototype.write_data_port8=function(t){this.write_data_port(t,1)},It.prototype.write_data_port16=function(t){this.write_data_port(t,2)},It.prototype.write_data_port32=function(t){this.write_data_port(t,4)},It.prototype.write_end=function(){160===this.current_command?this.atapi_handle():(us("write_end data_pointer="+bt(this.data_pointer)+" data_length="+bt(this.data_length),u),this.data_pointer>=this.data_length?this.do_write():(ls(48===this.current_command||52===this.current_command||197===this.current_command,"Unexpected command: "+bt(this.current_command)),this.status=88,this.data_end+=512,this.push_irq()))},It.prototype.ata_advance=function(t,e){us("Advance sectors="+e+" old_bytecount="+this.bytecount,u),this.bytecount-=e,36===t||41===t||52===t||57===t||37===t||53===t?(t=e+this.get_lba48(),this.sector=255&t|t>>16&65280,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255):this.is_lba?(t=e+this.get_lba28(),this.sector=255&t,this.cylinder_low=t>>8&255,this.cylinder_high=t>>16&255,this.head=-16&this.head|15&t):(e=(t=e+this.get_chs())/(this.head_count*this.sectors_per_track)|0,this.cylinder_low=255&e,this.cylinder_high=e>>8&255,this.head=(t/this.sectors_per_track|0)%this.head_count&15,this.sector=t%this.sectors_per_track+1&255,ls(t===this.get_chs()))},It.prototype.ata_read_sectors=function(t){var e=36===t||41===t,i=this.get_count(e);e=this.get_lba(e);var s=32===t||36===t,r=i*this.sector_size,a=e*this.sector_size;us("ATA read cmd="+bt(t)+" mode="+(this.is_lba?"lba":"chs")+" lba="+bt(e)+" lbacount="+bt(i)+" bytecount="+bt(r),u),a+r>this.buffer.byteLength?(ls(!1,"ATA read: Outside of disk",u),this.status=255,this.push_irq()):(this.status=192,this.report_read_start(),this.read_buffer(a,r,(e=>{us("ata_read: Data arrived",u),this.data_set(e),this.status=88,this.data_end=s?512:Math.min(r,512*this.sectors_per_drq),this.ata_advance(t,s?1:Math.min(i,this.sectors_per_track)),this.push_irq(),this.report_read_end(r)})))},It.prototype.ata_read_sectors_dma=function(t){var e=37===t;t=this.get_count(e),e=this.get_lba(e);var i=t*this.sector_size,s=e*this.sector_size;us("ATA DMA read lba="+bt(e)+" lbacount="+bt(t)+" bytecount="+bt(i),u),s+i>this.buffer.byteLength?(ls(!1,"ATA read: Outside of disk",u),this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},It.prototype.do_ata_read_sectors_dma=function(){var t=37===this.current_command,e=this.get_count(t);t=this.get_lba(t);var i=e*this.sector_size,s=t*this.sector_size;ls(t<this.buffer.byteLength),this.report_read_start();var r=this.device.prdt_addr;this.read_buffer(s,i,(t=>{us("do_ata_read_sectors_dma: Data arrived",u);var s=this.device.prdt_addr,a=0;ls(r===s);do{var n=this.cpu.read32s(s),o=this.cpu.read16(s+4),h=128&this.cpu.read8(s+7);o||(o=65536,us("dma: prd count was 0",u)),us("dma read transfer dest="+bt(n)+" prd_count="+bt(o),u),this.cpu.write_blob(t.subarray(a,a+o),n),a+=o,s+=8}while(!h);ls(a===i),this.ata_advance(this.current_command,e),this.status=80,this.device.dma_status&=-2,this.current_command=-1,this.push_irq(),this.report_read_end(i)}))},It.prototype.ata_write_sectors=function(t){var e=52===t||57===t,i=this.get_count(e);e=this.get_lba(e),t=48===t||52===t;var s=i*this.sector_size,r=e*this.sector_size;us("ATA write lba="+bt(e)+" mode="+(this.is_lba?"lba":"chs")+" lbacount="+bt(i)+" bytecount="+bt(s),u),r+s>this.buffer.byteLength?(ls(!1,"ATA write: Outside of disk",u),this.status=255,this.push_irq()):(this.status=88,this.data_allocate_noclear(s),this.data_end=t?512:Math.min(s,512*this.sectors_per_drq),this.write_dest=r)},It.prototype.ata_write_sectors_dma=function(t){var e=53===t;t=this.get_count(e),e=this.get_lba(e);var i=t*this.sector_size,s=e*this.sector_size;us("ATA DMA write lba="+bt(e)+" lbacount="+bt(t)+" bytecount="+bt(i),u),s+i>this.buffer.byteLength?(ls(!1,"ATA DMA write: Outside of disk",u),this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)},It.prototype.do_ata_write_sectors_dma=function(){var t=53===this.current_command,e=this.get_count(t),i=this.get_lba(t);t=e*this.sector_size,i*=this.sector_size;var s=this.device.prdt_addr,r=0;us("prdt addr: "+bt(s,8),u);const a=new Uint8Array(t);do{var n=this.cpu.read32s(s),o=this.cpu.read16(s+4),h=128&this.cpu.read8(s+7);o||(o=65536,us("dma: prd count was 0",u)),us("dma write transfer dest="+bt(n)+" prd_count="+bt(o),u),ls((n=this.cpu.mem8.subarray(n,n+o)).length===o),a.set(n,r),r+=o,s+=8}while(!h);ls(r===a.length),this.buffer.set(i,a,(()=>{us("dma write completed",u),this.ata_advance(this.current_command,e),this.status=80,this.push_irq(),this.device.dma_status&=-2,this.current_command=-1})),this.report_write(t)},It.prototype.get_chs=function(){var t=255&this.cylinder_low|this.cylinder_high<<8&65280,e=this.head,i=255&this.sector;return us("get_chs: c="+t+" h="+e+" s="+i,u),(t*this.head_count+e)*this.sectors_per_track+i-1},It.prototype.get_lba28=function(){return 255&this.sector|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|(15&this.head)<<24},It.prototype.get_lba48=function(){return(255&this.sector|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|this.sector>>8<<24&4278190080)>>>0},It.prototype.get_lba=function(t){return t?this.get_lba48():this.is_lba?this.get_lba28():this.get_chs()},It.prototype.get_count=function(t){return t?0===(t=this.bytecount)&&(t=65536):0===(t=255&this.bytecount)&&(t=256),t},It.prototype.create_identify_packet=function(){if(16&this.drive_head)this.data_allocate(0);else{for(var t=0;512>t;t++)this.data[t]=0;t=Math.min(16383,this.cylinder_count),this.data_set([64,this.is_atapi?133:0,t,t>>8,0,0,this.head_count,this.head_count>>8,this.sectors_per_track/512,this.sectors_per_track/512>>8,0,2,this.sectors_per_track,this.sectors_per_track>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,4,0,0,0,0,0,0,0,0,0,56,118,32,54,68,72,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,128,0,1,0,0,2,0,0,0,2,0,2,7,0,t,t>>8,this.head_count,this.head_count>>8,this.sectors_per_track,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,160===this.current_command?0:7,160===this.current_command?0:4,0,0,30,0,30,0,30,0,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,126,0,0,0,0,0,0,116,0,64,0,64,0,116,0,64,0,0,0,0,0,0,0,0,0,0,1,96,0,0,0,0,0,0,0,0,0,0,0,0,255&this.sector_count,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255]),this.data_end=this.data_length=512}},It.prototype.data_allocate=function(t){this.data_allocate_noclear(t);for(var e=0;e<t+3>>2;e++)this.data32[e]=0},It.prototype.data_allocate_noclear=function(t){this.data.length<t&&(this.data=new Uint8Array(t+3&-4),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer)),this.data_length=t,this.data_pointer=0},It.prototype.data_set=function(t){this.data_allocate_noclear(t.length),this.data.set(t)},It.prototype.report_read_start=function(){this.stats.loading=!0,this.bus.send("ide-read-start")},It.prototype.report_read_end=function(t){this.stats.loading=!1;var e=t/this.sector_size|0;this.stats.sectors_read+=e,this.stats.bytes_read+=t,this.bus.send("ide-read-end",[this.nr,t,e])},It.prototype.report_write=function(t){var e=t/this.sector_size|0;this.stats.sectors_written+=e,this.stats.bytes_written+=t,this.bus.send("ide-write-end",[this.nr,t,e])},It.prototype.read_buffer=function(t,e,i){const s=this.last_io_id++;this.in_progress_io_ids.add(s),this.buffer.get(t,e,(t=>{this.cancelled_io_ids.delete(s)?ls(!this.in_progress_io_ids.has(s)):(ls(this.in_progress_io_ids.delete(s)),i(t))}))},It.prototype.cancel_io_operations=function(){for(const t of this.in_progress_io_ids)this.cancelled_io_ids.add(t);this.in_progress_io_ids.clear()},It.prototype.get_state=function(){var t=[];return t[0]=this.bytecount,t[1]=this.cylinder_count,t[2]=this.cylinder_high,t[3]=this.cylinder_low,t[4]=this.data_pointer,t[5]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=this.drive_head,t[10]=this.error,t[11]=this.head,t[12]=this.head_count,t[13]=this.is_atapi,t[14]=this.is_lba,t[15]=this.lba_count,t[16]=this.data,t[17]=this.data_length,t[18]=this.sector,t[19]=this.sector_count,t[20]=this.sector_size,t[21]=this.sectors_per_drq,t[22]=this.sectors_per_track,t[23]=this.status,t[24]=this.write_dest,t[25]=this.current_command,t[26]=this.data_end,t[27]=this.current_atapi_command,t[28]=this.buffer,t},It.prototype.set_state=function(t){this.bytecount=t[0],this.cylinder_count=t[1],this.cylinder_high=t[2],this.cylinder_low=t[3],this.data_pointer=t[4],this.drive_head=t[9],this.error=t[10],this.head=t[11],this.head_count=t[12],this.is_atapi=t[13],this.is_lba=t[14],this.lba_count=t[15],this.data=t[16],this.data_length=t[17],this.sector=t[18],this.sector_count=t[19],this.sector_size=t[20],this.sectors_per_drq=t[21],this.sectors_per_track=t[22],this.status=t[23],this.write_dest=t[24],this.current_command=t[25],this.data_end=t[26],this.current_atapi_command=t[27],this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.buffer&&this.buffer.set_state(t[28])};var Rt=3320,Ct=3324;function St(t){this.pci_addr=new Uint8Array(4),this.pci_value=new Uint8Array(4),this.pci_response=new Uint8Array(4),this.pci_status=new Uint8Array(4),this.pci_addr32=new Int32Array(this.pci_addr.buffer),this.pci_value32=new Int32Array(this.pci_value.buffer),this.pci_response32=new Int32Array(this.pci_response.buffer),this.pci_status32=new Int32Array(this.pci_status.buffer),this.device_spaces=[],this.devices=[],this.cpu=t;for(var e=0;256>e;e++)this.device_spaces[e]=void 0,this.devices[e]=void 0;this.io=t.io,t.io.register_write(Ct,this,(function(t){this.pci_write8(this.pci_addr32[0],t)}),(function(t){this.pci_write16(this.pci_addr32[0],t)}),(function(t){this.pci_write32(this.pci_addr32[0],t)})),t.io.register_write(Ct+1,this,(function(t){this.pci_write8(this.pci_addr32[0]+1|0,t)})),t.io.register_write(Ct+2,this,(function(t){this.pci_write8(this.pci_addr32[0]+2|0,t)}),(function(t){this.pci_write16(this.pci_addr32[0]+2|0,t)})),t.io.register_write(Ct+3,this,(function(t){this.pci_write8(this.pci_addr32[0]+3|0,t)})),t.io.register_read_consecutive(Ct,this,(function(){return this.pci_response[0]}),(function(){return this.pci_response[1]}),(function(){return this.pci_response[2]}),(function(){return this.pci_response[3]})),t.io.register_read_consecutive(Rt,this,(function(){return this.pci_status[0]}),(function(){return this.pci_status[1]}),(function(){return this.pci_status[2]}),(function(){return this.pci_status[3]})),t.io.register_write_consecutive(Rt,this,(function(t){this.pci_addr[0]=252&t}),(function(e){2==(6&this.pci_addr[1])&&6==(6&e)?(us("CPU reboot via PCI"),t.reboot_internal()):this.pci_addr[1]=e}),(function(t){this.pci_addr[2]=t}),(function(t){this.pci_addr[3]=t,this.pci_query()})),this.register_device({pci_id:0,pci_space:[134,128,55,18,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0],pci_bars:[],name:"82441FX PMC"}),this.isa_bridge={pci_id:8,pci_space:[134,128,0,112,7,0,0,2,0,0,1,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82371SB PIIX3 ISA"},this.isa_bridge_space=this.register_device(this.isa_bridge),this.isa_bridge_space8=new Uint8Array(this.isa_bridge_space.buffer)}function zt(t,e,i){if(this.io=t.io,this.cpu=t,this.dma=t.devices.dma,this.bytes_expecting=0,this.receiving_command=new Uint8Array(10),this.receiving_index=0,this.next_command=null,this.response_data=new Uint8Array(10),this.response_length=this.response_index=0,this.fda_image=e,this.fdb_image=i,this.last_head=this.last_cylinder=this.drive=this.status_reg2=this.status_reg1=this.status_reg0=0,this.last_sector=1,this.dor=0,e){var s={163840:{type:1,tracks:40,sectors:8,heads:1},184320:{type:1,tracks:40,sectors:9,heads:1},204800:{type:1,tracks:40,sectors:10,heads:1},327680:{type:1,tracks:40,sectors:8,heads:2},368640:{type:1,tracks:40,sectors:9,heads:2},409600:{type:1,tracks:40,sectors:10,heads:2},737280:{type:3,tracks:80,sectors:9,heads:2},1228800:{type:2,tracks:80,sectors:15,heads:2},1474560:{type:4,tracks:80,sectors:18,heads:2},1763328:{type:5,tracks:82,sectors:21,heads:2},2949120:{type:5,tracks:80,sectors:36,heads:2},512:{type:1,tracks:1,sectors:1,heads:1}};let r=e.byteLength;(i=s[r])||(r=1474560<e.byteLength?2949120:1474560,i=s[r],us("Warning: Unkown floppy size: "+e.byteLength+", assuming "+r)),t.devices.rtc.cmos_write(Kt,i.type<<4),t=i.sectors,e=i.heads,i=i.tracks,this.sectors_per_track=t,this.number_of_heads=e,this.number_of_cylinders=i}else t.devices.rtc.cmos_write(Kt,64),this.number_of_cylinders=this.number_of_heads=this.sectors_per_track=0;this.io.register_read(1008,this,this.port3F0_read),this.io.register_read(1010,this,this.port3F2_read),this.io.register_read(1012,this,this.port3F4_read),this.io.register_read(1013,this,this.port3F5_read),this.io.register_read(1015,this,this.port3F7_read),this.io.register_write(1010,this,this.port3F2_write),this.io.register_write(1013,this,this.port3F5_write)}function Dt(t){this.cpu=t,this.channel_page=new Uint8Array(8),this.channel_pagehi=new Uint8Array(8),this.channel_addr=new Uint16Array(8),this.channel_addr_init=new Uint16Array(8),this.channel_count=new Uint16Array(8),this.channel_count_init=new Uint16Array(8),this.channel_mask=new Uint8Array(8),this.channel_mode=new Uint8Array(8),this.unmask_listeners=[],this.lsb_msb_flipflop=0,(t=t.io).register_write(0,this,this.port_addr_write.bind(this,0)),t.register_write(2,this,this.port_addr_write.bind(this,1)),t.register_write(4,this,this.port_addr_write.bind(this,2)),t.register_write(6,this,this.port_addr_write.bind(this,3)),t.register_write(1,this,this.port_count_write.bind(this,0)),t.register_write(3,this,this.port_count_write.bind(this,1)),t.register_write(5,this,this.port_count_write.bind(this,2)),t.register_write(7,this,this.port_count_write.bind(this,3)),t.register_read(0,this,this.port_addr_read.bind(this,0)),t.register_read(2,this,this.port_addr_read.bind(this,1)),t.register_read(4,this,this.port_addr_read.bind(this,2)),t.register_read(6,this,this.port_addr_read.bind(this,3)),t.register_read(1,this,this.port_count_read.bind(this,0)),t.register_read(3,this,this.port_count_read.bind(this,1)),t.register_read(5,this,this.port_count_read.bind(this,2)),t.register_read(7,this,this.port_count_read.bind(this,3)),t.register_write(192,this,this.port_addr_write.bind(this,4)),t.register_write(196,this,this.port_addr_write.bind(this,5)),t.register_write(200,this,this.port_addr_write.bind(this,6)),t.register_write(204,this,this.port_addr_write.bind(this,7)),t.register_write(194,this,this.port_count_write.bind(this,4)),t.register_write(198,this,this.port_count_write.bind(this,5)),t.register_write(202,this,this.port_count_write.bind(this,6)),t.register_write(206,this,this.port_count_write.bind(this,7)),t.register_read(192,this,this.port_addr_read.bind(this,4)),t.register_read(196,this,this.port_addr_read.bind(this,5)),t.register_read(200,this,this.port_addr_read.bind(this,6)),t.register_read(204,this,this.port_addr_read.bind(this,7)),t.register_read(194,this,this.port_count_read.bind(this,4)),t.register_read(198,this,this.port_count_read.bind(this,5)),t.register_read(202,this,this.port_count_read.bind(this,6)),t.register_read(206,this,this.port_count_read.bind(this,7)),t.register_write(135,this,this.port_page_write.bind(this,0)),t.register_write(131,this,this.port_page_write.bind(this,1)),t.register_write(129,this,this.port_page_write.bind(this,2)),t.register_write(130,this,this.port_page_write.bind(this,3)),t.register_write(143,this,this.port_page_write.bind(this,4)),t.register_write(139,this,this.port_page_write.bind(this,5)),t.register_write(137,this,this.port_page_write.bind(this,6)),t.register_write(138,this,this.port_page_write.bind(this,7)),t.register_read(135,this,this.port_page_read.bind(this,0)),t.register_read(131,this,this.port_page_read.bind(this,1)),t.register_read(129,this,this.port_page_read.bind(this,2)),t.register_read(130,this,this.port_page_read.bind(this,3)),t.register_read(143,this,this.port_page_read.bind(this,4)),t.register_read(139,this,this.port_page_read.bind(this,5)),t.register_read(137,this,this.port_page_read.bind(this,6)),t.register_read(138,this,this.port_page_read.bind(this,7)),t.register_write(1159,this,this.port_pagehi_write.bind(this,0)),t.register_write(1155,this,this.port_pagehi_write.bind(this,1)),t.register_write(1153,this,this.port_pagehi_write.bind(this,2)),t.register_write(1154,this,this.port_pagehi_write.bind(this,3)),t.register_write(1163,this,this.port_pagehi_write.bind(this,5)),t.register_write(1161,this,this.port_pagehi_write.bind(this,6)),t.register_write(1162,this,this.port_pagehi_write.bind(this,7)),t.register_read(1159,this,this.port_pagehi_read.bind(this,0)),t.register_read(1155,this,this.port_pagehi_read.bind(this,1)),t.register_read(1153,this,this.port_pagehi_read.bind(this,2)),t.register_read(1154,this,this.port_pagehi_read.bind(this,3)),t.register_read(1163,this,this.port_pagehi_read.bind(this,5)),t.register_read(1161,this,this.port_pagehi_read.bind(this,6)),t.register_read(1162,this,this.port_pagehi_read.bind(this,7)),t.register_write(10,this,this.port_singlemask_write.bind(this,0)),t.register_write(212,this,this.port_singlemask_write.bind(this,4)),t.register_write(15,this,this.port_multimask_write.bind(this,0)),t.register_write(222,this,this.port_multimask_write.bind(this,4)),t.register_read(15,this,this.port_multimask_read.bind(this,0)),t.register_read(222,this,this.port_multimask_read.bind(this,4)),t.register_write(11,this,this.port_mode_write.bind(this,0)),t.register_write(214,this,this.port_mode_write.bind(this,4)),t.register_write(12,this,this.portC_write),t.register_write(216,this,this.portC_write)}St.prototype.get_state=function(){for(var t=[],e=0;256>e;e++)t[e]=this.device_spaces[e];return t[256]=this.pci_addr,t[257]=this.pci_value,t[258]=this.pci_response,t[259]=this.pci_status,t},St.prototype.set_state=function(t){for(var e=0;256>e;e++){var i=this.devices[e],s=t[e];if(i&&s){for(var r=0;r<i.pci_bars.length;r++){var a=s[4+r];if(1&a){var n=i.pci_bars[r];this.set_io_bars(n,65534&n.original_bar,65534&a)}}this.device_spaces[e].set(s)}else i&&us("Warning: While restoring PCI device: Device exists in current configuration but not in snapshot ("+i.name+")"),s&&us("Warning: While restoring PCI device: Device doesn't exist in current configuration but does in snapshot (device "+bt(e,2)+")")}this.pci_addr.set(t[256]),this.pci_value.set(t[257]),this.pci_response.set(t[258]),this.pci_status.set(t[259])},St.prototype.pci_query=function(){var t=this.pci_addr[2]<<8|this.pci_addr[1],e=252&this.pci_addr[0],i=t>>3&31,s="query enabled="+(this.pci_addr[3]>>7)+" bdf="+bt(t,4);s+=" dev="+bt(i,2),s+=" addr="+bt(e,2),void 0!==(i=this.device_spaces[t])?(this.pci_status32[0]=-2147483648,this.pci_response32[0]=e<i.byteLength?i[e>>2]:0,s+=" "+bt(this.pci_addr32[0]>>>0,8)+" -> "+bt(this.pci_response32[0]>>>0,8),e>=i.byteLength&&(s+=" (undef)"),s+=" ("+this.devices[t].name+")",us(s,h)):(this.pci_response32[0]=-1,this.pci_status32[0]=0)},St.prototype.pci_write8=function(t,e){var i=t>>8&65535;t&=255;var s=new Uint8Array(this.device_spaces[i].buffer),r=this.devices[i];s&&(ls(!(16<=t&&44>t||48<=t&&52>t),"PCI: Expected 32-bit write, got 8-bit (addr: "+bt(t)+")"),us("PCI write8 dev="+bt(i>>3,2)+" ("+r.name+") addr="+bt(t,4)+" value="+bt(e,2),h),s[t]=e)},St.prototype.pci_write16=function(t,e){ls(0==(1&t));var i=t>>8&65535;t&=255;var s=new Uint16Array(this.device_spaces[i].buffer),r=this.devices[i];s&&(16<=t&&44>t?us("Warning: PCI: Expected 32-bit write, got 16-bit (addr: "+bt(t)+")"):(ls(!(48<=t&&52>t),"PCI: Expected 32-bit write, got 16-bit (addr: "+bt(t)+")"),us("PCI writ16 dev="+bt(i>>3,2)+" ("+r.name+") addr="+bt(t,4)+" value="+bt(e,4),h),s[t>>>1]=e))},St.prototype.pci_write32=function(t,e){ls(0==(3&t));var i=t>>8&65535;t&=255;var s=this.device_spaces[i],r=this.devices[i];if(s)if(16<=t&&40>t){var a=t-16>>2,n=r.pci_bars[a];us("BAR"+a+" exists="+(n?"y":"n")+" changed to "+bt(e>>>0)+" dev="+bt(i>>3,2)+" ("+r.name+") ",h),n?(ls(!(n.size&n.size-1),"bar size should be power of 2"),r=1&s[i=t>>2],-1==(3|e|n.size-1)?(e=~(n.size-1)|r,0===r&&(s[i]=e)):0===r&&((-16&e)!=(-16&(a=n.original_bar))&&us("Warning: Changing memory bar not supported, ignored",h),s[i]=a),1===r&&(ls(1===r),r=65534&s[i],a=65534&e,us("io bar changed from "+bt(r>>>0,8)+" to "+bt(a>>>0,8)+" size="+n.size,h),this.set_io_bars(n,r,a),s[i]=1|e)):s[t>>2]=0,us("BAR effective value: "+bt(s[t>>2]>>>0),h)}else 48===t?(us("PCI write rom address dev="+bt(i>>3,2)+" ("+r.name+") value="+bt(e>>>0,8),h),s[t>>2]=r.pci_rom_size?-1==(2047|e)?0|-r.pci_rom_size:0|r.pci_rom_address:0):4===t?us("PCI write dev="+bt(i>>3,2)+" ("+r.name+") addr="+bt(t,4)+" value="+bt(e>>>0,8),h):(us("PCI write dev="+bt(i>>3,2)+" ("+r.name+") addr="+bt(t,4)+" value="+bt(e>>>0,8),h),s[t>>>2]=e)},St.prototype.register_device=function(t){ls(void 0!==t.pci_id),ls(void 0!==t.pci_space),ls(void 0!==t.pci_bars);var e=t.pci_id;us("PCI register bdf="+bt(e)+" ("+t.name+")",h),ls(!this.devices[e]),ls(64<=t.pci_space.length),ls(e<this.devices.length);var i=new Int32Array(64);i.set(new Int32Array(new Uint8Array(t.pci_space).buffer)),this.device_spaces[e]=i,this.devices[e]=t,e=i.slice(4,10);for(var s=0;s<t.pci_bars.length;s++){var r=t.pci_bars[s];if(r){var a=e[s],n=1&a;if(r.original_bar=a,r.entries=[],0!==n)for(ls(1===n),a&=-2,n=0;n<r.size;n++)r.entries[n]=this.io.ports[a+n]}}return i},St.prototype.set_io_bars=function(t,e,i){var s=t.size;us("Move io bars: from="+bt(e)+" to="+bt(i)+" count="+s,h);for(var r=this.io.ports,a=0;a<s;a++){var n=r[e+a];4096<=e+a&&(r[e+a]=this.io.create_empty_entry()),n.read8===this.io.empty_port_read8&&n.read16===this.io.empty_port_read16&&n.read32===this.io.empty_port_read32&&n.write8===this.io.empty_port_write&&n.write16===this.io.empty_port_write&&n.write32===this.io.empty_port_write&&us("Warning: Bad IO bar: Source not mapped, port="+bt(e+a,4),h),n=t.entries[a];var o=r[i+a];ls(n&&o),4096<=i+a&&(r[i+a]=n),o.read8!==this.io.empty_port_read8&&o.read16!==this.io.empty_port_read16&&o.read32!==this.io.empty_port_read32&&o.write8!==this.io.empty_port_write&&o.write16!==this.io.empty_port_write&&o.write32!==this.io.empty_port_write||us("Warning: Bad IO bar: Target already mapped, port="+bt(i+a,4),h)}},St.prototype.raise_irq=function(t){var e=this.device_spaces[t];ls(e),this.cpu.device_raise_irq(this.isa_bridge_space8[96+((e[15]>>8&255)-1+((t>>3)-1&255)&3)])},St.prototype.lower_irq=function(t){var e=this.device_spaces[t];ls(e),this.cpu.device_lower_irq(this.isa_bridge_space8[96+((e[15]>>8&255)+(t>>3&255)-2&3)])},zt.prototype.get_state=function(){var t=[];return t[0]=this.bytes_expecting,t[1]=this.receiving_command,t[2]=this.receiving_index,t[4]=this.response_data,t[5]=this.response_index,t[6]=this.response_length,t[8]=this.status_reg0,t[9]=this.status_reg1,t[10]=this.status_reg2,t[11]=this.drive,t[12]=this.last_cylinder,t[13]=this.last_head,t[14]=this.last_sector,t[15]=this.dor,t[16]=this.sectors_per_track,t[17]=this.number_of_heads,t[18]=this.number_of_cylinders,t},zt.prototype.set_state=function(t){this.bytes_expecting=t[0],this.receiving_command=t[1],this.receiving_index=t[2],this.next_command=t[3],this.response_data=t[4],this.response_index=t[5],this.response_length=t[6],this.status_reg0=t[8],this.status_reg1=t[9],this.status_reg2=t[10],this.drive=t[11],this.last_cylinder=t[12],this.last_head=t[13],this.last_sector=t[14],this.dor=t[15],this.sectors_per_track=t[16],this.number_of_heads=t[17],this.number_of_cylinders=t[18]},zt.prototype.port3F0_read=function(){return us("3F0 read",d),0},zt.prototype.port3F4_read=function(){us("3F4 read",d);var t=128;return this.response_index<this.response_length&&(t|=80),0==(8&this.dor)&&(t|=32),t},zt.prototype.port3F7_read=function(){return us("3F7 read",d),0},zt.prototype.port3F5_read=function(){return this.response_index<this.response_length?(us("3F5 read: "+this.response_data[this.response_index],d),this.cpu.device_lower_irq(6),this.response_data[this.response_index++]):(us("3F5 read, empty",d),255)},zt.prototype.port3F5_write=function(t){if(this.fda_image)if(us("3F5 write "+bt(t),d),0<this.bytes_expecting){if(this.receiving_command[this.receiving_index++]=t,this.bytes_expecting--,0===this.bytes_expecting){if(ot){t="3F5 command received: ";for(var e=0;e<this.receiving_index;e++)t+=bt(this.receiving_command[e])+" ";us(t,d)}this.next_command.call(this,this.receiving_command)}}else{switch(t){case 3:this.next_command=this.fix_drive_data,this.bytes_expecting=2;break;case 4:this.next_command=this.check_drive_status,this.bytes_expecting=1;break;case 5:case 69:case 197:this.next_command=function(t){this.do_sector(!0,t)},this.bytes_expecting=8;break;case 230:this.next_command=function(t){this.do_sector(!1,t)},this.bytes_expecting=8;break;case 7:this.next_command=this.calibrate,this.bytes_expecting=1;break;case 8:this.check_interrupt_status();break;case 74:this.next_command=this.read_sector_id,this.bytes_expecting=1;break;case 15:this.bytes_expecting=2,this.next_command=this.seek;break;case 14:us("dump registers",d),this.response_data[0]=128,this.response_index=0,this.response_length=1,this.bytes_expecting=0;break;default:ls(!1,"Unimplemented floppy command call "+bt(t))}this.receiving_index=0}},zt.prototype.port3F2_read=function(){return us("read 3F2: DOR",d),this.dor},zt.prototype.port3F2_write=function(t){4==(4&t)&&0==(4&this.dor)&&this.cpu.device_raise_irq(6),us("start motors: "+bt(t>>4),d),us("enable dma: "+!!(8&t),d),us("reset fdc: "+!!(4&t),d),us("drive select: "+(3&t),d),us("DOR = "+bt(t),d),this.dor=t},zt.prototype.check_drive_status=function(t){us("check drive status",d),this.response_index=0,this.response_length=1,this.response_data[0]=32},zt.prototype.seek=function(t){us("seek",d),ls(0==(3&t[0]),"Unhandled seek drive"),this.last_cylinder=t[1],this.last_head=t[0]>>2&1,this.raise_irq()},zt.prototype.calibrate=function(t){us("floppy calibrate",d),this.raise_irq()},zt.prototype.check_interrupt_status=function(){us("floppy check interrupt status",d),this.response_index=0,this.response_length=2,this.response_data[0]=32,this.response_data[1]=this.last_cylinder},zt.prototype.do_sector=function(t,e){var i=e[2],s=e[1],r=e[3],a=128<<e[4],n=e[5]-e[3]+1,o=((i+this.number_of_heads*s)*this.sectors_per_track+r-1)*a;us("Floppy "+(t?"Write":"Read"),d),us("from "+bt(o)+" length "+bt(n*a),d),us(s+" / "+i+" / "+r,d),e[4]||us("FDC: sector count is zero, use data length instead",d),this.fda_image&&(t?this.dma.do_write(this.fda_image,o,n*a,2,this.done.bind(this,e,s,i,r)):this.dma.do_read(this.fda_image,o,n*a,2,this.done.bind(this,e,s,i,r)))},zt.prototype.done=function(t,e,i,s,r){r||(++s>this.sectors_per_track&&(s=1,++i>=this.number_of_heads&&(i=0,e++)),this.last_cylinder=e,this.last_head=i,this.last_sector=s,this.response_index=0,this.response_length=7,this.response_data[0]=i<<2|32,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=e,this.response_data[4]=i,this.response_data[5]=s,this.response_data[6]=t[4],this.raise_irq())},zt.prototype.fix_drive_data=function(t){us("floppy fix drive data "+t,d)},zt.prototype.read_sector_id=function(t){us("floppy read sector id "+t,d),this.response_index=0,this.response_length=7,this.response_data[0]=0,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=0,this.response_data[4]=0,this.response_data[5]=0,this.response_data[6]=0,this.raise_irq()},zt.prototype.raise_irq=function(){8&this.dor&&this.cpu.device_raise_irq(6)},fs.prototype.mmap_read8=function(t){return ls(0<=(t=this.memory_map_read8[t>>>V](t))&&255>=t),t},fs.prototype.mmap_write8=function(t,e){ls(0<=e&&255>=e),this.memory_map_write8[t>>>V](t,e)},fs.prototype.mmap_read16=function(t){var e=this.memory_map_read8[t>>>V];return ls(0<=(t=e(t)|e(t+1|0)<<8)&&65535>=t),t},fs.prototype.mmap_write16=function(t,e){var i=this.memory_map_write8[t>>>V];ls(0<=e&&65535>=e),i(t,255&e),i(t+1|0,e>>8)},fs.prototype.mmap_read32=function(t){return this.memory_map_read32[t>>>V](t)},fs.prototype.mmap_write32=function(t,e){this.memory_map_write32[t>>>V](t,e)},fs.prototype.mmap_write64=function(t,e,i){var s=t>>>V;ls(s===t+7>>>V),(s=this.memory_map_write32[s])(t,e),s(t+4,i)},fs.prototype.mmap_write128=function(t,e,i,s,r){var a=t>>>V;ls(a===t+12>>>V),(a=this.memory_map_write32[a])(t,e),a(t+4,i),a(t+8,s),a(t+12,r)},fs.prototype.write_blob=function(t,e){ls(t&&0<=t.length),t.length&&(ls(!this.in_mapped_range(e)),ls(!this.in_mapped_range(e+t.length-1)),this.jit_dirty_cache(e,e+t.length),this.mem8.set(t,e))},fs.prototype.read_blob=function(t,e){return e&&(ls(!this.in_mapped_range(t)),ls(!this.in_mapped_range(t+e-1))),this.mem8.subarray(t,t+e)},Dt.prototype.get_state=function(){return[this.channel_page,this.channel_pagehi,this.channel_addr,this.channel_addr_init,this.channel_count,this.channel_count_init,this.channel_mask,this.channel_mode,this.lsb_msb_flipflop]},Dt.prototype.set_state=function(t){this.channel_page=t[0],this.channel_pagehi=t[1],this.channel_addr=t[2],this.channel_addr_init=t[3],this.channel_count=t[4],this.channel_count_init=t[5],this.channel_mask=t[6],this.channel_mode=t[7],this.lsb_msb_flipflop=t[8]},Dt.prototype.port_count_write=function(t,e){us("count write ["+t+"] = "+bt(e),i),this.channel_count[t]=this.flipflop_get(this.channel_count[t],e,!1),this.channel_count_init[t]=this.flipflop_get(this.channel_count_init[t],e,!0)},Dt.prototype.port_count_read=function(t){return us("count read ["+t+"] -> "+bt(this.channel_count[t]),i),this.flipflop_read(this.channel_count[t])},Dt.prototype.port_addr_write=function(t,e){us("addr write ["+t+"] = "+bt(e),i),this.channel_addr[t]=this.flipflop_get(this.channel_addr[t],e,!1),this.channel_addr_init[t]=this.flipflop_get(this.channel_addr_init[t],e,!0)},Dt.prototype.port_addr_read=function(t){return us("addr read ["+t+"] -> "+bt(this.channel_addr[t]),i),this.flipflop_read(this.channel_addr[t])},Dt.prototype.port_pagehi_write=function(t,e){us("pagehi write ["+t+"] = "+bt(e),i),this.channel_pagehi[t]=e},Dt.prototype.port_pagehi_read=function(t){return us("pagehi read ["+t+"]",i),this.channel_pagehi[t]},Dt.prototype.port_page_write=function(t,e){us("page write ["+t+"] = "+bt(e),i),this.channel_page[t]=e},Dt.prototype.port_page_read=function(t){return us("page read ["+t+"]",i),this.channel_page[t]},Dt.prototype.port_singlemask_write=function(t,e){us("singlechannel mask write ["+(t=(3&e)+t)+"] = "+(e=4&e?1:0),i),this.update_mask(t,e)},Dt.prototype.port_multimask_write=function(t,e){us("multichannel mask write: "+bt(e),i);for(var s=0;4>s;s++)this.update_mask(t+s,e&1<<s)},Dt.prototype.port_multimask_read=function(t){var e=0|this.channel_mask[t+0];return e|=this.channel_mask[t+1]<<1,e|=this.channel_mask[t+2]<<2,e|=this.channel_mask[t+3]<<3,us("multichannel mask read: "+bt(e),i),e},Dt.prototype.port_mode_write=function(t,e){us("mode write ["+(t=(3&e)+t)+"] = "+bt(e),i),this.channel_mode[t]=e},Dt.prototype.portC_write=function(t){us("flipflop reset",i),this.lsb_msb_flipflop=0},Dt.prototype.on_unmask=function(t,e){this.unmask_listeners.push({fn:t,this_value:e})},Dt.prototype.update_mask=function(t,e){if(this.channel_mask[t]!==e&&(this.channel_mask[t]=e,!e))for(us("firing on_unmask("+t+")",i),e=0;e<this.unmask_listeners.length;e++)this.unmask_listeners[e].fn.call(this.unmask_listeners[e].this_value,t)},Dt.prototype.do_read=function(t,e,s,r,a){var n=this.count_get_8bit(r),o=this.address_get_8bit(r);if(us("DMA write channel "+r,i),us("to "+bt(o)+" len "+bt(n),i),s<n&&us("DMA should read more than provided: "+bt(s)+" "+bt(n),i),e+n>t.byteLength)us("DMA read outside of buffer",i),a(!0);else{var h=this.cpu;this.channel_addr[r]+=n,t.get(e,n,(function(t){h.write_blob(t,o),a(!1)}))}},Dt.prototype.do_write=function(t,e,s,r,a){var n=this.channel_count[r]+1&65535,o=5<=r?2:1,h=n*o,_=this.address_get_8bit(r),d=!1,c=!1,u=16&this.channel_mode[r];us("DMA write channel "+r,i),us("to "+bt(_)+" len "+bt(h),i),s<h?(us("DMA should read more than provided",i),n=Math.floor(s/o),h=n*o,d=!0):s>h&&(us("DMA attempted to read more than provided",i),c=!0),e+h>t.byteLength?(us("DMA write outside of buffer",i),a(!0)):(this.channel_addr[r]+=n,this.channel_count[r]-=n,!d&&u&&(us("DMA autoinit",i),this.channel_addr[r]=this.channel_addr_init[r],this.channel_count[r]=this.channel_count_init[r]),t.set(e,this.cpu.mem8.subarray(_,_+h),(()=>{c&&u?(us("DMA continuing from start",i),this.do_write(t,e+h,s-h,r,a)):a(!1)})))},Dt.prototype.address_get_8bit=function(t){var e=this.channel_addr[t];return 5<=t&&(e<<=1),(e=65535&e|this.channel_page[t]<<16)|this.channel_pagehi[t]<<24},Dt.prototype.count_get_8bit=function(t){var e=this.channel_count[t]+1;return 5<=t&&(e*=2),e},Dt.prototype.flipflop_get=function(t,e,i){return i||(this.lsb_msb_flipflop^=1),this.lsb_msb_flipflop?-256&t|e:-65281&t|e<<8},Dt.prototype.flipflop_read=function(t){return(this.lsb_msb_flipflop^=1)?255&t:t>>8&255};var Tt=1193.1816666;function Ut(t,e){this.cpu=t,this.bus=e,this.counter_start_time=new Float64Array(3),this.counter_start_value=new Uint16Array(3),this.counter_next_low=new Uint8Array(4),this.counter_enabled=new Uint8Array(4),this.counter_mode=new Uint8Array(4),this.counter_read_mode=new Uint8Array(4),this.counter_latch=new Uint8Array(4),this.counter_latch_value=new Uint16Array(3),this.counter_reload=new Uint16Array(3),t.io.register_read(97,this,(function(){var t=mt.microtick();return(66.66666666666667*t&1)<<4|(t=this.did_rollover(2,t))<<5})),t.io.register_write(97,this,(function(t){1&t?this.bus.send("pcspeaker-enable"):this.bus.send("pcspeaker-disable")})),t.io.register_read(64,this,(function(){return this.counter_read(0)})),t.io.register_read(65,this,(function(){return this.counter_read(1)})),t.io.register_read(66,this,(function(){return this.counter_read(2)})),t.io.register_write(64,this,(function(t){this.counter_write(0,t)})),t.io.register_write(65,this,(function(t){this.counter_write(1,t)})),t.io.register_write(66,this,(function(t){this.counter_write(2,t),this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])})),t.io.register_write(67,this,this.port43_write)}Ut.prototype.get_state=function(){var t=[];return t[0]=this.counter_next_low,t[1]=this.counter_enabled,t[2]=this.counter_mode,t[3]=this.counter_read_mode,t[4]=this.counter_latch,t[5]=this.counter_latch_value,t[6]=this.counter_reload,t[7]=this.counter_start_time,t[8]=this.counter_start_value,t},Ut.prototype.set_state=function(t){this.counter_next_low=t[0],this.counter_enabled=t[1],this.counter_mode=t[2],this.counter_read_mode=t[3],this.counter_latch=t[4],this.counter_latch_value=t[5],this.counter_reload=t[6],this.counter_start_time=t[7],this.counter_start_value=t[8]},Ut.prototype.timer=function(t,e){var i=100;return e||(this.counter_enabled[0]&&this.did_rollover(0,t)?(this.counter_start_value[0]=this.get_counter_value(0,t),this.counter_start_time[0]=t,us("pit interrupt. new value: "+this.counter_start_value[0],o),this.cpu.device_lower_irq(0),this.cpu.device_raise_irq(0),0===this.counter_mode[0]&&(this.counter_enabled[0]=0)):this.cpu.device_lower_irq(0),this.counter_enabled[0]&&(i=(this.counter_start_value[0]-Math.floor((t-this.counter_start_time[0])*Tt))/Tt)),i},Ut.prototype.get_counter_value=function(t,e){if(!this.counter_enabled[t])return 0;var i=e-this.counter_start_time[t],s=Math.floor(i*Tt);return e=this.counter_start_value[t]-s,us("diff="+i+" dticks="+s+" value="+e+" reload="+this.counter_reload[t],o),e>=(i=this.counter_reload[t])?(us("Warning: Counter"+t+" value "+e+" is larger than reload "+i,o),e%=i):0>e&&(e=e%i+i),e},Ut.prototype.did_rollover=function(t,e){return 0>(e-=this.counter_start_time[t])?(us("Warning: PIT timer difference is negative, resetting (timer "+t+")"),!0):this.counter_start_value[t]<Math.floor(e*Tt)},Ut.prototype.counter_read=function(t){var e=this.counter_latch[t];return e?(this.counter_latch[t]--,2===e?255&this.counter_latch_value[t]:this.counter_latch_value[t]>>8):(e=this.counter_next_low[t],3===this.counter_mode[t]&&(this.counter_next_low[t]^=1),t=this.get_counter_value(t,mt.microtick()),e?255&t:t>>8)},Ut.prototype.counter_write=function(t,e){this.counter_reload[t]=this.counter_next_low[t]?-256&this.counter_reload[t]|e:255&this.counter_reload[t]|e<<8,3===this.counter_read_mode[t]&&this.counter_next_low[t]||(this.counter_reload[t]||(this.counter_reload[t]=65535),this.counter_start_value[t]=this.counter_reload[t],this.counter_enabled[t]=!0,this.counter_start_time[t]=mt.microtick(),us("counter"+t+" reload="+bt(this.counter_reload[t])+" tick="+(this.counter_reload[t]||65536)/Tt+"ms",o)),3===this.counter_read_mode[t]&&(this.counter_next_low[t]^=1)},Ut.prototype.port43_write=function(t){var e=t>>1&7,i=1&t,s=t>>6&3;t=t>>4&3,1===s&&us("Unimplemented timer1",o),3===s?us("Unimplemented read back",o):0===t?(this.counter_latch[s]=2,e=this.get_counter_value(s,mt.microtick()),us("latch: "+e,o),this.counter_latch_value[s]=e?e-1:0):(6<=e&&(e&=-5),us("Control: mode="+e+" ctr="+s+" read_mode="+t+" bcd="+i,o),this.counter_next_low[s]=1===t?0:1,0===s&&this.cpu.device_lower_irq(0),0!==e&&3!==e&&2!==e&&us("Unimplemented counter mode: "+bt(e),o),this.counter_mode[s]=e,this.counter_read_mode[s]=t,2===s&&this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]]))},Ut.prototype.dump=function(){const t=this.counter_reload[0];us("counter0 ticks every "+(t||65536)/Tt+"ms (reload="+t+")")};var Ot=65536,Pt=2560,Lt=1600,Mt=3758096384,Ft=8*Ot,Nt=4*Ot,Bt=Uint32Array.from([655360,655360,720896,753664]),Wt=Uint32Array.from([131072,65536,32768,32768]);function Gt(t,e,i){this.cpu=t,this.bus=e,this.vga_memory_size=i,this.cursor_address=0,this.cursor_scanline_start=14,this.cursor_scanline_end=15,this.max_cols=80,this.max_rows=25,this.virtual_height=this.virtual_width=this.screen_height=this.screen_width=0,this.layers=[],this.start_address_latched=this.start_address=0,this.crtc=new Uint8Array(25),this.line_compare=this.offset_register=this.preset_row_scan=this.underline_location_register=this.vertical_blank_start=this.vertical_display_enable_end=this.horizontal_blank_start=this.horizontal_display_enable_end=this.crtc_mode=0,this.graphical_mode_is_linear=!0,this.graphical_mode=!1,setTimeout((()=>{e.send("screen-set-mode",this.graphical_mode)}),0),this.vga256_palette=new Int32Array(256),this.latch_dword=0,this.svga_version=45253,this.svga_height=this.svga_width=0,this.svga_enabled=!1,this.svga_bpp=32,this.svga_offset=this.svga_bank_offset=0,this.pci_space=[52,18,17,17,3,1,0,0,0,0,0,3,0,0,0,0,8,Mt>>>8,Mt>>>16,Mt>>>24,0,0,0,0,0,0,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,190,254,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_id=144,this.pci_bars=[{size:i}],this.pci_rom_size=65536,this.pci_rom_address=4272947200,this.name="vga",this.stats={is_graphical:!1,res_x:0,res_y:0,bpp:0},this.dac_state=this.dac_color_index_read=this.dac_color_index_write=this.index_crtc=0,this.dac_mask=255,this.dac_map=new Uint8Array(16),this.attribute_controller_index=-1,this.palette_source=32,this.color_select=this.horizontal_panning=this.color_plane_enable=this.attribute_mode=0,this.sequencer_index=-1,this.plane_write_bm=15,this.clocking_mode=this.sequencer_memory_mode=0,this.graphics_index=-1,this.planar_rotate_reg=this.planar_mode=this.plane_read=0,this.planar_bitmap=255,this.max_scan_line=this.color_dont_care=this.color_compare=this.miscellaneous_graphics_register=this.planar_setreset_enable=this.planar_setreset=0,this.port_3DA_value=this.miscellaneous_output_register=255,(i=t.io).register_write(960,this,this.port3C0_write),i.register_read(960,this,this.port3C0_read,this.port3C0_read16),i.register_read(961,this,this.port3C1_read),i.register_write(962,this,this.port3C2_write),i.register_write_consecutive(964,this,this.port3C4_write,this.port3C5_write),i.register_read(964,this,this.port3C4_read),i.register_read(965,this,this.port3C5_read),i.register_write_consecutive(974,this,this.port3CE_write,this.port3CF_write),i.register_read(974,this,this.port3CE_read),i.register_read(975,this,this.port3CF_read),i.register_read(966,this,this.port3C6_read),i.register_write(966,this,this.port3C6_write),i.register_write(967,this,this.port3C7_write),i.register_read(967,this,this.port3C7_read),i.register_write(968,this,this.port3C8_write),i.register_read(968,this,this.port3C8_read),i.register_write(969,this,this.port3C9_write),i.register_read(969,this,this.port3C9_read),i.register_read(972,this,this.port3CC_read),i.register_write_consecutive(980,this,this.port3D4_write,this.port3D5_write),i.register_read(980,this,this.port3D4_read),i.register_read(981,this,this.port3D5_read,(()=>(us("Warning: 16-bit read from 3D5",n),this.port3D5_read()))),i.register_read(970,this,(function(){return us("3CA read",n),0})),i.register_read(986,this,this.port3DA_read),i.register_read(954,this,this.port3DA_read),this.dispi_index=-1,this.dispi_enable_value=0,i.register_write(462,this,void 0,this.port1CE_write),i.register_write(463,this,void 0,this.port1CF_write),i.register_read(463,this,void 0,this.port1CF_read),void 0===this.vga_memory_size||this.vga_memory_size<Nt?(this.vga_memory_size=Nt,us("vga memory size rounded up to "+this.vga_memory_size,n)):this.vga_memory_size&Ot-1&&(this.vga_memory_size|=Ot-1,this.vga_memory_size++);const s=t.svga_allocate_memory(this.vga_memory_size);this.svga_memory=yt.view(Uint8Array,t.wasm_memory,s,this.vga_memory_size),this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0,this.image_data=null,e.register("screen-fill-buffer",(function(){this.screen_fill_buffer()}),this),this.vga_memory=new Uint8Array(4*Ot),this.plane0=new Uint8Array(this.vga_memory.buffer,0*Ot,Ot),this.plane1=new Uint8Array(this.vga_memory.buffer,1*Ot,Ot),this.plane2=new Uint8Array(this.vga_memory.buffer,2*Ot,Ot),this.plane3=new Uint8Array(this.vga_memory.buffer,3*Ot,Ot),this.pixel_buffer=new Uint8Array(Ft);var r=this;i.mmap_register(655360,131072,(function(t){return r.vga_memory_read(t)}),(function(t,e){r.vga_memory_write(t,e)})),t.devices.pci.register_device(this)}Gt.prototype.get_state=function(){var t=[];return t[0]=this.vga_memory_size,t[1]=this.cursor_address,t[2]=this.cursor_scanline_start,t[3]=this.cursor_scanline_end,t[4]=this.max_cols,t[5]=this.max_rows,t[6]=this.vga_memory,t[7]=this.dac_state,t[8]=this.start_address,t[9]=this.graphical_mode,t[10]=this.vga256_palette,t[11]=this.latch_dword,t[12]=this.color_compare,t[13]=this.color_dont_care,t[14]=this.miscellaneous_graphics_register,t[15]=this.svga_width,t[16]=this.svga_height,t[17]=this.crtc_mode,t[18]=this.svga_enabled,t[19]=this.svga_bpp,t[20]=this.svga_bank_offset,t[21]=this.svga_offset,t[22]=this.index_crtc,t[23]=this.dac_color_index_write,t[24]=this.dac_color_index_read,t[25]=this.dac_map,t[26]=this.sequencer_index,t[27]=this.plane_write_bm,t[28]=this.sequencer_memory_mode,t[29]=this.graphics_index,t[30]=this.plane_read,t[31]=this.planar_mode,t[32]=this.planar_rotate_reg,t[33]=this.planar_bitmap,t[34]=this.max_scan_line,t[35]=this.miscellaneous_output_register,t[36]=this.port_3DA_value,t[37]=this.dispi_index,t[38]=this.dispi_enable_value,t[39]=this.svga_memory,t[40]=this.graphical_mode_is_linear,t[41]=this.attribute_controller_index,t[42]=this.offset_register,t[43]=this.planar_setreset,t[44]=this.planar_setreset_enable,t[45]=this.start_address_latched,t[46]=this.crtc,t[47]=this.horizontal_display_enable_end,t[48]=this.horizontal_blank_start,t[49]=this.vertical_display_enable_end,t[50]=this.vertical_blank_start,t[51]=this.underline_location_register,t[52]=this.preset_row_scan,t[53]=this.offset_register,t[54]=this.palette_source,t[55]=this.attribute_mode,t[56]=this.color_plane_enable,t[57]=this.horizontal_panning,t[58]=this.color_select,t[59]=this.clocking_mode,t[60]=this.line_compare,t[61]=this.pixel_buffer,t[62]=this.dac_mask,t},Gt.prototype.set_state=function(t){this.vga_memory_size=t[0],this.cursor_address=t[1],this.cursor_scanline_start=t[2],this.cursor_scanline_end=t[3],this.max_cols=t[4],this.max_rows=t[5],t[6]&&this.vga_memory.set(t[6]),this.dac_state=t[7],this.start_address=t[8],this.graphical_mode=t[9],this.vga256_palette=t[10],this.latch_dword=t[11],this.color_compare=t[12],this.color_dont_care=t[13],this.miscellaneous_graphics_register=t[14],this.svga_width=t[15],this.svga_height=t[16],this.crtc_mode=t[17],this.svga_enabled=t[18],this.svga_bpp=t[19],this.svga_bank_offset=t[20],this.svga_offset=t[21],this.index_crtc=t[22],this.dac_color_index_write=t[23],this.dac_color_index_read=t[24],this.dac_map=t[25],this.sequencer_index=t[26],this.plane_write_bm=t[27],this.sequencer_memory_mode=t[28],this.graphics_index=t[29],this.plane_read=t[30],this.planar_mode=t[31],this.planar_rotate_reg=t[32],this.planar_bitmap=t[33],this.max_scan_line=t[34],this.miscellaneous_output_register=t[35],this.port_3DA_value=t[36],this.dispi_index=t[37],this.dispi_enable_value=t[38],this.svga_memory.set(t[39]),this.graphical_mode_is_linear=t[40],this.attribute_controller_index=t[41],this.offset_register=t[42],this.planar_setreset=t[43],this.planar_setreset_enable=t[44],this.start_address_latched=t[45],this.crtc.set(t[46]),this.horizontal_display_enable_end=t[47],this.horizontal_blank_start=t[48],this.vertical_display_enable_end=t[49],this.vertical_blank_start=t[50],this.underline_location_register=t[51],this.preset_row_scan=t[52],this.offset_register=t[53],this.palette_source=t[54],this.attribute_mode=t[55],this.color_plane_enable=t[56],this.horizontal_panning=t[57],this.color_select=t[58],this.clocking_mode=t[59],this.line_compare=t[60],t[61]&&this.pixel_buffer.set(t[61]),this.dac_mask=void 0===t[62]?255:t[62],this.bus.send("screen-set-mode",this.graphical_mode),this.graphical_mode?(this.screen_height=this.screen_width=0,this.svga_enabled?(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.update_layers()):(this.update_vga_size(),this.update_layers(),this.complete_replot())):(this.set_size_text(this.max_cols,this.max_rows),this.update_cursor_scanline(),this.update_cursor()),this.complete_redraw()},Gt.prototype.vga_memory_read=function(t){if(this.svga_enabled&&this.graphical_mode_is_linear)return this.cpu.read8((t-655360|this.svga_bank_offset)+Mt|0);var e=this.miscellaneous_graphics_register>>2&3;return 0>(t-=Bt[e])||t>=Wt[e]?(us("vga read outside memory space: addr:"+bt(t),n),0):(this.latch_dword=this.plane0[t],this.latch_dword|=this.plane1[t]<<8,this.latch_dword|=this.plane2[t]<<16,this.latch_dword|=this.plane3[t]<<24,8&this.planar_mode?(e=255,1&this.color_dont_care&&(e&=this.plane0[t]^~(1&this.color_compare?255:0)),2&this.color_dont_care&&(e&=this.plane1[t]^~(2&this.color_compare?255:0)),4&this.color_dont_care&&(e&=this.plane2[t]^~(4&this.color_compare?255:0)),8&this.color_dont_care&&(e&=this.plane3[t]^~(8&this.color_compare?255:0)),e):(e=this.plane_read,this.graphical_mode?8&this.sequencer_memory_mode?(e=3&t,t&=-4):16&this.planar_mode&&(e=1&t,t&=-2):e=0,this.vga_memory[e<<16|t]))},Gt.prototype.vga_memory_write=function(t,e){if(this.svga_enabled&&this.graphical_mode&&this.graphical_mode_is_linear)this.cpu.write8((t-655360|this.svga_bank_offset)+Mt|0,e);else{var i=this.miscellaneous_graphics_register>>2&3;0>(t-=Bt[i])||t>=Wt[i]?us("vga write outside memory space: addr:"+bt(t)+", value:"+bt(e),n):this.graphical_mode?this.vga_memory_write_graphical(t,e):3&this.plane_write_bm&&this.vga_memory_write_text_mode(t,e)}},Gt.prototype.vga_memory_write_graphical=function(t,e){var i=3&this.planar_mode,s=this.apply_feed(this.planar_bitmap),r=this.apply_expand(this.planar_setreset),a=this.apply_expand(this.planar_setreset_enable);switch(i){case 0:e=this.apply_rotate(e);var n=this.apply_feed(e);n=this.apply_setreset(n,a),n=this.apply_logical(n,this.latch_dword),n=this.apply_bitmask(n,s);break;case 1:n=this.latch_dword;break;case 2:n=this.apply_expand(e),n=this.apply_logical(n,this.latch_dword),n=this.apply_bitmask(n,s);break;case 3:e=this.apply_rotate(e),s&=this.apply_feed(e),n=this.apply_bitmask(r,s)}switch(e=15,12&this.sequencer_memory_mode){case 0:e=5<<(1&t),t&=-2;break;case 8:case 12:e=1<<(3&t),t&=-4}1&(e&=this.plane_write_bm)&&(this.plane0[t]=n>>0&255),2&e&&(this.plane1[t]=n>>8&255),4&e&&(this.plane2[t]=n>>16&255),8&e&&(this.plane3[t]=n>>24&255),t=this.vga_addr_to_pixel(t),this.partial_replot(t,t+7)},Gt.prototype.apply_feed=function(t){return t|t<<8|t<<16|t<<24},Gt.prototype.apply_expand=function(t){return(1&t?255:0)|(2&t?255:0)<<8|(4&t?255:0)<<16|(8&t?255:0)<<24},Gt.prototype.apply_rotate=function(t){return(t|t<<8)>>>(7&this.planar_rotate_reg)&255},Gt.prototype.apply_setreset=function(t,e){var i=this.apply_expand(this.planar_setreset);return(t|e&i)&(~e|i)},Gt.prototype.apply_logical=function(t,e){switch(24&this.planar_rotate_reg){case 8:return t&e;case 16:return t|e;case 24:return t^e}return t},Gt.prototype.apply_bitmask=function(t,e){return e&t|~e&this.latch_dword},Gt.prototype.text_mode_redraw=function(){for(var t,e,i=this.start_address<<1,s=0;s<this.max_rows;s++)for(var r=0;r<this.max_cols;r++)t=this.vga_memory[i],e=this.vga_memory[1|i],this.bus.send("screen-put-char",[s,r,t,this.vga256_palette[this.dac_mask&this.dac_map[e>>4&15]],this.vga256_palette[this.dac_mask&this.dac_map[15&e]]]),i+=2},Gt.prototype.vga_memory_write_text_mode=function(t,e){var i=(t>>1)-this.start_address,s=i/this.max_cols|0;if(i%=this.max_cols,1&t)var r=e,a=this.vga_memory[-2&t];else a=e,r=this.vga_memory[1|t];this.bus.send("screen-put-char",[s,i,a,this.vga256_palette[this.dac_mask&this.dac_map[r>>4&15]],this.vga256_palette[this.dac_mask&this.dac_map[15&r]]]),this.vga_memory[t]=e},Gt.prototype.update_cursor=function(){var t=(this.cursor_address-this.start_address)/this.max_cols|0,e=(this.cursor_address-this.start_address)%this.max_cols;t=Math.min(this.max_rows-1,t),this.bus.send("screen-update-cursor",[t,e])},Gt.prototype.complete_redraw=function(){us("complete redraw",n),this.graphical_mode?this.svga_enabled?this.cpu.svga_mark_dirty():(this.diff_addr_min=0,this.diff_addr_max=Ft):this.text_mode_redraw()},Gt.prototype.complete_replot=function(){us("complete replot",n),this.graphical_mode&&!this.svga_enabled&&(this.diff_plot_min=0,this.diff_plot_max=Ft,this.complete_redraw())},Gt.prototype.partial_redraw=function(t,e){t<this.diff_addr_min&&(this.diff_addr_min=t),e>this.diff_addr_max&&(this.diff_addr_max=e)},Gt.prototype.partial_replot=function(t,e){t<this.diff_plot_min&&(this.diff_plot_min=t),e>this.diff_plot_max&&(this.diff_plot_max=e),this.partial_redraw(t,e)},Gt.prototype.reset_diffs=function(){this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0},Gt.prototype.destroy=function(){},Gt.prototype.vga_bytes_per_line=function(){var t=this.offset_register<<2;return 64&this.underline_location_register?t<<=1:64&this.crtc_mode&&(t>>>=1),t},Gt.prototype.vga_addr_shift_count=function(){var t=128+(~this.underline_location_register&this.crtc_mode&64);return t-=64&this.underline_location_register,(t-=64&this.attribute_mode)>>>6},Gt.prototype.vga_addr_to_pixel=function(t){var e=this.vga_addr_shift_count();if(3&~this.crtc_mode){var i=t-this.start_address;i&=this.crtc_mode<<13|-24577;var s=(i<<=e)/this.virtual_width|0;switch(i%=this.virtual_width,3&this.crtc_mode){case 2:s=s<<1|t>>13&1;break;case 1:s=s<<1|t>>14&1;break;case 0:s=s<<2|t>>13&3}return s*this.virtual_width+i+(this.start_address<<e)}return t<<e},Gt.prototype.scan_line_to_screen_row=function(t){return 128&this.max_scan_line&&(t>>>=1),t=Math.ceil(t/(1+(31&this.max_scan_line))),1&this.crtc_mode||(t<<=1),2&this.crtc_mode||(t<<=1),t},Gt.prototype.set_size_text=function(t,e){this.max_cols=t,this.max_rows=e,this.bus.send("screen-set-size-text",[t,e])},Gt.prototype.set_size_graphical=function(t,e,i,s,r){if(!this.stats.is_graphical||this.stats.bpp!==i||this.screen_width!==t||this.screen_height!==e||this.virtual_width!==s||this.virtual_height!==r){if(this.screen_width=t,this.screen_height=e,this.virtual_width=s,this.virtual_height=r,this.stats.bpp=i,this.stats.is_graphical=!0,this.stats.res_x=t,this.stats.res_y=e,"undefined"!=typeof ImageData){const t=s*r,e=this.cpu.svga_allocate_dest_buffer(t)>>>0;this.dest_buffet_offset=e,this.image_data=new ImageData(new Uint8ClampedArray(this.cpu.wasm_memory.buffer,e,4*t),s,r),this.cpu.svga_mark_dirty()}this.bus.send("screen-set-size-graphical",[t,e,s,r,i])}},Gt.prototype.update_vga_size=function(){if(!this.svga_enabled){var t=Math.min(1+this.horizontal_display_enable_end,this.horizontal_blank_start),e=Math.min(1+this.vertical_display_enable_end,this.vertical_blank_start);if(t&&e)if(this.graphical_mode){t<<=3;var i=this.offset_register<<4;64&this.attribute_mode&&(t>>>=1,i>>>=1),e=this.scan_line_to_screen_row(e);var s=Math.ceil(Wt[0]/this.vga_bytes_per_line());this.set_size_graphical(t,e,8,i,s),this.update_vertical_retrace(),this.update_layers()}else 128&this.max_scan_line&&(e>>>=1),i=e/(1+(31&this.max_scan_line))|0,t&&i&&this.set_size_text(t,i)}},Gt.prototype.update_layers=function(){if(this.graphical_mode||this.text_mode_redraw(),this.svga_enabled)this.layers=[];else if(this.virtual_width&&this.screen_width)if(!this.palette_source||32&this.clocking_mode)this.layers=[],this.bus.send("screen-clear");else{var t=this.start_address_latched,e=this.horizontal_panning;64&this.attribute_mode&&(e>>>=1);var i=this.preset_row_scan>>5&3,s=this.vga_addr_to_pixel(t+i);t=s/this.virtual_width|0;var r=s%this.virtual_width+e;s=this.scan_line_to_screen_row(1+this.line_compare),s=Math.min(s,this.screen_height);var a=this.screen_height-s;this.layers=[],r=-r;for(var n=0;r<this.screen_width;r+=this.virtual_width,n++)this.layers.push({image_data:this.image_data,screen_x:r,screen_y:0,buffer_x:0,buffer_y:t+n,buffer_width:this.virtual_width,buffer_height:s});for(t=0,32&this.attribute_mode||(t=this.vga_addr_to_pixel(i)+e),r=-t,n=0;r<this.screen_width;r+=this.virtual_width,n++)this.layers.push({image_data:this.image_data,screen_x:r,screen_y:s,buffer_x:0,buffer_y:n,buffer_width:this.virtual_width,buffer_height:a})}},Gt.prototype.update_vertical_retrace=function(){this.port_3DA_value|=8,this.start_address_latched!==this.start_address&&(this.start_address_latched=this.start_address,this.update_layers())},Gt.prototype.update_cursor_scanline=function(){this.bus.send("screen-update-cursor-scanline",[this.cursor_scanline_start,this.cursor_scanline_end])},Gt.prototype.port3C0_write=function(t){if(-1===this.attribute_controller_index)us("attribute controller index register: "+bt(t),n),this.attribute_controller_index=31&t,us("attribute actual index: "+bt(this.attribute_controller_index),n),this.palette_source!==(32&t)&&(this.palette_source=32&t,this.update_layers());else{if(16>this.attribute_controller_index)us("internal palette: "+bt(this.attribute_controller_index)+" -> "+bt(t),n),this.dac_map[this.attribute_controller_index]=t,64&this.attribute_mode||this.complete_redraw();else switch(this.attribute_controller_index){case 16:if(us("3C0 / attribute mode control: "+bt(t),n),this.attribute_mode!==t){var e=this.attribute_mode;this.attribute_mode=t;var i=0<(1&t);this.svga_enabled||this.graphical_mode===i||(this.graphical_mode=i,this.bus.send("screen-set-mode",this.graphical_mode)),64&(e^t)&&this.complete_replot(),this.update_vga_size(),this.complete_redraw()}break;case 18:us("3C0 / color plane enable: "+bt(t),n),this.color_plane_enable!==t&&(this.color_plane_enable=t,this.complete_redraw());break;case 19:us("3C0 / horizontal panning: "+bt(t),n),this.horizontal_panning!==t&&(this.horizontal_panning=15&t,this.update_layers());break;case 20:us("3C0 / color select: "+bt(t),n),this.color_select!==t&&(this.color_select=t,this.complete_redraw());break;default:us("3C0 / attribute controller write "+bt(this.attribute_controller_index)+": "+bt(t),n)}this.attribute_controller_index=-1}},Gt.prototype.port3C0_read=function(){return us("3C0 read",n),this.attribute_controller_index|this.palette_source},Gt.prototype.port3C0_read16=function(){return us("3C0 read16",n),255&this.port3C0_read()|this.port3C1_read()<<8&65280},Gt.prototype.port3C1_read=function(){if(16>this.attribute_controller_index)return us("3C1 / internal palette read: "+bt(this.attribute_controller_index)+" -> "+bt(this.dac_map[this.attribute_controller_index]),n),255&this.dac_map[this.attribute_controller_index];switch(this.attribute_controller_index){case 16:return us("3C1 / attribute mode read: "+bt(this.attribute_mode),n),this.attribute_mode;case 18:return us("3C1 / color plane enable read: "+bt(this.color_plane_enable),n),this.color_plane_enable;case 19:return us("3C1 / horizontal panning read: "+bt(this.horizontal_panning),n),this.horizontal_panning;case 20:return us("3C1 / color select read: "+bt(this.color_select),n),this.color_select;default:us("3C1 / attribute controller read "+bt(this.attribute_controller_index),n)}return 255},Gt.prototype.port3C2_write=function(t){us("3C2 / miscellaneous output register = "+bt(t),n),this.miscellaneous_output_register=t},Gt.prototype.port3C4_write=function(t){this.sequencer_index=t},Gt.prototype.port3C4_read=function(){return this.sequencer_index},Gt.prototype.port3C5_write=function(t){switch(this.sequencer_index){case 1:us("clocking mode: "+bt(t),n);var e=this.clocking_mode;this.clocking_mode=t,32&(e^t)&&this.update_layers();break;case 2:us("plane write mask: "+bt(t),n),this.plane_write_bm=t;break;case 4:us("sequencer memory mode: "+bt(t),n),this.sequencer_memory_mode=t;break;default:us("3C5 / sequencer write "+bt(this.sequencer_index)+": "+bt(t),n)}},Gt.prototype.port3C5_read=function(){switch(us("3C5 / sequencer read "+bt(this.sequencer_index),n),this.sequencer_index){case 1:return this.clocking_mode;case 2:return this.plane_write_bm;case 4:return this.sequencer_memory_mode;case 6:return 18}return 0},Gt.prototype.port3C6_write=function(t){this.dac_mask=t},Gt.prototype.port3C6_read=function(){return this.dac_mask},Gt.prototype.port3C7_write=function(t){us("3C7 write: "+bt(t),n),this.dac_color_index_read=3*t,this.dac_state&=0},Gt.prototype.port3C7_read=function(){return this.dac_state},Gt.prototype.port3C8_write=function(t){this.dac_color_index_write=3*t,this.dac_state|=3},Gt.prototype.port3C8_read=function(){return this.dac_color_index_write/3&255},Gt.prototype.port3C9_write=function(t){var e=this.dac_color_index_write/3|0,i=this.dac_color_index_write%3,s=this.vga256_palette[e];if(0==(32&this.dispi_enable_value)){const e=1&(t&=63);t=t<<2|e<<1|e}0===i?s=-16711681&s|t<<16:1===i?s=-65281&s|t<<8:(s=-256&s|t,us("dac set color, index="+bt(e)+" value="+bt(s),n)),this.vga256_palette[e]!==s&&(this.vga256_palette[e]=s,this.complete_redraw()),this.dac_color_index_write++},Gt.prototype.port3C9_read=function(){us("3C9 read",n);var t=this.vga256_palette[this.dac_color_index_read/3|0]>>8*(2-this.dac_color_index_read%3)&255;return this.dac_color_index_read++,32&this.dispi_enable_value?t:t>>2},Gt.prototype.port3CC_read=function(){return us("3CC read",n),this.miscellaneous_output_register},Gt.prototype.port3CE_write=function(t){this.graphics_index=t},Gt.prototype.port3CE_read=function(){return this.graphics_index},Gt.prototype.port3CF_write=function(t){switch(this.graphics_index){case 0:this.planar_setreset=t,us("plane set/reset: "+bt(t),n);break;case 1:this.planar_setreset_enable=t,us("plane set/reset enable: "+bt(t),n);break;case 2:this.color_compare=t,us("color compare: "+bt(t),n);break;case 3:this.planar_rotate_reg=t,us("plane rotate: "+bt(t),n);break;case 4:this.plane_read=t,us("plane read: "+bt(t),n);break;case 5:var e=this.planar_mode;this.planar_mode=t,us("planar mode: "+bt(t),n),96&(e^t)&&this.complete_replot();break;case 6:us("miscellaneous graphics register: "+bt(t),n),this.miscellaneous_graphics_register!==t&&(this.miscellaneous_graphics_register=t,this.update_vga_size());break;case 7:this.color_dont_care=t,us("color don't care: "+bt(t),n);break;case 8:this.planar_bitmap=t,us("planar bitmap: "+bt(t),n);break;default:us("3CF / graphics write "+bt(this.graphics_index)+": "+bt(t),n)}},Gt.prototype.port3CF_read=function(){switch(us("3CF / graphics read "+bt(this.graphics_index),n),this.graphics_index){case 0:return this.planar_setreset;case 1:return this.planar_setreset_enable;case 2:return this.color_compare;case 3:return this.planar_rotate_reg;case 4:return this.plane_read;case 5:return this.planar_mode;case 6:return this.miscellaneous_graphics_register;case 7:return this.color_dont_care;case 8:return this.planar_bitmap}return 0},Gt.prototype.port3D4_write=function(t){us("3D4 / crtc index: "+t,n),this.index_crtc=t},Gt.prototype.port3D4_read=function(){return us("3D4 read / crtc index: "+this.index_crtc,n),this.index_crtc},Gt.prototype.port3D5_write=function(t){switch(this.index_crtc){case 1:us("3D5 / hdisp enable end write: "+bt(t),n),this.horizontal_display_enable_end!==t&&(this.horizontal_display_enable_end=t,this.update_vga_size());break;case 2:this.horizontal_blank_start!==t&&(this.horizontal_blank_start=t,this.update_vga_size());break;case 7:us("3D5 / overflow register write: "+bt(t),n);var e=this.vertical_display_enable_end;this.vertical_display_enable_end&=255,this.vertical_display_enable_end=this.vertical_display_enable_end|t<<3&512|t<<7&256,e!=this.vertical_display_enable_end&&this.update_vga_size(),this.line_compare=767&this.line_compare|t<<4&256,e=this.vertical_blank_start,this.vertical_blank_start=767&this.vertical_blank_start|t<<5&256,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 8:us("3D5 / preset row scan write: "+bt(t),n),this.preset_row_scan=t,this.update_layers();break;case 9:us("3D5 / max scan line write: "+bt(t),n),this.max_scan_line=t,this.line_compare=511&this.line_compare|t<<3&512,e=this.vertical_blank_start,this.vertical_blank_start=511&this.vertical_blank_start|t<<4&512,e!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 10:us("3D5 / cursor scanline start write: "+bt(t),n),this.cursor_scanline_start=t,this.update_cursor_scanline();break;case 11:us("3D5 / cursor scanline end write: "+bt(t),n),this.cursor_scanline_end=t,this.update_cursor_scanline();break;case 12:(this.start_address>>8&255)!==t&&(this.start_address=255&this.start_address|t<<8,this.update_layers(),3&~this.crtc_mode&&this.complete_replot()),us("3D5 / start addr hi write: "+bt(t)+" -> "+bt(this.start_address,4),n);break;case 13:(255&this.start_address)!==t&&(this.start_address=65280&this.start_address|t,this.update_layers(),3&~this.crtc_mode&&this.complete_replot()),us("3D5 / start addr lo write: "+bt(t)+" -> "+bt(this.start_address,4),n);break;case 14:us("3D5 / cursor address hi write: "+bt(t),n),this.cursor_address=255&this.cursor_address|t<<8,this.update_cursor();break;case 15:us("3D5 / cursor address lo write: "+bt(t),n),this.cursor_address=65280&this.cursor_address|t,this.update_cursor();break;case 18:us("3D5 / vdisp enable end write: "+bt(t),n),(255&this.vertical_display_enable_end)!==t&&(this.vertical_display_enable_end=768&this.vertical_display_enable_end|t,this.update_vga_size());break;case 19:us("3D5 / offset register write: "+bt(t),n),this.offset_register!==t&&(this.offset_register=t,this.update_vga_size(),3&~this.crtc_mode&&this.complete_replot());break;case 20:us("3D5 / underline location write: "+bt(t),n),this.underline_location_register!==t&&(e=this.underline_location_register,this.underline_location_register=t,this.update_vga_size(),64&(e^t)&&this.complete_replot());break;case 21:us("3D5 / vertical blank start write: "+bt(t),n),(255&this.vertical_blank_start)!==t&&(this.vertical_blank_start=768&this.vertical_blank_start|t,this.update_vga_size());break;case 23:us("3D5 / crtc mode write: "+bt(t),n),this.crtc_mode!==t&&(e=this.crtc_mode,this.crtc_mode=t,this.update_vga_size(),67&(e^t)&&this.complete_replot());break;case 24:us("3D5 / line compare write: "+bt(t),n),this.line_compare=768&this.line_compare|t,this.update_layers();break;default:this.index_crtc<this.crtc.length&&(this.crtc[this.index_crtc]=t),us("3D5 / CRTC write "+bt(this.index_crtc)+": "+bt(t),n)}},Gt.prototype.port3D5_read=function(){switch(us("3D5 read "+bt(this.index_crtc),n),this.index_crtc){case 1:return this.horizontal_display_enable_end;case 2:return this.horizontal_blank_start;case 7:return this.vertical_display_enable_end>>7&2|this.vertical_blank_start>>5&8|this.line_compare>>4&16|this.vertical_display_enable_end>>3&64;case 8:return this.preset_row_scan;case 9:return this.max_scan_line;case 10:return this.cursor_scanline_start;case 11:return this.cursor_scanline_end;case 12:return 255&this.start_address;case 13:return this.start_address>>8;case 14:return this.cursor_address>>8;case 15:return 255&this.cursor_address;case 18:return 255&this.vertical_display_enable_end;case 19:return this.offset_register;case 20:return this.underline_location_register;case 21:return 255&this.vertical_blank_start;case 23:return this.crtc_mode;case 24:return 255&this.line_compare}return this.index_crtc<this.crtc.length?this.crtc[this.index_crtc]:0},Gt.prototype.port3DA_read=function(){us("3DA read - status 1 and clear attr index",n);var t=this.port_3DA_value;return this.graphical_mode?(this.port_3DA_value^=1,this.port_3DA_value&=1):(1&this.port_3DA_value&&(this.port_3DA_value^=8),this.port_3DA_value^=1),this.attribute_controller_index=-1,t},Gt.prototype.port1CE_write=function(t){this.dispi_index=t},Gt.prototype.port1CF_write=function(t){switch(us("1CF / dispi write "+bt(this.dispi_index)+": "+bt(t),n),this.dispi_index){case 0:45248<=t&&45253>=t?this.svga_version=t:us("Invalid version value: "+bt(t),n);break;case 1:this.svga_width=t,this.svga_width>Pt&&(us("svga_width reduced from "+this.svga_width+" to "+Pt,n),this.svga_width=Pt);break;case 2:this.svga_height=t,this.svga_height>Lt&&(us("svga_height reduced from "+this.svga_height+" to "+Lt,n),this.svga_height=Lt);break;case 3:this.svga_bpp=t;break;case 4:this.svga_enabled=1==(1&t),this.dispi_enable_value=t;break;case 5:us("SVGA bank offset: "+bt(t<<16),n),this.svga_bank_offset=t<<16;break;case 9:const e=t*this.svga_width;us("SVGA offset: "+bt(e)+" y="+bt(t),n),this.svga_offset!==e&&(this.svga_offset=e,this.complete_redraw())}!this.svga_enabled||this.svga_width&&this.svga_height||(us("SVGA: disabled because of invalid width/height: "+this.svga_width+"x"+this.svga_height,n),this.svga_enabled=!1),ls(4!==this.svga_bpp,"unimplemented svga bpp: 4"),ls(4===this.svga_bpp||8===this.svga_bpp||15===this.svga_bpp||16===this.svga_bpp||24===this.svga_bpp||32===this.svga_bpp,"unexpected svga bpp: "+this.svga_bpp),us("SVGA: enabled="+this.svga_enabled+", "+this.svga_width+"x"+this.svga_height+"x"+this.svga_bpp,n),this.svga_enabled&&4===this.dispi_index&&(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.bus.send("screen-set-mode",!0),this.graphical_mode_is_linear=this.graphical_mode=!0),this.svga_enabled||(this.svga_bank_offset=0),this.update_layers()},Gt.prototype.port1CF_read=function(){return us("1CF / dispi read "+bt(this.dispi_index),n),this.svga_register_read(this.dispi_index)},Gt.prototype.svga_register_read=function(t){switch(t){case 0:return this.svga_version;case 1:return 2&this.dispi_enable_value?Pt:this.svga_width;case 2:return 2&this.dispi_enable_value?Lt:this.svga_height;case 3:return 2&this.dispi_enable_value?32:this.svga_bpp;case 4:return this.dispi_enable_value;case 5:return this.svga_bank_offset>>>16;case 6:return this.screen_width?this.screen_width:1;case 8:return 0;case 10:return this.vga_memory_size/Ot|0}return 255},Gt.prototype.vga_replot=function(){for(var t=-16&this.diff_plot_min,e=Math.min(15|this.diff_plot_max,Ft-1),i=this.vga_addr_shift_count(),s=3&~this.crtc_mode,r=96&this.planar_mode,a=64&this.attribute_mode;t<=e;){var n=t>>>i;if(s){var o=t/this.virtual_width|0,h=t-this.virtual_width*o;switch(s){case 1:n=(1&o)<<13,o>>>=1;break;case 2:n=(1&o)<<14,o>>>=1;break;case 3:n=(3&o)<<13,o>>>=2}n|=(o*this.virtual_width+h>>>i)+this.start_address}o=this.plane0[n],h=this.plane1[n];var _=this.plane2[n],d=this.plane3[n];switch(n=new Uint8Array(8),r){case 0:o<<=0,h<<=1,_<<=2,d<<=3;for(var c=7;0<=c;c--)n[7-c]=o>>c&1|h>>c&2|_>>c&4|d>>c&8;break;case 32:n[0]=o>>6&3|_>>4&12,n[1]=o>>4&3|_>>2&12,n[2]=o>>2&3|_>>0&12,n[3]=o>>0&3|_<<2&12,n[4]=h>>6&3|d>>4&12,n[5]=h>>4&3|d>>2&12,n[6]=h>>2&3|d>>0&12,n[7]=h>>0&3|d<<2&12;break;case 64:case 96:n[0]=o>>4&15,n[1]=o>>0&15,n[2]=h>>4&15,n[3]=h>>0&15,n[4]=_>>4&15,n[5]=_>>0&15,n[6]=d>>4&15,n[7]=d>>0&15}if(a)for(o=c=0;4>c;c++,t++,o+=2)this.pixel_buffer[t]=n[o]<<4|n[o+1];else for(c=0;8>c;c++,t++)this.pixel_buffer[t]=n[c]}},Gt.prototype.vga_redraw=function(){var t=this.diff_addr_min,e=Math.min(this.diff_addr_max,Ft-1);const i=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.virtual_width*this.virtual_height);var s=255,r=0;if(128&this.attribute_mode&&(s&=207,r|=this.color_select<<4&48),64&this.attribute_mode)for(;t<=e;t++){var a=this.pixel_buffer[t]&s|r;a=this.vga256_palette[a],i[t]=65280&a|a<<16|a>>16|4278190080}else for(s&=63,r|=this.color_select<<4&192;t<=e;t++)a=this.dac_map[this.pixel_buffer[t]&this.color_plane_enable]&s|r,a=this.vga256_palette[a],i[t]=65280&a|a<<16|a>>16|4278190080},Gt.prototype.screen_fill_buffer=function(){if(this.graphical_mode){if(0===this.image_data.data.byteLength){var t=new Uint8ClampedArray(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,4*this.virtual_width*this.virtual_height);this.image_data=new ImageData(t,this.virtual_width,this.virtual_height),this.update_layers()}if(this.svga_enabled){t=0;let s=this.svga_height;if(8===this.svga_bpp){const t=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.screen_width*this.screen_height),s=new Uint8Array(this.cpu.wasm_memory.buffer,this.svga_memory.byteOffset,this.vga_memory_size);for(var e=0;e<t.length;e++){var i=this.vga256_palette[s[e]];t[e]=65280&i|i<<16|i>>16|4278190080}}else this.cpu.svga_fill_pixel_buffer(this.svga_bpp,this.svga_offset),e=15===this.svga_bpp?2:this.svga_bpp/8,t=((this.cpu.svga_dirty_bitmap_min_offset[0]/e|0)-this.svga_offset)/this.svga_width|0,s=1+(((this.cpu.svga_dirty_bitmap_max_offset[0]/e|0)-this.svga_offset)/this.svga_width|0);t<s&&(t=Math.max(t,0),s=Math.min(s,this.svga_height),this.bus.send("screen-fill-buffer-end",[{image_data:this.image_data,screen_x:0,screen_y:t,buffer_x:0,buffer_y:t,buffer_width:this.svga_width,buffer_height:s-t}]))}else this.vga_replot(),this.vga_redraw(),this.bus.send("screen-fill-buffer-end",this.layers);this.reset_diffs()}this.update_vertical_retrace()};function jt(t,e){this.cpu=t,this.bus=e,this.use_mouse=this.enable_mouse_stream=!1,this.have_mouse=!0,this.mouse_clicks=this.mouse_delta_y=this.mouse_delta_x=0,this.have_keyboard=!0,this.next_read_resolution=this.next_read_rate=this.next_handle_scan_code_set=this.next_read_led=this.next_read_sample=this.next_is_mouse_command=this.enable_keyboard_stream=!1,this.kbd_buffer=new vt(1024),this.last_port60_byte=0,this.sample_rate=100,this.mouse_id=this.mouse_detect_state=0,this.mouse_reset_workaround=!1,this.wheel_movement=0,this.resolution=4,this.scaling2=!1,this.last_mouse_packet=-1,this.mouse_buffer=new vt(1024),this.next_byte_is_aux=this.next_byte_is_ready=!1,this.bus.register("keyboard-code",(function(t){this.kbd_send_code(t)}),this),this.bus.register("mouse-click",(function(t){this.mouse_send_click(t[0],t[1],t[2])}),this),this.bus.register("mouse-delta",(function(t){this.mouse_send_delta(t[0],t[1])}),this),this.bus.register("mouse-wheel",(function(t){this.wheel_movement-=t[0],this.wheel_movement-=2*t[1],this.wheel_movement=Math.min(7,Math.max(-8,this.wheel_movement)),this.send_mouse_packet(0,0)}),this),this.command_register=5,this.controller_output_port=0,this.read_controller_output_port=this.read_command_register=this.read_output_register=!1,t.io.register_read(96,this,this.port60_read),t.io.register_read(100,this,this.port64_read),t.io.register_write(96,this,this.port60_write),t.io.register_write(100,this,this.port64_write)}jt.prototype.get_state=function(){var t=[];return t[0]=this.enable_mouse_stream,t[1]=this.use_mouse,t[2]=this.have_mouse,t[3]=this.mouse_delta_x,t[4]=this.mouse_delta_y,t[5]=this.mouse_clicks,t[6]=this.have_keyboard,t[7]=this.enable_keyboard_stream,t[8]=this.next_is_mouse_command,t[9]=this.next_read_sample,t[10]=this.next_read_led,t[11]=this.next_handle_scan_code_set,t[12]=this.next_read_rate,t[13]=this.next_read_resolution,t[15]=this.last_port60_byte,t[16]=this.sample_rate,t[17]=this.resolution,t[18]=this.scaling2,t[20]=this.command_register,t[21]=this.read_output_register,t[22]=this.read_command_register,t[23]=this.controller_output_port,t[24]=this.read_controller_output_port,t[25]=this.mouse_id,t[26]=this.mouse_detect_state,t[27]=this.mouse_reset_workaround,t},jt.prototype.set_state=function(t){this.enable_mouse_stream=t[0],this.use_mouse=t[1],this.have_mouse=t[2],this.mouse_delta_x=t[3],this.mouse_delta_y=t[4],this.mouse_clicks=t[5],this.have_keyboard=t[6],this.enable_keyboard_stream=t[7],this.next_is_mouse_command=t[8],this.next_read_sample=t[9],this.next_read_led=t[10],this.next_handle_scan_code_set=t[11],this.next_read_rate=t[12],this.next_read_resolution=t[13],this.last_port60_byte=t[15],this.sample_rate=t[16],this.resolution=t[17],this.scaling2=t[18],this.command_register=t[20],this.read_output_register=t[21],this.read_command_register=t[22],this.controller_output_port=t[23],this.read_controller_output_port=t[24],this.mouse_id=t[25]||0,this.mouse_detect_state=t[26]||0,this.mouse_reset_workaround=t[27]||!1,this.next_byte_is_aux=this.next_byte_is_ready=!1,this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.bus.send("mouse-enable",this.use_mouse)},jt.prototype.raise_irq=function(){this.next_byte_is_ready||(this.kbd_buffer.length?this.kbd_irq():this.mouse_buffer.length&&this.mouse_irq())},jt.prototype.mouse_irq=function(){this.next_byte_is_aux=this.next_byte_is_ready=!0,2&this.command_register&&(us("Mouse irq",r),this.cpu.device_lower_irq(12),this.cpu.device_raise_irq(12))},jt.prototype.kbd_irq=function(){this.next_byte_is_ready=!0,this.next_byte_is_aux=!1,1&this.command_register&&(us("Keyboard irq",r),this.cpu.device_lower_irq(1),this.cpu.device_raise_irq(1))},jt.prototype.kbd_send_code=function(t){this.enable_keyboard_stream&&(us("adding kbd code: "+bt(t),r),this.kbd_buffer.push(t),this.raise_irq())},jt.prototype.mouse_send_delta=function(t,e){if(this.have_mouse&&this.use_mouse){var i=this.resolution*this.sample_rate/80;this.mouse_delta_x+=t*i,this.mouse_delta_y+=e*i,this.enable_mouse_stream&&(t=0|this.mouse_delta_x,e=0|this.mouse_delta_y,t||e)&&(Date.now(),this.mouse_delta_x-=t,this.mouse_delta_y-=e,this.send_mouse_packet(t,e))}},jt.prototype.mouse_send_click=function(t,e,i){this.have_mouse&&this.use_mouse&&(this.mouse_clicks=t|i<<1|e<<2,this.enable_mouse_stream&&this.send_mouse_packet(0,0))},jt.prototype.send_mouse_packet=function(t,e){var i=(0>e)<<5|(0>t)<<4|8|this.mouse_clicks;this.last_mouse_packet=Date.now(),this.mouse_buffer.push(i),this.mouse_buffer.push(t),this.mouse_buffer.push(e),4===this.mouse_id?(this.mouse_buffer.push(0|15&this.wheel_movement),this.wheel_movement=0):3===this.mouse_id&&(this.mouse_buffer.push(255&this.wheel_movement),this.wheel_movement=0),this.raise_irq()},jt.prototype.apply_scaling2=function(t){var e=t>>31;switch(Math.abs(t)){case 0:case 1:case 3:return t;case 2:return e;case 4:return 6*e;case 5:return 9*e;default:return t<<1}},jt.prototype.port60_read=function(){return this.next_byte_is_ready=!1,this.kbd_buffer.length||this.mouse_buffer.length?(this.next_byte_is_aux?(this.cpu.device_lower_irq(12),this.last_port60_byte=this.mouse_buffer.shift(),us("Port 60 read (mouse): "+bt(this.last_port60_byte),r)):(this.cpu.device_lower_irq(1),this.last_port60_byte=this.kbd_buffer.shift(),us("Port 60 read (kbd)  : "+bt(this.last_port60_byte),r)),(this.kbd_buffer.length||this.mouse_buffer.length)&&this.raise_irq(),this.last_port60_byte):(us("Port 60 read: Empty",r),this.last_port60_byte)},jt.prototype.port64_read=function(){var t=16;return this.next_byte_is_ready&&(t|=1),this.next_byte_is_aux&&(t|=32),us("port 64 read: "+bt(t),r),t},jt.prototype.port60_write=function(t){if(us("port 60 write: "+bt(t),r),this.read_command_register)this.command_register=t,this.read_command_register=!1,us("Keyboard command register = "+bt(this.command_register),r);else if(this.read_output_register)this.read_output_register=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(t),this.mouse_irq();else if(this.next_read_sample){switch(this.next_read_sample=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.sample_rate=t,this.mouse_detect_state){case-1:60===t?(this.mouse_reset_workaround=!0,this.mouse_detect_state=0):(this.mouse_reset_workaround=!1,this.mouse_detect_state=200===t?1:0);break;case 0:200===t&&(this.mouse_detect_state=1);break;case 1:this.mouse_detect_state=100===t?2:200===t?3:0;break;case 2:80===t&&(this.mouse_id=3),this.mouse_detect_state=-1;break;case 3:80===t&&(this.mouse_id=4),this.mouse_detect_state=-1}us("mouse sample rate: "+bt(t)+", mouse id: "+bt(this.mouse_id),r),this.sample_rate||(us("invalid sample rate, reset to 100",r),this.sample_rate=100),this.mouse_irq()}else if(this.next_read_resolution)this.next_read_resolution=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),3<t?(this.resolution=4,us("invalid resolution, resetting to 4",r)):(this.resolution=1<<t,us("resolution: "+this.resolution,r)),this.mouse_irq();else if(this.next_read_led)this.next_read_led=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_handle_scan_code_set)this.next_handle_scan_code_set=!1,this.kbd_buffer.push(250),this.kbd_irq(),t||this.kbd_buffer.push(2);else if(this.next_read_rate)this.next_read_rate=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_is_mouse_command){if(this.next_is_mouse_command=!1,us("Port 60 data register write: "+bt(t),r),this.have_mouse){switch(this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.mouse_buffer.push(250),t){case 230:us("Scaling 1:1",r),this.scaling2=!1;break;case 231:us("Scaling 2:1",r),this.scaling2=!0;break;case 232:this.next_read_resolution=!0;break;case 233:this.send_mouse_packet(0,0);break;case 235:us("unimplemented request single packet",r),this.send_mouse_packet(0,0);break;case 242:us("required id: "+bt(this.mouse_id),r),this.mouse_buffer.push(this.mouse_id),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0,this.raise_irq();break;case 243:this.next_read_sample=!0;break;case 244:this.use_mouse=this.enable_mouse_stream=!0,this.bus.send("mouse-enable",!0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 245:this.enable_mouse_stream=!1;break;case 246:this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4;break;case 255:us("Mouse reset",r),this.mouse_buffer.push(170),this.mouse_buffer.push(0),this.use_mouse=!0,this.bus.send("mouse-enable",!0),this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4,this.mouse_reset_workaround||(this.mouse_id=0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;default:us("Unimplemented mouse command: "+bt(t),r)}this.mouse_irq()}}else if(this.read_controller_output_port)this.read_controller_output_port=!1,this.controller_output_port=t;else{switch(us("Port 60 data register write: "+bt(t),r),this.mouse_buffer.clear(),this.kbd_buffer.clear(),this.kbd_buffer.push(250),t){case 237:this.next_read_led=!0;break;case 240:this.next_handle_scan_code_set=!0;break;case 242:this.kbd_buffer.push(171),this.kbd_buffer.push(83);break;case 243:this.next_read_rate=!0;break;case 244:us("kbd enable scanning",r),this.enable_keyboard_stream=!0;break;case 245:us("kbd disable scanning",r),this.enable_keyboard_stream=!1;break;case 246:break;case 255:this.kbd_buffer.clear(),this.kbd_buffer.push(250),this.kbd_buffer.push(170),this.kbd_buffer.push(0);break;default:us("Unimplemented keyboard command: "+bt(t),r)}this.kbd_irq()}},jt.prototype.port64_write=function(t){switch(us("port 64 write: "+bt(t),r),t){case 32:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(this.command_register),this.kbd_irq();break;case 96:this.read_command_register=!0;break;case 209:this.read_controller_output_port=!0;break;case 211:this.read_output_register=!0;break;case 212:this.next_is_mouse_command=!0;break;case 167:us("Disable second port",r),this.command_register|=32;break;case 168:us("Enable second port",r),this.command_register&=-33;break;case 169:case 171:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 170:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(85),this.kbd_irq();break;case 173:us("Disable Keyboard",r),this.command_register|=16;break;case 174:us("Enable Keyboard",r),this.command_register&=-17;break;case 254:us("CPU reboot via PS2"),this.cpu.reboot_internal();break;default:us("port 64: Unimplemented command byte: "+bt(t),r)}};var Vt=!1;function Ht(t,e){this.irq_value=this.irr=this.isr=this.irq_map=this.irq_mask=0,this.requested_irq=-1,this.master=e,this.is_master=void 0===this.master,this.slave=void 0,this.name=this.is_master?"master":"slave ",this.expect_icw4=!1,this.read_isr=this.state=0,this.auto_eoi=1,this.elcr=this.special_mask_mode=0,this.cpu=t,this.is_master?(this.slave=new Ht(this.cpu,this),this.check_irqs=function(){if(0<=this.requested_irq)Vt&&us("master> Already requested irq: "+this.requested_irq,a),this.cpu.handle_irqs();else{var t=this.irr&this.irq_mask;if(t){t&=-t;var e=this.special_mask_mode?this.irq_mask:-1;this.isr&&(this.isr&-this.isr&e)<=t?us("master> higher prio: isr="+bt(this.isr,2)+" mask="+bt(255&this.irq_mask,2)+" irq="+bt(t,2),a):(ls(0!==t),ls(t===1<<(e=yt.int_log2_byte(t))),Vt&&us("master> request irq "+e,a),this.requested_irq=e,this.cpu.handle_irqs())}else Vt&&us("master> no unmasked irrs. irr="+bt(this.irr,2)+" mask="+bt(255&this.irq_mask,2)+" isr="+bt(this.isr,2),a)}},this.acknowledge_irq=function(){if(-1!==this.requested_irq)if(0===this.irr)Vt&&us("master> spurious requested="+this.requested_irq,a),this.requested_irq=-1;else{ls(this.irr),ls(0<=this.requested_irq);var t=1<<this.requested_irq;0==(this.elcr&t)&&(this.irr&=~t),this.auto_eoi||(this.isr|=t),Vt&&us("master> acknowledge "+this.requested_irq,a),2===this.requested_irq?this.slave.acknowledge_irq():this.cpu.pic_call_irq(this.irq_map|this.requested_irq),this.requested_irq=-1,this.check_irqs()}}):(this.check_irqs=function(){if(0<=this.requested_irq)Vt&&us("slave > Already requested irq: "+this.requested_irq,a),this.cpu.handle_irqs();else{var t=this.irr&this.irq_mask;if(t){t&=-t;var e=this.special_mask_mode?this.irq_mask:-1;this.isr&&(this.isr&-this.isr&e)<=t?Vt&&us("slave > higher prio: isr="+bt(this.isr,2)+" irq="+bt(t,2),a):(ls(0!==t),ls(t===1<<(e=yt.int_log2_byte(t))),Vt&&us("slave > request irq "+e,a),this.requested_irq=e,this.master.set_irq(2))}else Vt&&us("slave > no unmasked irrs. irr="+bt(this.irr,2)+" mask="+bt(255&this.irq_mask,2)+" isr="+bt(this.isr,2),a)}},this.acknowledge_irq=function(){if(-1!==this.requested_irq)if(0===this.irr)Vt&&us("slave > spurious requested="+this.requested_irq,a),this.requested_irq=-1,this.master.irq_value&=-5,this.cpu.pic_call_irq(7|this.irq_map);else{ls(this.irr),ls(0<=this.requested_irq);var t=1<<this.requested_irq;0==(this.elcr&t)&&(this.irr&=~t),this.auto_eoi||(this.isr|=t),this.master.irq_value&=-5,Vt&&us("slave > acknowledge "+this.requested_irq,a),this.cpu.pic_call_irq(this.irq_map|this.requested_irq),this.requested_irq=-1,this.check_irqs()}}),this.dump=function(){us("mask: "+bt(255&this.irq_mask),a),us("base: "+bt(this.irq_map),a),us("requested: "+bt(this.irr),a),us("serviced: "+bt(this.isr),a),this.is_master&&this.slave.dump()},this.is_master?(t=32,e=1232):(t=160,e=1233),this.cpu.io.register_write(t,this,this.port20_write),this.cpu.io.register_read(t,this,this.port20_read),this.cpu.io.register_write(1|t,this,this.port21_write),this.cpu.io.register_read(1|t,this,this.port21_read),this.cpu.io.register_write(e,this,this.port4D0_write),this.cpu.io.register_read(e,this,this.port4D0_read),this.is_master?(this.set_irq=function(t){if(ls(0<=t&&16>t),8<=t)this.slave.set_irq(t-8);else{var e=1<<t;0==(this.irq_value&e)?(Vt&&us("master> set irq "+t,a),this.irr|=e,this.irq_value|=e,this.check_irqs()):Vt&&us("master> set irq "+t+": already set!",a)}},this.clear_irq=function(t){ls(0<=t&&16>t),Vt&&us("master> clear irq "+t,a),8<=t?this.slave.clear_irq(t-8):(t=1<<t,this.irq_value&t&&(this.irq_value&=~t,this.irr&=~t,this.check_irqs()))}):(this.set_irq=function(t){ls(0<=t&&8>t);var e=1<<t;0==(this.irq_value&e)?(Vt&&us("slave > set irq "+t,a),this.irr|=e,this.irq_value|=e,this.check_irqs()):Vt&&us("slave > set irq "+t+": already set!",a)},this.clear_irq=function(t){ls(0<=t&&8>t),Vt&&us("slave > clear irq "+t,a),t=1<<t,this.irq_value&t&&(this.irq_value&=~t,this.irr&=~t,this.check_irqs())}),this.get_isr=function(){return this.isr}}Ht.prototype.get_state=function(){var t=[];return t[0]=this.irq_mask,t[1]=this.irq_map,t[2]=this.isr,t[3]=this.irr,t[4]=this.is_master,t[5]=this.slave,t[6]=this.expect_icw4,t[7]=this.state,t[8]=this.read_isr,t[9]=this.auto_eoi,t[10]=this.elcr,t},Ht.prototype.set_state=function(t){this.irq_mask=t[0],this.irq_map=t[1],this.isr=t[2],this.irr=t[3],this.is_master=t[4],this.slave&&this.slave.set_state(t[5]),this.expect_icw4=t[6],this.state=t[7],this.read_isr=t[8],this.auto_eoi=t[9],this.elcr=t[10]},Ht.prototype.port20_write=function(t){if(16&t)us("icw1 = "+bt(t),a),this.irq_value=this.irq_mask=this.irr=this.isr=0,this.auto_eoi=1,this.requested_irq=-1,this.expect_icw4=1&t,this.state=1;else if(8&t)us("ocw3: "+bt(t),a),2&t&&(this.read_isr=1&t),4&t&&ls(!1,"unimplemented: polling",a),64&t&&(this.special_mask_mode=32==(32&t),us("special mask mode: "+this.special_mask_mode,a));else{us("eoi: "+bt(t)+" ("+this.name+")",a);var e=t>>5;1===e?(this.isr&=this.isr-1,us("new isr: "+bt(this.isr,2),a)):3===e?this.isr&=~(1<<(7&t)):192==(200&t)?us("lowest priority: "+bt(7&t),a):(us("Unknown eoi: "+bt(t),a),ls(!1),this.isr&=this.isr-1),this.check_irqs()}},Ht.prototype.port20_read=function(){return this.read_isr?(us("read port 20h (isr): "+bt(this.isr),a),this.isr):(us("read port 20h (irr): "+bt(this.irr),a),this.irr)},Ht.prototype.port21_write=function(t){0===this.state?this.expect_icw4?(this.expect_icw4=!1,this.auto_eoi=2&t,us("icw4: "+bt(t)+" autoeoi="+this.auto_eoi,a),0==(1&t)&&ls(!1,"unimplemented: not 8086 mode",a)):(this.irq_mask=~t,Vt&&us("interrupt mask: "+(255&this.irq_mask).toString(2)+" ("+this.name+")",a),this.check_irqs()):1===this.state?(this.irq_map=t,us("interrupts are mapped to "+bt(this.irq_map)+" ("+this.name+")",a),this.state++):2===this.state&&(this.state=0,us("icw3: "+bt(t),a))},Ht.prototype.port21_read=function(){return us("21h read "+bt(255&~this.irq_mask),a),255&~this.irq_mask},Ht.prototype.port4D0_read=function(){return us("elcr read: "+bt(this.elcr,2),a),this.elcr},Ht.prototype.port4D0_write=function(t){us("elcr write: "+bt(t,2),a),this.elcr=t};var Kt=16,Xt=18,Yt=27,Qt=57;function Jt(t){this.cpu=t,this.cmos_index=0,this.cmos_data=new Uint8Array(128),this.last_update=this.rtc_time=Date.now(),this.next_interrupt_alarm=this.next_interrupt=0,this.periodic_interrupt=!1,this.periodic_interrupt_time=.9765625,this.cmos_a=38,this.cmos_b=2,this.nmi_disabled=this.cmos_c=0,t.io.register_write(112,this,(function(t){this.cmos_index=127&t,this.nmi_disabled=t>>7})),t.io.register_write(113,this,this.cmos_port_write),t.io.register_read(113,this,this.cmos_port_read)}Jt.prototype.get_state=function(){var t=[];return t[0]=this.cmos_index,t[1]=this.cmos_data,t[2]=this.rtc_time,t[3]=this.last_update,t[4]=this.next_interrupt,t[5]=this.next_interrupt_alarm,t[6]=this.periodic_interrupt,t[7]=this.periodic_interrupt_time,t[8]=this.cmos_a,t[9]=this.cmos_b,t[10]=this.cmos_c,t[11]=this.nmi_disabled,t},Jt.prototype.set_state=function(t){this.cmos_index=t[0],this.cmos_data=t[1],this.rtc_time=t[2],this.last_update=t[3],this.next_interrupt=t[4],this.next_interrupt_alarm=t[5],this.periodic_interrupt=t[6],this.periodic_interrupt_time=t[7],this.cmos_a=t[8],this.cmos_b=t[9],this.cmos_c=t[10],this.nmi_disabled=t[11]},Jt.prototype.timer=function(t,e){return t=Date.now(),this.rtc_time+=t-this.last_update,this.last_update=t,this.periodic_interrupt&&this.next_interrupt<t?(this.cpu.device_raise_irq(8),this.cmos_c|=192,this.next_interrupt+=this.periodic_interrupt_time*Math.ceil((t-this.next_interrupt)/this.periodic_interrupt_time)):this.next_interrupt_alarm&&this.next_interrupt_alarm<t&&(this.cpu.device_raise_irq(8),this.cmos_c|=160,this.next_interrupt_alarm=0),e=100,this.periodic_interrupt&&this.next_interrupt&&(e=Math.min(e,Math.max(0,this.next_interrupt-t))),this.next_interrupt_alarm&&(e=Math.min(e,Math.max(0,this.next_interrupt_alarm-t))),e},Jt.prototype.bcd_pack=function(t){for(var e,i=0,s=0;t;)s|=(e=t%10)<<4*i,i++,t=(t-e)/10;return s},Jt.prototype.bcd_unpack=function(t){const e=15&t,i=t>>4&15;return ls(256>t),ls(10>e),ls(10>i),e+10*i},Jt.prototype.encode_time=function(t){return 4&this.cmos_b?t:this.bcd_pack(t)},Jt.prototype.decode_time=function(t){return 4&this.cmos_b?t:this.bcd_unpack(t)},Jt.prototype.cmos_port_read=function(){var t=this.cmos_index;switch(t){case 0:return this.encode_time(new Date(this.rtc_time).getUTCSeconds());case 2:return this.encode_time(new Date(this.rtc_time).getUTCMinutes());case 4:return this.encode_time(new Date(this.rtc_time).getUTCHours());case 7:return this.encode_time(new Date(this.rtc_time).getUTCDate());case 8:return this.encode_time(new Date(this.rtc_time).getUTCMonth()+1);case 9:return this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100);case 10:return 999<=mt.microtick()%1e3?128|this.cmos_a:this.cmos_a;case 11:return this.cmos_b;case 12:return this.cpu.device_lower_irq(8),us("cmos reg C read",p),t=this.cmos_c,this.cmos_c&=-241,t;case 13:return 0;case 50:return this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0);default:return us("cmos read from index "+bt(t),p),this.cmos_data[this.cmos_index]}},Jt.prototype.cmos_port_write=function(t){switch(this.cmos_index){case 10:this.cmos_a=127&t,this.periodic_interrupt_time=1e3/(32768>>(15&this.cmos_a)-1),us("Periodic interrupt, a="+bt(this.cmos_a,2)+" t="+this.periodic_interrupt_time,p);break;case 11:if(this.cmos_b=t,64&this.cmos_b&&(this.next_interrupt=Date.now()),32&this.cmos_b){t=new Date;const e=this.decode_time(this.cmos_data[1]),i=this.decode_time(this.cmos_data[3]),s=this.decode_time(this.cmos_data[5]),r=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),s,i,e));us("RTC alarm scheduled for "+r+" hh:mm:ss="+s+":"+i+":"+e+" ms_from_now="+(r-t),p),this.next_interrupt_alarm=+r}16&this.cmos_b&&us("Unimplemented: updated interrupt",p),us("cmos b="+bt(this.cmos_b,2),p);break;case 1:case 3:case 5:this.cmos_write(this.cmos_index,t);break;default:us("cmos write index "+bt(this.cmos_index)+": "+bt(t),p)}this.periodic_interrupt=64==(64&this.cmos_b)&&0<(15&this.cmos_a)},Jt.prototype.cmos_read=function(t){return ls(128>t),this.cmos_data[t]},Jt.prototype.cmos_write=function(t,e){us("cmos "+bt(t)+" <- "+bt(e),p),ls(128>t),this.cmos_data[t]=e};var $t=128,Zt=1,te=2,ee=4,ie=12,se=1,re=32,ae=64;function ne(t,e,i){switch(this.bus=i,this.cpu=t,this.ints=1<<te,this.line_control=this.baud_rate=0,this.lsr=ae|re,this.ier=this.fifo_control=0,this.iir=Zt,this.irq=this.scratch_register=this.modem_status=this.modem_control=0,this.input=new vt(4096),this.current_line="",e){case 1016:this.com=0,this.irq=4;break;case 760:this.com=1,this.irq=3;break;case 1e3:this.com=2,this.irq=4;break;case 744:this.irq=this.com=3;break;default:us("Invalid serial port: "+bt(e),c),this.com=0,this.irq=4}this.bus.register("serial"+this.com+"-input",(function(t){this.data_received(t)}),this),(t=t.io).register_write(e,this,(function(t){this.write_data(t)}),(function(t){this.write_data(255&t),this.write_data(t>>8)})),t.register_write(1|e,this,(function(t){this.line_control&$t?(this.baud_rate=255&this.baud_rate|t<<8,us("baud rate: "+bt(this.baud_rate),c)):(0==(this.ier&te)&&t&te&&this.ThrowInterrupt(te),this.ier=15&t,us("interrupt enable: "+bt(t),c),this.CheckInterrupt())})),t.register_read(e,this,(function(){if(this.line_control&$t)return 255&this.baud_rate;var t=this.input.shift();return us(-1===t?"Read input empty":"Read input: "+bt(t),c),0===this.input.length&&(this.lsr&=~se,this.ClearInterrupt(ie),this.ClearInterrupt(ee)),t})),t.register_read(1|e,this,(function(){return this.line_control&$t?this.baud_rate>>8:15&this.ier})),t.register_read(2|e,this,(function(){var t=15&this.iir;return us("read interrupt identification: "+bt(this.iir),c),this.iir==te&&this.ClearInterrupt(te),1&this.fifo_control&&(t|=192),t})),t.register_write(2|e,this,(function(t){us("fifo control: "+bt(t),c),this.fifo_control=t})),t.register_read(3|e,this,(function(){return us("read line control: "+bt(this.line_control),c),this.line_control})),t.register_write(3|e,this,(function(t){us("line control: "+bt(t),c),this.line_control=t})),t.register_read(4|e,this,(function(){return this.modem_control})),t.register_write(4|e,this,(function(t){us("modem control: "+bt(t),c),this.modem_control=t})),t.register_read(5|e,this,(function(){return us("read line status: "+bt(this.lsr),c),this.lsr})),t.register_write(5|e,this,(function(t){us("Factory test write",c)})),t.register_read(6|e,this,(function(){return us("read modem status: "+bt(this.modem_status),c),this.modem_status})),t.register_write(6|e,this,(function(t){us("Unkown register write (base+6)",c)})),t.register_read(7|e,this,(function(){return this.scratch_register})),t.register_write(7|e,this,(function(t){this.scratch_register=t}))}ne.prototype.get_state=function(){var t=[];return t[0]=this.ints,t[1]=this.baud_rate,t[2]=this.line_control,t[3]=this.lsr,t[4]=this.fifo_control,t[5]=this.ier,t[6]=this.iir,t[7]=this.modem_control,t[8]=this.modem_status,t[9]=this.scratch_register,t[10]=this.irq,t},ne.prototype.set_state=function(t){this.ints=t[0],this.baud_rate=t[1],this.line_control=t[2],this.lsr=t[3],this.fifo_control=t[4],this.ier=t[5],this.iir=t[6],this.modem_control=t[7],this.modem_status=t[8],this.scratch_register=t[9],this.irq=t[10]},ne.prototype.CheckInterrupt=function(){this.ints&1<<ie&&1&this.ier?(this.iir=ie,this.cpu.device_raise_irq(this.irq)):this.ints&1<<ee&&1&this.ier?(this.iir=ee,this.cpu.device_raise_irq(this.irq)):this.ints&1<<te&&2&this.ier?(this.iir=te,this.cpu.device_raise_irq(this.irq)):1&this.ints&&8&this.ier?(this.iir=0,this.cpu.device_raise_irq(this.irq)):(this.iir=Zt,this.cpu.device_lower_irq(this.irq))},ne.prototype.ThrowInterrupt=function(t){this.ints|=1<<t,this.CheckInterrupt()},ne.prototype.ClearInterrupt=function(t){this.ints&=~(1<<t),this.CheckInterrupt()},ne.prototype.data_received=function(t){us("input: "+bt(t),c),this.input.push(t),this.lsr|=se,1&this.fifo_control?this.ThrowInterrupt(ie):this.ThrowInterrupt(ee)},ne.prototype.write_data=function(t){this.line_control&$t?this.baud_rate=-256&this.baud_rate|t:(us("data: "+bt(t),c),this.ThrowInterrupt(te),255!==t&&(t=String.fromCharCode(t),this.bus.send("serial"+this.com+"-output-char",t),ot&&(this.current_line+=t,"\n"===t&&(t=this.current_line.trimRight().replace(/[\x00-\x08\x0b-\x1f\x7f\x80-\xff]/g,""),us("SERIAL: "+t),this.current_line=""))))};var oe=4275044352,he=1e8,_e=1e12/he,de=0,ce=16|de<<5,ue=32816,pe=4;function le(t){function e(){return r?(Date.now()-a)*_e+n|0:n}function i(){return de?r?(Date.now()-a)*(_e/4294967296)+o|0:o:0}var s=this,r=!1,a=Date.now(),n=0,o=0,h=!1,_=0,d=new Int32Array(pe<<1),c=new Int32Array(pe<<1),u=new Int32Array(pe<<1),p=0;this.legacy_mode=!1,this.timer=function(i){if(!r)return 100;i=e()>>>0;for(var s,a,n=0;n<pe;n++)s=d[n<<1],a=c[n<<1]>>>0,(p<=i?a>p&&a<=i:a>p||a<=i)&&(a=4&s,2&s?(a=a&&!(_&1<<n),_|=1<<n):_&=~(1<<n),8&s&&(c[n<<1]+=u[n<<1]),a&&t.device_raise_irq(0));return p=i,100},t.io.mmap_register(oe,16384,(function(t){switch(us("Read "+bt(t,4)+" (ctr="+bt(e()>>>0)+")",l),t){case 0:return pe-1<<8|98305|de<<13;case 4:return he;case 16:return s.legacy_mode<<1|r;case 240:return e();case 244:return i()}var a=t>>2&7,n=t-256>>5;if(256>t||n>=pe||5<a)return us("Read reserved address: "+bt(t),l),0;switch(us("Read counter: addr="+bt(t)+" counter="+bt(n,2)+" reg="+bt(a),l),a){case 0:return d[n<<1]&~ue|ce;case 1:return d[n<<1|1];case 2:return c[n<<1];case 3:return c[n<<1|1];case 4:case 5:return 0}}),(function(t,p){switch(us("Write "+bt(t,4)+": "+bt(p,2),l),t){case 16:return us("conf: enabled="+(1&p)+" legacy="+(p>>1&1),l),1&(r^p)&&(1&p?a=Date.now():(n=e(),o=i())),r=1==(1&p),void(s.legacy_mode=2==(2&p));case 32:return void(_&=~p);case 240:return void(n=p);case 244:return void(o=p)}var f=t>>2&7,m=t-256>>5;if(256>t||m>=pe||2<f)us("Write reserved address: "+bt(t)+" data="+bt(p),l);else switch(us("Write counter: addr="+bt(t)+" counter="+bt(m,2)+" reg="+bt(f)+" data="+bt(p,2),l),f){case 0:d[m<<1]=p;break;case 2:h?(u[m<<1]=p,h=!1,us("Accumulator acc="+bt(p>>>0,8)+" ctr="+bt(m,2),l)):(c[m<<1]=p,64&d[m<<1]&&(h=!0,d[m<<1]&=-65));break;case 3:c[m<<1|1]=p}}))}function fe(t){this.cpu=t;var e=t.io;t.devices.pci.register_device({pci_id:56,pci_space:[134,128,19,113,7,0,128,2,8,0,128,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1,0,0],pci_bars:[],name:"acpi"}),this.timer_imprecision_offset=this.timer_last_value=0,this.status=1,this.pm1_enable=this.pm1_status=0,this.last_timer=this.get_timer(mt.microtick()),this.gpe=new Uint8Array(4),e.register_read(45056,this,void 0,(function(){return us("ACPI pm1_status read",f),this.pm1_status})),e.register_write(45056,this,void 0,(function(t){us("ACPI pm1_status write: "+bt(t,4),f),this.pm1_status&=~t})),e.register_read(45058,this,void 0,(function(){return us("ACPI pm1_enable read",f),this.pm1_enable})),e.register_write(45058,this,void 0,(function(t){us("ACPI pm1_enable write: "+bt(t),f),this.pm1_enable=t})),e.register_read(45060,this,void 0,(function(){return us("ACPI status read",f),this.status})),e.register_write(45060,this,void 0,(function(t){us("ACPI status write: "+bt(t),f),this.status=t})),e.register_read(45064,this,void 0,void 0,(function(){return 16777215&this.get_timer(mt.microtick())})),e.register_read(45024,this,(function(){return us("Read gpe#0",f),this.gpe[0]})),e.register_read(45025,this,(function(){return us("Read gpe#1",f),this.gpe[1]})),e.register_read(45026,this,(function(){return us("Read gpe#2",f),this.gpe[2]})),e.register_read(45027,this,(function(){return us("Read gpe#3",f),this.gpe[3]})),e.register_write(45024,this,(function(t){us("Write gpe#0: "+bt(t),f),this.gpe[0]=t})),e.register_write(45025,this,(function(t){us("Write gpe#1: "+bt(t),f),this.gpe[1]=t})),e.register_write(45026,this,(function(t){us("Write gpe#2: "+bt(t),f),this.gpe[2]=t})),e.register_write(45027,this,(function(t){us("Write gpe#3: "+bt(t),f),this.gpe[3]=t}))}fe.prototype.timer=function(t){var e=0!=(8388608&((t=this.get_timer(t))^this.last_timer));return 1&this.pm1_enable&&e?(us("ACPI raise irq",f),this.pm1_status|=1,this.cpu.device_raise_irq(9)):this.cpu.device_lower_irq(9),this.last_timer=t,100},fe.prototype.get_timer=function(t){return(t=Math.round(3579.545*t))===this.timer_last_value?this.timer_imprecision_offset<3579.545&&this.timer_imprecision_offset++:(ls(t>this.timer_last_value),this.timer_last_value+this.timer_imprecision_offset<=t?(this.timer_imprecision_offset=0,this.timer_last_value=t):us("Warning: Overshot pmtimer, waiting; current="+t+" last="+this.timer_last_value+" offset="+this.timer_imprecision_offset,f)),this.timer_last_value+this.timer_imprecision_offset},fe.prototype.get_state=function(){var t=[];return t[0]=this.status,t[1]=this.pm1_status,t[2]=this.pm1_enable,t[3]=this.gpe,t},fe.prototype.set_state=function(t){this.status=t[0],this.pm1_status=t[1],this.pm1_enable=t[2],this.gpe=t[3]};var me=4276092928,ge="Fixed (0);Lowest Prio (1);SMI (2);Reserved (3);NMI (4);INIT (5);Reserved (6);ExtINT (7)".split(";"),ye=["physical","logical"];function be(t){this.cpu=t,this.timer_divider=this.apic_id=0,this.timer_divider_shift=1,this.timer_current_count=this.timer_initial_count=0,this.next_tick=mt.microtick(),this.lvt_error=this.lvt_int1=this.lvt_int0=this.lvt_perf_counter=this.lvt_timer=Ee,this.icr1=this.icr0=this.tpr=0,this.irr=new Int32Array(8),this.isr=new Int32Array(8),this.tmr=new Int32Array(8),this.spurious_vector=254,this.destination_format=-1,this.read_error=this.error=this.local_destination=0,t.io.mmap_register(me,1048576,(t=>{us("Unsupported read8 from apic: "+bt(t>>>0),m);var e=3&t;return this.read32(-4&t)>>8*e&255}),((t,e)=>{us("Unsupported write8 from apic: "+bt(t)+" <- "+bt(e),m),ps(),ls(!1)}),(t=>this.read32(t)),((t,e)=>this.write32(t,e)))}be.prototype.read32=function(t){switch(t=t-me|0){case 32:return us("APIC read id",m),this.apic_id;case 48:return us("APIC read version",m),327700;case 128:return this.tpr;case 208:return us("Read local destination",m),this.local_destination;case 224:return us("Read destination format",m),this.destination_format;case 240:return this.spurious_vector;case 256:case 272:case 288:case 304:case 320:case 336:case 352:case 368:return us("Read isr "+(t=t-256>>4)+": "+bt(this.isr[t]>>>0,8),m),this.isr[t];case 384:case 400:case 416:case 432:case 448:case 464:case 480:case 496:return us("Read tmr "+(t=t-384>>4)+": "+bt(this.tmr[t]>>>0,8),m),this.tmr[t];case 512:case 528:case 544:case 560:case 576:case 592:case 608:case 624:return us("Read irr "+(t=t-512>>4)+": "+bt(this.irr[t]>>>0,8),m),this.irr[t];case 640:return us("Read error: "+bt(this.read_error>>>0,8),m),this.read_error;case 768:return this.icr0;case 784:return us("APIC read icr1",m),this.icr1;case 800:return us("read timer lvt",m),this.lvt_timer;case 832:return us("read lvt perf counter",m),this.lvt_perf_counter;case 848:return us("read lvt int0",m),this.lvt_int0;case 864:return us("read lvt int1",m),this.lvt_int1;case 880:return us("read lvt error",m),this.lvt_error;case 992:return us("read timer divider",m),this.timer_divider;case 896:return us("read timer initial count",m),this.timer_initial_count;case 912:return us("read timer current count: "+bt(this.timer_current_count>>>0,8),m),this.timer_current_count;default:return us("APIC read "+bt(t),m),ls(!1),0}},be.prototype.write32=function(t,e){switch(t=t-me|0){case 48:us("APIC write version: "+bt(e>>>0,8)+", ignored",m);break;case 128:this.tpr=255&e,this.check_vector();break;case 176:-1!==(t=this.highest_isr())?(this.register_clear_bit(this.isr,t),this.register_get_bit(this.tmr,t)&&this.cpu.devices.ioapic.remote_eoi(t),this.check_vector()):us("Bad eoi: No isr set",m);break;case 208:us("Set local destination: "+bt(e>>>0,8),m),this.local_destination=4278190080&e;break;case 224:us("Set destination format: "+bt(e>>>0,8),m),this.destination_format=16777215|e;break;case 240:us("Set spurious vector: "+bt(e>>>0,8),m),this.spurious_vector=e;break;case 640:us("Write error: "+bt(e>>>0,8),m),this.read_error=this.error,this.error=0;break;case 768:t=255&e;var i=e>>8&7,s=e>>11&1,r=e>>15&1,a=e>>18&3,n=this.icr1>>>24;us("APIC write icr0: "+bt(e,8)+" vector="+bt(t,2)+" destination_mode="+ye[s]+" delivery_mode="+ge[i]+" destination_shorthand="+["no","self","all with self","all without self"][a],m),this.icr0=-4097&e,0===a?this.route(t,i,r,n,s):1===a?this.deliver(t,Ce,r):2===a?this.deliver(t,i,r):3!==a&&ls(!1);break;case 784:us("APIC write icr1: "+bt(e>>>0,8),m),this.icr1=e;break;case 800:us("timer lvt: "+bt(e>>>0,8),m),this.lvt_timer=e;break;case 832:us("lvt perf counter: "+bt(e>>>0,8),m),this.lvt_perf_counter=e;break;case 848:us("lvt int0: "+bt(e>>>0,8),m),this.lvt_int0=e;break;case 864:us("lvt int1: "+bt(e>>>0,8),m),this.lvt_int1=e;break;case 880:us("lvt error: "+bt(e>>>0,8),m),this.lvt_error=e;break;case 992:us("timer divider: "+bt(e>>>0,8),m),this.timer_divider=e,e=3&e|(8&e)>>1,this.timer_divider_shift=7===e?0:e+1;break;case 896:us("timer initial: "+bt(e>>>0,8),m),this.timer_initial_count=e>>>0,this.timer_current_count=e>>>0,this.next_tick=mt.microtick(),this.timer_active=!0;break;case 912:us("timer current: "+bt(e>>>0,8),m),ls(!1,"read-only register");break;default:us("APIC write32 "+bt(t)+" <- "+bt(e>>>0,8),m),ls(!1)}},be.prototype.timer=function(t){if(0===this.timer_current_count)return 100;const e=pt/(1<<this.timer_divider_shift);return t=(t-this.next_tick)*e>>>0,this.next_tick+=t/e,this.timer_current_count-=t,0>=this.timer_current_count&&(131072===(t=393216&this.lvt_timer)?(this.timer_current_count%=this.timer_initial_count,0>=this.timer_current_count&&(this.timer_current_count+=this.timer_initial_count),ls(0!==this.timer_current_count),0==(this.lvt_timer&Ee)&&this.deliver(255&this.lvt_timer,Ce,!1)):0===t&&(this.timer_current_count=0,us("APIC timer one shot end",m),0==(this.lvt_timer&Ee)&&this.deliver(255&this.lvt_timer,Ce,!1))),Math.max(0,this.timer_current_count/e)},be.prototype.route=function(t,e,i,s,r){this.deliver(t,e,i)},be.prototype.deliver=function(t,e,i){e!==ze&&e!==Se&&((16>t||255===t)&&ls(!1,"TODO: Invalid vector"),this.register_get_bit(this.irr,t)?us("Not delivered: irr already set, vector="+bt(t,2),m):(this.register_set_bit(this.irr,t),i?this.register_set_bit(this.tmr,t):this.register_clear_bit(this.tmr,t),this.check_vector()))},be.prototype.highest_irr=function(){var t=this.register_get_highest_bit(this.irr);return ls(255!==t),ls(16<=t||-1===t),t},be.prototype.highest_isr=function(){var t=this.register_get_highest_bit(this.isr);return ls(255!==t),ls(16<=t||-1===t),t},be.prototype.check_vector=function(){var t=this.highest_irr();if(-1!==t){var e=this.highest_isr();e>=t||(240&t)<=(240&this.tpr)||this.cpu.handle_irqs()}},be.prototype.acknowledge_irq=function(){var t=this.highest_irr();if(-1!==t){var e=this.highest_isr();e>=t||(240&t)<=(240&this.tpr)||(this.register_clear_bit(this.irr,t),this.register_set_bit(this.isr,t),this.cpu.pic_call_irq(t),this.check_vector())}},be.prototype.get_state=function(){var t=[];return t[0]=this.apic_id,t[1]=this.timer_divider,t[2]=this.timer_divider_shift,t[3]=this.timer_initial_count,t[4]=this.timer_current_count,t[5]=this.next_tick,t[6]=this.lvt_timer,t[7]=this.lvt_perf_counter,t[8]=this.lvt_int0,t[9]=this.lvt_int1,t[10]=this.lvt_error,t[11]=this.tpr,t[12]=this.icr0,t[13]=this.icr1,t[14]=this.irr,t[15]=this.isr,t[16]=this.tmr,t[17]=this.spurious_vector,t[18]=this.destination_format,t[19]=this.local_destination,t[20]=this.error,t[21]=this.read_error,t},be.prototype.set_state=function(t){this.apic_id=t[0],this.timer_divider=t[1],this.timer_divider_shift=t[2],this.timer_initial_count=t[3],this.timer_current_count=t[4],this.next_tick=t[5],this.lvt_timer=t[6],this.lvt_perf_counter=t[7],this.lvt_int0=t[8],this.lvt_int1=t[9],this.lvt_error=t[10],this.tpr=t[11],this.icr0=t[12],this.icr1=t[13],this.irr=t[14],this.isr=t[15],this.tmr=t[16],this.spurious_vector=t[17],this.destination_format=t[18],this.local_destination=t[19],this.error=t[20],this.read_error=t[21]},be.prototype.register_get_bit=function(t,e){return ls(0<=e&&256>e),t[e>>5]>>(31&e)&1},be.prototype.register_set_bit=function(t,e){ls(0<=e&&256>e),t[e>>5]|=1<<(31&e)},be.prototype.register_clear_bit=function(t,e){ls(0<=e&&256>e),t[e>>5]&=~(1<<(31&e))},be.prototype.register_get_highest_bit=function(t){for(var e=7;0<=e;e--){var i=t[e];if(i)return yt.int_log2(i>>>0)|e<<5}return-1};var ve=4273995776,we=0,ke=16,xe=24,Ae=0,qe=32768,Ee=65536,Ie=16384,Re=-110592,Ce=0,Se=4,ze=5;function De(t){this.cpu=t,this.ioredtbl_config=new Int32Array(xe),this.ioredtbl_destination=new Int32Array(xe);for(var e=0;e<this.ioredtbl_config.length;e++)this.ioredtbl_config[e]=Ee;this.ioregsel=0,this.ioapic_id=Ae,this.irq_value=this.irr=0,ls(32<=H),t.io.mmap_register(ve,H,(t=>(t=t-ve|0)>=ke&&t<ke+4?(us("ioapic read8 byte "+(t-=ke)+" "+bt(this.ioregsel),m),this.read(this.ioregsel)>>8*t&255):(us("Unexpected IOAPIC register read: "+bt(t>>>0),m),ls(!1),0)),((t,e)=>{ls(!1,"unsupported write8 from ioapic: "+bt(t>>>0))}),(t=>(t=t-ve|0)===we?this.ioregsel:t===ke?this.read(this.ioregsel):(us("Unexpected IOAPIC register read: "+bt(t>>>0),m),ls(!1),0)),((t,e)=>{(t=t-ve|0)===we?this.ioregsel=e:t===ke?this.write(this.ioregsel,e):(us("Unexpected IOAPIC register write: "+bt(t>>>0)+" <- "+bt(e>>>0,8),m),ls(!1))}))}De.prototype.remote_eoi=function(t){for(var e=0;e<xe;e++){var i=this.ioredtbl_config[e];(255&i)===t&&i&Ie&&(us("Clear remote IRR for irq="+bt(e),m),this.ioredtbl_config[e]&=-16385,this.check_irq(e))}},De.prototype.check_irq=function(t){var e=1<<t;if(0!=(this.irr&e)){var i=this.ioredtbl_config[t];if(0==(i&Ee)){var s=i>>8&7,r=i>>11&1,a=255&i,n=this.ioredtbl_destination[t]>>>24,o=(i&qe)===qe;if(0==(i&qe))this.irr&=~e;else if(this.ioredtbl_config[t]|=Ie,i&Ie)return void us("No route: level interrupt and remote IRR still set",m);s===Ce||1===s?this.cpu.devices.apic.route(a,s,o,n,r):ls(!1,"TODO"),this.ioredtbl_config[t]&=-4097}}},De.prototype.set_irq=function(t){if(t>=xe)ls(!1,"Bad irq: "+t,m);else{var e=1<<t;0==(this.irq_value&e)&&(this.irq_value|=e,(this.ioredtbl_config[t]&(qe|Ee))!==Ee&&(this.irr|=e,this.check_irq(t)))}},De.prototype.clear_irq=function(t){if(t>=xe)ls(!1,"Bad irq: "+t,m);else{var e=1<<t;(this.irq_value&e)===e&&(this.irq_value&=~e,this.ioredtbl_config[t]&qe&&(this.irr&=~e))}},De.prototype.read=function(t){if(0===t)return us("IOAPIC Read id",m),this.ioapic_id<<24;if(1===t)return us("IOAPIC Read version",m),17|xe-1<<16;if(2===t)return us("IOAPIC Read arbitration id",m),this.ioapic_id<<24;if(16<=t&&t<16+2*xe){var e=t-16>>1;return 1&t?(t=this.ioredtbl_destination[e],us("IOAPIC Read destination irq="+bt(e)+" -> "+bt(t,8),m)):(t=this.ioredtbl_config[e],us("IOAPIC Read config irq="+bt(e)+" -> "+bt(t,8),m)),t}return us("IOAPIC register read outside of range "+bt(t),m),ls(!1),0},De.prototype.write=function(t,e){if(0===t)this.ioapic_id=e>>>24&15;else if(1===t||2===t)us("Invalid write: "+t,m);else if(16<=t&&t<16+2*xe){var i=t-16>>1;if(1&t)this.ioredtbl_destination[i]=4278190080&e,us("Write destination "+bt(e>>>0,8)+" irq="+bt(i)+" dest="+bt(e>>>24,2),m);else{this.ioredtbl_config[i]=110591&e|this.ioredtbl_config[i]&Re,t=255&e;var s=e>>8&7,r=e>>11&1,a=e>>15&1,n=e>>16&1;us("Write config "+bt(e>>>0,8)+" irq="+bt(i)+" vector="+bt(t,2)+" deliverymode="+ge[s]+" destmode="+ye[r]+" is_level="+a+" disabled="+n,m),this.check_irq(i)}}else us("IOAPIC register write outside of range "+bt(t)+": "+bt(e>>>0,8),m),ls(!1)},De.prototype.get_state=function(){var t=[];return t[0]=this.ioredtbl_config,t[1]=this.ioredtbl_destination,t[2]=this.ioregsel,t[3]=this.ioapic_id,t[4]=this.irr,t[5]=this.irq_value,t},De.prototype.set_state=function(t){this.ioredtbl_config=t[0],this.ioredtbl_destination=t[1],this.ioregsel=t[2],this.ioapic_id=t[3],this.irr=t[4],this.irq_value=t[5]};var Te=6,Ue=-2039052682,Oe=0,Pe=1,Le=2,Me=3,Fe=16;function Ne(t){this.message=t}Ne.prototype=Error();const Be={Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array};function We(t,e){if("object"!=typeof t||null===t)return ls("function"!=typeof t),t;if(t instanceof Array)return t.map((t=>We(t,e)));if(t.constructor===Object&&(console.log(t),ls(t.constructor!==Object,"Expected non-object")),t.BYTES_PER_ELEMENT){var i=new Uint8Array(t.buffer,t.byteOffset,t.length*t.BYTES_PER_ELEMENT);return t=t.constructor.name.replace("bound ",""),ls(Be[t]),{__state_type__:t,buffer_id:e.push(i)-1}}ot&&!t.get_state&&console.log("Object without get_state: ",t),i=t.get_state(),t=[];for(var s=0;s<i.length;s++){var r=i[s];ls("function"!=typeof r),t[s]=We(r,e)}return t}function Ge(t,e){if("object"!=typeof t||null===t)return ls("function"!=typeof t),t;if(t instanceof Array){for(var i=0;i<t.length;i++)t[i]=Ge(t[i],e);return t}ls(void 0!==(i=t.__state_type__));const s=Be[i];return ls(s,"Unkown type: "+i),new s(e[t.buffer_id])}fs.prototype.save_state=function(){for(var t=[],e=We(this,t),i=[],s=0,r=0;r<t.length;r++){var a=t[r].byteLength;i[r]={offset:s,length:a},s=(s+=a)+3&-4}e=JSON.stringify({buffer_infos:i,state:e}),e=(new TextEncoder).encode(e);var n=(r=(r=Fe+e.length)+3&-4)+s;s=new ArrayBuffer(n);var o=new Int32Array(s,0,Fe/4);for(new Uint8Array(s,Fe,e.length).set(e),a=new Uint8Array(s,r),o[Oe]=Ue,o[Pe]=Te,o[Le]=n,o[Me]=e.length,r=0;r<t.length;r++)ls((n=t[r]).constructor===Uint8Array),a.set(n,i[r].offset);return us("State: json size "+(e.byteLength>>10)+"k"),us("State: Total buffers size "+(a.byteLength>>10)+"k"),s},fs.prototype.restore_state=function(t){function e(t,e){const i=t.length;if(i<Fe)throw new Ne("Invalid length: "+i);if((t=new Int32Array(t.buffer,t.byteOffset,4))[Oe]!==Ue)throw new Ne("Invalid header: "+bt(t[Oe]>>>0));if(t[Pe]!==Te)throw new Ne("Version mismatch: dump="+t[Pe]+" we="+Te);if(e&&t[Le]!==i)throw new Ne("Length doesn't match header: real="+i+" header="+t[Le]);return t[Me]}function i(t){return t=(new TextDecoder).decode(t),JSON.parse(t)}if(t=new Uint8Array(t),4247762216===new Uint32Array(t.buffer,0,1)[0]){var s=this.zstd_create_ctx(t.length);new Uint8Array(this.wasm_memory.buffer,this.zstd_get_src_ptr(s),t.length).set(t);var r=this.zstd_read(s,16),a=new Uint8Array(this.wasm_memory.buffer,r,16),n=e(a,!1);this.zstd_read_free(r,16),r=this.zstd_read(s,n),a=i(a=new Uint8Array(this.wasm_memory.buffer,r,n)),this.zstd_read_free(r,n),r=a.state;var o=a.buffer_infos;for(var h of(a=[],n=Fe+n,o)){if(o=(n+3&-4)-n,1048576<h.length){var _=this.zstd_read(s,o);this.zstd_read_free(_,o),_=new Uint8Array(h.length),a.push(_.buffer);for(var d=0;d<h.length;){var c=h.length-d;ls(0<=c),c=Math.min(c,1048576);const t=this.zstd_read(s,c);_.set(new Uint8Array(this.wasm_memory.buffer,t,c),d),this.zstd_read_free(t,c),d+=c}}else d=(_=this.zstd_read(s,o+h.length))+o,a.push(this.wasm_memory.buffer.slice(d,d+h.length)),this.zstd_read_free(_,o+h.length);n+=o+h.length}r=Ge(r,a),this.set_state(r),this.zstd_free_ctx(s)}else{if(0>(s=e(t,!0))||s+12>=t.length)throw new Ne("Invalid info block length: "+s);h=(r=i(h=t.subarray(Fe,Fe+s))).state,r=r.buffer_infos;let a=Fe+s;a=a+3&-4,h=Ge(h,s=r.map((e=>{const i=a+e.offset;return t.buffer.slice(i,i+e.length)}))),this.set_state(h)}};const je=!1;var Ve=0,He=1,Ke=2,Xe=3,Ye=4,Qe=4,Je=5,$e=6,Ze=7,ti=8,ei=9,ii=10,si=11,ri=12,ai=12,ni=13,oi=13,hi=14,_i=14,di=15,ci=15,ui=16,pi=31,li=2,fi=64,mi=128,gi=64,yi=76,bi=128;function vi(t,e,i){t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&(us("Replace mac in eth destination field",g),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5]),t[6]===e[0]&&t[7]===e[1]&&t[8]===e[2]&&t[9]===e[3]&&t[10]===e[4]&&t[11]===e[5]&&(us("Replace mac in eth source field",g),t[6]=i[0],t[7]=i[1],t[8]=i[2],t[9]=i[3],t[10]=i[4],t[11]=i[5]);var s=t[12]<<8|t[13];if(2048===s){if(4!==(s=(t=t.subarray(14))[0]>>4))us("Expected ipv4.version==4 but got: "+s,g);else if(ls(5==(15&t[0]),"TODO: ihl!=5"),17===t[9]){s=(t=t.subarray(20))[0]<<8|t[1];var r=t[2]<<8|t[3];if(us("udp srcport="+s+" dstport="+r+" checksum="+bt(t[6]<<8|t[7],4),g),67===s||67===r)if(1669485411!==(r=(s=t.subarray(8))[236]<<24|s[237]<<16|s[238]<<8|s[239]))us("dhcp packet didn't match magic: "+bt(r,8));else for(s[28]===e[0]&&s[29]===e[1]&&s[30]===e[2]&&s[31]===e[3]&&s[32]===e[4]&&s[33]===e[5]&&(us("Replace mac in dhcp.chaddr",g),s[28]=i[0],s[29]=i[1],s[30]=i[2],s[31]=i[3],s[32]=i[4],s[33]=i[5],t[6]=t[7]=0),r=240;r<s.length;){const a=s[r++];if(255===a)break;const n=s[r++];61===a&&1===s[r+0]&&s[r+1]===e[0]&&s[r+2]===e[1]&&s[r+3]===e[2]&&s[r+4]===e[3]&&s[r+5]===e[4]&&s[r+6]===e[5]&&(us("Replace mac in dhcp.clientidentifier",g),s[r+1]=i[0],s[r+2]=i[1],s[r+3]=i[2],s[r+4]=i[3],s[r+5]=i[4],s[r+6]=i[5],t[6]=t[7]=0),r+=n}}}else 2054===s&&(t=t.subarray(14),us("arp oper="+t[7]+" "+wi(t.subarray(8,14))+" "+wi(t.subarray(18,24)),g),t[8]===e[0]&&t[9]===e[1]&&t[10]===e[2]&&t[11]===e[3]&&t[12]===e[4]&&t[13]===e[5]&&(us("Replace mac in arp.sha",g),t[8]=i[0],t[9]=i[1],t[10]=i[2],t[11]=i[3],t[12]=i[4],t[13]=i[5]))}function wi(t){return[t[0].toString(16).padStart(2,"0"),t[1].toString(16).padStart(2,"0"),t[2].toString(16).padStart(2,"0"),t[3].toString(16).padStart(2,"0"),t[4].toString(16).padStart(2,"0"),t[5].toString(16).padStart(2,"0")].join(":")}function ki(t,e){const i=t[12]<<8|t[13]<<0;if(2048===i){var s=t.subarray(14);const n=s[2]<<8|s[3];var r=s[9];if(17===r){var a=s.subarray(20);s=a[0]<<8|a[1],r=a[2]<<8|a[3];const o=a[6]<<8|a[7];67===s||67===r?(a=a.subarray(8).subarray(28,34),us(e+" len="+t.length+" ethertype="+bt(i)+" ipv4.len="+n+" ipv4.proto="+bt(t[23])+" udp.srcport="+s+" udp.dstport="+r+" udp.chksum="+bt(o,4)+" dhcp.chaddr="+wi(a))):us(e+" len="+t.length+" ethertype="+bt(i)+" ipv4.len="+n+" ipv4.proto="+bt(t[23])+" udp.srcport="+s+" udp.dstport="+r+" udp.chksum="+bt(o,4))}else 1!==r&&us(e+" len="+t.length+" ethertype="+bt(i)+" ipv4.len="+n+" ipv4.proto="+bt(t[23]))}else t.subarray(14),us(e+" len="+t.length+" ethertype="+bt(i)+" arp");us(function(t){function e(t,e){return yt.pad0(t.toString(16).toUpperCase(),e)}const i=[];let s=0;for(;s+15<t.length;s+=16){for(var r=e(s,5)+"   ",a=0;16>a;a++)r+=e(t[s+a],2)+" ";for(r+="  ",a=0;16>a;a++){var n=t[s+a];r+=33<=n&&34!==n&&92!==n&&126>=n?String.fromCharCode(n):"."}i.push(r)}for(r=e(s,5)+"   ";s<t.length;s++)r+=e(t[s],2)+" ";for(r+="   ".repeat(16-(a=15&s)),r+="  ",n=0;n<a;n++){const e=t[s+n];r+=33<=e&&34!==e&&92!==e&&126>=e?String.fromCharCode(e):"."}return i.push(r),"\n"+i.join("\n")+"\n"}(t))}function xi(t,e,i,s){for(this.cpu=t,this.pci=t.devices.pci,this.preserve_mac_from_state_image=i,this.mac_address_translation=s,this.bus=e,this.bus.register("net0-receive",(function(t){this.receive(t)}),this),this.port=768,this.name="ne2k",this.pci_space=[236,16,41,128,3,1,0,0,0,0,0,2,0,0,0,0,255&this.port|1,this.port>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,184,254,0,0,0,0,0,0,0,0,0,1,0,0],this.pci_id=40,this.pci_bars=[{size:32}],this.imr=this.isr=0,this.cr=1,this.tpsr=this.tcnt=this.rcnt=this.dcfg=0,this.memory=new Uint8Array(32768),this.txcr=this.rxcr=0,this.tsr=1,this.mac=new Uint8Array([0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0]),this.mac_address_in_state=null,e=0;6>e;e++)this.memory[e<<1]=this.memory[e<<1|1]=this.mac[e];this.memory[28]=this.memory[29]=87,this.memory[30]=this.memory[31]=87,us("Mac: "+wi(this.mac),g),this.rsar=0,this.pstart=gi,this.pstop=bi,this.boundary=this.curpg=yi,(e=t.io).register_read(this.port|Ve,this,(function(){return us("Read cmd",g),this.cr})),e.register_write(this.port|Ve,this,(function(t){this.cr=t,us("Write command: "+bt(t,2)+" newpg="+(this.cr>>6)+" txcr="+bt(this.txcr,2),g),1&this.cr||(24&t&&0===this.rcnt&&this.do_interrupt(fi),4&t&&(t=this.tpsr<<8,t=this.memory.subarray(t,t+this.tcnt),je&&ki(t,"send"),this.mac_address_in_state&&vi(t=new Uint8Array(t),this.mac_address_in_state,this.mac),this.bus.send("net0-send",t),this.bus.send("eth-transmit-end",[t.length]),this.cr&=-5,this.do_interrupt(li),us("Command: Transfer. length="+bt(t.byteLength),g)))})),e.register_read(this.port|oi,this,(function(){return us("Read counter0",g),0})),e.register_read(this.port|_i,this,(function(){return us("Read8 counter1",g),0}),(function(){return us("Read16 counter1",g),0})),e.register_read(this.port|ci,this,(function(){return us("Read counter2",g),0})),e.register_read(this.port|pi,this,(function(){return this.get_page(),us("Read reset",g),this.do_interrupt(mi),0})),e.register_write(this.port|pi,this,(function(t){this.get_page(),us("Write reset: "+bt(t,2),g)})),e.register_read(this.port|He,this,(function(){var t=this.get_page();return 0===t?this.pstart:1===t?(us("Read pg1/01 (mac[0])",g),this.mac[0]):2===t?this.pstart:(us("Read pg"+t+"/01"),ls(!1),0)})),e.register_write(this.port|He,this,(function(t){var e=this.get_page();0===e?(us("start page: "+bt(t,2),g),this.pstart=t):1===e?(us("mac[0] = "+bt(t),g),this.mac[0]=t):3===e?us("Unimplemented: Write pg3/01 (9346CR): "+bt(t),g):(us("Write pg"+e+"/01: "+bt(t),g),ls(!1))})),e.register_read(this.port|Ke,this,(function(){var t=this.get_page();return 0===t?this.pstop:1===t?(us("Read pg1/02 (mac[1])",g),this.mac[1]):2===t?this.pstop:(us("Read pg"+t+"/02",g),ls(!1),0)})),e.register_write(this.port|Ke,this,(function(t){var e=this.get_page();0===e?(us("stop page: "+bt(t,2),g),t>this.memory.length>>8&&(t=this.memory.length>>8,us("XXX: Adjusting stop page to "+bt(t),g)),this.pstop=t):1===e?(us("mac[1] = "+bt(t),g),this.mac[1]=t):(us("Write pg"+e+"/02: "+bt(t),g),ls(!1))})),e.register_read(this.port|Ze,this,(function(){var t=this.get_page();return 0===t?(us("Read isr: "+bt(this.isr,2),g),this.isr):1===t?(us("Read curpg: "+bt(this.curpg,2),g),this.curpg):void ls(!1)})),e.register_write(this.port|Ze,this,(function(t){var e=this.get_page();0===e?(us("Write isr: "+bt(t,2),g),this.isr&=~t,this.update_irq()):1===e?(us("Write curpg: "+bt(t,2),g),this.curpg=t):ls(!1)})),e.register_write(this.port|ni,this,(function(t){var e=this.get_page();0===e?(this.txcr=t,us("Write tx config: "+bt(t,2),g)):us("Unimplemented: Write pg"+e+"/0d "+bt(t,2),g)})),e.register_write(this.port|hi,this,(function(t){var e=this.get_page();0===e?(us("Write data configuration: "+bt(t,2),g),this.dcfg=t):us("Unimplemented: Write pg"+e+"/0e "+bt(t,2),g)})),e.register_read(this.port|ii,this,(function(){return 0===this.get_page()?(us("Read pg0/0a",g),80):(ls(!1,"TODO"),0)})),e.register_write(this.port|ii,this,(function(t){var e=this.get_page();0===e?(us("Write remote byte count low: "+bt(t,2),g),this.rcnt=65280&this.rcnt|255&t):us("Unimplemented: Write pg"+e+"/0a "+bt(t,2),g)})),e.register_read(this.port|si,this,(function(){return 0===this.get_page()?(us("Read pg0/0b",g),67):(ls(!1,"TODO"),0)})),e.register_write(this.port|si,this,(function(t){var e=this.get_page();0===e?(us("Write remote byte count high: "+bt(t,2),g),this.rcnt=255&this.rcnt|t<<8&65280):us("Unimplemented: Write pg"+e+"/0b "+bt(t,2),g)})),e.register_read(this.port|ti,this,(function(){var t=this.get_page();if(0===t)return us("Read remote start address low",g),255&this.rsar;us("Unimplemented: Read pg"+t+"/08",g),ls(!1)})),e.register_write(this.port|ti,this,(function(t){var e=this.get_page();0===e?(us("Write remote start address low: "+bt(t,2),g),this.rsar=65280&this.rsar|255&t):us("Unimplemented: Write pg"+e+"/08 "+bt(t,2),g)})),e.register_read(this.port|ei,this,(function(){var t=this.get_page();if(0===t)return us("Read remote start address high",g),this.rsar>>8&255;us("Unimplemented: Read pg"+t+"/09",g),ls(!1)})),e.register_write(this.port|ei,this,(function(t){var e=this.get_page();0===e?(us("Write remote start address low: "+bt(t,2),g),this.rsar=255&this.rsar|t<<8&65280):us("Unimplemented: Write pg"+e+"/09 "+bt(t,2),g)})),e.register_write(this.port|di,this,(function(t){var e=this.get_page();0===e?(us("Write interrupt mask register: "+bt(t,2)+" isr="+bt(this.isr,2),g),this.imr=t,this.update_irq()):us("Unimplemented: Write pg"+e+"/0f "+bt(t,2),g)})),e.register_read(this.port|Xe,this,(function(){var t=this.get_page();return 0===t?(us("Read boundary: "+bt(this.boundary,2),g),this.boundary):1===t?(us("Read pg1/03 (mac[2])",g),this.mac[2]):(3===t?us("Unimplemented: Read pg3/03 (CONFIG0)",g):(us("Read pg"+t+"/03",g),ls(!1)),0)})),e.register_write(this.port|Xe,this,(function(t){var e=this.get_page();0===e?(us("Write boundary: "+bt(t,2),g),this.boundary=t):1===e?(us("mac[2] = "+bt(t),g),this.mac[2]=t):(us("Write pg"+e+"/03: "+bt(t),g),ls(!1))})),e.register_read(this.port|Ye,this,(function(){var t=this.get_page();return 0===t?this.tsr:1===t?(us("Read pg1/04 (mac[3])",g),this.mac[3]):(us("Read pg"+t+"/04",g),ls(!1),0)})),e.register_write(this.port|Qe,this,(function(t){var e=this.get_page();0===e?(us("Write tpsr: "+bt(t,2),g),this.tpsr=t):1===e?(us("mac[3] = "+bt(t),g),this.mac[3]=t):(us("Write pg"+e+"/04: "+bt(t),g),ls(!1))})),e.register_read(this.port|Je,this,(function(){var t=this.get_page();return 0===t?(us("Unimplemented: Read pg0/05 (NCR: Number of Collisions Register)",g),0):1===t?(us("Read pg1/05 (mac[4])",g),this.mac[4]):(3===t?us("Unimplemented: Read pg3/05 (CONFIG2)",g):(us("Read pg"+t+"/05",g),ls(!1)),0)})),e.register_write(this.port|Je,this,(function(t){var e=this.get_page();0===e?(us("Write tcnt low: "+bt(t,2),g),this.tcnt=-256&this.tcnt|t):1===e?(us("mac[4] = "+bt(t),g),this.mac[4]=t):3===e?us("Unimplemented: Write pg3/05 (CONFIG2): "+bt(t),g):(us("Write pg"+e+"/05: "+bt(t),g),ls(!1))})),e.register_read(this.port|$e,this,(function(){var t=this.get_page();return 0===t?(ls(!1,"TODO"),0):1===t?(us("Read pg1/06 (mac[5])",g),this.mac[5]):(3===t?us("Unimplemented: Read pg3/06 (CONFIG3)",g):(us("Read pg"+t+"/06",g),ls(!1)),0)})),e.register_write(this.port|$e,this,(function(t){var e=this.get_page();0===e?(us("Write tcnt high: "+bt(t,2),g),this.tcnt=255&this.tcnt|t<<8):1===e?(us("mac[5] = "+bt(t),g),this.mac[5]=t):3===e?us("Unimplemented: Write pg3/06 (CONFIG3): "+bt(t),g):(us("Write pg"+e+"/06: "+bt(t),g),ls(!1))})),e.register_read(this.port|ri,this,(function(){var t=this.get_page();return 0===t?9:(us("Unimplemented: Read pg"+t+"/0c",g),ls(!1),0)})),e.register_write(this.port|ai,this,(function(t){var e=this.get_page();0===e?(us("RX configuration reg write: "+bt(t,2),g),this.rxcr=t):us("Unimplemented: Write pg"+e+"/0c: "+bt(t),g)})),e.register_read(this.port|ui|0,this,this.data_port_read8,this.data_port_read16,this.data_port_read32),e.register_write(this.port|ui|0,this,this.data_port_write16,this.data_port_write16,this.data_port_write32),t.devices.pci.register_device(this)}xi.prototype.get_state=function(){var t=[];return t[0]=this.isr,t[1]=this.imr,t[2]=this.cr,t[3]=this.dcfg,t[4]=this.rcnt,t[5]=this.tcnt,t[6]=this.tpsr,t[7]=this.rsar,t[8]=this.pstart,t[9]=this.curpg,t[10]=this.boundary,t[11]=this.pstop,t[12]=this.rxcr,t[13]=this.txcr,t[14]=this.tsr,t[15]=this.mac,t[16]=this.memory,t},xi.prototype.set_state=function(t){this.isr=t[0],this.imr=t[1],this.cr=t[2],this.dcfg=t[3],this.rcnt=t[4],this.tcnt=t[5],this.tpsr=t[6],this.rsar=t[7],this.pstart=t[8],this.curpg=t[9],this.boundary=t[10],this.pstop=t[11],this.rxcr=t[12],this.txcr=t[13],this.tsr=t[14],this.preserve_mac_from_state_image?(this.mac=t[15],this.memory=t[16]):this.mac_address_translation&&(this.mac_address_in_state=t[15],this.memory=t[16],us("Using mac address translation guest_os_mac="+wi(this.mac_address_in_state)+" real_mac="+wi(this.mac),g))},xi.prototype.do_interrupt=function(t){us("Do interrupt "+bt(t,2),g),this.isr|=t,this.update_irq()},xi.prototype.update_irq=function(){this.imr&this.isr?this.pci.raise_irq(this.pci_id):this.pci.lower_irq(this.pci_id)},xi.prototype.data_port_write=function(t){(16>=this.rsar||this.rsar>=gi<<8&&this.rsar<bi<<8)&&(this.memory[this.rsar]=t),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),0===this.rcnt&&this.do_interrupt(fi)},xi.prototype.data_port_write16=function(t){this.data_port_write(t),1&this.dcfg&&this.data_port_write(t>>8)},xi.prototype.data_port_write32=function(t){this.data_port_write(t),this.data_port_write(t>>8),this.data_port_write(t>>16),this.data_port_write(t>>24)},xi.prototype.data_port_read=function(){let t=0;return this.rsar<bi<<8&&(t=this.memory[this.rsar]),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),0===this.rcnt&&this.do_interrupt(fi),t},xi.prototype.data_port_read8=function(){return 255&this.data_port_read16()},xi.prototype.data_port_read16=function(){return 1&this.dcfg?this.data_port_read()|this.data_port_read()<<8:this.data_port_read()},xi.prototype.data_port_read32=function(){return this.data_port_read()|this.data_port_read()<<8|this.data_port_read()<<16|this.data_port_read()<<24},xi.prototype.receive=function(t){if(!(1&this.cr)&&(je&&ki(t,"receive"),this.bus.send("eth-receive-end",[t.length]),16&this.rxcr||4&this.rxcr&&255===t[0]&&255===t[1]&&255===t[2]&&255===t[3]&&255===t[4]&&255===t[5]||!(8&this.rxcr&&1==(1&t[0])||t[0]!==this.mac[0]||t[1]!==this.mac[1]||t[2]!==this.mac[2]||t[3]!==this.mac[3]||t[4]!==this.mac[4]||t[5]!==this.mac[5]))){this.mac_address_in_state&&vi(t=new Uint8Array(t),this.mac,this.mac_address_in_state);var e=this.curpg<<8,i=Math.max(60,t.length)+4,s=e+4,r=this.curpg+1+(i>>8),a=e+i,n=1+(i>>8),o=this.boundary>this.curpg?this.boundary-this.curpg:this.pstop-this.curpg+this.boundary-this.pstart;o<n&&0!==this.boundary?us("Buffer full, dropping packet pstart="+bt(this.pstart)+" pstop="+bt(this.pstop)+" curpg="+bt(this.curpg)+" needed="+bt(n)+" boundary="+bt(this.boundary)+" available="+bt(o),g):(a>this.pstop<<8?(ls(60<=t.length),ls(0<=(a=(this.pstop<<8)-s)),this.memory.set(t.subarray(0,a),s),this.memory.set(t.subarray(a),this.pstart<<8),us("rcv cut="+bt(a),g)):(this.memory.set(t,s),60>t.length&&this.memory.fill(0,s+t.length,s+60)),r>=this.pstop&&(r+=this.pstart-this.pstop),this.memory[e]=1,this.memory[e+1]=r,this.memory[e+2]=i,this.memory[e+3]=i>>8,this.curpg=r,us("rcv offset="+bt(e)+" len="+bt(i)+" next="+bt(r),g),this.do_interrupt(1))}},xi.prototype.get_page=function(){return this.cr>>6&3};var Ai="COPYRIGHT (C) CREATIVE TECHNOLOGY LTD, 1992.",qi=0,Ei=64,Ii=65536,Ri=65536,Ci=1,Si=5,zi=5,Di=new Uint8Array(256),Ti=[],Ui=[],Oi=[],Pi=new Uint8Array(256),Li=[];function Mi(t,e){this.cpu=t,this.bus=e,this.write_buffer=new vt(Ei),this.read_buffer=new vt(Ei),this.read_buffer_lastvalue=0,this.command=qi,this.mixer_current_address=this.command_size=0,this.mixer_registers=new Uint8Array(256),this.mixer_reset(),this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers=[new wt(Ii),new wt(Ii)],this.dma=t.devices.dma,this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_channel_8bit=Ci,this.dma_channel_16bit=Si,this.dma_autoinit=!1,this.dma_buffer=new ArrayBuffer(Ri),this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_uint8=new Uint8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new yt.SyncBuffer(this.dma_buffer),this.dma_paused=this.dma_waiting_transfer=!1,this.sampling_rate=22050,e.send("dac-tell-sampling-rate",this.sampling_rate),this.bytes_per_sample=1,this.e2_value=170,this.e2_count=0,this.asp_registers=new Uint8Array(256),this.mpu_read_buffer=new vt(Ei),this.fm_current_address1=this.fm_current_address0=this.mpu_read_buffer_lastvalue=0,this.fm_waveform_select_enable=!1,this.irq=zi,this.irq_triggered=new Uint8Array(16),t.io.register_read_consecutive(544,this,this.port2x0_read,this.port2x1_read,this.port2x2_read,this.port2x3_read),t.io.register_read_consecutive(904,this,this.port2x0_read,this.port2x1_read),t.io.register_read_consecutive(548,this,this.port2x4_read,this.port2x5_read),t.io.register_read(550,this,this.port2x6_read),t.io.register_read(551,this,this.port2x7_read),t.io.register_read(552,this,this.port2x8_read),t.io.register_read(553,this,this.port2x9_read),t.io.register_read(554,this,this.port2xA_read),t.io.register_read(555,this,this.port2xB_read),t.io.register_read(556,this,this.port2xC_read),t.io.register_read(557,this,this.port2xD_read),t.io.register_read_consecutive(558,this,this.port2xE_read,this.port2xF_read),t.io.register_write_consecutive(544,this,this.port2x0_write,this.port2x1_write,this.port2x2_write,this.port2x3_write),t.io.register_write_consecutive(904,this,this.port2x0_write,this.port2x1_write),t.io.register_write_consecutive(548,this,this.port2x4_write,this.port2x5_write),t.io.register_write(550,this,this.port2x6_write),t.io.register_write(551,this,this.port2x7_write),t.io.register_write_consecutive(552,this,this.port2x8_write,this.port2x9_write),t.io.register_write(554,this,this.port2xA_write),t.io.register_write(555,this,this.port2xB_write),t.io.register_write(556,this,this.port2xC_write),t.io.register_write(557,this,this.port2xD_write),t.io.register_write(558,this,this.port2xE_write),t.io.register_write(559,this,this.port2xF_write),t.io.register_read_consecutive(816,this,this.port3x0_read,this.port3x1_read),t.io.register_write_consecutive(816,this,this.port3x0_write,this.port3x1_write),this.dma.on_unmask(this.dma_on_unmask,this),e.register("dac-request-data",(function(){this.dac_handle_request()}),this),e.register("speaker-has-initialized",(function(){this.mixer_reset()}),this),e.send("speaker-confirm-initialized"),this.dsp_reset()}function Fi(t,e,i){i||(i=Mi.prototype.dsp_default_handler);for(var s=0;s<t.length;s++)Di[t[s]]=e,Ti[t[s]]=i}function Ni(t){for(var e=[],i=0;16>i;i++)e.push(t+i);return e}Mi.prototype.dsp_reset=function(){this.write_buffer.clear(),this.read_buffer.clear(),this.command=qi,this.command_size=0,this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers[0].clear(),this.dac_buffers[1].clear(),this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_autoinit=!1,this.dma_buffer_uint8.fill(0),this.dma_paused=this.dma_waiting_transfer=!1,this.e2_value=170,this.e2_count=0,this.sampling_rate=22050,this.bytes_per_sample=1,this.lower_irq(1),this.irq_triggered.fill(0),this.asp_registers.fill(0),this.asp_registers[5]=1,this.asp_registers[9]=248},Mi.prototype.get_state=function(){var t=[];return t[2]=this.read_buffer_lastvalue,t[3]=this.command,t[4]=this.command_size,t[5]=this.mixer_current_address,t[6]=this.mixer_registers,t[7]=this.dummy_speaker_enabled,t[8]=this.test_register,t[9]=this.dsp_highspeed,t[10]=this.dsp_stereo,t[11]=this.dsp_16bit,t[12]=this.dsp_signed,t[15]=this.dma_sample_count,t[16]=this.dma_bytes_count,t[17]=this.dma_bytes_left,t[18]=this.dma_bytes_block,t[19]=this.dma_irq,t[20]=this.dma_channel,t[21]=this.dma_channel_8bit,t[22]=this.dma_channel_16bit,t[23]=this.dma_autoinit,t[24]=this.dma_buffer_uint8,t[25]=this.dma_waiting_transfer,t[26]=this.dma_paused,t[27]=this.sampling_rate,t[28]=this.bytes_per_sample,t[29]=this.e2_value,t[30]=this.e2_count,t[31]=this.asp_registers,t[33]=this.mpu_read_buffer_last_value,t[34]=this.irq,t[35]=this.irq_triggered,t},Mi.prototype.set_state=function(t){this.read_buffer_lastvalue=t[2],this.command=t[3],this.command_size=t[4],this.mixer_current_address=t[5],this.mixer_registers=t[6],this.mixer_full_update(),this.dummy_speaker_enabled=t[7],this.test_register=t[8],this.dsp_highspeed=t[9],this.dsp_stereo=t[10],this.dsp_16bit=t[11],this.dsp_signed=t[12],this.dma_sample_count=t[15],this.dma_bytes_count=t[16],this.dma_bytes_left=t[17],this.dma_bytes_block=t[18],this.dma_irq=t[19],this.dma_channel=t[20],this.dma_channel_8bit=t[21],this.dma_channel_16bit=t[22],this.dma_autoinit=t[23],this.dma_buffer_uint8=t[24],this.dma_waiting_transfer=t[25],this.dma_paused=t[26],this.sampling_rate=t[27],this.bytes_per_sample=t[28],this.e2_value=t[29],this.e2_count=t[30],this.asp_registers=t[31],this.mpu_read_buffer_last_value=t[33],this.irq=t[34],this.irq_triggered=t[35],this.dma_buffer=this.dma_buffer_uint8.buffer,this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new yt.SyncBuffer(this.dma_buffer),this.dma_paused?this.bus.send("dac-disable"):this.bus.send("dac-enable")},Mi.prototype.port2x0_read=function(){return us("220 read: fm music status port (unimplemented)",v),255},Mi.prototype.port2x1_read=function(){return us("221 read: fm music data port (write only)",v),255},Mi.prototype.port2x2_read=function(){return us("222 read: advanced fm music status port (unimplemented)",v),255},Mi.prototype.port2x3_read=function(){return us("223 read: advanced music data port (write only)",v),255},Mi.prototype.port2x4_read=function(){return us("224 read: mixer address port",v),this.mixer_current_address},Mi.prototype.port2x5_read=function(){return us("225 read: mixer data port",v),this.mixer_read(this.mixer_current_address)},Mi.prototype.port2x6_read=function(){return us("226 read: (write only)",v),255},Mi.prototype.port2x7_read=function(){return us("227 read: undocumented",v),255},Mi.prototype.port2x8_read=function(){return us("228 read: fm music status port (unimplemented)",v),255},Mi.prototype.port2x9_read=function(){return us("229 read: fm music data port (write only)",v),255},Mi.prototype.port2xA_read=function(){return us("22A read: read data",v),this.read_buffer.length&&(this.read_buffer_lastvalue=this.read_buffer.shift()),us(" <- "+this.read_buffer_lastvalue+" "+bt(this.read_buffer_lastvalue)+" '"+String.fromCharCode(this.read_buffer_lastvalue)+"'",v),this.read_buffer_lastvalue},Mi.prototype.port2xB_read=function(){return us("22B read: undocumented",v),255},Mi.prototype.port2xC_read=function(){return us("22C read: write-buffer status",v),127},Mi.prototype.port2xD_read=function(){return us("22D read: undocumented",v),255},Mi.prototype.port2xE_read=function(){return us("22E read: read-buffer status / irq 8bit ack.",v),this.irq_triggered[1]&&this.lower_irq(1),(this.read_buffer.length&&!this.dsp_highspeed)<<7|127},Mi.prototype.port2xF_read=function(){return us("22F read: irq 16bit ack",v),this.lower_irq(2),0},Mi.prototype.port2x0_write=function(t){us("220 write: (unimplemented) fm register 0 address = "+bt(t),v),this.fm_current_address0=0},Mi.prototype.port2x1_write=function(t){us("221 write: (unimplemented) fm register 0 data = "+bt(t),v);var e=Li[this.fm_current_address0];e||(e=this.fm_default_write),e.call(this,t,0,this.fm_current_address0)},Mi.prototype.port2x2_write=function(t){us("222 write: (unimplemented) fm register 1 address = "+bt(t),v),this.fm_current_address1=0},Mi.prototype.port2x3_write=function(t){us("223 write: (unimplemented) fm register 1 data ="+bt(t),v);var e=Li[this.fm_current_address1];e||(e=this.fm_default_write),e.call(this,t,1,this.fm_current_address1)},Mi.prototype.port2x4_write=function(t){us("224 write: mixer address = "+bt(t),v),this.mixer_current_address=t},Mi.prototype.port2x5_write=function(t){us("225 write: mixer data = "+bt(t),v),this.mixer_write(this.mixer_current_address,t)},Mi.prototype.port2x6_write=function(t){us("226 write: reset = "+bt(t),v),this.dsp_highspeed?(us(" -> exit highspeed",v),this.dsp_highspeed=!1):t&&(us(" -> reset",v),this.dsp_reset()),this.read_buffer.clear(),this.read_buffer.push(170)},Mi.prototype.port2x7_write=function(t){us("227 write: undocumented",v)},Mi.prototype.port2x8_write=function(t){us("228 write: fm music register port (unimplemented)",v)},Mi.prototype.port2x9_write=function(t){us("229 write: fm music data port (unimplemented)",v)},Mi.prototype.port2xA_write=function(t){us("22A write: dsp read data port (read only)",v)},Mi.prototype.port2xB_write=function(t){us("22B write: undocumented",v)},Mi.prototype.port2xC_write=function(t){us("22C write: write command/data",v),this.command===qi?(us("22C write: command = "+bt(t),v),this.command=t,this.write_buffer.clear(),this.command_size=Di[t]):(us("22C write: data: "+bt(t),v),this.write_buffer.push(t)),this.write_buffer.length>=this.command_size&&this.command_do()},Mi.prototype.port2xD_write=function(t){us("22D write: undocumented",v)},Mi.prototype.port2xE_write=function(t){us("22E write: dsp read buffer status (read only)",v)},Mi.prototype.port2xF_write=function(t){us("22F write: undocumented",v)},Mi.prototype.port3x0_read=function(){return us("330 read: mpu data",v),this.mpu_read_buffer.length&&(this.mpu_read_buffer_lastvalue=this.mpu_read_buffer.shift()),us(" <- "+bt(this.mpu_read_buffer_lastvalue),v),this.mpu_read_buffer_lastvalue},Mi.prototype.port3x0_write=function(t){us("330 write: mpu data (unimplemented) : "+bt(t),v)},Mi.prototype.port3x1_read=function(){return us("331 read: mpu status",v),0|128*!this.mpu_read_buffer.length},Mi.prototype.port3x1_write=function(t){us("331 write: mpu command: "+bt(t),v),255==t&&(this.mpu_read_buffer.clear(),this.mpu_read_buffer.push(254))},Mi.prototype.command_do=function(){var t=Ti[this.command];t||(t=this.dsp_default_handler),t.call(this),this.command=qi,this.command_size=0,this.write_buffer.clear()},Mi.prototype.dsp_default_handler=function(){us("Unhandled command: "+bt(this.command),v)},Fi([14],2,(function(){this.asp_registers[this.write_buffer.shift()]=this.write_buffer.shift()})),Fi([15],1,(function(){this.read_buffer.clear(),this.read_buffer.push(this.asp_registers[this.write_buffer.shift()])})),Fi([16],1,(function(){var t=Qi(this.write_buffer.shift(),127.5,-1);this.dac_buffers[0].push(t),this.dac_buffers[1].push(t),this.bus.send("dac-enable")})),Fi([20,21],2,(function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=this.dma_autoinit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()})),Fi([22],2),Fi([23],2),Fi([28],0,(function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=!1,this.dma_transfer_start()})),Fi([31],0),Fi([32],0,(function(){this.read_buffer.clear(),this.read_buffer.push(127)})),Fi([36],2),Fi([44],0),Fi([48],0),Fi([49],0),Fi([52],0),Fi([53],0),Fi([54],0),Fi([55],0),Fi([56],0),Fi([64],1,(function(){this.sampling_rate_change(1e6/(256-this.write_buffer.shift())/this.get_channel_count())})),Fi([65,66],2,(function(){this.sampling_rate_change(this.write_buffer.shift()<<8|this.write_buffer.shift())})),Fi([72],2,(function(){this.dma_transfer_size_set()})),Fi([116],2),Fi([117],2),Fi([118],2),Fi([119],2),Fi([125],0),Fi([127],0),Fi([128],2),Fi([144],0,(function(){this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_signed=!1,this.dsp_highspeed=!0,this.dsp_16bit=!1,this.dma_transfer_start()})),Fi([145],0),Fi([152],0),Fi([153],0),Fi([160],0),Fi([168],0),Fi(Ni(176),3,(function(){if(8&this.command)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=2,this.dma_channel=this.dma_channel_16bit,this.dma_autoinit=!!(4&this.command),this.dsp_signed=!!(16&t),this.dsp_stereo=!!(32&t),this.dsp_16bit=!0,this.dma_transfer_size_set(),this.dma_transfer_start()}})),Fi(Ni(192),3,(function(){if(8&this.command)this.dsp_default_handler();else{var t=this.write_buffer.shift();this.dma_irq=1,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!!(4&this.command),this.dsp_signed=!!(16&t),this.dsp_stereo=!!(32&t),this.dsp_16bit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}})),Fi([208],0,(function(){this.dma_paused=!0,this.bus.send("dac-disable")})),Fi([209],0,(function(){this.dummy_speaker_enabled=!0})),Fi([211],0,(function(){this.dummy_speaker_enabled=!1})),Fi([212],0,(function(){this.dma_paused=!1,this.bus.send("dac-enable")})),Fi([213],0,(function(){this.dma_paused=!0,this.bus.send("dac-disable")})),Fi([214],0,(function(){this.dma_paused=!1,this.bus.send("dac-enable")})),Fi([216],0,(function(){this.read_buffer.clear(),this.read_buffer.push(255*this.dummy_speaker_enabled)})),Fi([217,218],0,(function(){this.dma_autoinit=!1})),Fi([224],1,(function(){this.read_buffer.clear(),this.read_buffer.push(~this.write_buffer.shift())})),Fi([225],0,(function(){this.read_buffer.clear(),this.read_buffer.push(4),this.read_buffer.push(5)})),Fi([226],1),Fi([227],0,(function(){this.read_buffer.clear();for(var t=0;t<Ai.length;t++)this.read_buffer.push(Ai.charCodeAt(t));this.read_buffer.push(0)})),Fi([228],1,(function(){this.test_register=this.write_buffer.shift()})),Fi([232],0,(function(){this.read_buffer.clear(),this.read_buffer.push(this.test_register)})),Fi([242,243],0,(function(){this.raise_irq()}));var Bi=new Uint8Array(256);function Wi(t,e){e||(e=Mi.prototype.mixer_default_read),Ui[t]=e}function Gi(t,e){e||(e=Mi.prototype.mixer_default_write),Oi[t]=e}function ji(t,e,i){Pi[t]=1,Ui[t]=function(){return 240&this.mixer_registers[e]|this.mixer_registers[i]>>>4},Oi[t]=function(s){this.mixer_registers[t]=s;var r=s<<4&240|15&this.mixer_registers[i];this.mixer_write(e,240&s|15&this.mixer_registers[e]),this.mixer_write(i,r)}}function Vi(t,e,i){Ui[t]=Mi.prototype.mixer_default_read,Oi[t]=function(s){this.mixer_registers[t]=s,this.bus.send("mixer-volume",[e,i,(s>>>2)-62])}}function Hi(t,e){e||(e=Mi.prototype.fm_default_write);for(var i=0;i<t.length;i++)Li[t[i]]=e}function Ki(t,e){for(var i=[];t<=e;t++)i.push(t);return i}Bi[14]=255,Bi[15]=7,Bi[55]=56,Fi([249],1,(function(){var t=this.write_buffer.shift();us("dsp 0xf9: unknown function. input: "+t,v),this.read_buffer.clear(),this.read_buffer.push(Bi[t])})),Mi.prototype.mixer_read=function(t){var e=Ui[t];return e?e=e.call(this):(e=this.mixer_registers[t],us("unhandled mixer register read. addr:"+bt(t)+" data:"+bt(e),v)),e},Mi.prototype.mixer_write=function(t,e){var i=Oi[t];i?i.call(this,e):us("unhandled mixer register write. addr:"+bt(t)+" data:"+bt(e),v)},Mi.prototype.mixer_default_read=function(){return us("mixer register read. addr:"+bt(this.mixer_current_address),v),this.mixer_registers[this.mixer_current_address]},Mi.prototype.mixer_default_write=function(t){us("mixer register write. addr:"+bt(this.mixer_current_address)+" data:"+bt(t),v),this.mixer_registers[this.mixer_current_address]=t},Mi.prototype.mixer_reset=function(){this.mixer_registers[4]=204,this.mixer_registers[34]=204,this.mixer_registers[38]=204,this.mixer_registers[40]=0,this.mixer_registers[46]=0,this.mixer_registers[10]=0,this.mixer_registers[48]=192,this.mixer_registers[49]=192,this.mixer_registers[50]=192,this.mixer_registers[51]=192,this.mixer_registers[52]=192,this.mixer_registers[53]=192,this.mixer_registers[54]=0,this.mixer_registers[55]=0,this.mixer_registers[56]=0,this.mixer_registers[57]=0,this.mixer_registers[59]=0,this.mixer_registers[60]=31,this.mixer_registers[61]=21,this.mixer_registers[62]=11,this.mixer_registers[63]=0,this.mixer_registers[64]=0,this.mixer_registers[65]=0,this.mixer_registers[66]=0,this.mixer_registers[67]=0,this.mixer_registers[68]=128,this.mixer_registers[69]=128,this.mixer_registers[70]=128,this.mixer_registers[71]=128,this.mixer_full_update()},Mi.prototype.mixer_full_update=function(){for(var t=1;t<this.mixer_registers.length;t++)Pi[t]||this.mixer_write(t,this.mixer_registers[t])},Wi(0,(function(){return this.mixer_reset(),0})),Gi(0),ji(4,50,51),ji(34,48,49),ji(38,52,53),ji(40,54,55),ji(46,56,57),Vi(48,$,0),Vi(49,$,1),Vi(50,tt,0),Vi(51,tt,1),Wi(59),Gi(59,(function(t){this.mixer_registers[59]=t,this.bus.send("mixer-volume",[Z,2,6*(t>>>6)-18])})),Wi(65),Gi(65,(function(t){this.mixer_registers[65]=t,this.bus.send("mixer-gain-left",6*(t>>>6))})),Wi(66),Gi(66,(function(t){this.mixer_registers[66]=t,this.bus.send("mixer-gain-right",6*(t>>>6))})),Wi(68),Gi(68,(function(t){this.mixer_registers[68]=t,t>>>=3,this.bus.send("mixer-treble-left",t-(16>t?14:16))})),Wi(69),Gi(69,(function(t){this.mixer_registers[69]=t,t>>>=3,this.bus.send("mixer-treble-right",t-(16>t?14:16))})),Wi(70),Gi(70,(function(t){this.mixer_registers[70]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))})),Wi(71),Gi(71,(function(t){this.mixer_registers[71]=t,t>>>=3,this.bus.send("mixer-bass-right",t-(16>t?14:16))})),Wi(128,(function(){switch(this.irq){case 2:return 1;case zi:return 2;case 7:return 4;case 10:return 8;default:return 0}})),Gi(128,(function(t){1&t&&(this.irq=2),2&t&&(this.irq=zi),4&t&&(this.irq=7),8&t&&(this.irq=10)})),Wi(129,(function(){var t=0;switch(this.dma_channel_8bit){case 0:t|=1;break;case Ci:t|=2;break;case 3:t|=8}switch(this.dma_channel_16bit){case Si:t|=32;break;case 6:t|=64;break;case 7:t|=128}return t})),Gi(129,(function(t){1&t&&(this.dma_channel_8bit=0),2&t&&(this.dma_channel_8bit=Ci),8&t&&(this.dma_channel_8bit=3),32&t&&(this.dma_channel_16bit=Si),64&t&&(this.dma_channel_16bit=6),128&t&&(this.dma_channel_16bit=7)})),Wi(130,(function(){for(var t=32,e=0;16>e;e++)t|=e*this.irq_triggered[e];return t})),Mi.prototype.fm_default_write=function(t,e,i){us("unhandled fm register write. addr:"+e+"|"+bt(i)+" data:"+bt(t),v)};var Xi=new Uint8Array(32);function Yi(t,e){return 18*t+Xi[e]}function Qi(t,e,i){return function(t,e,i){return(t<e)*e+(t>i)*i+(e<=t&&t<=i)*t}(t/e+i,-1,1)}Xi[0]=0,Xi[1]=1,Xi[2]=2,Xi[3]=3,Xi[4]=4,Xi[5]=5,Xi[8]=6,Xi[9]=7,Xi[10]=8,Xi[11]=9,Xi[12]=10,Xi[13]=11,Xi[16]=12,Xi[17]=13,Xi[18]=14,Xi[19]=15,Xi[20]=16,Xi[21]=17,Hi([1],(function(t,e,i){this.fm_waveform_select_enable[e]=1&t,this.fm_update_waveforms()})),Hi([2]),Hi([3]),Hi([4],(function(t,e,i){})),Hi([5],(function(t,e,i){0===e&&this.fm_default_write(t,e,i)})),Hi([8],(function(t,e,i){})),Hi(Ki(32,53),(function(t,e,i){Yi(e,i-32)})),Hi(Ki(64,85),(function(t,e,i){Yi(e,i-64)})),Hi(Ki(96,117),(function(t,e,i){Yi(e,i-96)})),Hi(Ki(128,149),(function(t,e,i){Yi(e,i-128)})),Hi(Ki(160,168),(function(t,e,i){})),Hi(Ki(176,184),(function(t,e,i){})),Hi([189],(function(t,e,i){})),Hi(Ki(192,200),(function(t,e,i){})),Hi(Ki(224,245),(function(t,e,i){Yi(e,i-224)})),Mi.prototype.fm_update_waveforms=function(){},Mi.prototype.sampling_rate_change=function(t){this.sampling_rate=t,this.bus.send("dac-tell-sampling-rate",t)},Mi.prototype.get_channel_count=function(){return this.dsp_stereo?2:1},Mi.prototype.dma_transfer_size_set=function(){this.dma_sample_count=1+(this.write_buffer.shift()<<0)+(this.write_buffer.shift()<<8)},Mi.prototype.dma_transfer_start=function(){us("begin dma transfer",v),this.bytes_per_sample=1,this.dsp_16bit&&(this.bytes_per_sample*=2),this.dma_bytes_count=this.dma_sample_count*this.bytes_per_sample,this.dma_bytes_block=1024*this.bytes_per_sample,this.dma_bytes_block=Math.min(Math.max(this.dma_bytes_count>>2&-4,32),this.dma_bytes_block),this.dma_waiting_transfer=!0,this.dma.channel_mask[this.dma_channel]||this.dma_on_unmask(this.dma_channel)},Mi.prototype.dma_on_unmask=function(t){t===this.dma_channel&&this.dma_waiting_transfer&&(this.dma_waiting_transfer=!1,this.dma_bytes_left=this.dma_bytes_count,this.dma_paused=!1,this.bus.send("dac-enable"))},Mi.prototype.dma_transfer_next=function(){us("dma transfering next block",v);var t=Math.min(this.dma_bytes_left,this.dma_bytes_block),e=Math.floor(t/this.bytes_per_sample);this.dma.do_write(this.dma_syncbuffer,0,t,this.dma_channel,(i=>{us("dma block transfer "+(i?"unsuccessful":"successful"),v),i||(this.dma_to_dac(e),this.dma_bytes_left-=t,this.dma_bytes_left||(this.raise_irq(this.dma_irq),this.dma_autoinit&&(this.dma_bytes_left=this.dma_bytes_count)))}))},Mi.prototype.dma_to_dac=function(t){for(var e=this.dsp_16bit?32767.5:127.5,i=this.dsp_signed?0:-1,s=this.dsp_stereo?1:2,r=this.dsp_16bit?this.dsp_signed?this.dma_buffer_int16:this.dma_buffer_uint16:this.dsp_signed?this.dma_buffer_int8:this.dma_buffer_uint8,a=0,n=0;n<t;n++)for(var o=Qi(r[n],e,i),h=0;h<s;h++)this.dac_buffers[a].push(o),a^=1;this.dac_send()},Mi.prototype.dac_handle_request=function(){!this.dma_bytes_left||this.dma_paused?this.dac_send():this.dma_transfer_next()},Mi.prototype.dac_send=function(){if(this.dac_buffers[0].length){var t=this.dac_buffers[0].shift_block(this.dac_buffers[0].length),e=this.dac_buffers[1].shift_block(this.dac_buffers[1].length);this.bus.send("dac-send-data",[t,e],[t.buffer,e.buffer])}},Mi.prototype.raise_irq=function(t){us("raise irq",v),this.irq_triggered[t]=1,this.cpu.device_raise_irq(this.irq)},Mi.prototype.lower_irq=function(t){us("lower irq",v),this.irq_triggered[t]=0,this.cpu.device_lower_irq(this.irq)};const Ji=6900,$i=28,Zi=29,ts=32,es=16,is=1,ss=2,rs=4;function as(t,e){for(var i of(this.cpu=t,this.pci=t.devices.pci,this.device_id=e.device_id,this.pci_space=[255&Ji,Ji>>8,255&e.device_id,e.device_id>>8,7,5,16,0,1,0,2,0,0,0,0,0,1,168,0,0,0,16,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255&Ji,Ji>>8,255&e.subsystem_device_id,e.subsystem_device_id>>8,0,0,0,0,64,0,0,0,0,0,0,0,0,1,0,0],this.pci_space=this.pci_space.concat(yt.zeros(256-this.pci_space.length)),this.pci_id=e.pci_id,this.pci_bars=[],this.name=e.name,this.driver_feature_select=this.device_feature_select=0,this.device_feature=new Uint32Array(4),this.driver_feature=new Uint32Array(4),e.common.features))ls(0<=i,"VirtIO device<"+this.name+"> feature bit numbers must be non-negative"),ls(128>i,"VirtIO device<"+this.name+"> feature bit numbers assumed less than 128 in implementation"),this.device_feature[i>>>5]|=1<<(31&i),this.driver_feature[i>>>5]|=1<<(31&i);for(var s of(ls(e.common.features.includes(ts),"VirtIO device<"+this.name+"> only non-transitional devices are supported"),this.features_ok=!0,this.device_status=0,this.config_has_changed=!1,this.config_generation=0,this.queues=[],e.common.queues))this.queues.push(new ns(t,this,s));if(this.queue_select=0,this.queue_selected=this.queues[0],this.isr_status=0,ot){for(var r of(i=new Set,this.queues.map((t=>t.notify_offset))))s=e.notification.single_handler?0:r,i.add(s),ls(e.notification.handlers[s],"VirtIO device<"+this.name+"> every queue's notifier must exist");for(const[t,s]of e.notification.handlers.entries())ls(!s||i.has(t),"VirtIO device<"+this.name+"> no defined notify handler should be unused")}(r=[]).push(this.create_common_capability(e.common)),r.push(this.create_notification_capability(e.notification)),r.push(this.create_isr_capability(e.isr_status)),e.device_specific&&r.push(this.create_device_specific_capability(e.device_specific)),this.init_capabilities(r),t.devices.pci.register_device(this),this.reset()}function ns(t,e,i){this.cpu=t,this.virtio=e,this.size_supported=this.size=i.size_supported,this.mask=this.size-1,this.enabled=!1,this.notify_offset=i.notify_offset,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.reset()}function os(t,e){this.cpu=t.cpu,this.virtio=t.virtio,this.head_idx=e,this.read_buffers=[],this.length_readable=this.read_buffer_offset=this.read_buffer_idx=0,this.write_buffers=[],this.length_writable=this.length_written=this.write_buffer_offset=this.write_buffer_idx=0;let i=t.desc_addr,s=0,r=t.size,a=!1;const n=this.virtio.is_feature_negotiated($i);for(us("<<< Descriptor chain start",y);;){const o=t.get_descriptor(i,e);if(us("descriptor: idx="+e+" addr="+bt(o.addr_high,8)+":"+bt(o.addr_low,8)+" len="+bt(o.len,8)+" flags="+bt(o.flags,4)+" next="+bt(o.next,4),y),n&&o.flags&rs)ot&&o.flags&is&&us("Driver bug: has set VIRTQ_DESC_F_NEXT flag in an indirect table descriptor",y),i=o.addr_low,s=e=0,r=o.len/es,us("start indirect",y);else{if(o.flags&ss)a=!0,this.write_buffers.push(o),this.length_writable+=o.len;else{if(a){us("Driver bug: readonly buffer after writeonly buffer within chain",y);break}this.read_buffers.push(o),this.length_readable+=o.len}if(s++,s>r){us("Driver bug: descriptor chain cycle detected",y);break}if(!(o.flags&is))break;e=o.next}}us("Descriptor chain end >>>",y)}as.prototype.create_common_capability=function(t){return{type:1,bar:0,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:4,name:"device_feature_select",read:()=>this.device_feature_select,write:t=>{this.device_feature_select=t}},{bytes:4,name:"device_feature",read:()=>this.device_feature[this.device_feature_select]||0,write:t=>{}},{bytes:4,name:"driver_feature_select",read:()=>this.driver_feature_select,write:t=>{this.driver_feature_select=t}},{bytes:4,name:"driver_feature",read:()=>this.driver_feature[this.driver_feature_select]||0,write:t=>{const e=this.device_feature[this.driver_feature_select];this.driver_feature_select<this.driver_feature.length&&(this.driver_feature[this.driver_feature_select]=t&e),this.features_ok=this.features_ok&&!(t&~e)}},{bytes:2,name:"msix_config",read:()=>(us("No msi-x capability supported.",y),65535),write:t=>{us("No msi-x capability supported.",y)}},{bytes:2,name:"num_queues",read:()=>this.queues.length,write:t=>{}},{bytes:1,name:"device_status",read:()=>this.device_status,write:e=>{0===e?(us("Reset device<"+this.name+">",y),this.reset()):us(128&e?"Warning: Device<"+this.name+"> status failed":"Device<"+this.name+"> status: "+(1&e?"ACKNOWLEDGE ":"")+(2&e?"DRIVER ":"")+(4&e?"DRIVER_OK":"")+(8&e?"FEATURES_OK ":"")+(64&e?"DEVICE_NEEDS_RESET":""),y),e&~this.device_status&4&&64&this.device_status&&this.notify_config_changes(),this.features_ok||(ot&&8&e&&us("Removing FEATURES_OK",y),e&=-9),this.device_status=e,e&~this.device_status&4&&t.on_driver_ok()}},{bytes:1,name:"config_generation",read:()=>this.config_generation,write:t=>{}},{bytes:2,name:"queue_select",read:()=>this.queue_select,write:t=>{this.queue_select=t,this.queue_select<this.queues.length?this.queues_selected=this.queues[this.queue_select]:this.queue_selected=null}},{bytes:2,name:"queue_size",read:()=>this.queue_selected?this.queue_selected.size:0,write:t=>{this.queue_selected&&(t&t-1&&(us("Warning: dev<"+this.name+"> Given queue size was not a power of 2. Rounding up to next power of 2.",y),t=1<<yt.int_log2(t-1)+1),t>this.queue_selected.size_supported&&(us("Warning: dev<"+this.name+"> Trying to set queue size greater than supported. Clamping to supported size.",y),t=this.queue_selected.size_supported),this.queue_selected.set_size(t))}},{bytes:2,name:"queue_msix_vector",read:()=>(us("No msi-x capability supported.",y),65535),write:t=>{us("No msi-x capability supported.",y)}},{bytes:2,name:"queue_enable",read:()=>this.queue_selected?0|this.queue_selected.enabled:0,write:t=>{this.queue_selected&&(1===t?this.queue_selected.is_configured()?this.queue_selected.enable():us("Driver bug: tried enabling unconfigured queue",y):0===t&&us("Driver bug: tried writing 0 to queue_enable",y))}},{bytes:2,name:"queue_notify_off",read:()=>this.queue_selected?this.queue_selected.notify_offset:0,write:t=>{}},{bytes:4,name:"queue_desc (low dword)",read:()=>this.queue_selected?this.queue_selected.desc_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.desc_addr=t)}},{bytes:4,name:"queue_desc (high dword)",read:()=>0,write:t=>{us("Warning: High dword of 64 bit queue_desc ignored",y)}},{bytes:4,name:"queue_avail (low dword)",read:()=>this.queue_selected?this.queue_selected.avail_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.avail_addr=t)}},{bytes:4,name:"queue_avail (high dword)",read:()=>0,write:t=>{us("Warning: High dword of 64 bit queue_avail ignored",y)}},{bytes:4,name:"queue_used (low dword)",read:()=>this.queue_selected?this.queue_selected.used_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.used_addr=t)}},{bytes:4,name:"queue_used (high dword)",read:()=>0,write:t=>{us("Warning: High dword of 64 bit queue_used ignored",y)}}]}},as.prototype.create_notification_capability=function(t){const e=[];let i;t.single_handler?(ls(1===t.handlers.length,"VirtIO device<"+this.name+"> too many notify handlers specified: expected single handler"),i=0):i=2;for(const[i,s]of t.handlers.entries())e.push({bytes:2,name:"notify"+i,read:()=>65535,write:s||(t=>{})});return{type:2,bar:1,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array([255&i,i>>8&255,i>>16&255,i>>24]),struct:e}},as.prototype.create_isr_capability=function(t){return{type:3,bar:2,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:1,name:"isr_status",read:()=>{const t=this.isr_status;return this.lower_irq(),t},write:t=>{}}]}},as.prototype.create_device_specific_capability=function(t){return ls(3&~t.offset,"VirtIO device<"+this.name+"> device specific cap offset must be 4-byte aligned"),{type:4,bar:3,port:t.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:t.struct}},as.prototype.init_capabilities=function(t){let e=this.pci_space[52]=64;var i=e;for(const r of t){e=(i=e)+(t=16+r.extra.length),ls(256>=e,"VirtIO device<"+this.name+"> can't fit all capabilities into 256byte configspace"),ls(0<=r.bar&&6>r.bar,"VirtIO device<"+this.name+"> capability invalid bar number");var s=r.struct.reduce(((t,e)=>t+e.bytes),0);s=16>(s+=r.offset)?16:1<<yt.int_log2(s-1)+1,ls(0==(r.port&s-1),"VirtIO device<"+this.name+"> capability port should be aligned to pci bar size"),this.pci_bars[r.bar]={size:s},this.pci_space[i]=9,this.pci_space[i+1]=e,this.pci_space[i+2]=t,this.pci_space[i+3]=r.type,this.pci_space[i+4]=r.bar,this.pci_space[i+5]=0,this.pci_space[i+6]=0,this.pci_space[i+7]=0,this.pci_space[i+8]=255&r.offset,this.pci_space[i+9]=r.offset>>>8&255,this.pci_space[i+10]=r.offset>>>16&255,this.pci_space[i+11]=r.offset>>>24,this.pci_space[i+12]=255&s,this.pci_space[i+13]=s>>>8&255,this.pci_space[i+14]=s>>>16&255,this.pci_space[i+15]=s>>>24;for(const[t,e]of r.extra.entries())this.pci_space[i+16+t]=e;i=16+4*r.bar,this.pci_space[i]=254&r.port|!r.use_mmio,this.pci_space[i+1]=r.port>>>8&255,this.pci_space[i+2]=r.port>>>16&255,this.pci_space[i+3]=r.port>>>24&255,i=r.port+r.offset;for(const e of r.struct){let a=e.read;if(t=e.write,ot&&(a=()=>{const t=e.read();return us("Device<"+this.name+"> cap["+r.type+"] read["+e.name+"] => "+bt(t,8*e.bytes),y),t},t=t=>{us("Device<"+this.name+"> cap["+r.type+"] write["+e.name+"] <= "+bt(t,8*e.bytes),y),e.write(t)}),r.use_mmio)ls(!1,"VirtIO device <"+this.name+"> mmio capability not implemented.");else{s=function(t){return us("Warning: 8-bit read from 16-bit virtio port",y),a(-2&t)>>((1&t)<<3)&255};const r=function(t){return us("Warning: 8-bit read from 32-bit virtio port",y),a(-4&t)>>((3&t)<<3)&255};switch(e.bytes){case 4:this.cpu.io.register_read(i,this,r,void 0,a),this.cpu.io.register_write(i,this,void 0,void 0,t);break;case 2:this.cpu.io.register_read(i,this,s,a),this.cpu.io.register_write(i,this,void 0,t);break;case 1:this.cpu.io.register_read(i,this,a),this.cpu.io.register_write(i,this,t);break;default:ls(!1,"VirtIO device <"+this.name+"> invalid capability field width of "+e.bytes+" bytes")}}i+=e.bytes}}ls(256>=e+(i=20),"VirtIO device<"+this.name+"> can't fit all capabilities into 256byte configspace"),this.pci_space[e]=9,this.pci_space[e+1]=0,this.pci_space[e+2]=i,this.pci_space[e+3]=5,this.pci_space[e+4]=0,this.pci_space[e+5]=0,this.pci_space[e+6]=0,this.pci_space[e+7]=0,this.pci_space[e+8]=0,this.pci_space[e+9]=0,this.pci_space[e+10]=0,this.pci_space[e+11]=0,this.pci_space[e+12]=0,this.pci_space[e+13]=0,this.pci_space[e+14]=0,this.pci_space[e+15]=0,this.pci_space[e+16]=0,this.pci_space[e+17]=0,this.pci_space[e+18]=0,this.pci_space[e+19]=0},as.prototype.get_state=function(){let t=[];return t[0]=this.device_feature_select,t[1]=this.driver_feature_select,t[2]=this.device_feature,t[3]=this.driver_feature,t[4]=this.features_ok,t[5]=this.device_status,t[6]=this.config_has_changed,t[7]=this.config_generation,t[8]=this.isr_status,t[9]=this.queue_select,t.concat(this.queues)},as.prototype.set_state=function(t){this.device_feature_select=t[0],this.driver_feature_select=t[1],this.device_feature=t[2],this.driver_feature=t[3],this.features_ok=t[4],this.device_status=t[5],this.config_has_changed=t[6],this.config_generation=t[7],this.isr_status=t[8],this.queue_select=t[9];let e=0;for(let i of t.slice(10))this.queues[e].set_state(i),e++;this.queue_selected=this.queues[this.queue_select]||null},as.prototype.reset=function(){this.driver_feature_select=this.device_feature_select=0,this.driver_feature.set(this.device_feature),this.features_ok=!0,this.queue_select=this.device_status=0,this.queue_selected=this.queues[0];for(const t of this.queues)t.reset();this.config_has_changed=!1,this.config_generation=0,this.lower_irq()},as.prototype.notify_config_changes=function(){this.config_has_changed=!0,4&this.device_status?this.raise_irq(2):ls(!1,"VirtIO device<"+this.name+"> attempted to notify driver before DRIVER_OK")},as.prototype.update_config_generation=function(){this.config_has_changed&&(this.config_generation++,this.config_generation&=255,this.config_has_changed=!1)},as.prototype.is_feature_negotiated=function(t){return 0<(this.driver_feature[t>>>5]&1<<(31&t))},as.prototype.needs_reset=function(){us("Device<"+this.name+"> experienced error - requires reset",y),this.device_status|=64,4&this.device_status&&this.notify_config_changes()},as.prototype.raise_irq=function(t){us("Raise irq "+bt(t),y),this.isr_status|=t,this.pci.raise_irq(this.pci_id)},as.prototype.lower_irq=function(){us("Lower irq ",y),this.isr_status=0,this.pci.lower_irq(this.pci_id)},ns.prototype.get_state=function(){const t=[];return t[0]=this.size,t[1]=this.size_supported,t[2]=this.enabled,t[3]=this.notify_offset,t[4]=this.desc_addr,t[5]=this.avail_addr,t[6]=this.avail_last_idx,t[7]=this.used_addr,t[8]=this.num_staged_replies,t},ns.prototype.set_state=function(t){this.size=t[0],this.size_supported=t[1],this.enabled=t[2],this.notify_offset=t[3],this.desc_addr=t[4],this.avail_addr=t[5],this.avail_last_idx=t[6],this.used_addr=t[7],this.num_staged_replies=t[8],this.mask=this.size-1},ns.prototype.reset=function(){this.enabled=!1,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.set_size(this.size_supported)},ns.prototype.is_configured=function(){return this.desc_addr&&this.avail_addr&&this.used_addr},ns.prototype.enable=function(){ls(this.is_configured(),"VirtQueue must be configured before enabled"),this.enabled=!0},ns.prototype.set_size=function(t){ls(0==(t&t-1),"VirtQueue size must be power of 2 or zero"),ls(t<=this.size_supported,"VirtQueue size must be within supported size"),this.size=t,this.mask=t-1},ns.prototype.count_requests=function(){return ls(this.avail_addr,"VirtQueue addresses must be configured before use"),this.avail_get_idx()-this.avail_last_idx&this.mask},ns.prototype.has_request=function(){return ls(this.avail_addr,"VirtQueue addresses must be configured before use"),(this.avail_get_idx()&this.mask)!==this.avail_last_idx},ns.prototype.pop_request=function(){ls(this.avail_addr,"VirtQueue addresses must be configured before use"),ls(this.has_request(),"VirtQueue must not pop nonexistent request");var t=this.avail_get_entry(this.avail_last_idx);return us("Pop request: avail_last_idx="+this.avail_last_idx+" desc_idx="+t,y),t=new os(this,t),this.avail_last_idx=this.avail_last_idx+1&this.mask,t},ns.prototype.push_reply=function(t){ls(this.used_addr,"VirtQueue addresses must be configured before use"),ls(this.num_staged_replies<this.size,"VirtQueue replies must not exceed queue size");const e=this.used_get_idx()+this.num_staged_replies&this.mask;us("Push reply: used_idx="+e+" desc_idx="+t.head_idx,y),this.used_set_entry(e,t.head_idx,t.length_written),this.num_staged_replies++},ns.prototype.flush_replies=function(){if(ls(this.used_addr,"VirtQueue addresses must be configured before use"),0===this.num_staged_replies)us("flush_replies: Nothing to flush",y);else{us("Flushing "+this.num_staged_replies+" replies",y);var t=this.used_get_idx()+this.num_staged_replies&65535;this.used_set_idx(t),this.num_staged_replies=0,this.virtio.is_feature_negotiated(Zi)?(this.avail_get_used_event(),this.virtio.raise_irq(1)):1&~this.avail_get_flags()&&this.virtio.raise_irq(1)}},ns.prototype.notify_me_after=function(t){ls(0<=t,"Must skip a non-negative number of requests"),t=this.avail_get_idx()+t&65535,this.used_set_avail_event(t)},ns.prototype.get_descriptor=function(t,e){return{addr_low:this.cpu.read32s(t+e*es),addr_high:this.cpu.read32s(t+e*es+4),len:this.cpu.read32s(t+e*es+8),flags:this.cpu.read16(t+e*es+12),next:this.cpu.read16(t+e*es+14)}},ns.prototype.avail_get_flags=function(){return this.cpu.read16(this.avail_addr)},ns.prototype.avail_get_idx=function(){return this.cpu.read16(this.avail_addr+2)},ns.prototype.avail_get_entry=function(t){return this.cpu.read16(this.avail_addr+4+2*t)},ns.prototype.avail_get_used_event=function(){return this.cpu.read16(this.avail_addr+4+2*this.size)},ns.prototype.used_get_flags=function(){return this.cpu.read16(this.used_addr)},ns.prototype.used_set_flags=function(t){this.cpu.write16(this.used_addr,t)},ns.prototype.used_get_idx=function(){return this.cpu.read16(this.used_addr+2)},ns.prototype.used_set_idx=function(t){this.cpu.write16(this.used_addr+2,t)},ns.prototype.used_set_entry=function(t,e,i){this.cpu.write32(this.used_addr+4+8*t,e),this.cpu.write32(this.used_addr+8+8*t,i)},ns.prototype.used_set_avail_event=function(t){this.cpu.write16(this.used_addr+4+8*this.size,t)},os.prototype.get_next_blob=function(t){let e=0,i=t.length;for(;i;){if(this.read_buffer_idx===this.read_buffers.length){us("Device<"+this.virtio.name+"> Read more than device-readable buffers has",y);break}var s=this.read_buffers[this.read_buffer_idx];const r=s.addr_low+this.read_buffer_offset;(s=s.len-this.read_buffer_offset)>i?(s=i,this.read_buffer_offset+=i):(this.read_buffer_idx++,this.read_buffer_offset=0),t.set(this.cpu.read_blob(r,s),e),e+=s,i-=s}return e},os.prototype.set_next_blob=function(t){let e=0,i=t.length;for(;i;){if(this.write_buffer_idx===this.write_buffers.length){us("Device<"+this.virtio.name+"> Write more than device-writable capacity",y);break}var s=this.write_buffers[this.write_buffer_idx];const r=s.addr_low+this.write_buffer_offset;(s=s.len-this.write_buffer_offset)>i?(s=i,this.write_buffer_offset+=i):(this.write_buffer_idx++,this.write_buffer_offset=0),this.cpu.write_blob(t.subarray(e,e+s),r),e+=s,i-=s}return this.length_written+=e,e};var hs={};function _s(){this.listeners={},this.pair=void 0}_s.prototype.register=function(t,e,i){var s=this.listeners[t];void 0===s&&(s=this.listeners[t]=[]),s.push({fn:e,this_value:i})},_s.prototype.unregister=function(t,e){var i=this.listeners[t];void 0!==i&&(this.listeners[t]=i.filter((function(t){return t.fn!==e})))},_s.prototype.send=function(t,e,i){if(this.pair&&void 0!==(t=this.pair.listeners[t]))for(i=0;i<t.length;i++){var s=t[i];s.fn.call(s.this_value,e)}},_s.prototype.send_async=function(t,e){ls(1===arguments.length||2===arguments.length),setTimeout(this.send.bind(this,t,e),0)},hs.create=function(){var t=new _s,e=new _s;return t.pair=e,e.pair=t,[t,e]};var ds=[];function cs(t){ht?ds.push(t,"\n"):console.log(t)}var us=function(){if(!ot)return function(){};var t=w.reduce((function(t,e){return t[e[0]]=e[1],t}),{}),e="",i=0;return function(s,r){if(ot&&(r=r||1)&dt){if((s="["+yt.pads(t[r]||"",4)+"] "+s)===e&&2048>++i)return;r=new Date,r=yt.pad0(r.getHours(),2)+":"+yt.pad0(r.getMinutes(),2)+":"+yt.pad0(r.getSeconds(),2)+"+"+yt.pad0(r.getMilliseconds(),3)+" ",i&&(cs(1===i?r+e:"Previous message repeated "+i+" times"),i=0),cs(r+s),e=s}}}();function ps(t){ot&&us(Error().stack,t)}function ls(t,e,i){ot&&(t||function(t){if(console.trace(),t)throw"Assert failed: "+t;throw"Assert failed"}(e))}function fs(t,e,i){this.next_tick_immediately=i,this.wm=e,this.wasm_patch(),this.create_jit_imports(),this.wasm_memory=e=this.wm.exports.memory,this.memory_size=yt.view(Uint32Array,e,812,1),this.mem8=new Uint8Array(0),this.mem32s=new Int32Array(this.mem8.buffer),this.segment_is_null=yt.view(Uint8Array,e,724,8),this.segment_offsets=yt.view(Int32Array,e,736,8),this.segment_limits=yt.view(Uint32Array,e,768,8),this.protected_mode=yt.view(Int32Array,e,800,1),this.idtr_size=yt.view(Int32Array,e,564,1),this.idtr_offset=yt.view(Int32Array,e,568,1),this.gdtr_size=yt.view(Int32Array,e,572,1),this.gdtr_offset=yt.view(Int32Array,e,576,1),this.tss_size_32=yt.view(Int32Array,e,1128,1),this.page_fault=yt.view(Uint32Array,e,540,8),this.cr=yt.view(Int32Array,e,580,8),this.cpl=yt.view(Uint8Array,e,612,1),this.is_32=yt.view(Int32Array,e,804,1),this.stack_size_32=yt.view(Int32Array,e,808,1),this.in_hlt=yt.view(Uint8Array,e,616,1),this.last_virt_eip=yt.view(Int32Array,e,620,1),this.eip_phys=yt.view(Int32Array,e,624,1),this.sysenter_cs=yt.view(Int32Array,e,636,1),this.sysenter_esp=yt.view(Int32Array,e,640,1),this.sysenter_eip=yt.view(Int32Array,e,644,1),this.prefixes=yt.view(Int32Array,e,648,1),this.flags=yt.view(Int32Array,e,120,1),this.flags_changed=yt.view(Int32Array,e,100,1),this.last_op_size=yt.view(Int32Array,e,96,1),this.last_op1=yt.view(Int32Array,e,104,1),this.last_result=yt.view(Int32Array,e,112,1),this.current_tsc=yt.view(Uint32Array,e,960,2),this.devices={},this.instruction_pointer=yt.view(Int32Array,e,556,1),this.previous_ip=yt.view(Int32Array,e,560,1),this.apic_enabled=yt.view(Uint8Array,e,548,1),this.acpi_enabled=yt.view(Uint8Array,e,552,1),this.memory_map_read8=[],this.memory_map_write8=[],this.memory_map_read32=[],this.memory_map_write32=[],this.bios={main:null,vga:null},this.instruction_counter=yt.view(Uint32Array,e,664,1),this.reg32=yt.view(Int32Array,e,64,8),this.fpu_st=yt.view(Int32Array,e,1152,32),this.fpu_stack_empty=yt.view(Uint8Array,e,816,1),this.fpu_stack_empty[0]=255,this.fpu_stack_ptr=yt.view(Uint8Array,e,1032,1),this.fpu_stack_ptr[0]=0,this.fpu_control_word=yt.view(Uint16Array,e,1036,1),this.fpu_control_word[0]=895,this.fpu_status_word=yt.view(Uint16Array,e,1040,1),this.fpu_status_word[0]=0,this.fpu_ip=yt.view(Int32Array,e,1048,1),this.fpu_ip[0]=0,this.fpu_ip_selector=yt.view(Int32Array,e,1052,1),this.fpu_ip_selector[0]=0,this.fpu_opcode=yt.view(Int32Array,e,1044,1),this.fpu_opcode[0]=0,this.fpu_dp=yt.view(Int32Array,e,1056,1),this.fpu_dp[0]=0,this.fpu_dp_selector=yt.view(Int32Array,e,1060,1),this.fpu_dp_selector[0]=0,this.reg_xmm32s=yt.view(Int32Array,e,832,32),this.mxcsr=yt.view(Int32Array,e,824,1),this.sreg=yt.view(Uint16Array,e,668,8),this.dreg=yt.view(Int32Array,e,684,8),this.reg_pdpte=yt.view(Int32Array,e,968,8),this.svga_dirty_bitmap_min_offset=yt.view(Uint32Array,e,716,1),this.svga_dirty_bitmap_max_offset=yt.view(Uint32Array,e,720,1),this.fw_value=[],this.fw_pointer=0,this.option_roms=[],this.io=void 0,this.bus=t,this.set_tsc(0,0),this.debug_init(),ot&&(this.do_many_cycles_total=this.do_many_cycles_count=0,this.seen_code={},this.seen_code_uncompiled={})}fs.prototype.clear_opstats=function(){new Uint8Array(this.wasm_memory.buffer,32768,131072).fill(0),this.wm.exports.profiler_init()},fs.prototype.create_jit_imports=function(){const t=Object.create(null);t.m=this.wm.exports.memory;for(let e of Object.keys(this.wm.exports))e.startsWith("_")||e.startsWith("zstd")||e.endsWith("_js")||(t[e]=this.wm.exports[e]);this.jit_imports=t},fs.prototype.wasm_patch=function(){const t=t=>this.wm.exports[t],e=e=>{const i=t(e);return console.assert(i,"Missing import: "+e),i};this.reset_cpu=e("reset_cpu"),this.getiopl=e("getiopl"),this.get_eflags=e("get_eflags"),this.get_eflags_no_arith=e("get_eflags_no_arith"),this.pic_call_irq=e("pic_call_irq"),this.do_many_cycles_native=e("do_many_cycles_native"),this.cycle_internal=e("cycle_internal"),this.read8=e("read8"),this.read16=e("read16"),this.read32s=e("read32s"),this.write8=e("write8"),this.write16=e("write16"),this.write32=e("write32"),this.in_mapped_range=e("in_mapped_range"),this.fpu_load_tag_word=e("fpu_load_tag_word"),this.fpu_load_status_word=e("fpu_load_status_word"),this.fpu_get_sti_f64=e("fpu_get_sti_f64"),this.translate_address_system_read=e("translate_address_system_read_js"),this.get_seg_cs=e("get_seg_cs"),this.get_real_eip=e("get_real_eip"),this.clear_tlb=e("clear_tlb"),this.full_clear_tlb=e("full_clear_tlb"),this.update_state_flags=e("update_state_flags"),this.set_tsc=e("set_tsc"),this.store_current_tsc=e("store_current_tsc"),this.set_cpuid_level=e("set_cpuid_level"),ot&&(this.jit_force_generate_unsafe=t("jit_force_generate_unsafe")),this.jit_clear_cache=e("jit_clear_cache_js"),this.jit_dirty_cache=e("jit_dirty_cache"),this.codegen_finalize_finished=e("codegen_finalize_finished"),this.allocate_memory=e("allocate_memory"),this.zero_memory=e("zero_memory"),this.svga_allocate_memory=e("svga_allocate_memory"),this.svga_allocate_dest_buffer=e("svga_allocate_dest_buffer"),this.svga_fill_pixel_buffer=e("svga_fill_pixel_buffer"),this.svga_mark_dirty=e("svga_mark_dirty"),this.zstd_create_ctx=e("zstd_create_ctx"),this.zstd_get_src_ptr=e("zstd_get_src_ptr"),this.zstd_free_ctx=e("zstd_free_ctx"),this.zstd_read=e("zstd_read"),this.zstd_read_free=e("zstd_read_free")},fs.prototype.jit_force_generate=function(t){this.jit_force_generate_unsafe?this.jit_force_generate_unsafe(t):ls(!1,"Not supported in this wasm build: jit_force_generate_unsafe")},fs.prototype.jit_clear_func=function(t){ls(0<=t&&t<Q),this.wm.wasm_table.set(t+J,null)},fs.prototype.jit_clear_all_funcs=function(){const t=this.wm.wasm_table;for(let e=0;e<Q;e++)t.set(J+e,null)},fs.prototype.get_state=function(){var t=[];t[0]=this.memory_size[0],t[1]=this.segment_is_null,t[2]=this.segment_offsets,t[3]=this.segment_limits,t[4]=this.protected_mode[0],t[5]=this.idtr_offset[0],t[6]=this.idtr_size[0],t[7]=this.gdtr_offset[0],t[8]=this.gdtr_size[0],t[9]=this.page_fault[0],t[10]=this.cr,t[11]=this.cpl[0],t[13]=this.is_32[0],t[16]=this.stack_size_32[0],t[17]=this.in_hlt[0],t[18]=this.last_virt_eip[0],t[19]=this.eip_phys[0],t[22]=this.sysenter_cs[0],t[23]=this.sysenter_eip[0],t[24]=this.sysenter_esp[0],t[25]=this.prefixes[0],t[26]=this.flags[0],t[27]=this.flags_changed[0],t[28]=this.last_op1[0],t[30]=this.last_op_size[0],t[37]=this.instruction_pointer[0],t[38]=this.previous_ip[0],t[39]=this.reg32,t[40]=this.sreg,t[41]=this.dreg,t[42]=this.reg_pdpte,this.store_current_tsc(),t[43]=this.current_tsc,t[45]=this.devices.virtio_9p,t[46]=this.devices.apic,t[47]=this.devices.rtc,t[48]=this.devices.pci,t[49]=this.devices.dma,t[50]=this.devices.acpi,t[51]=this.devices.hpet,t[52]=this.devices.vga,t[53]=this.devices.ps2,t[54]=this.devices.uart0,t[55]=this.devices.fdc,t[56]=this.devices.cdrom,t[57]=this.devices.hda,t[58]=this.devices.pit,t[59]=this.devices.net,t[60]=this.devices.pic,t[61]=this.devices.sb16,t[62]=this.fw_value,t[63]=this.devices.ioapic,t[64]=this.tss_size_32[0],t[66]=this.reg_xmm32s,t[67]=this.fpu_st,t[68]=this.fpu_stack_empty[0],t[69]=this.fpu_stack_ptr[0],t[70]=this.fpu_control_word[0],t[71]=this.fpu_ip[0],t[72]=this.fpu_ip_selector[0],t[73]=this.fpu_dp[0],t[74]=this.fpu_dp_selector[0],t[75]=this.fpu_opcode[0];const{packed_memory:e,bitmap:i}=this.pack_memory();return t[77]=e,t[78]=new Uint8Array(i.get_buffer()),t[79]=this.devices.uart1,t[80]=this.devices.uart2,t[81]=this.devices.uart3,t},fs.prototype.set_state=function(t){this.memory_size[0]=t[0],this.mem8.length!==this.memory_size[0]&&console.warn("Note: Memory size mismatch. we="+this.mem8.length+" state="+this.memory_size[0]),this.segment_is_null.set(t[1]),this.segment_offsets.set(t[2]),this.segment_limits.set(t[3]),this.protected_mode[0]=t[4],this.idtr_offset[0]=t[5],this.idtr_size[0]=t[6],this.gdtr_offset[0]=t[7],this.gdtr_size[0]=t[8],this.page_fault[0]=t[9],this.cr.set(t[10]),this.cpl[0]=t[11],this.is_32[0]=t[13],this.stack_size_32[0]=t[16],this.in_hlt[0]=t[17],this.last_virt_eip[0]=t[18],this.eip_phys[0]=t[19],this.sysenter_cs[0]=t[22],this.sysenter_eip[0]=t[23],this.sysenter_esp[0]=t[24],this.prefixes[0]=t[25],this.flags[0]=t[26],this.flags_changed[0]=t[27],this.last_op1[0]=t[28],this.last_op_size[0]=t[30],this.instruction_pointer[0]=t[37],this.previous_ip[0]=t[38],this.reg32.set(t[39]),this.sreg.set(t[40]),this.dreg.set(t[41]),t[42]&&this.reg_pdpte.set(t[42]),this.set_tsc(t[43][0],t[43][1]),this.devices.virtio_9p&&this.devices.virtio_9p.set_state(t[45]),this.devices.apic&&this.devices.apic.set_state(t[46]),this.devices.rtc&&this.devices.rtc.set_state(t[47]),this.devices.pci&&this.devices.pci.set_state(t[48]),this.devices.dma&&this.devices.dma.set_state(t[49]),this.devices.acpi&&this.devices.acpi.set_state(t[50]),this.devices.hpet&&this.devices.hpet.set_state(t[51]),this.devices.vga&&this.devices.vga.set_state(t[52]),this.devices.ps2&&this.devices.ps2.set_state(t[53]),this.devices.uart0&&this.devices.uart0.set_state(t[54]),this.devices.fdc&&this.devices.fdc.set_state(t[55]),this.devices.cdrom&&this.devices.cdrom.set_state(t[56]),this.devices.hda&&this.devices.hda.set_state(t[57]),this.devices.pit&&this.devices.pit.set_state(t[58]),this.devices.net&&this.devices.net.set_state(t[59]),this.devices.pic&&this.devices.pic.set_state(t[60]),this.devices.sb16&&this.devices.sb16.set_state(t[61]),this.devices.uart1&&this.devices.uart1.set_state(t[79]),this.devices.uart2&&this.devices.uart2.set_state(t[80]),this.devices.uart3&&this.devices.uart3.set_state(t[81]),this.fw_value=t[62],this.devices.ioapic&&this.devices.ioapic.set_state(t[63]),this.tss_size_32[0]=t[64],this.reg_xmm32s.set(t[66]),this.fpu_st.set(t[67]),this.fpu_stack_empty[0]=t[68],this.fpu_stack_ptr[0]=t[69],this.fpu_control_word[0]=t[70],this.fpu_ip[0]=t[71],this.fpu_ip_selector[0]=t[72],this.fpu_dp[0]=t[73],this.fpu_dp_selector[0]=t[74],this.fpu_opcode[0]=t[75];const e=new yt.Bitmap(t[78].buffer);this.unpack_memory(e,t[77]),this.update_state_flags(),this.full_clear_tlb(),this.jit_clear_cache()},fs.prototype.pack_memory=function(){ls(0==(4095&this.mem8.length));for(var t=this.mem8.length>>12,e=[],i=0;i<t;i++){var s=i<<12;s=this.mem32s.subarray(s>>2,s+4096>>2);let t=!0;for(let e=0;e<s.length;e++)if(0!==s[e]){t=!1;break}t||e.push(i)}t=new yt.Bitmap(t),i=new Uint8Array(e.length<<12);for(let[s,r]of e.entries())t.set(r,1),e=r<<12,e=this.mem8.subarray(e,e+4096),i.set(e,s<<12);return{bitmap:t,packed_memory:i}},fs.prototype.unpack_memory=function(t,e){this.zero_memory(this.memory_size[0]);const i=this.memory_size[0]>>12;let s=0;for(let a=0;a<i;a++)if(t.get(a)){var r=s<<12;r=e.subarray(r,r+4096),this.mem8.set(r,a<<12),s++}},fs.prototype.main_run=function(){if(this.in_hlt[0]){var t=this.hlt_loop();if(this.in_hlt[0])return t}let e=t=mt.microtick();for(;e-t<1;){this.do_many_cycles(),e=mt.microtick();const t=this.run_hardware_timers(e);if(this.handle_irqs(),this.in_hlt[0])return t}return 0},fs.prototype.reboot_internal=function(){this.reset_cpu(),this.fw_value=[],this.devices.virtio&&this.devices.virtio.reset(),this.load_bios()},fs.prototype.reset_memory=function(){this.mem8.fill(0)},fs.prototype.create_memory=function(t){1048576>t?t=1048576:0>(0|t)&&(t=Math.pow(2,31)-H),ls(0<(0|(t=1+(t-1|H-1)|0))),ls(0==(t&H-1)),console.assert(0===this.memory_size[0],"Expected uninitialised memory"),this.memory_size[0]=t;const e=this.allocate_memory(t);this.mem8=yt.view(Uint8Array,this.wasm_memory,e,t),this.mem32s=yt.view(Uint32Array,this.wasm_memory,e,t>>2)},gt.exportProperty(fs.prototype,"create_memory",fs.prototype.create_memory),fs.prototype.init=function(t,e){"number"==typeof t.log_level&&(dt=t.log_level),this.create_memory("number"==typeof t.memory_size?t.memory_size:67108864),t.cpuid_level&&this.set_cpuid_level(t.cpuid_level),this.acpi_enabled[0]=+t.acpi,this.reset_cpu();var i=new lt(this);if(this.io=i,this.bios.main=t.bios,this.bios.vga=t.vga_bios,this.load_bios(),t.bzimage){const{option_rom:e}=function(t,e,i,s){us("Trying to load kernel of size "+e.byteLength);var r=new Uint8Array(e);const a=new Uint16Array(e),n=new Uint32Array(e);var o=r[Ss]||4,h=a[Ds>>1];if(h!==$s)us("Bad checksum1: "+bt(h));else{if((h=a[Ts>>1]|a[Ts+2>>1]<<16)===Zs){ls(514<=(h=a[Us>>1]));var _=r[Ps];ls(_&er);var d=a[Hs>>1],c=n[Ws>>2],u=n[Gs>>2],p=r[js],l=r[Vs],f=n[Ks>>2],m=n[Xs>>2],g=n[Ys>>2],y=n[Qs>>2],b=n[Qs+4>>2],v=n[Js>>2];for(us("kernel boot protocol version: "+bt(h)),us("flags="+bt(_)+" xflags="+bt(d)),us("code32_start="+bt(n[Ls>>2])),us("initrd_addr_max="+bt(c)),us("kernel_alignment="+bt(u)),us("relocatable="+p),us("min_alignment="+bt(l)),us("cmdline max="+bt(f)),us("payload offset="+bt(m)+" size="+bt(g)),us("pref_address="+bt(b)+":"+bt(y)),us("init_size="+bt(v)),r[Os]=tr,r[Ps]=_&~ir&~sr|rr,a[Ns>>1]=56832,a[zs>>1]=65535,us("heap_end_ptr="+bt(56832)),ls((s+="\0").length<f),us("cmd_line_ptr="+bt(581632)),n[Bs>>2]=581632,r=0;r<s.length;r++)t[581632+r]=s.charCodeAt(r);return us("prot_mode_kernel_start="+bt(o=512*(o+1))),s=new Uint8Array(e,0,o),e=new Uint8Array(e,o),r=o=0,i&&(o=67108864,r=i.byteLength,ls(1048576+e.length<o),t.set(new Uint8Array(i),o)),n[Ms>>2]=o,n[Fs>>2]=r,ls(655360>524288+s.length),t.set(s,524288),t.set(e,1048576),{option_rom:{name:"genroms/kernel.bin",data:ar(32768,57344)}}}us("Bad checksum2: "+bt(h))}}(this.mem8,t.bzimage,t.initrd,t.cmdline||"");e&&this.option_roms.push(e)}i.register_read(179,this,(function(){return us("port 0xB3 read"),0}));var s=0;i.register_read(146,this,(function(){return s})),i.register_write(146,this,(function(t){s=t})),i.register_read(1297,this,(function(){return this.fw_pointer<this.fw_value.length?this.fw_value[this.fw_pointer++]:(ls(!1,"config port: Read past value"),0)})),i.register_write(1296,this,void 0,(function(t){function e(t){return new Uint8Array(new Int32Array([t]).buffer)}function i(t){return t>>8|t<<8&65280}function s(t){return t<<24|t<<8&16711680|t>>8&65280|t>>>24}if(us("bios config port, index="+bt(t)),this.fw_pointer=0,0===t)this.fw_value=e(1431127377);else if(1===t)this.fw_value=e(0);else if(3===t)this.fw_value=e(this.memory_size[0]);else if(5===t)this.fw_value=e(1);else if(15===t)this.fw_value=e(1);else if(13===t)this.fw_value=new Uint8Array(16);else if(25===t){t=new Int32Array(4+64*this.option_roms.length);const e=new Uint8Array(t.buffer);t[0]=s(this.option_roms.length);for(let r=0;r<this.option_roms.length;r++){const{name:a,data:n}=this.option_roms[r],o=4+64*r;ls(65536>Y+r),t[o+0>>2]=s(n.length),t[o+4>>2]=i(Y+r),ls(56>a.length);for(let t=0;t<a.length;t++)e[o+8+t]=a.charCodeAt(t)}this.fw_value=e}else t>=32768&&t<Y?this.fw_value=e(0):t>=Y&&t-Y<this.option_roms.length?this.fw_value=this.option_roms[t-Y].data:(us("Warning: Unimplemented fw index: "+bt(t)),this.fw_value=e(0))})),ot&&(i.register_write(128,this,(function(t){})),i.register_read(128,this,(function(){return 255})),i.register_write(233,this,(function(t){}))),this.devices={},t.load_devices&&(this.devices.pic=new Ht(this),this.devices.pci=new St(this),this.acpi_enabled[0]&&(this.devices.ioapic=new De(this),this.devices.apic=new be(this),this.devices.acpi=new fe(this)),this.devices.rtc=new Jt(this),this.fill_cmos(this.devices.rtc,t),this.devices.dma=new Dt(this),ut&&(this.devices.hpet=new le(this)),this.devices.vga=new Gt(this,e,t.vga_memory_size||8388608),this.devices.ps2=new jt(this,e),this.devices.uart0=new ne(this,1016,e),t.uart1&&(this.devices.uart1=new ne(this,760,e)),t.uart2&&(this.devices.uart2=new ne(this,1e3,e)),t.uart3&&(this.devices.uart3=new ne(this,744,e)),this.devices.fdc=new zt(this,t.fda,t.fdb),i=0,t.hda&&(this.devices.hda=new Et(this,t.hda,t.hdb,!1,i++,e)),t.cdrom&&(this.devices.cdrom=new Et(this,t.cdrom,void 0,!0,i++,e)),this.devices.pit=new Ut(this,e),t.enable_ne2k&&(this.devices.net=new xi(this,e,t.preserve_mac_from_state_image,t.mac_address_translation)),t.fs9p&&(this.devices.virtio_9p=new nt(t.fs9p,this,e)),this.devices.sb16=new Mi(this,e)),t.multiboot&&this.load_multiboot(t.multiboot),ot&&this.debug.init()},fs.prototype.load_multiboot=function(t){if(us("Trying multiboot from buffer of size "+t.byteLength,e),8192>t.byteLength){var i=new Int32Array(2048);new Uint8Array(i.buffer).set(new Uint8Array(t))}else i=new Int32Array(t,0,2048);for(var s=0;8192>s;s+=4)if(464367618===i[s>>2]){var r=i[s+4>>2];if(!(464367618+r+i[s+8>>2]|0)){us("Multiboot magic found, flags: "+bt(r>>>0,8),e),ls(0==(-65537&r),"TODO"),this.reg32[z]=732803074,this.reg32[U]=31744,this.write32(31744,0),this.cr[0]=1,this.protected_mode[0]=1,this.flags[0]=2,this.is_32[0]=1,this.stack_size_32[0]=1;for(var a=0;6>a;a++)this.segment_is_null[a]=0,this.segment_offsets[a]=0,this.segment_limits[a]=4294967295,this.sreg[a]=45058;if(65536&r){us("Multiboot specifies its own address table",e),a=i[s+12>>2];var n=i[s+16>>2];r=i[s+20>>2];var o=i[s+24>>2];i=i[s+28>>2],us("header="+bt(a,8)+" load="+bt(n,8)+" load_end="+bt(r,8)+" bss_end="+bt(o,8)+" entry="+bt(i,8)),ls(n<=a),s-=a-n,0===r?r=void 0:(ls(r>=n),r-=n),t=new Uint8Array(t,s,r),this.write_blob(t,n),this.instruction_pointer[0]=this.get_seg_cs()+i|0}else if(1179403647===i[0])for(n of(us("Multiboot image is in elf format",e),s=Es(t),this.instruction_pointer[0]=this.get_seg_cs()+s.header.entry|0,s.program_headers))0!==n.type&&(1===n.type?(ls(n.paddr===n.vaddr),ls(n.filesz<=n.memsz),n.paddr+n.memsz<this.memory_size[0]?n.filesz&&(s=new Uint8Array(t,n.offset,n.filesz),this.write_blob(s,n.paddr)):us("Warning: Skipped loading section, paddr="+bt(n.paddr)+" memsz="+n.memsz,e)):2!==n.type&&3!==n.type&&4!==n.type&&6!==n.type&&1685382480!==n.type&&1685382481!==n.type&&1685382483!==n.type&&ls(!1,"unimplemented elf section type: "+bt(n.type)));else ls(!1,"Not a bootable multiboot format");this.io.register_write_consecutive(244,this,(function(t){throw console.log("Test exited with code "+bt(t,2)),"HALT"}),(function(){}),(function(){}),(function(){}));for(let h=0;15>=h;h++){function _(t){us("kvm-unit-test: Set irq "+bt(h)+" to "+bt(t,2)),t?this.device_raise_irq(h):this.device_lower_irq(h)}this.io.register_write(8192+h,this,_,_,_)}this.update_state_flags(),us("Starting multiboot kernel at:",e),this.debug.dump_state(),this.debug.dump_regs();break}us("Multiboot checksum check failed",e)}},fs.prototype.fill_cmos=function(t,e){var i=e.boot_order||531;t.cmos_write(56,1|i>>4&240),t.cmos_write(61,255&i),t.cmos_write(21,128),t.cmos_write(22,2),i=0,1048576<=this.memory_size[0]&&(i=this.memory_size[0]-1048576>>10,i=Math.min(i,65535)),t.cmos_write(23,255&i),t.cmos_write(24,i>>8&255),t.cmos_write(48,255&i),t.cmos_write(49,i>>8&255),i=0,16777216<=this.memory_size[0]&&(i=this.memory_size[0]-16777216>>16,i=Math.min(i,65535)),t.cmos_write(52,255&i),t.cmos_write(53,i>>8&255),t.cmos_write(91,0),t.cmos_write(92,0),t.cmos_write(93,0),t.cmos_write(20,47),t.cmos_write(95,0),e.fastboot&&t.cmos_write(63,1)},fs.prototype.load_bios=function(){var t=this.bios.main,e=this.bios.vga;if(t){var i=new Uint8Array(t);if(this.write_blob(i,1048576-t.byteLength),e){var s=new Uint8Array(e);this.write_blob(s,786432),this.io.mmap_register(4272947200,1048576,(function(t){return(t=t-4272947200|0)<s.length?s[t]:0}),(function(t,e){ls(!1,"Unexpected write to VGA rom")}))}else us("Warning: No VGA BIOS");this.io.mmap_register(4293918720,1048576,function(t){return this.mem8[1048575&t]}.bind(this),function(t,e){this.mem8[1048575&t]=e}.bind(this))}else us("Warning: No BIOS")},fs.prototype.do_many_cycles=function(){if(ot)var t=mt.microtick();this.do_many_cycles_native(),ot&&(this.do_many_cycles_total+=mt.microtick()-t,this.do_many_cycles_count++)},fs.prototype.cycle=function(){this.cycle_internal()},gt.exportProperty(fs.prototype,"cycle",fs.prototype.cycle),fs.prototype.codegen_finalize=function(t,e,i,s,r){s>>>=0,r>>>=0,ls(0<=t&&t<Q);const a=new Uint8Array(this.wasm_memory.buffer,s,r);ot&&(this.seen_code[e]=(this.seen_code[e]||0)+1,this.test_hook_did_generate_wasm&&this.test_hook_did_generate_wasm(a)),s=WebAssembly.instantiate(a,{e:this.jit_imports}).then((s=>{this.wm.wasm_table.set(t+J,s.instance.exports.f),this.codegen_finalize_finished(t,e,i),this.test_hook_did_finalize_wasm&&this.test_hook_did_finalize_wasm(a)})),ot&&s.catch((t=>{throw console.log(t),t}))},fs.prototype.log_uncompiled_code=function(t,e){0},fs.prototype.dump_function_code=function(t,e){},fs.prototype.hlt_loop=function(){if(this.get_eflags_no_arith()&R){const t=this.run_hardware_timers(mt.microtick());return this.handle_irqs(),t}return 100},fs.prototype.run_hardware_timers=function(t){if(ut)var e=this.devices.pit.timer(t,this.devices.hpet.legacy_mode),i=this.devices.rtc.timer(t,this.devices.hpet.legacy_mode),s=this.devices.hpet.timer(t);else e=this.devices.pit.timer(t,!1),i=this.devices.rtc.timer(t,!1),s=100;let r=100,a=100;return this.acpi_enabled[0]&&(r=this.devices.acpi.timer(t),a=this.devices.apic.timer(t)),Math.min(e,i,s,r,a)},fs.prototype.hlt_op=function(){0==(this.get_eflags_no_arith()&R)&&this.bus.send("cpu-event-halt"),this.in_hlt[0]=1,this.hlt_loop()},fs.prototype.handle_irqs=function(){this.get_eflags_no_arith()&R&&(this.pic_acknowledge(),this.next_tick_immediately())},fs.prototype.pic_acknowledge=function(){ls(this.get_eflags_no_arith()&R),this.devices.pic&&this.devices.pic.acknowledge_irq(),this.devices.apic&&this.devices.apic.acknowledge_irq()},fs.prototype.device_raise_irq=function(t){ls(1===arguments.length),this.devices.pic&&this.devices.pic.set_irq(t),this.devices.ioapic&&this.devices.ioapic.set_irq(t)},fs.prototype.device_lower_irq=function(t){this.devices.pic&&this.devices.pic.clear_irq(t),this.devices.ioapic&&this.devices.ioapic.clear_irq(t)},"undefined"!=typeof window?window.CPU=fs:"undefined"!=typeof module&&void 0!==module.exports?module.exports.CPU=fs:"function"==typeof importScripts&&(self.CPU=fs),fs.prototype.debug_init=function(){function t(t){if(ot){for(var e=a.protected_mode[0]?"prot":"real",i=a.get_eflags(),s=a.getiopl(),r=a.cpl[0],n=bt(a.sreg[N],4)+":"+bt(a.get_real_eip()>>>0,8),o=bt(a.sreg[B],4)+":"+bt(a.reg32[F]>>>0,8),h=a.is_32[0]?"32":"16",_=a.flags[0]&R?1:0,d={[k]:"c",[x]:"p",[A]:"a",[q]:"z",[E]:"s",[I]:"t",[R]:"i",[C]:"d",[S]:"o"},c="",u=0;16>u;u++)d[1<<u]&&(c=i&1<<u?c+d[1<<u]:c+" ");return"mode="+e+"/"+h+" paging="+ +(0!=(a.cr[0]&K))+" pae="+ +(0!=(a.cr[4]&X))+" iopl="+s+" cpl="+r+" if="+_+" cs:eip="+n+" cs_off="+bt(a.get_seg_cs()>>>0,8)+" flgs="+bt(a.get_eflags()>>>0,6)+" ("+c+") ss:esp="+o+" ssize="+ +a.stack_size_32[0]+(t?" in "+t:"")}}function i(){if(ot){for(var t={eax:z,ecx:D,edx:T,ebx:U,esp:O,ebp:P,esi:L,edi:M},e="eax ecx edx ebx esp ebp esi edi".split(" "),i="",s="",r=0;4>r;r++)i+=e[r]+"="+bt(a.reg32[t[e[r]]]>>>0,8)+" ",s+=e[r+4]+"="+bt(a.reg32[t[e[r+4]]]>>>0,8)+" ";return[i+="  ds="+bt(a.sreg[W],4)+" es="+bt(a.sreg[F],4)+" fs="+bt(a.sreg[G],4),s+="  gs="+bt(a.sreg[j],4)+" cs="+bt(a.sreg[N],4)+" ss="+bt(a.sreg[B],4)]}}function s(t,e,i){if(ot){if(!(1&t))return!1;var s=128==(128&t);return{size:s,global:256==(256&t),accessed:32==(32&t),dirty:64==(64&t),cache_disable:16==(16&t),user:4==(4&t),read_write:2==(2&t),address:(s&&!i?t&(e?4292870144:4290772992):4294963200&t)>>>0}}}function r(t,e,i){if(ot)for(var r=e?512:1024,n=e?8:4,o=e?21:22,h=0;h<r;h++){var _=a.read32s(t+h*n),d=s(_,e,!0);if(d)if(_="",_+=d.size?"S ":"  ",_+=d.accessed?"A ":"  ",_+=d.cache_disable?"Cd ":"  ",_+=d.user?"U ":"  ",_+=d.read_write?"Rw ":"   ",d.size)us("=== "+bt(i+(h<<o)>>>0,8)+" -> "+bt(d.address>>>0,8)+" | "+_);else{us("=== "+bt(i+(h<<o)>>>0,8)+" | "+_);for(var c=0;c<r;c++){var u=d.address+c*n,p=s(_=a.read32s(u),e,!1);p&&(_="",_+=p.cache_disable?"Cd ":"   ",_+=p.user?"U ":"  ",_+=p.read_write?"Rw ":"   ",_+=p.global?"G ":"  ",_+=p.accessed?"A ":"  ",_+=p.dirty?"Di ":"   ",us("# "+bt(i+(h<<o|c<<12)>>>0,8)+" -> "+bt(p.address,8)+" | "+_+"        (at "+bt(u,8)+")"))}}}}var a=this,n={};let o,h,d;this.debug=n,n.init=function(){function t(t){10===t?(us(e,_),e=""):e+=String.fromCharCode(t)}if(ot&&a.io){var e="";a.io.register_write(1026,this,t),a.io.register_write(1280,this,t)}},n.get_regs_short=i,n.dump_regs=function(){if(ot){var t=i();us(t[0],e),us(t[1],e)}},n.get_state=t,n.dump_state=function(i){ot&&us(t(i),e)},n.dump_stack=function(t,e){if(ot){var i=a.reg32[O];for(us("========= STACK =========="),(e>=t||void 0===e)&&(t=5,e=-5);t>e;t--){var s="    ";t||(s="=>  "),s+=bt(t,2)+" | ",us(s+bt(i+4*t,8)+" | "+bt(a.read32s(i+4*t)>>>0))}}},n.dump_page_structures=function(){if(a.cr[4]&X){us("PAE enabled");for(var t=0;4>t;t++){var e=a.read32s(a.cr[3]+8*t);1&e&&r(4294963200&e,!0,t<<30)}}else us("PAE disabled"),r(a.cr[3],!1,0)},n.dump_gdt_ldt=function(){function t(t,e){for(var i=0;i<e;i+=8,t+=8){var s=a.read16(t+2)|a.read8(t+4)<<16|a.read8(t+7)<<24,r=a.read16(t)|(15&a.read8(t+6))<<16,n=a.read8(t+5),o=a.read8(t+6)>>4,h="",_=n>>5&3;h=128&n?h+" P ":h+"NP ",16&n?(h=4&o?h+"32b ":h+"16b ",8&n?(h+="X ",4&n&&(h+="C ")):h+="R ",h+="RW "):h+="sys: "+bt(15&n),8&o&&(r=r<<12|4095),us(bt(-8&i,4)+" "+bt(s>>>0,8)+" ("+bt(r>>>0,8)+" bytes) "+h+";  dpl = "+_+", a = "+n.toString(2)+", f = "+o.toString(2))}}ot&&(us("gdt: (len = "+bt(a.gdtr_size[0])+")"),t(a.translate_address_system_read(a.gdtr_offset[0]),a.gdtr_size[0]),us("\nldt: (len = "+bt(a.segment_limits[7])+")"),t(a.translate_address_system_read(a.segment_offsets[7]),a.segment_limits[7]))},n.dump_idt=function(){if(ot)for(var t=0;t<a.idtr_size[0];t+=8){var e=a.translate_address_system_read(a.idtr_offset[0]+t),i=a.read16(e)|a.read16(e+6)<<16,s=a.read16(e+2),r=(e=a.read8(e+5))>>5&3,n=5==(31&e)?"task gate ":14==(31&e)?"intr gate ":15==(31&e)?"trap gate ":"invalid   ";n=128&e?n+" P":n+"NP",us(bt(t>>3,4)+" "+bt(i>>>0,8)+", "+bt(s,4)+"; "+n+";  dpl = "+r+", t = "+e.toString(2))}},n.get_memory_dump=function(t,e){if(ot)return void 0===t?(t=0,e=a.memory_size[0]):void 0===e&&(e=t,t=0),a.mem8.slice(t,t+e).buffer},n.memory_hex_dump=function(t,e){if(ot){e=e||64;for(var i,s,r=0;r<e>>4;r++){i=bt(t+(r<<4),5)+"   ";for(var n=0;16>n;n++)i+=bt(s=a.read8(t+(r<<4)+n),2)+" ";for(i+="  ",n=0;16>n;n++)i+=33>(s=a.read8(t+(r<<4)+n))||126<s?".":String.fromCharCode(s);us(i)}}},n.used_memory_dump=function(){if(ot)for(var t,e=a.memory_size[0]/128/16|0,i=0;16>i;i++){t=bt(128*i*e,8)+" | ";for(var s=0;128>s;s++)t+=0<a.mem32s[(128*i+s)*e]?"X":" ";us(t)}},n.debug_interrupt=function(t){},n.dump_code=function(t,e,i){if(!h){if(void 0===o&&(o="function"==typeof require?require("./capstone-x86.min.js"):window.cs,void 0===o))return void us("Warning: Missing capstone library, disassembly not available");h=[new o.Capstone(o.ARCH_X86,o.MODE_16),new o.Capstone(o.ARCH_X86,o.MODE_32)]}try{h[t].disasm(e,i).forEach((function(t){us(bt(t.address>>>0)+": "+yt.pads(t.bytes.map((t=>bt(t,2).slice(-2))).join(" "),20)+" "+t.mnemonic+" "+t.op_str)})),us("")}catch(t){us("Could not disassemble: "+Array.from(e).map((t=>bt(t,2))).join(" "))}},n.dump_wasm=function(t){if(void 0!==d||(d="function"==typeof require?require("./libwabt.js"):new window.WabtModule,void 0!==d)){t=t.slice();try{var e=d.readWasm(t,{readDebugNames:!1});e.generateNames(),e.applyNames();const i=e.toText({foldExprs:!0,inlineExport:!0});us(i)}catch(e){var i=new Blob([t]),s=document.createElement("a");s.download="failed.wasm",s.href=window.URL.createObjectURL(i),s.dataset.downloadurl=["application/octet-stream",s.download,s.href].join(":"),s.click(),window.URL.revokeObjectURL(s.src),console.log(e.toString())}finally{e&&e.destroy()}}else us("Warning: Missing libwabt, wasm dump not available")}};const ms=1179403647;let gs=DataView.prototype,ys={size:1,get:gs.getUint8,set:gs.setUint8},bs={size:2,get:gs.getUint16,set:gs.setUint16},vs={size:4,get:gs.getUint32,set:gs.setUint32},ws=qs([{magic:vs},{class:ys},{data:ys},{version0:ys},{osabi:ys},{abiversion:ys},{pad0:(ks=7,{size:ks,get:t=>-1})},{type:bs},{machine:bs},{version1:vs},{entry:vs},{phoff:vs},{shoff:vs},{flags:vs},{ehsize:bs},{phentsize:bs},{phnum:bs},{shentsize:bs},{shnum:bs},{shstrndx:bs}]);var ks;console.assert(52===ws.reduce(((t,e)=>t+e.size),0));let xs=qs([{type:vs},{offset:vs},{vaddr:vs},{paddr:vs},{filesz:vs},{memsz:vs},{flags:vs},{align:vs}]);console.assert(32===xs.reduce(((t,e)=>t+e.size),0));let As=qs([{name:vs},{type:vs},{flags:vs},{addr:vs},{offset:vs},{size:vs},{link:vs},{info:vs},{addralign:vs},{entsize:vs}]);function qs(t){return t.map((function(t){var e=Object.keys(t);return console.assert(1===e.length),t=t[e=e[0]],console.assert(0<t.size),{name:e,type:t,size:t.size,get:t.get,set:t.set}}))}function Es(t){t=new DataView(t);let[e,i]=Is(t,ws);if(console.assert(52===i),ot)for(var s of Object.keys(e))us(s+": 0x"+(e[s].toString(16)>>>0));if(console.assert(e.magic===ms,"Bad magic"),console.assert(1===e.class,"Unimplemented: 64 bit elf"),console.assert(1===e.data,"Unimplemented: big endian"),console.assert(1===e.version0,"Bad version0"),console.assert(2===e.type,"Unimplemented type"),console.assert(1===e.version1,"Bad version1"),console.assert(52===e.ehsize,"Bad header size"),console.assert(32===e.phentsize,"Bad program header size"),console.assert(40===e.shentsize,"Bad section header size"),[s]=Rs(Cs(t,e.phoff,e.phentsize*e.phnum),xs,e.phnum),[t]=Rs(Cs(t,e.shoff,e.shentsize*e.shnum),As,e.shnum),ot&&dt){console.log("%d program headers:",s.length);for(let t of s)console.log("type=%s offset=%s vaddr=%s paddr=%s filesz=%s memsz=%s flags=%s align=%s",t.type.toString(16),t.offset.toString(16),t.vaddr.toString(16),t.paddr.toString(16),t.filesz.toString(16),t.memsz.toString(16),t.flags.toString(16),t.align.toString(16));console.log("%d program headers:",t.length);for(let e of t)console.log("name=%s type=%s flags=%s addr=%s offset=%s size=%s link=%s info=%s addralign=%s entsize=%s",e.name.toString(16),e.type.toString(16),e.flags.toString(16),e.addr.toString(16),e.offset.toString(16),e.size.toString(16),e.link.toString(16),e.info.toString(16),e.addralign.toString(16),e.entsize.toString(16))}return{header:e,program_headers:s,sections_headers:t}}function Is(t,e){let i={},s=0;for(let r of e)e=r.get.call(t,s,!0),console.assert(void 0===i[r.name]),i[r.name]=e,s+=r.size;return[i,s]}function Rs(t,e,i){let s=[],r=0;for(var a=0;a<i;a++){let[i,a]=Is(Cs(t,r),e);s.push(i),r+=a}return[s,r]}function Cs(t,e,i){return new DataView(t.buffer,t.byteOffset+e,i)}console.assert(40===As.reduce(((t,e)=>t+e.size),0));const Ss=497,zs=506,Ds=510,Ts=514,Us=518,Os=528,Ps=529,Ls=532,Ms=536,Fs=540,Ns=548,Bs=552,Ws=556,Gs=560,js=564,Vs=565,Hs=566,Ks=568,Xs=584,Ys=588,Qs=600,Js=608,$s=43605,Zs=1400005704,tr=255,er=1,ir=32,sr=64,rr=128;function ar(t,e){const i=new Uint8Array(256);new Uint16Array(i.buffer)[0]=43605,i[2]=1;var s=3;for(i[s++]=250,i[s++]=184,i[s++]=t>>0,i[s++]=t>>8,i[s++]=142,i[s++]=192,i[s++]=142,i[s++]=216,i[s++]=142,i[s++]=224,i[s++]=142,i[s++]=232,i[s++]=142,i[s++]=208,i[s++]=188,i[s++]=e>>0,i[s++]=e>>8,i[s++]=234,i[s++]=0,i[s++]=0,i[s++]=t+32>>0,i[s++]=t+32>>8,ls(512>s),e=i[t=s]=0,s=0;s<i.length;s++)e+=i[s];return i[t]=-e,i}var nr=42,or=128;function hr(t){function e(t){return!t.altKey&&o[56]&&a(56,!1),r(t,!1)}function i(t){return!t.altKey&&o[56]&&a(56,!1),r(t,!0)}function s(t){t=Object.keys(o);for(var e,i=0;i<t.length;i++)e=+t[i],o[e]&&a(e,!1);o={}}function r(t,e){var i;if((i=h.bus)&&(i=!(t.shiftKey&&t.ctrlKey&&(73===t.keyCode||74===t.keyCode||75===t.keyCode)||!h.emu_enabled)&&(!t.target||(t.target.classList.contains("phone_keyboard")||"INPUT"!==t.target.nodeName&&"TEXTAREA"!==t.target.nodeName))),i){if(void 0!==t.code&&void 0!==(i=u[t.code])||(i=_[t.keyCode]),i)return a(i,e,t.repeat),t.preventDefault&&t.preventDefault(),!1;console.log("Missing char in map: keyCode="+(t.keyCode||-1).toString(16)+" code="+t.code)}}function a(t,e,i){if(e)o[t]&&!i&&a(t,!1);else if(!o[t])return;(o[t]=e)||(t|=128),255<t?(n(t>>8),n(255&t)):n(t)}function n(t){h.bus.send("keyboard-code",t)}var o={},h=this;this.emu_enabled=!0;var _=new Uint16Array([0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,58,0,0,0,0,0,0,1,0,0,0,0,57,57417,57425,57423,57415,57419,57416,57421,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,39,0,13,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,57435,57436,57437,0,0,82,79,80,81,75,76,77,71,72,73,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,39,13,51,12,52,53,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,26,43,27,40,0,57435,57400,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),d={8:8,10:13,32:32,39:222,44:188,45:189,46:190,47:191,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,59:186,61:187,91:219,92:220,93:221,96:192,97:65,98:66,99:67,100:68,101:69,102:70,103:71,104:72,105:73,106:74,107:75,108:76,109:77,110:78,111:79,112:80,113:81,114:82,115:83,116:84,117:85,118:86,119:87,120:88,121:89,122:90},c={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,42:56,43:187,58:186,60:188,62:190,63:191,64:50,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,94:54,95:189,123:219,124:220,125:221,126:192},u={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,NumLock:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,IntlBackslash:86,F11:87,F12:88,NumpadEnter:57372,ControlRight:57373,NumpadDivide:57397,AltRight:57400,Home:57415,ArrowUp:57416,PageUp:57417,ArrowLeft:57419,ArrowRight:57421,End:57423,ArrowDown:57424,PageDown:57425,Insert:57426,Delete:57427,OSLeft:57435,OSRight:57436,ContextMenu:57437};this.bus=t,this.destroy=function(){"undefined"!=typeof window&&(window.removeEventListener("keyup",e,!1),window.removeEventListener("keydown",i,!1),window.removeEventListener("blur",s,!1))},this.init=function(){"undefined"!=typeof window&&(this.destroy(),window.addEventListener("keyup",e,!1),window.addEventListener("keydown",i,!1),window.addEventListener("blur",s,!1))},this.init(),this.simulate_press=function(t){r(t={keyCode:t},!0),r(t,!1)},this.simulate_char=function(t){var e=t.charCodeAt(0);e in d?this.simulate_press(d[e]):e in c?(n(nr),this.simulate_press(c[e]),n(nr|or)):console.log("ascii -> keyCode not found: ",e,t)}}function _r(t,e){function i(t){if(!f.enabled||!f.emu_enabled)return!1;var i,s=e||document.body;if(!(i=document.pointerLockElement))t:{for(t=t.target;t.parentNode;){if(t===s){i=!0;break t}t=t.parentNode}i=!1}return i}function s(t){i(t)&&(t=t.changedTouches)&&t.length&&(t=t[t.length-1],p=t.clientX,l=t.clientY)}function r(t){(d||u||c)&&(f.bus.send("mouse-click",[!1,!1,!1]),d=u=c=!1)}function a(t){if(f.bus&&i(t)&&f.is_running){var s=0,r=0,a=t.changedTouches;a?a.length&&(s=(a=a[a.length-1]).clientX-p,r=a.clientY-l,p=a.clientX,l=a.clientY,t.preventDefault()):"number"==typeof t.movementX?(s=t.movementX,r=t.movementY):"number"==typeof t.webkitMovementX?(s=t.webkitMovementX,r=t.webkitMovementY):"number"==typeof t.mozMovementX?(s=t.mozMovementX,r=t.mozMovementY):(s=t.clientX-p,r=t.clientY-l,p=t.clientX,l=t.clientY),f.bus.send("mouse-delta",[.15*s,-.15*r]),e&&f.bus.send("mouse-absolute",[t.pageX-e.offsetLeft,t.pageY-e.offsetTop,e.offsetWidth,e.offsetHeight])}}function n(t){i(t)&&h(t,!0)}function o(t){i(t)&&h(t,!1)}function h(t,e){f.bus&&(1===t.which?d=e:2===t.which?u=e:3===t.which?c=e:us("Unknown event.which: "+t.which),f.bus.send("mouse-click",[d,u,c]),t.preventDefault())}function _(t){if(i(t)){var e=t.wheelDelta||-t.detail;0>e?e=-1:0<e&&(e=1),f.bus.send("mouse-wheel",[e,0]),t.preventDefault()}}var d=!1,c=!1,u=!1,p=0,l=0,f=this;this.enabled=!1,this.emu_enabled=!0,this.bus=t,this.bus.register("mouse-enable",(function(t){this.enabled=t}),this),this.is_running=!1,this.bus.register("emulator-stopped",(function(){this.is_running=!1}),this),this.bus.register("emulator-started",(function(){this.is_running=!0}),this),this.destroy=function(){"undefined"!=typeof window&&(window.removeEventListener("touchstart",s,!1),window.removeEventListener("touchend",r,!1),window.removeEventListener("touchmove",a,!1),window.removeEventListener("mousemove",a,!1),window.removeEventListener("mousedown",n,!1),window.removeEventListener("mouseup",o,!1),window.removeEventListener("wheel",_,{passive:!1}))},this.init=function(){"undefined"!=typeof window&&(this.destroy(),window.addEventListener("touchstart",s,!1),window.addEventListener("touchend",r,!1),window.addEventListener("touchmove",a,!1),window.addEventListener("mousemove",a,!1),window.addEventListener("mousedown",n,!1),window.addEventListener("mouseup",o,!1),window.addEventListener("wheel",_,{passive:!1}))},this.init()}var dr=8e3;function cr(t){if("undefined"!=typeof window)if(window.AudioContext||window.webkitAudioContext){var e=window.AudioWorklet?fr:mr;this.bus=t,this.audio_context=window.AudioContext?new AudioContext:new webkitAudioContext,this.mixer=new ur(t,this.audio_context),this.pcspeaker=new lr(t,this.audio_context,this.mixer),this.dac=new e(t,this.audio_context,this.mixer),this.pcspeaker.start(),t.register("emulator-stopped",(function(){this.audio_context.suspend()}),this),t.register("emulator-started",(function(){this.audio_context.resume()}),this),t.register("speaker-confirm-initialized",(function(){t.send("speaker-has-initialized")}),this),t.send("speaker-has-initialized")}else console.warn("Web browser doesn't support Web Audio API")}function ur(t,e){function i(t){return function(e){t.gain.setValueAtTime(e,this.audio_context.currentTime)}}this.audio_context=e,this.sources=new Map,this.gain_right=this.gain_left=this.volume_right=this.volume_left=this.volume_both=1,this.node_treble_left=this.audio_context.createBiquadFilter(),this.node_treble_right=this.audio_context.createBiquadFilter(),this.node_treble_left.type="highshelf",this.node_treble_right.type="highshelf",this.node_treble_left.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_treble_right.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_bass_left=this.audio_context.createBiquadFilter(),this.node_bass_right=this.audio_context.createBiquadFilter(),this.node_bass_left.type="lowshelf",this.node_bass_right.type="lowshelf",this.node_bass_left.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_bass_right.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_gain_left=this.audio_context.createGain(),this.node_gain_right=this.audio_context.createGain(),this.node_merger=this.audio_context.createChannelMerger(2),this.input_left=this.node_treble_left,this.input_right=this.node_treble_right,this.node_treble_left.connect(this.node_bass_left),this.node_bass_left.connect(this.node_gain_left),this.node_gain_left.connect(this.node_merger,0,0),this.node_treble_right.connect(this.node_bass_right),this.node_bass_right.connect(this.node_gain_right),this.node_gain_right.connect(this.node_merger,0,1),this.node_merger.connect(this.audio_context.destination),t.register("mixer-connect",(function(t){this.connect_source(t[0],t[1])}),this),t.register("mixer-disconnect",(function(t){this.disconnect_source(t[0],t[1])}),this),t.register("mixer-volume",(function(t){var e=t[0],i=t[1];t=Math.pow(10,t[2]/20);var s=e===$?this:this.sources.get(e);void 0===s?ls(!1,"Mixer set volume - cannot set volume for undefined source: "+e):s.set_volume(t,i)}),this),t.register("mixer-gain-left",(function(t){this.gain_left=Math.pow(10,t/20),this.update()}),this),t.register("mixer-gain-right",(function(t){this.gain_right=Math.pow(10,t/20),this.update()}),this),t.register("mixer-treble-left",i(this.node_treble_left),this),t.register("mixer-treble-right",i(this.node_treble_right),this),t.register("mixer-bass-left",i(this.node_bass_left),this),t.register("mixer-bass-right",i(this.node_bass_right),this)}function pr(t,e,i,s){this.audio_context=t,this.connected_right=this.connected_left=!0,this.volume_right=this.volume_left=this.volume_both=this.gain_hidden=1,this.node_splitter=t.createChannelSplitter(2),this.node_gain_left=t.createGain(),this.node_gain_right=t.createGain(),e.connect(this.node_splitter),this.node_splitter.connect(this.node_gain_left,0),this.node_gain_left.connect(i),this.node_splitter.connect(this.node_gain_right,1),this.node_gain_right.connect(s)}function lr(t,e,i){this.node_oscillator=e.createOscillator(),this.node_oscillator.type="square",this.node_oscillator.frequency.setValueAtTime(440,e.currentTime),this.mixer_connection=i.add_source(this.node_oscillator,Z),this.mixer_connection.disconnect(),t.register("pcspeaker-enable",(function(){i.connect_source(Z)}),this),t.register("pcspeaker-disable",(function(){i.disconnect_source(Z)}),this),t.register("pcspeaker-update",(function(t){var i=t[1],s=0;3===t[0]&&(s=1e3*Tt/i,s=Math.min(s,this.node_oscillator.frequency.maxValue),s=Math.max(s,0)),this.node_oscillator.frequency.setValueAtTime(s,e.currentTime)}),this)}function fr(t,e,i){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=48e3;var s=(e=function(){function t(t){return 0===t?1:(t*=Math.PI,Math.sin(t)/t)}function e(){var t=Reflect.construct(AudioWorkletProcessor,[],e);return t.kernel_size=3,t.queue_data=Array(1024),t.queue_start=0,t.queue_end=0,t.queue_length=0,t.queue_size=t.queue_data.length,t.queued_samples=0,t.source_buffer_previous=i,t.source_buffer_current=i,t.source_samples_per_destination=1,t.source_block_start=0,t.source_time=0,t.source_offset=0,t.port.onmessage=e=>{switch(e.data.type){case"queue":t.queue_push(e.data.value);break;case"sampling-rate":t.source_samples_per_destination=e.data.value/sampleRate}},t}var i=[new Float32Array(256),new Float32Array(256)];Reflect.setPrototypeOf(e.prototype,AudioWorkletProcessor.prototype),Reflect.setPrototypeOf(e,AudioWorkletProcessor),e.prototype.process=e.prototype.process=function(t,e,i){for(t=0;t<e[0][0].length;t++){for(var s=i=0,r=this.source_offset+this.kernel_size,a=this.source_offset-this.kernel_size+1;a<=r;a++){var n=this.source_block_start+a;i+=this.get_sample(n,0)*this.kernel(this.source_time-a),s+=this.get_sample(n,1)*this.kernel(this.source_time-a)}(isNaN(i)||isNaN(s))&&(i=s=0,this.dbg_log("ERROR: NaN values! Ignoring for now.")),e[0][0][t]=i,e[0][1][t]=s,this.source_time+=this.source_samples_per_destination,this.source_offset=Math.floor(this.source_time)}return e=this.source_offset,e+=this.kernel_size+2,this.source_time-=this.source_offset,this.source_block_start+=this.source_offset,this.source_offset=0,this.ensure_enough_data(e),!0},e.prototype.kernel=function(e){return t(e)*t(e/this.kernel_size)},e.prototype.get_sample=function(t,e){return 0>t?(t+=this.source_buffer_previous[0].length,this.source_buffer_previous[e][t]):this.source_buffer_current[e][t]},e.prototype.ensure_enough_data=function(t){var e=this.source_buffer_current[0].length;e-this.source_block_start<t&&(this.prepare_next_buffer(),this.source_block_start-=e)},e.prototype.prepare_next_buffer=function(){256>this.queued_samples&&this.queue_length&&this.dbg_log("Not enough samples - should not happen during midway of playback"),this.source_buffer_previous=this.source_buffer_current,this.source_buffer_current=this.queue_shift();var t=this.source_buffer_current[0].length;if(256>t){for(var e=this.queue_start,i=0;256>t&&i<this.queue_length;)t+=this.queue_data[e][0].length,e=e+1&this.queue_size-1,i++;t=Math.max(t,256),(t=[new Float32Array(t),new Float32Array(t)])[0].set(this.source_buffer_current[0]),t[1].set(this.source_buffer_current[1]),e=this.source_buffer_current[0].length;for(var s=0;s<i;s++){var r=this.queue_shift();t[0].set(r[0],e),t[1].set(r[1],e),e+=r[0].length}this.source_buffer_current=t}this.pump()},e.prototype.pump=function(){1024>this.queued_samples/this.source_samples_per_destination&&this.port.postMessage({type:"pump"})},e.prototype.queue_push=function(t){this.queue_length<this.queue_size&&(this.queue_data[this.queue_end]=t,this.queue_end=this.queue_end+1&this.queue_size-1,this.queue_length++,this.queued_samples+=t[0].length,this.pump())},e.prototype.queue_shift=function(){if(!this.queue_length)return i;var t=this.queue_data[this.queue_start];return this.queue_data[this.queue_start]=null,this.queue_start=this.queue_start+1&this.queue_size-1,this.queue_length--,this.queued_samples-=t[0].length,t},e.prototype.dbg_log=function(t){ot&&this.port.postMessage({type:"debug-log",value:t})},registerProcessor("dac-processor",e)}.toString()).indexOf("{")+1,r=e.lastIndexOf("}");e=e.substring(s,r),ot&&(e="var DEBUG = true;\n"+e),e=new Blob([e],{type:"application/javascript"});var a=URL.createObjectURL(e);this.node_processor=null,this.node_output=this.audio_context.createGain(),this.audio_context.audioWorklet.addModule(a).then((()=>{URL.revokeObjectURL(a),this.node_processor=new AudioWorkletNode(this.audio_context,"dac-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2],parameterData:{},processorOptions:{}}),this.node_processor.port.postMessage({type:"sampling-rate",value:this.sampling_rate}),this.node_processor.port.onmessage=t=>{switch(t.data.type){case"pump":this.pump();break;case"debug-log":us("SpeakerWorkletDAC - Worklet: "+t.data.value)}},this.node_processor.connect(this.node_output)})),this.mixer_connection=i.add_source(this.node_output,tt),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",(function(t){this.queue(t)}),this),t.register("dac-enable",(function(t){this.enabled=!0}),this),t.register("dac-disable",(function(){this.enabled=!1}),this),t.register("dac-tell-sampling-rate",(function(t){ls(0<t,"Sampling rate should be nonzero"),this.sampling_rate=t,this.node_processor&&this.node_processor.port.postMessage({type:"sampling-rate",value:t})}),this),ot&&(this.debugger=new gr(this.audio_context,this.node_output))}function mr(t,e,i){this.bus=t,this.audio_context=e,this.enabled=!1,this.sampling_rate=22050,this.buffered_time=0,this.rate_ratio=1,this.node_lowpass=this.audio_context.createBiquadFilter(),this.node_lowpass.type="lowpass",this.node_output=this.node_lowpass,this.mixer_connection=i.add_source(this.node_output,tt),this.mixer_connection.set_gain_hidden(3),t.register("dac-send-data",(function(t){this.queue(t)}),this),t.register("dac-enable",(function(t){this.enabled=!0,this.pump()}),this),t.register("dac-disable",(function(){this.enabled=!1}),this),t.register("dac-tell-sampling-rate",(function(t){ls(0<t,"Sampling rate should be nonzero"),this.sampling_rate=t,this.rate_ratio=Math.ceil(dr/t),this.node_lowpass.frequency.setValueAtTime(t/2,this.audio_context.currentTime)}),this),ot&&(this.debugger=new gr(this.audio_context,this.node_output))}function gr(t,e){this.audio_context=t,this.node_source=e,this.node_processor=null,this.node_gain=this.audio_context.createGain(),this.node_gain.gain.setValueAtTime(0,this.audio_context.currentTime),this.node_gain.connect(this.audio_context.destination),this.is_active=!1,this.queued_history=[],this.output_history=[],this.queued=[[],[]],this.output=[[],[]]}function yr(t,e){function i(t){n.bus&&n.enabled&&(n.send_char(t.which),t.preventDefault())}function s(t){var e=t.which;8===e?(n.send_char(127),t.preventDefault()):9===e&&(n.send_char(9),t.preventDefault())}function r(t){if(n.enabled){for(var e=t.clipboardData.getData("text/plain"),i=0;i<e.length;i++)n.send_char(e.charCodeAt(i));t.preventDefault()}}function a(e){e.target!==t&&t.blur()}var n=this;this.enabled=!0,this.bus=e,this.text="",this.text_new_line=!1,this.last_update=0,this.bus.register("serial0-output-char",(function(t){this.show_char(t)}),this),this.destroy=function(){t.removeEventListener("keypress",i,!1),t.removeEventListener("keydown",s,!1),t.removeEventListener("paste",r,!1),window.removeEventListener("mousedown",a,!1)},this.init=function(){this.destroy(),t.style.display="block",t.addEventListener("keypress",i,!1),t.addEventListener("keydown",s,!1),t.addEventListener("paste",r,!1),window.addEventListener("mousedown",a,!1)},this.init(),this.show_char=function(t){"\b"===t?(this.text=this.text.slice(0,-1),this.update()):"\r"!==t&&(this.text+=t,"\n"===t&&(this.text_new_line=!0),this.update())},this.update=function(){var t=Date.now(),e=t-this.last_update;16>e?void 0===this.update_timer&&(this.update_timer=setTimeout((()=>{this.update_timer=void 0;var t=Date.now();ls(15<=t-this.last_update),this.last_update=t,this.render()}),16-e)):(void 0!==this.update_timer&&(clearTimeout(this.update_timer),this.update_timer=void 0),this.last_update=t,this.render())},this.render=function(){t.value=this.text,this.text_new_line&&(this.text_new_line=!1,t.scrollTop=1e9)},this.send_char=function(t){n.bus&&n.bus.send("serial0-input",t)}}function br(t,e){if(this.element=t,window.Terminal){var i=this.term=new window.Terminal;i.setOption("logLevel","off"),i.write("This is the serial console. Whatever you type or paste here will be sent to COM1");var s=i.onData((function(t){for(let i=0;i<t.length;i++)e.send("serial0-input",t.charCodeAt(i))}));e.register("serial0-output-char",(function(t){i.write(t)}),this),this.destroy=function(){s.dispose(),i.dispose()}}}function vr(t,e){this.bus=e,this.socket=void 0,this.send_queue=[],this.url=t,this.reconnect_interval=1e4,this.last_connect_attempt=Date.now()-this.reconnect_interval,this.send_queue_limit=64,this.bus.register("net0-send",(function(t){this.send(t)}),this)}function wr(t){this.cpu_is_running=!1;var i,s,r=hs.create();this.bus=r[0],this.emulator_bus=r[1];const a=new WebAssembly.Table({element:"anyfunc",initial:Q+J});r={cpu_exception_hook:t=>this.cpu_exception_hook&&this.cpu_exception_hook(t),hlt_op:function(){return i.hlt_op()},abort:function(){ls(!1)},microtick:mt.microtick,get_rand_int:function(){return yt.get_rand_int()},pic_acknowledge:function(){i.pic_acknowledge()},io_port_read8:function(t){return i.io.port_read8(t)},io_port_read16:function(t){return i.io.port_read16(t)},io_port_read32:function(t){return i.io.port_read32(t)},io_port_write8:function(t,e){i.io.port_write8(t,e)},io_port_write16:function(t,e){i.io.port_write16(t,e)},io_port_write32:function(t,e){i.io.port_write32(t,e)},mmap_read8:function(t){return i.mmap_read8(t)},mmap_read16:function(t){return i.mmap_read16(t)},mmap_read32:function(t){return i.mmap_read32(t)},mmap_write8:function(t,e){i.mmap_write8(t,e)},mmap_write16:function(t,e){i.mmap_write16(t,e)},mmap_write32:function(t,e){i.mmap_write32(t,e)},mmap_write64:function(t,e,s){i.mmap_write64(t,e,s)},mmap_write128:function(t,e,s,r,a){i.mmap_write128(t,e,s,r,a)},log_from_wasm:function(t,i){t=yt.read_sized_string_from_mem(s,t,i),us(t,e)},console_log_from_wasm:function(t,e){t=yt.read_sized_string_from_mem(s,t,e),console.error(t)},dbg_trace_from_wasm:function(){ps(e)},codegen_finalize:(t,e,s,r,a)=>{i.codegen_finalize(t,e,s,r,a)},jit_clear_func:t=>i.jit_clear_func(t),jit_clear_all_funcs:()=>i.jit_clear_all_funcs(),__indirect_function_table:a};let n=t.wasm_fn;n||(n=e=>new Promise((i=>{let s=ot?"v86-debug.wasm":"v86.wasm",r="v86-fallback.wasm";if(t.wasm_path){s=t.wasm_path;const e=s.lastIndexOf("/");r=(-1===e?"":s.substr(0,e))+"/"+r}else"undefined"==typeof window&&"string"==typeof __dirname?(s=__dirname+"/"+s,r=__dirname+"/"+r):(s="build/"+s,r="build/"+r);yt.load_file(s,{done:async t=>{try{const{instance:s}=await WebAssembly.instantiate(t,e);i(s.exports)}catch(t){yt.load_file(r,{done:async t=>{({instance:t}=await WebAssembly.instantiate(t,e)),i(t.exports)}})}},progress:t=>{this.emulator_bus.send("download-progress",{file_index:0,file_count:1,file_name:s,lengthComputable:t.lengthComputable,total:t.total,loaded:t.loaded})}})}))),n({env:r}).then((e=>{s=e.memory,e.rust_init(),e=this.v86=new mt(this.emulator_bus,{exports:e,wasm_table:a}),i=e.cpu,this.continue_init(e,t)}))}function kr(t){this.message=t||"File already exists"}function xr(t){this.message=t||"File not found"}cr.prototype.destroy=function(){this.audio_context&&this.audio_context.close(),this.dac&&this.dac.node_processor&&this.dac.node_processor.port.close()},ur.prototype.add_source=function(t,e){return t=new pr(this.audio_context,t,this.input_left,this.input_right),ls(!this.sources.has(e),"Mixer add source - overwritting source: "+e),this.sources.set(e,t),t},ur.prototype.connect_source=function(t,e){var i=this.sources.get(t);void 0===i?ls(!1,"Mixer connect - cannot connect undefined source: "+t):i.connect(e)},ur.prototype.disconnect_source=function(t,e){var i=this.sources.get(t);void 0===i?ls(!1,"Mixer disconnect - cannot disconnect undefined source: "+t):i.disconnect(e)},ur.prototype.set_volume=function(t,e){switch(void 0===e&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return void ls(!1,"Mixer set master volume - unknown channel: "+e)}this.update()},ur.prototype.update=function(){var t=this.volume_both*this.volume_right*this.gain_right;this.node_gain_left.gain.setValueAtTime(this.volume_both*this.volume_left*this.gain_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)},pr.prototype.update=function(){var t=this.connected_right*this.gain_hidden*this.volume_both*this.volume_right;this.node_gain_left.gain.setValueAtTime(this.connected_left*this.gain_hidden*this.volume_both*this.volume_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(t,this.audio_context.currentTime)},pr.prototype.connect=function(t){var e=!t||2===t;(e||0===t)&&(this.connected_left=!0),(e||1===t)&&(this.connected_right=!0),this.update()},pr.prototype.disconnect=function(t){var e=!t||2===t;(e||0===t)&&(this.connected_left=!1),(e||1===t)&&(this.connected_right=!1),this.update()},pr.prototype.set_volume=function(t,e){switch(void 0===e&&(e=2),e){case 0:this.volume_left=t;break;case 1:this.volume_right=t;break;case 2:this.volume_both=t;break;default:return void ls(!1,"Mixer set volume - unknown channel: "+e)}this.update()},pr.prototype.set_gain_hidden=function(t){this.gain_hidden=t},lr.prototype.start=function(){this.node_oscillator.start()},fr.prototype.queue=function(t){this.node_processor&&(ot&&this.debugger.push_queued_data(t),this.node_processor.port.postMessage({type:"queue",value:t},[t[0].buffer,t[1].buffer]))},fr.prototype.pump=function(){this.enabled&&this.bus.send("dac-request-data")},mr.prototype.queue=function(t){ot&&this.debugger.push_queued_data(t);var e=t[0].length,i=e/this.sampling_rate;if(1<this.rate_ratio)for(var s=this.audio_context.createBuffer(2,e*this.rate_ratio,this.sampling_rate*this.rate_ratio),r=s.getChannelData(0),a=s.getChannelData(1),n=0,o=0;o<e;o++)for(var h=0;h<this.rate_ratio;h++,n++)r[n]=t[0][o],a[n]=t[1][o];else(s=this.audio_context.createBuffer(2,e,this.sampling_rate)).copyToChannel?(s.copyToChannel(t[0],0),s.copyToChannel(t[1],1)):(s.getChannelData(0).set(t[0]),s.getChannelData(1).set(t[1]));if((t=this.audio_context.createBufferSource()).buffer=s,t.connect(this.node_lowpass),t.addEventListener("ended",this.pump.bind(this)),s=this.audio_context.currentTime,this.buffered_time<s)for(us("Speaker DAC - Creating/Recreating reserve - shouldn't occur frequently during playback"),this.buffered_time=s,s=.2-i,e=0;e<=s;)e+=i,this.buffered_time+=i,setTimeout((()=>this.pump()),1e3*e);t.start(this.buffered_time),this.buffered_time+=i,setTimeout((()=>this.pump()),0)},mr.prototype.pump=function(){this.enabled&&(this.buffered_time-this.audio_context.currentTime>.2||this.bus.send("dac-request-data"))},gr.prototype.start=function(t){this.is_active=!0,this.queued=[[],[]],this.output=[[],[]],this.queued_history.push(this.queued),this.output_history.push(this.output),this.node_processor=this.audio_context.createScriptProcessor(1024,2,2),this.node_processor.onaudioprocess=t=>{this.output[0].push(t.inputBuffer.getChannelData(0).slice()),this.output[1].push(t.inputBuffer.getChannelData(1).slice())},this.node_source.connect(this.node_processor),this.node_processor.connect(this.node_gain),setTimeout((()=>{this.stop()}),t)},gr.prototype.stop=function(){this.is_active=!1,this.node_source.disconnect(this.node_processor),this.node_processor.disconnect(),this.node_processor=null},gr.prototype.push_queued_data=function(t){this.is_active&&(this.queued[0].push(t[0].slice()),this.queued[1].push(t[1].slice()))},gr.prototype.download_txt=function(t,e){xt(t=this.output_history[t][e].map((t=>t.join(" "))).join(" "),"dacdata.txt")},gr.prototype.download_csv=function(t){t=this.output_history[t];for(var e=[],i=0;i<t[0].length;i++)for(var s=0;s<t[0][i].length;s++)e.push(`${t[0][i][s]},${t[1][i][s]}`);xt(e.join("\n"),"dacdata.csv")},br.prototype.show=function(){this.term&&this.term.open(this.element)},vr.prototype.handle_message=function(t){this.bus&&this.bus.send("net0-receive",new Uint8Array(t.data))},vr.prototype.handle_close=function(t){this.connect(),setTimeout(this.connect.bind(this),this.reconnect_interval)},vr.prototype.handle_open=function(t){for(t=0;t<this.send_queue.length;t++)this.send(this.send_queue[t]);this.send_queue=[]},vr.prototype.handle_error=function(t){},vr.prototype.destroy=function(){this.socket&&this.socket.close()},vr.prototype.connect=function(){if("undefined"!=typeof WebSocket){if(this.socket){var t=this.socket.readyState;if(0===t||1===t)return}t=Date.now(),this.last_connect_attempt+this.reconnect_interval>t||(this.last_connect_attempt=Date.now(),this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=this.handle_open.bind(this),this.socket.onmessage=this.handle_message.bind(this),this.socket.onclose=this.handle_close.bind(this),this.socket.onerror=this.handle_error.bind(this))}},vr.prototype.send=function(t){this.socket&&1===this.socket.readyState?this.socket.send(t):(this.send_queue.push(t),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())},vr.prototype.change_proxy=function(t){this.url=t,this.socket&&(this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.close(),this.socket=void 0)},wr.prototype.continue_init=async function(t,e){function i(t,e){switch(t){case"hda":r.hda=this.disk_images.hda=e;break;case"hdb":r.hdb=this.disk_images.hdb=e;break;case"cdrom":r.cdrom=this.disk_images.cdrom=e;break;case"fda":r.fda=this.disk_images.fda=e;break;case"fdb":r.fdb=this.disk_images.fdb=e;break;case"multiboot":r.multiboot=this.disk_images.multiboot=e.buffer;break;case"bzimage":r.bzimage=this.disk_images.bzimage=e.buffer;break;case"initrd":r.initrd=this.disk_images.initrd=e.buffer;break;case"bios":r.bios=e.buffer;break;case"vga_bios":r.vga_bios=e.buffer;break;case"initial_state":r.initial_state=e.buffer;break;case"fs9p_json":r.fs9p_json=e;break;default:ls(!1,t)}}async function s(){if(r.fs9p&&r.fs9p_json){if(r.initial_state?us("Filesystem basefs ignored: Overridden by state image"):r.fs9p.load_from_json(r.fs9p_json),e.bzimage_initrd_from_filesystem){const{bzimage_path:t,initrd_path:e}=this.get_bzimage_initrd_from_filesystem(r.fs9p);us("Found bzimage: "+t+" and initrd: "+e);const[s,a]=await Promise.all([r.fs9p.read_file(e),r.fs9p.read_file(t)]);i.call(this,"initrd",new yt.SyncBuffer(s.buffer)),i.call(this,"bzimage",new yt.SyncBuffer(a.buffer))}}else ls(!e.bzimage_initrd_from_filesystem,"bzimage_initrd_from_filesystem: Requires a filesystem");this.serial_adapter&&this.serial_adapter.show&&this.serial_adapter.show(),this.bus.send("cpu-init",r),r.initial_state&&(t.restore_state(r.initial_state),r.initial_state=void 0),e.autostart&&this.bus.send("cpu-run"),this.emulator_bus.send("emulator-loaded")}this.bus.register("emulator-stopped",(function(){this.cpu_is_running=!1}),this),this.bus.register("emulator-started",(function(){this.cpu_is_running=!0}),this);var r={};this.disk_images={fda:void 0,fdb:void 0,hda:void 0,hdb:void 0,cdrom:void 0},r.acpi=e.acpi,r.load_devices=!0,r.log_level=e.log_level,r.memory_size=e.memory_size||67108864,r.vga_memory_size=e.vga_memory_size||8388608,r.boot_order=e.boot_order||531,r.fastboot=e.fastboot||!1,r.fda=void 0,r.fdb=void 0,r.uart1=e.uart1,r.uart2=e.uart2,r.uart3=e.uart3,r.cmdline=e.cmdline,r.preserve_mac_from_state_image=e.preserve_mac_from_state_image,r.mac_address_translation=e.mac_address_translation,r.cpuid_level=e.cpuid_level,e.network_adapter?this.network_adapter=e.network_adapter(this.bus):e.network_relay_url&&(this.network_adapter=new vr(e.network_relay_url,this.bus)),r.enable_ne2k=!0,e.disable_keyboard||(this.keyboard_adapter=new hr(this.bus)),e.disable_mouse||(this.mouse_adapter=new _r(this.bus,e.screen_container)),e.screen_container?this.screen_adapter=new et(e.screen_container,this.bus):e.screen_dummy&&(this.screen_adapter=new qr(this.bus)),e.serial_container&&(this.serial_adapter=new yr(e.serial_container,this.bus)),e.serial_container_xtermjs&&(this.serial_adapter=new br(e.serial_container_xtermjs,this.bus)),e.disable_speaker||(this.speaker_adapter=new cr(this.bus));var a,n,o=[];e.state&&console.warn("Warning: Unknown option 'state'. Did you mean 'initial_state'?");for(var h="bios vga_bios cdrom hda hdb fda fdb initial_state multiboot bzimage initrd".split(" "),_=0;_<h.length;_++)a=h[_],(n=e[h[_]])&&(n.get&&n.set&&n.load?o.push({name:a,loadable:n}):("bios"!==a&&"vga_bios"!==a&&"initial_state"!==a&&"multiboot"!==a&&"bzimage"!==a&&"initrd"!==a||(n.async=!1),n.buffer instanceof ArrayBuffer?(n=new yt.SyncBuffer(n.buffer),o.push({name:a,loadable:n})):"undefined"!=typeof File&&n.buffer instanceof File?(void 0===n.async&&(n.async=268435456<=n.buffer.size),n=n.async?new yt.AsyncFileBuffer(n.buffer):new yt.SyncFileBuffer(n.buffer),o.push({name:a,loadable:n})):n.url?n.async?(n=n.use_parts?new yt.AsyncXHRPartfileBuffer(n.url,n.size,n.fixed_chunk_size):new yt.AsyncXHRBuffer(n.url,n.size,n.fixed_chunk_size),o.push({name:a,loadable:n})):o.push({name:a,url:n.url,size:n.size}):us("Ignored file: url="+n.url+" buffer="+n.buffer)));if(e.filesystem){h=e.filesystem.basefs,_=e.filesystem.baseurl;let t=new Rr;if(_&&(t=new Cr(t,_)),r.fs9p=this.fs9p=new Pr(t),h){if(ls(_,"Filesystem: baseurl must be specified"),"object"==typeof h){var d=h.size;h=h.url}ls("string"==typeof h),o.push({name:"fs9p_json",url:h,size:d,as_json:!0})}}var c=this,u=o.length,p=function(t){if(t===u)setTimeout(s.bind(this),0);else{var e=o[t];e.loadable?(e.loadable.onload=function(s){i.call(this,e.name,e.loadable),p(t+1)}.bind(this),e.loadable.load()):yt.load_file(e.url,{done:function(s){i.call(this,e.name,e.as_json?s:new yt.SyncBuffer(s)),p(t+1)}.bind(this),progress:function(i){200===i.target.status?c.emulator_bus.send("download-progress",{file_index:t,file_count:u,file_name:e.url,lengthComputable:i.lengthComputable,total:i.total||e.size,loaded:i.loaded}):c.emulator_bus.send("download-error",{file_index:t,file_count:u,file_name:e.url,request:i.target})},as_json:e.as_json})}}.bind(this);p(0)},wr.prototype.get_bzimage_initrd_from_filesystem=function(t){const e=(t.read_dir("/")||[]).map((t=>"/"+t));let i,s;t=(t.read_dir("/boot/")||[]).map((t=>"/boot/"+t));for(let r of[].concat(e,t)){const t=/old/i.test(r)||/fallback/i.test(r);!(/vmlinuz/i.test(r)||/bzimage/i.test(r))||s&&t||(s=r),!(/initrd/i.test(r)||/initramfs/i.test(r))||i&&t||(i=r)}return i&&s||(console.log("Failed to find bzimage or initrd in filesystem. Files:"),console.log(e.join(" ")),console.log(t.join(" "))),{initrd_path:i,bzimage_path:s}},wr.prototype.run=async function(){this.bus.send("cpu-run")},gt.exportProperty(wr.prototype,"run",wr.prototype.run),wr.prototype.stop=async function(){this.cpu_is_running&&await new Promise((t=>{const e=()=>{this.remove_listener("emulator-stopped",e),t()};this.add_listener("emulator-stopped",e),this.bus.send("cpu-stop")}))},gt.exportProperty(wr.prototype,"stop",wr.prototype.stop),wr.prototype.destroy=async function(){await this.stop(),this.v86.destroy(),this.keyboard_adapter&&this.keyboard_adapter.destroy(),this.network_adapter&&this.network_adapter.destroy(),this.mouse_adapter&&this.mouse_adapter.destroy(),this.screen_adapter&&this.screen_adapter.destroy(),this.serial_adapter&&this.serial_adapter.destroy(),this.speaker_adapter&&this.speaker_adapter.destroy()},gt.exportProperty(wr.prototype,"destroy",wr.prototype.destroy),wr.prototype.restart=function(){this.bus.send("cpu-restart")},gt.exportProperty(wr.prototype,"restart",wr.prototype.restart),wr.prototype.add_listener=function(t,e){this.bus.register(t,e,this)},gt.exportProperty(wr.prototype,"add_listener",wr.prototype.add_listener),wr.prototype.remove_listener=function(t,e){this.bus.unregister(t,e)},gt.exportProperty(wr.prototype,"remove_listener",wr.prototype.remove_listener),wr.prototype.restore_state=async function(t){ls(1===arguments.length),this.v86.restore_state(t)},gt.exportProperty(wr.prototype,"restore_state",wr.prototype.restore_state),wr.prototype.save_state=async function(){return ls(0===arguments.length),this.v86.save_state()},gt.exportProperty(wr.prototype,"save_state",wr.prototype.save_state),wr.prototype.get_statistics=function(){console.warn("V86Starter.prototype.get_statistics is deprecated. Use events instead.");var t={cpu:{instruction_counter:this.get_instruction_counter()}};if(!this.v86)return t;var e=this.v86.cpu.devices;return e.hda&&(t.hda=e.hda.stats),e.cdrom&&(t.cdrom=e.cdrom.stats),e.ps2&&(t.mouse={enabled:e.ps2.use_mouse}),e.vga&&(t.vga={is_graphical:e.vga.stats.is_graphical}),t},gt.exportProperty(wr.prototype,"get_statistics",wr.prototype.get_statistics),wr.prototype.get_instruction_counter=function(){return this.v86?this.v86.cpu.instruction_counter[0]>>>0:0},gt.exportProperty(wr.prototype,"get_instruction_counter",wr.prototype.get_instruction_counter),wr.prototype.is_running=function(){return this.cpu_is_running},gt.exportProperty(wr.prototype,"is_running",wr.prototype.is_running),wr.prototype.keyboard_send_scancodes=function(t){for(var e=0;e<t.length;e++)this.bus.send("keyboard-code",t[e])},gt.exportProperty(wr.prototype,"keyboard_send_scancodes",wr.prototype.keyboard_send_scancodes),wr.prototype.keyboard_send_keys=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_press(t[e])},gt.exportProperty(wr.prototype,"keyboard_send_keys",wr.prototype.keyboard_send_keys),wr.prototype.keyboard_send_text=function(t){for(var e=0;e<t.length;e++)this.keyboard_adapter.simulate_char(t[e])},gt.exportProperty(wr.prototype,"keyboard_send_text",wr.prototype.keyboard_send_text),wr.prototype.screen_make_screenshot=function(){this.screen_adapter&&this.screen_adapter.make_screenshot()},gt.exportProperty(wr.prototype,"screen_make_screenshot",wr.prototype.screen_make_screenshot),wr.prototype.screen_set_scale=function(t,e){this.screen_adapter&&this.screen_adapter.set_scale(t,e)},gt.exportProperty(wr.prototype,"screen_set_scale",wr.prototype.screen_set_scale),wr.prototype.screen_go_fullscreen=function(){if(this.screen_adapter){var t=document.getElementById("screen_container");if(t){var e=t.requestFullScreen||t.webkitRequestFullscreen||t.mozRequestFullScreen||t.msRequestFullScreen;e&&(e.call(t),(t=document.getElementsByClassName("phone_keyboard")[0])&&t.focus());try{navigator.keyboard.lock()}catch(t){}this.lock_mouse()}}},gt.exportProperty(wr.prototype,"screen_go_fullscreen",wr.prototype.screen_go_fullscreen),wr.prototype.lock_mouse=function(){var t=document.body,e=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;e&&e.call(t)},gt.exportProperty(wr.prototype,"lock_mouse",wr.prototype.lock_mouse),wr.prototype.mouse_set_status=function(t){this.mouse_adapter&&(this.mouse_adapter.emu_enabled=t)},wr.prototype.keyboard_set_status=function(t){this.keyboard_adapter&&(this.keyboard_adapter.emu_enabled=t)},gt.exportProperty(wr.prototype,"keyboard_set_status",wr.prototype.keyboard_set_status),wr.prototype.serial0_send=function(t){for(var e=0;e<t.length;e++)this.bus.send("serial0-input",t.charCodeAt(e))},gt.exportProperty(wr.prototype,"serial0_send",wr.prototype.serial0_send),wr.prototype.serial_send_bytes=function(t,e){for(var i=0;i<e.length;i++)this.bus.send("serial"+t+"-input",e[i])},gt.exportProperty(wr.prototype,"serial_send_bytes",wr.prototype.serial_send_bytes),wr.prototype.mount_fs=async function(t,e,i,s){let r=new Rr;e&&(r=new Cr(r,e));const a=new Pr(r,this.fs9p.qidcounter),n=()=>{const e=this.fs9p.Mount(t,a);s&&(-2===e?s(new xr):-17===e?s(new kr):0>e?(ls(!1,"Unexpected error code: "+-e),s(Error("Failed to mount. Error number: "+-e))):s(null))};e?(ls("object"==typeof i,"Filesystem: basefs must be a JSON object"),a.load_from_json(i,(()=>n()))):n()},gt.exportProperty(wr.prototype,"mount_fs",wr.prototype.mount_fs),wr.prototype.create_file=async function(t,e){ls(2===arguments.length);var i=this.fs9p;if(i){var s=t.split("/");s=s[s.length-1];var r=i.SearchPath(t).parentid;if(""===s||-1===r)return Promise.reject(new xr);await i.CreateBinaryFile(s,r,e)}},gt.exportProperty(wr.prototype,"create_file",wr.prototype.create_file),wr.prototype.read_file=async function(t){ls(1===arguments.length);var e=this.fs9p;if(e)return(e=await e.read_file(t))?e:Promise.reject(new xr)},gt.exportProperty(wr.prototype,"read_file",wr.prototype.read_file),wr.prototype.automatically=function(t){const e=t=>{const i=t[0];if(i){var s=t.slice(1);if(i.sleep)setTimeout((()=>e(s)),1e3*i.sleep);else if(i.vga_text){const r=this.screen_adapter.get_text_screen();for(let t of r)if(t.includes(i.vga_text))return void e(s);setTimeout((()=>e(t)),1e3)}else i.keyboard_send?(i.keyboard_send instanceof Array?this.keyboard_send_scancodes(i.keyboard_send):(ls("string"==typeof i.keyboard_send),this.keyboard_send_text(i.keyboard_send)),e(s)):i.call?(i.call(),e(s)):ls(!1,i)}};e(t)},wr.prototype.read_memory=function(t,e){return this.v86.cpu.read_blob(t,e)},wr.prototype.write_memory=function(t,e){this.v86.cpu.write_blob(t,e)},kr.prototype=Error.prototype,xr.prototype=Error.prototype,"undefined"!=typeof window?(window.V86Starter=wr,window.V86=wr):"undefined"!=typeof module&&void 0!==module.exports?(module.exports.V86Starter=wr,module.exports.V86=wr):"function"==typeof importScripts&&(self.V86Starter=wr,self.V86=wr);var Ar={Connector:function(t){this.listeners={},this.pair=t,t.addEventListener("message",function(t){t=t.data;for(var e=this.listeners[t[0]],i=0;i<e.length;i++){var s=e[i];s.fn.call(s.this_value,t[1])}}.bind(this),!1)}};function qr(t){var e,i,s,r,a;this.bus=t,t.register("screen-set-mode",(function(t){this.set_mode(t)}),this),t.register("screen-fill-buffer-end",(function(t){this.update_buffer(t[0],t[1])}),this),t.register("screen-put-char",(function(t){this.put_char(t[0],t[1],t[2],t[3],t[4])}),this),t.register("screen-text-scroll",(function(t){console.log("scroll",t)}),this),t.register("screen-update-cursor",(function(t){this.update_cursor(t[0],t[1])}),this),t.register("screen-update-cursor-scanline",(function(t){this.update_cursor_scanline(t[0],t[1])}),this),t.register("screen-set-size-text",(function(t){this.set_size_text(t[0],t[1])}),this),t.register("screen-set-size-graphical",(function(t){this.set_size_graphical(t[0],t[1])}),this),this.put_char=function(t,e,i,n,o){t<a&&e<r&&(s[t=3*(t*r+e)]=i,s[t+1]=n,s[t+2]=o)},this.destroy=function(){},this.set_mode=function(t){},this.clear_screen=function(){},this.set_size_text=function(t,e){t===r&&e===a||(s=new Int32Array(t*e*3),r=t,a=e)},this.set_size_graphical=function(t,e){},this.set_scale=function(t,e){},this.update_cursor_scanline=function(t,e){},this.update_cursor=function(t,s){t===e&&s===i||(e=t,i=s)},this.update_buffer=function(t,e){},this.get_text_screen=function(){for(var t=[],e=0;e<a;e++)t.push(this.get_text_row(e));return t},this.get_text_row=function(t){var e="";t=3*t*r;for(var i=0;i<r;i++)e+=String.fromCharCode(s[t+3*i]);return e}}Ar.Connector.prototype.register=function(t,e,i){var s=this.listeners[t];void 0===s&&(s=this.listeners[t]=[]),s.push({fn:e,this_value:i})},Ar.Connector.prototype.send=function(t,e,i){ls(1<=arguments.length),this.pair&&this.pair.postMessage([t,e],i)},Ar.init=function(t){return new Ar.Connector(t)};const Er={stats_to_string:function(t){return Er.print_misc_stats(t)+Er.print_instruction_counts(t)},print_misc_stats:function(t){let e="";var i="COMPILE COMPILE_SKIPPED_NO_NEW_ENTRY_POINTS COMPILE_WRONG_ADDRESS_SPACE COMPILE_CUT_OFF_AT_END_OF_PAGE COMPILE_WITH_LOOP_SAFETY COMPILE_PAGE COMPILE_PAGE/COMPILE COMPILE_BASIC_BLOCK COMPILE_DUPLICATED_BASIC_BLOCK COMPILE_WASM_BLOCK COMPILE_WASM_LOOP COMPILE_DISPATCHER COMPILE_ENTRY_POINT COMPILE_WASM_TOTAL_BYTES COMPILE_WASM_TOTAL_BYTES/COMPILE_PAGE RUN_INTERPRETED RUN_INTERPRETED_NEW_PAGE RUN_INTERPRETED_PAGE_HAS_CODE RUN_INTERPRETED_PAGE_HAS_ENTRY_AFTER_PAGE_WALK RUN_INTERPRETED_NEAR_END_OF_PAGE RUN_INTERPRETED_DIFFERENT_STATE RUN_INTERPRETED_DIFFERENT_STATE_CPL3 RUN_INTERPRETED_DIFFERENT_STATE_FLAT RUN_INTERPRETED_DIFFERENT_STATE_IS32 RUN_INTERPRETED_DIFFERENT_STATE_SS32 RUN_INTERPRETED_MISSED_COMPILED_ENTRY_RUN_INTERPRETED RUN_INTERPRETED_STEPS RUN_FROM_CACHE RUN_FROM_CACHE_STEPS RUN_FROM_CACHE_STEPS/RUN_FROM_CACHE RUN_FROM_CACHE_STEPS/RUN_INTERPRETED_STEPS DIRECT_EXIT INDIRECT_JUMP INDIRECT_JUMP_NO_ENTRY NORMAL_PAGE_CHANGE NORMAL_FALLTHRU NORMAL_FALLTHRU_WITH_TARGET_BLOCK NORMAL_BRANCH NORMAL_BRANCH_WITH_TARGET_BLOCK CONDITIONAL_JUMP CONDITIONAL_JUMP_PAGE_CHANGE CONDITIONAL_JUMP_EXIT CONDITIONAL_JUMP_FALLTHRU CONDITIONAL_JUMP_FALLTHRU_WITH_TARGET_BLOCK CONDITIONAL_JUMP_BRANCH CONDITIONAL_JUMP_BRANCH_WITH_TARGET_BLOCK DISPATCHER_SMALL DISPATCHER_LARGE LOOP LOOP_SAFETY CONDITION_OPTIMISED CONDITION_UNOPTIMISED CONDITION_UNOPTIMISED_PF CONDITION_UNOPTIMISED_UNHANDLED_L CONDITION_UNOPTIMISED_UNHANDLED_LE FAILED_PAGE_CHANGE SAFE_READ_FAST SAFE_READ_SLOW_PAGE_CROSSED SAFE_READ_SLOW_NOT_VALID SAFE_READ_SLOW_NOT_USER SAFE_READ_SLOW_IN_MAPPED_RANGE SAFE_WRITE_FAST SAFE_WRITE_SLOW_PAGE_CROSSED SAFE_WRITE_SLOW_NOT_VALID SAFE_WRITE_SLOW_NOT_USER SAFE_WRITE_SLOW_IN_MAPPED_RANGE SAFE_WRITE_SLOW_READ_ONLY SAFE_WRITE_SLOW_HAS_CODE SAFE_READ_WRITE_FAST SAFE_READ_WRITE_SLOW_PAGE_CROSSED SAFE_READ_WRITE_SLOW_NOT_VALID SAFE_READ_WRITE_SLOW_NOT_USER SAFE_READ_WRITE_SLOW_IN_MAPPED_RANGE SAFE_READ_WRITE_SLOW_READ_ONLY SAFE_READ_WRITE_SLOW_HAS_CODE PAGE_FAULT TLB_MISS DO_MANY_CYCLES CYCLE_INTERNAL INVALIDATE_ALL_MODULES_NO_FREE_WASM_INDICES INVALIDATE_MODULE_WRITTEN_WHILE_COMPILED INVALIDATE_MODULE_UNUSED_AFTER_OVERWRITE INVALIDATE_MODULE_DIRTY_PAGE INVALIDATE_PAGE_HAD_CODE INVALIDATE_PAGE_HAD_ENTRY_POINTS DIRTY_PAGE_DID_NOT_HAVE_CODE RUN_FROM_CACHE_EXIT_SAME_PAGE RUN_FROM_CACHE_EXIT_NEAR_END_OF_PAGE RUN_FROM_CACHE_EXIT_DIFFERENT_PAGE CLEAR_TLB FULL_CLEAR_TLB TLB_FULL TLB_GLOBAL_FULL MODRM_SIMPLE_REG MODRM_SIMPLE_REG_WITH_OFFSET MODRM_SIMPLE_CONST_OFFSET MODRM_COMPLEX SEG_OFFSET_OPTIMISED SEG_OFFSET_NOT_OPTIMISED SEG_OFFSET_NOT_OPTIMISED_ES SEG_OFFSET_NOT_OPTIMISED_FS SEG_OFFSET_NOT_OPTIMISED_GS SEG_OFFSET_NOT_OPTIMISED_NOT_FLAT".split(" "),s=0;const r={};for(let n=0;n<i.length;n++){const o=i[n];var a=void 0;if(o.includes("/")){s++;const[t,e]=o.split("/");a=r[t]/r[e]}else a=1e8<=(a=r[o]=t.wm.exports.profiler_stat_get(n-s))?Math.round(a/1e6)+"m":1e5<=a?Math.round(a/1e3)+"k":a;e+=o+"="+a+"\n"}return e+="\n",e=e+"TLB_ENTRIES="+(i=t.wm.exports.get_valid_tlb_entries_count())+" ("+(s=t.wm.exports.get_valid_global_tlb_entries_count())+" global, "+(i-s)+" non-global)\nWASM_TABLE_FREE="+t.wm.exports.jit_get_wasm_table_index_free_list_count()+"\n",e+="JIT_CACHE_SIZE="+t.wm.exports.jit_get_cache_size()+"\n",e+="FLAT_SEGMENTS="+t.wm.exports.has_flat_segmentation()+"\n",e+="do_many_cycles avg: "+(t.do_many_cycles_total/t.do_many_cycles_count||0)+"\n",e+="wasm memory size: "+(t.wasm_memory.buffer.byteLength>>20)+"m\n",e=e+"Config:\nMAX_PAGES="+t.wm.exports.get_jit_config(0)+"\n",e+="JIT_USE_LOOP_SAFETY="+!!t.wm.exports.get_jit_config(1)+"\n",e+"MAX_EXTRA_BASIC_BLOCKS="+t.wm.exports.get_jit_config(2)+"\n"},print_instruction_counts:function(t){return[Er.print_instruction_counts_offset(t,!1,!1,!1,!1),Er.print_instruction_counts_offset(t,!0,!1,!1,!1),Er.print_instruction_counts_offset(t,!1,!0,!1,!1),Er.print_instruction_counts_offset(t,!1,!1,!0,!1),Er.print_instruction_counts_offset(t,!1,!1,!1,!0)].join("\n\n")},print_instruction_counts_offset:function(t,e,i,s,r){let a="";var n=[],o=e?"compiled":i?"jit exit":s?"unguarded register":r?"wasm size":"executed";for(let a=0;256>a;a++)for(let o=0;8>o;o++)for(let _ of[!1,!0]){var h=t.wm.exports.get_opstats_buffer(e,i,s,r,a,!1,_,o);n.push({opcode:a,count:h,is_mem:_,fixed_g:o}),h=t.wm.exports.get_opstats_buffer(e,i,s,r,a,!0,_,o),n.push({opcode:3840|a,count:h,is_mem:_,fixed_g:o})}t=0,e=new Set([38,46,54,62,100,101,102,103,240,242,243]);for(let{count:i,opcode:s}of n)e.has(s)||(t+=i);if(0===t)return"";i=new Uint32Array(256),e=new Uint32Array(256);for(let{opcode:t,count:s}of n)3840==(65280&t)?e[255&t]+=s:i[255&t]+=s;a=a+"------------------\nTotal: "+t+"\n";const _=1e7<t?1e3:1;for(s=Math.max.apply(Math,n.map((({count:t})=>Math.round(t/_)))),s=String(s).length,a+=`Instruction counts ${o} (in ${_}):\n`,r=0;256>r;r++)a+=r.toString(16).padStart(2,"0")+":"+yt.pads(Math.round(i[r]/_),s),a=15==r%16?a+"\n":a+" ";for(a=a+"\n"+`Instruction counts ${o} (0f, in ${_}):\n`,o=0;256>o;o++)a+=(255&o).toString(16).padStart(2,"0")+":"+yt.pads(Math.round(e[o]/_),s),a=15==o%16?a+"\n":a+" ";a+="\n",n=n.filter((({count:t})=>t)).sort((({count:t},{count:e})=>e-t));for(let{opcode:e,is_mem:i,fixed_g:s,count:r}of n.slice(0,200))a+=(n=e.toString(16)+"_"+s+(i?"_m":"_r"))+":"+(r/t*100).toFixed(2)+" ";return a+"\n"}};function Ir(){}function Rr(){this.filedata=new Map}function Cr(t,e){ls(e,"ServerMemoryFileStorage: baseurl should not be empty"),this.storage=t,this.baseurl=e}"undefined"!=typeof module&&void 0!==module.exports&&(module.exports.print_stats=Er),Ir.prototype.read=function(t,e,i){},Ir.prototype.cache=function(t,e){},Ir.prototype.uncache=function(t){},Rr.prototype.read=async function(t,e,i){return ls(t,"MemoryFileStorage read: sha256sum should be a non-empty string"),(t=this.filedata.get(t))?t.subarray(e,e+i):null},Rr.prototype.cache=async function(t,e){ls(t,"MemoryFileStorage cache: sha256sum should be a non-empty string"),this.filedata.set(t,e)},Rr.prototype.uncache=function(t){this.filedata.delete(t)},Cr.prototype.load_from_server=function(t){return new Promise(((e,i)=>{yt.load_file(this.baseurl+t,{done:async i=>{i=new Uint8Array(i),await this.cache(t,i),e(i)}})}))},Cr.prototype.read=async function(t,e,i){const s=await this.storage.read(t,e,i);return s||(await this.load_from_server(t)).subarray(e,e+i)},Cr.prototype.cache=async function(t,e){return await this.storage.cache(t,e)},Cr.prototype.uncache=function(t){this.storage.uncache(t)},"undefined"!=typeof window?(window.MemoryFileStorage=Rr,window.ServerFileStorageWrapper=Cr):"undefined"!=typeof module&&void 0!==module.exports?(module.exports.MemoryFileStorage=Rr,module.exports.ServerFileStorageWrapper=Cr):"function"==typeof importScripts&&(self.MemoryFileStorage=Rr,self.ServerFileStorageWrapper=Cr);var Sr=61440,zr=49152,Dr=40960,Tr=32768,Ur=16384,Or=4;function Pr(t,e){this.inodes=[],this.events=[],this.storage=t,this.qidcounter=e||{last_qidnumber:0},this.inodedata={},this.total_size=274877906944,this.used_size=0,this.mounts=[],this.CreateDirectory("",-1)}function Lr(t){this.direntries=new Map,this.minor=this.major=this.mtime=this.atime=this.ctime=this.fid=this.gid=this.uid=this.size=this.status=0,this.symlink="",this.mode=493,this.qid={type:0,version:0,path:t},this.caps=void 0,this.nlinks=0,this.sha256sum="",this.locks=[],this.foreign_id=this.mount_id=-1}function Mr(t){this.fs=t,this.backtrack=new Map}function Fr(){this.type=rt,this.start=0,this.length=1/0,this.proc_id=-1,this.client_id=""}Pr.prototype.get_state=function(){let t=[];t[0]=this.inodes,t[1]=this.qidcounter.last_qidnumber,t[2]=[];for(const[e,i]of Object.entries(this.inodedata))0==(this.inodes[e].mode&Ur)&&t[2].push([e,i]);return t[3]=this.total_size,t[4]=this.used_size,t.concat(this.mounts)},Pr.prototype.set_state=function(t){this.inodes=t[0].map((t=>{const e=new Lr(0);return e.set_state(t),e})),this.qidcounter.last_qidnumber=t[1],this.inodedata={};for(let[e,i]of t[2])i.buffer.byteLength!==i.byteLength&&(i=i.slice()),this.inodedata[e]=i;this.total_size=t[3],this.used_size=t[4],this.mounts=t.slice(5)},Pr.prototype.AddEvent=function(t,e){var i=this.inodes[t];0==i.status||2==i.status?e():this.is_forwarder(i)?this.follow_fs(i).AddEvent(i.foreign_id,e):this.events.push({id:t,OnEvent:e})},Pr.prototype.HandleEvent=function(t){var e=this.inodes[t];this.is_forwarder(e)&&this.follow_fs(e).HandleEvent(e.foreign_id),e=[];for(var i=0;i<this.events.length;i++)this.events[i].id==t?this.events[i].OnEvent():e.push(this.events[i]);this.events=e},Pr.prototype.load_from_json=function(t,e){if(ls(t,"Invalid fs passed to load_from_json"),3!==t.version)throw"The filesystem JSON format has changed. Please update your fs2json (https://github.com/copy/fs2json) and recreate the filesystem JSON.";var i=t.fsroot;for(this.used_size=t.size,t=0;t<i.length;t++)this.LoadRecursive(i[t],0);e&&e()},Pr.prototype.LoadRecursive=function(t,e){var i=this.CreateInode();const s=t[0];i.size=t[1],i.mtime=t[2],i.ctime=i.mtime,i.atime=i.mtime,i.mode=t[3],i.uid=t[4],i.gid=t[5];var r=i.mode&Sr;r===Ur?(this.PushInode(i,e,s),this.LoadDir(this.inodes.length-1,t[6])):r===Tr?(i.status=2,i.sha256sum=t[6],ls(i.sha256sum),this.PushInode(i,e,s)):r===Dr?(i.symlink=t[6],this.PushInode(i,e,s)):r!==zr&&us("Unexpected ifmt: "+bt(r)+" ("+s+")")},Pr.prototype.LoadDir=function(t,e){for(var i=0;i<e.length;i++)this.LoadRecursive(e[i],t)},Pr.prototype.should_be_linked=function(t){return!this.is_forwarder(t)||0===t.foreign_id},Pr.prototype.link_under_dir=function(t,e,i){const s=this.inodes[e],r=this.inodes[t];ls(!this.is_forwarder(r),"Filesystem: Shouldn't link under fowarder parents"),ls(this.IsDirectory(t),"Filesystem: Can't link under non-directories"),ls(this.should_be_linked(s),"Filesystem: Can't link across filesystems apart from their root"),ls(0<=s.nlinks,"Filesystem: Found negative nlinks value of "+s.nlinks),ls(!r.direntries.has(i),"Filesystem: Name '"+i+"' is already taken"),r.direntries.set(i,e),s.nlinks++,this.IsDirectory(e)&&(ls(!s.direntries.has(".."),"Filesystem: Cannot link a directory twice"),s.direntries.has(".")||s.nlinks++,s.direntries.set(".",e),s.direntries.set("..",t),r.nlinks++)},Pr.prototype.unlink_from_dir=function(t,e){const i=this.Search(t,e),s=this.inodes[i],r=this.inodes[t];ls(!this.is_forwarder(r),"Filesystem: Can't unlink from forwarders"),ls(this.IsDirectory(t),"Filesystem: Can't unlink from non-directories"),r.direntries.delete(e)?(s.nlinks--,this.IsDirectory(i)&&(ls(s.direntries.get("..")===t,"Filesystem: Found directory with bad parent id"),s.direntries.delete(".."),r.nlinks--),ls(0<=s.nlinks,"Filesystem: Found negative nlinks value of "+s.nlinks)):ls(!1,"Filesystem: Can't unlink non-existent file: "+e)},Pr.prototype.PushInode=function(t,e,i){-1!=e?(this.inodes.push(t),t.fid=this.inodes.length-1,this.link_under_dir(e,t.fid,i)):0==this.inodes.length?(this.inodes.push(t),t.direntries.set(".",0),t.direntries.set("..",0),t.nlinks=2):(Nr.Debug("Error in Filesystem: Pushed inode with name = "+i+" has no parent"),Nr.Abort())},Lr.prototype.get_state=function(){const t=[];return t[0]=this.mode,t[1]=(this.mode&Sr)===Ur?[...this.direntries]:(this.mode&Sr)===Tr?this.sha256sum:(this.mode&Sr)===Dr?this.symlink:(this.mode&Sr)===zr?[this.minor,this.major]:null,t[2]=this.locks,t[3]=this.status,t[4]=this.size,t[5]=this.uid,t[6]=this.gid,t[7]=this.fid,t[8]=this.ctime,t[9]=this.atime,t[10]=this.mtime,t[11]=this.qid.version,t[12]=this.qid.path,t[13]=this.nlinks,t},Lr.prototype.set_state=function(t){if(this.mode=t[0],(this.mode&Sr)===Ur){this.direntries=new Map;for(const[e,i]of t[1])this.direntries.set(e,i)}else(this.mode&Sr)===Tr?this.sha256sum=t[1]:(this.mode&Sr)===Dr?this.symlink=t[1]:(this.mode&Sr)===zr&&([this.minor,this.major]=t[1]);this.locks=[];for(const e of t[2]){const t=new Fr;t.set_state(e),this.locks.push(t)}this.status=t[3],this.size=t[4],this.uid=t[5],this.gid=t[6],this.fid=t[7],this.ctime=t[8],this.atime=t[9],this.mtime=t[10],this.qid.type=(this.mode&Sr)>>8,this.qid.version=t[11],this.qid.path=t[12],this.nlinks=t[13]},Pr.prototype.divert=function(t,e){const i=this.Search(t,e),s=this.inodes[i],r=new Lr(-1);ls(s,"Filesystem divert: name ("+e+") not found"),ls(this.IsDirectory(i)||1>=s.nlinks,"Filesystem: can't divert hardlinked file '"+e+"' with nlinks="+s.nlinks),Object.assign(r,s);const a=this.inodes.length;if(this.inodes.push(r),r.fid=a,this.is_forwarder(s)&&this.mounts[s.mount_id].backtrack.set(s.foreign_id,a),this.should_be_linked(s)&&(this.unlink_from_dir(t,e),this.link_under_dir(t,a,e)),this.IsDirectory(i)&&!this.is_forwarder(s))for(const[t,e]of r.direntries)"."!==t&&".."!==t&&this.IsDirectory(e)&&this.inodes[e].direntries.set("..",a);return this.inodedata[a]=this.inodedata[i],delete this.inodedata[i],s.direntries=new Map,s.nlinks=0,a},Pr.prototype.copy_inode=function(t,e){Object.assign(e,t,{fid:e.fid,direntries:e.direntries,nlinks:e.nlinks})},Pr.prototype.CreateInode=function(){const t=Math.round(Date.now()/1e3),e=new Lr(++this.qidcounter.last_qidnumber);return e.atime=e.ctime=e.mtime=t,e},Pr.prototype.CreateDirectory=function(t,e){var i=this.inodes[e];return 0<=e&&this.is_forwarder(i)?(e=i.foreign_id,t=this.follow_fs(i).CreateDirectory(t,e),this.create_forwarder(i.mount_id,t)):((i=this.CreateInode()).mode=511|Ur,0<=e&&(i.uid=this.inodes[e].uid,i.gid=this.inodes[e].gid,i.mode=511&this.inodes[e].mode|Ur),i.qid.type=Ur>>8,this.PushInode(i,e,t),this.NotifyListeners(this.inodes.length-1,"newdir"),this.inodes.length-1)},Pr.prototype.CreateFile=function(t,e){var i=this.inodes[e];return this.is_forwarder(i)?(e=i.foreign_id,t=this.follow_fs(i).CreateFile(t,e),this.create_forwarder(i.mount_id,t)):((i=this.CreateInode()).uid=this.inodes[e].uid,i.gid=this.inodes[e].gid,i.qid.type=128,i.mode=438&this.inodes[e].mode|Tr,this.PushInode(i,e,t),this.NotifyListeners(this.inodes.length-1,"newfile"),this.inodes.length-1)},Pr.prototype.CreateNode=function(t,e,i,s){var r=this.inodes[e];return this.is_forwarder(r)?(e=r.foreign_id,t=this.follow_fs(r).CreateNode(t,e,i,s),this.create_forwarder(r.mount_id,t)):((r=this.CreateInode()).major=i,r.minor=s,r.uid=this.inodes[e].uid,r.gid=this.inodes[e].gid,r.qid.type=192,r.mode=438&this.inodes[e].mode,this.PushInode(r,e,t),this.inodes.length-1)},Pr.prototype.CreateSymlink=function(t,e,i){var s=this.inodes[e];return this.is_forwarder(s)?(e=s.foreign_id,t=this.follow_fs(s).CreateSymlink(t,e,i),this.create_forwarder(s.mount_id,t)):((s=this.CreateInode()).uid=this.inodes[e].uid,s.gid=this.inodes[e].gid,s.qid.type=160,s.symlink=i,s.mode=Dr,this.PushInode(s,e,t),this.inodes.length-1)},Pr.prototype.CreateTextFile=async function(t,e,i){var s=this.inodes[e];if(this.is_forwarder(s))return e=s.foreign_id,i=await this.follow_fs(s).CreateTextFile(t,e,i),this.create_forwarder(s.mount_id,i);for(s=this.CreateFile(t,e),e=this.inodes[s],t=new Uint8Array(i.length),e.size=i.length,e=0;e<i.length;e++)t[e]=i.charCodeAt(e);return await this.set_data(s,t),s},Pr.prototype.CreateBinaryFile=async function(t,e,i){var s=this.inodes[e];return this.is_forwarder(s)?(e=s.foreign_id,i=await this.follow_fs(s).CreateBinaryFile(t,e,i),this.create_forwarder(s.mount_id,i)):(s=this.CreateFile(t,e),t=this.inodes[s],(e=new Uint8Array(i.length)).set(i),await this.set_data(s,e),t.size=i.length,s)},Pr.prototype.OpenInode=function(t,e){var i=this.inodes[t];return this.is_forwarder(i)?this.follow_fs(i).OpenInode(i.foreign_id,e):((i.mode&Sr)==Ur&&this.FillDirectory(t),!0)},Pr.prototype.CloseInode=async function(t){var e=this.inodes[t];if(this.is_forwarder(e))return await this.follow_fs(e).CloseInode(e.foreign_id);2===e.status&&this.storage.uncache(e.sha256sum),e.status==Or&&(e.status=-1,await this.DeleteData(t))},Pr.prototype.Rename=async function(t,e,i,s){if(t==i&&e==s)return 0;var r=this.Search(t,e);if(-1===r)return-2;var a=this.GetFullPath(t)+"/"+e;if(-1!=this.Search(i,s)){var n=this.Unlink(i,s);if(0>n)return n}var o=this.inodes[r],h=this.inodes[t];if(n=this.inodes[i],this.is_forwarder(h)||this.is_forwarder(n))if(this.is_forwarder(h)&&h.mount_id===n.mount_id){if(0>(t=await this.follow_fs(h).Rename(h.foreign_id,e,n.foreign_id,s)))return t}else{if(this.is_a_root(r))return us("XXX: Attempted to move mountpoint ("+e+") - skipped",b),-1;if(!this.IsDirectory(r)&&1<this.GetInode(r).nlinks)return us("XXX: Attempted to move hardlinked file ("+e+") across filesystems - skipped",b),-1;h=this.divert(t,e);const a=this.GetInode(r),_=await this.Read(h,0,a.size);if(this.is_forwarder(n)?(i=this.follow_fs(n),s=this.IsDirectory(h)?i.CreateDirectory(s,n.foreign_id):i.CreateFile(s,n.foreign_id),i=i.GetInode(s),this.copy_inode(a,i),this.set_forwarder(r,n.mount_id,s)):(this.delete_forwarder(o),this.copy_inode(a,o),this.link_under_dir(i,r,s)),await this.ChangeSize(r,a.size),_&&_.length&&await this.Write(r,0,_.length,_),this.IsDirectory(r))for(const t of this.GetChildren(h))if(0>(n=await this.Rename(h,t,r,t)))return n;if(await this.DeleteData(h),0>(t=this.Unlink(t,e)))return t}else this.unlink_from_dir(t,e),this.link_under_dir(i,r,s),o.qid.version++;return this.NotifyListeners(r,"rename",{oldpath:a}),0},Pr.prototype.Write=async function(t,e,i,s){this.NotifyListeners(t,"write");var r=this.inodes[t];if(this.is_forwarder(r))t=r.foreign_id,await this.follow_fs(r).Write(t,e,i,s);else{var a=await this.get_buffer(t);!a||a.length<e+i?(await this.ChangeSize(t,Math.floor(3*(e+i)/2)),r.size=e+i,a=await this.get_buffer(t)):r.size<e+i&&(r.size=e+i),s&&a.set(s.subarray(0,i),e),await this.set_data(t,a)}},Pr.prototype.Read=async function(t,e,i){const s=this.inodes[t];return this.is_forwarder(s)?(t=s.foreign_id,await this.follow_fs(s).Read(t,e,i)):await this.get_data(t,e,i)},Pr.prototype.Search=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){const i=t.foreign_id;return-1===(e=this.follow_fs(t).Search(i,e))?-1:this.get_forwarder(t.mount_id,e)}return void 0===(e=t.direntries.get(e))?-1:e},Pr.prototype.CountUsedInodes=function(){let t=this.inodes.length;for(const{fs:e,backtrack:i}of this.mounts)t+=e.CountUsedInodes(),t-=i.size;return t},Pr.prototype.CountFreeInodes=function(){let t=1048576;for(const{fs:e}of this.mounts)t+=e.CountFreeInodes();return t},Pr.prototype.GetTotalSize=function(){let t=this.used_size;for(const{fs:e}of this.mounts)t+=e.GetTotalSize();return t},Pr.prototype.GetSpace=function(){let t=this.total_size;for(const{fs:e}of this.mounts)t+=e.GetSpace();return this.total_size},Pr.prototype.GetDirectoryName=function(t){const e=this.inodes[this.GetParent(t)];if(this.is_forwarder(e))return this.follow_fs(e).GetDirectoryName(this.inodes[t].foreign_id);if(!e)return"";for(const[i,s]of e.direntries)if(s===t)return i;return ls(!1,"Filesystem: Found directory inode whose parent doesn't link to it"),""},Pr.prototype.GetFullPath=function(t){ls(this.IsDirectory(t),"Filesystem: Cannot get full path of non-directory inode");for(var e="";0!=t;)e="/"+this.GetDirectoryName(t)+e,t=this.GetParent(t);return e.substring(1)},Pr.prototype.Link=function(t,e,i){if(this.IsDirectory(e))return-1;const s=this.inodes[t],r=this.inodes[e];return this.is_forwarder(s)?this.is_forwarder(r)&&r.mount_id===s.mount_id?this.follow_fs(s).Link(s.foreign_id,r.foreign_id,i):(us("XXX: Attempted to hardlink a file into a child filesystem - skipped",b),-1):this.is_forwarder(r)?(us("XXX: Attempted to hardlink file across filesystems - skipped",b),-1):(this.link_under_dir(t,e,i),0)},Pr.prototype.Unlink=function(t,e){if("."===e||".."===e)return-1;const i=this.Search(t,e),s=this.inodes[i],r=this.inodes[t];return this.is_forwarder(r)?(ls(this.is_forwarder(s),"Children of forwarders should be forwarders"),t=r.foreign_id,this.follow_fs(r).Unlink(t,e)):this.IsDirectory(i)&&!this.IsEmpty(i)?-39:(this.unlink_from_dir(t,e),0===s.nlinks&&(s.status=Or,this.NotifyListeners(i,"delete")),0)},Pr.prototype.DeleteData=async function(t){const e=this.inodes[t];this.is_forwarder(e)?await this.follow_fs(e).DeleteData(e.foreign_id):(e.size=0,delete this.inodedata[t])},Pr.prototype.get_buffer=async function(t){const e=this.inodes[t];return ls(e,`Filesystem get_buffer: idx ${t} does not point to an inode`),this.inodedata[t]?this.inodedata[t]:2===e.status?(ls(e.sha256sum,"Filesystem get_data: found inode on server without sha256sum"),await this.storage.read(e.sha256sum,0,e.size)):null},Pr.prototype.get_data=async function(t,e,i){const s=this.inodes[t];return ls(s,`Filesystem get_data: idx ${t} does not point to an inode`),this.inodedata[t]?this.inodedata[t].subarray(e,e+i):2===s.status?(ls(s.sha256sum,"Filesystem get_data: found inode on server without sha256sum"),await this.storage.read(s.sha256sum,e,i)):null},Pr.prototype.set_data=async function(t,e){this.inodedata[t]=e,2===this.inodes[t].status&&(this.inodes[t].status=0,this.storage.uncache(this.inodes[t].sha256sum))},Pr.prototype.GetInode=function(t){return ls(!isNaN(t),"Filesystem GetInode: NaN idx"),ls(0<=t&&t<this.inodes.length,"Filesystem GetInode: out of range idx:"+t),t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).GetInode(t.foreign_id):t},Pr.prototype.ChangeSize=async function(t,e){var i=this.GetInode(t),s=await this.get_data(t,0,i.size);if(e!=i.size){var r=new Uint8Array(e);i.size=e,s&&r.set(s.subarray(0,Math.min(s.length,i.size)),0),await this.set_data(t,r)}},Pr.prototype.SearchPath=function(t){0<(t=(t=t.replace("//","/")).split("/")).length&&0===t[t.length-1].length&&t.pop(),0<t.length&&0===t[0].length&&t.shift();const e=t.length;var i=-1,s=0;let r=null;for(var a=0;a<e;a++)if(i=s,s=this.Search(i,t[a]),!r&&this.is_forwarder(this.inodes[i])&&(r="/"+t.slice(a).join("/")),-1==s)return a<e-1?{id:-1,parentid:-1,name:t[a],forward_path:r}:{id:-1,parentid:i,name:t[a],forward_path:r};return{id:s,parentid:i,name:t[a],forward_path:r}},Pr.prototype.GetRecursiveList=function(t,e){if(this.is_forwarder(this.inodes[t])){const i=this.follow_fs(this.inodes[t]),s=this.inodes[t].mount_id,r=e.length;for(i.GetRecursiveList(this.inodes[t].foreign_id,e),t=r;t<e.length;t++)e[t].parentid=this.get_forwarder(s,e[t].parentid)}else for(const[i,s]of this.inodes[t].direntries)"."!==i&&".."!==i&&(e.push({parentid:t,name:i}),this.IsDirectory(s)&&this.GetRecursiveList(s,e))},Pr.prototype.RecursiveDelete=function(t){var e=[];if(-1!==(t=this.SearchPath(t)).id)for(this.GetRecursiveList(t.id,e),t=e.length-1;0<=t;t--){const i=this.Unlink(e[t].parentid,e[t].name);ls(0===i,"Filesystem RecursiveDelete failed at parent="+e[t].parentid+", name='"+e[t].name+"' with error code: "+-i)}},Pr.prototype.DeleteNode=function(t){var e=this.SearchPath(t);-1!=e.id&&((this.inodes[e.id].mode&Sr)==Tr?ls(0===(t=this.Unlink(e.parentid,e.name)),"Filesystem DeleteNode failed with error code: "+-t):(this.inodes[e.id].mode&Sr)==Ur&&(this.RecursiveDelete(t),ls(0===(t=this.Unlink(e.parentid,e.name)),"Filesystem DeleteNode failed with error code: "+-t)))},Pr.prototype.NotifyListeners=function(t,e,i){},Pr.prototype.Check=function(){for(var t=1;t<this.inodes.length;t++)if(-1!=this.inodes[t].status){var e=this.GetInode(t);if(0>e.nlinks&&Nr.Debug("Error in filesystem: negative nlinks="+e.nlinks+" at id ="+t),this.IsDirectory(t)){e=this.GetInode(t),this.IsDirectory(t)&&0>this.GetParent(t)&&Nr.Debug("Error in filesystem: negative parent id "+t);for(const[t,i]of e.direntries){0===t.length&&Nr.Debug("Error in filesystem: inode with no name and id "+i);for(const e of t)32>e&&Nr.Debug("Error in filesystem: Unallowed char in filename")}}}},Pr.prototype.FillDirectory=function(t){var e=this.inodes[t];if(this.is_forwarder(e))this.follow_fs(e).FillDirectory(e.foreign_id);else{var i=0;for(const t of e.direntries.keys())i+=24+Wr.UTF8Length(t);t=this.inodedata[t]=new Uint8Array(i),e.size=i,i=0;for(const[s,r]of e.direntries)e=this.GetInode(r),i+=Br.Marshall(["Q","d","b","s"],[e.qid,i+13+8+1+2+Wr.UTF8Length(s),e.mode>>12,s],t,i)}},Pr.prototype.RoundToDirentry=function(t,e){const i=this.inodedata[t];if(ls(i,`FS directory data for dirid=${t} should be generated`),ls(i.length,"FS directory should have at least an entry"),e>=i.length)return i.length;for(t=0;;){const s=Br.Unmarshall(["Q","d"],i,{offset:t})[1];if(s>e)break;t=s}return t},Pr.prototype.IsDirectory=function(t){return t=this.inodes[t],this.is_forwarder(t)?this.follow_fs(t).IsDirectory(t.foreign_id):(t.mode&Sr)===Ur},Pr.prototype.IsEmpty=function(t){if(t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).IsDirectory(t.foreign_id);for(const e of t.direntries.keys())if("."!==e&&".."!==e)return!1;return!0},Pr.prototype.GetChildren=function(t){if(ls(this.IsDirectory(t),"Filesystem: cannot get children of non-directory inode"),t=this.inodes[t],this.is_forwarder(t))return this.follow_fs(t).GetChildren(t.foreign_id);const e=[];for(const i of t.direntries.keys())"."!==i&&".."!==i&&e.push(i);return e},Pr.prototype.GetParent=function(t){if(ls(this.IsDirectory(t),"Filesystem: cannot get parent of non-directory inode"),t=this.inodes[t],this.should_be_linked(t))return t.direntries.get("..");const e=this.follow_fs(t).GetParent(t.foreign_id);return ls(-1!==e,"Filesystem: should not have invalid parent ids"),this.get_forwarder(t.mount_id,e)},Pr.prototype.PrepareCAPs=function(t){return(t=this.GetInode(t)).caps||(t.caps=new Uint8Array(20),t.caps[0]=0,t.caps[1]=0,t.caps[2]=0,t.caps[3]=2,t.caps[4]=255,t.caps[5]=255,t.caps[6]=255,t.caps[7]=255,t.caps[8]=255,t.caps[9]=255,t.caps[10]=255,t.caps[11]=255,t.caps[12]=63,t.caps[13]=0,t.caps[14]=0,t.caps[15]=0,t.caps[16]=63,t.caps[17]=0,t.caps[18]=0,t.caps[19]=0),t.caps.length},Mr.prototype.get_state=function(){const t=[];return t[0]=this.fs,t[1]=[...this.backtrack],t},Mr.prototype.set_state=function(t){this.fs=t[0],this.backtrack=new Map(t[1])},Pr.prototype.set_forwarder=function(t,e,i){const s=this.inodes[t];ls(0===s.nlinks,"Filesystem: attempted to convert an inode into forwarder before unlinking the inode"),this.is_forwarder(s)&&this.mounts[s.mount_id].backtrack.delete(s.foreign_id),s.status=5,s.mount_id=e,s.foreign_id=i,this.mounts[e].backtrack.set(i,t)},Pr.prototype.create_forwarder=function(t,e){const i=this.CreateInode(),s=this.inodes.length;return this.inodes.push(i),i.fid=s,this.set_forwarder(s,t,e),s},Pr.prototype.is_forwarder=function(t){return 5===t.status},Pr.prototype.is_a_root=function(t){return 0===this.GetInode(t).fid},Pr.prototype.get_forwarder=function(t,e){var i=this.mounts[t];return ls(0<=e,"Filesystem get_forwarder: invalid foreign_id: "+e),ls(i,"Filesystem get_forwarder: invalid mount number: "+t),void 0===(i=i.backtrack.get(e))?this.create_forwarder(t,e):i},Pr.prototype.delete_forwarder=function(t){ls(this.is_forwarder(t),"Filesystem delete_forwarder: expected forwarder"),t.status=-1,this.mounts[t.mount_id].backtrack.delete(t.foreign_id)},Pr.prototype.follow_fs=function(t){const e=this.mounts[t.mount_id];return ls(this.is_forwarder(t),"Filesystem follow_fs: inode should be a forwarding inode"),ls(e,"Filesystem follow_fs: inode<id="+t.fid+"> should point to valid mounted FS"),e.fs},Pr.prototype.Mount=function(t,e){ls(e.qidcounter===this.qidcounter,"Cannot mount filesystem whose qid numbers aren't synchronised with current filesystem.");var i=this.SearchPath(t);return-1===i.parentid?(us("Mount failed: parent for path not found: "+t,b),-2):-1!==i.id?(us("Mount failed: file already exists at path: "+t,b),-17):i.forward_path?(t=this.inodes[i.parentid],0>(i=this.follow_fs(t).Mount(i.forward_path,e))?i:this.get_forwarder(t.mount_id,i)):(t=this.mounts.length,this.mounts.push(new Mr(e)),e=this.create_forwarder(t,0),this.link_under_dir(i.parentid,e,i.name),e)},Fr.prototype.get_state=function(){const t=[];return t[0]=this.type,t[1]=this.start,t[2]=1/0===this.length?0:this.length,t[3]=this.proc_id,t[4]=this.client_id,t},Fr.prototype.set_state=function(t){this.type=t[0],this.start=t[1],this.length=0===t[2]?1/0:t[2],this.proc_id=t[3],this.client_id=t[4]},Fr.prototype.clone=function(){const t=new Fr;return t.set_state(this.get_state()),t},Fr.prototype.conflicts_with=function(t){return!(this.proc_id===t.proc_id&&this.client_id===t.client_id||this.type===rt||t.type===rt||1!==this.type&&1!==t.type||this.start+this.length<=t.start||t.start+t.length<=this.start)},Fr.prototype.is_alike=function(t){return t.proc_id===this.proc_id&&t.client_id===this.client_id&&t.type===this.type},Fr.prototype.may_merge_after=function(t){return this.is_alike(t)&&t.start+t.length===this.start},Pr.prototype.DescribeLock=function(t,e,i,s,r){ls(0===t||1===t||t===rt,"Filesystem: Invalid lock type: "+t),ls(0<=e,"Filesystem: Invalid negative lock starting offset: "+e),ls(0<i,"Filesystem: Invalid non-positive lock length: "+i);const a=new Fr;return a.type=t,a.start=e,a.length=i,a.proc_id=s,a.client_id=r,a},Pr.prototype.GetLock=function(t,e){if(t=this.inodes[t],this.is_forwarder(t)){var i=t.foreign_id;return this.follow_fs(t).GetLock(i,e)}for(i of t.locks)if(e.conflicts_with(i))return i.clone();return null},Pr.prototype.Lock=function(t,e,i){const s=this.inodes[t];if(this.is_forwarder(s))return t=s.foreign_id,this.follow_fs(s).Lock(t,e,i);if((e=e.clone()).type!==rt&&this.GetLock(t,e))return 1;for(i=0;i<s.locks.length;i++){if(ls(0<(t=s.locks[i]).length,"Filesystem: Found non-positive lock region length: "+t.length),ls(0===t.type||1===t.type,"Filesystem: Found invalid lock type: "+t.type),ls(!s.locks[i-1]||s.locks[i-1].start<=t.start,"Filesystem: Locks should be sorted by starting offset"),t.start+t.length<=e.start)continue;if(e.start+e.length<=t.start)break;if(t.proc_id!==e.proc_id||t.client_id!==e.client_id){ls(!t.conflicts_with(e),"Filesytem: Found conflicting lock region, despite already checked for conflicts");continue}var r=e.start+e.length;const a=e.start-t.start,n=t.start+t.length-r;if(0<a&&0<n&&t.type===e.type)return 0;if(0<a&&(t.length=a),0>=a&&0<n)t.start=r,t.length=n;else if(0<n){for(;i<s.locks.length&&s.locks[i].start<r;)i++;s.locks.splice(i,0,this.DescribeLock(t.type,r,n,t.proc_id,t.client_id))}else 0>=a&&(s.locks.splice(i,1),i--)}if(e.type!==rt){for(i=e,t=!1,r=0;r<s.locks.length&&(i.may_merge_after(s.locks[r])&&(s.locks[r].length+=e.length,i=s.locks[r],t=!0),!(e.start<=s.locks[r].start));r++);for(t||(s.locks.splice(r,0,i),r++);r<s.locks.length;r++)if(s.locks[r].is_alike(i)){s.locks[r].may_merge_after(i)&&(i.length+=s.locks[r].length,s.locks.splice(r,1));break}}return 0},Pr.prototype.read_dir=function(t){if(-1!==(t=this.SearchPath(t)).id)return t=this.GetInode(t.id),Array.from(t.direntries.keys()).filter((t=>"."!==t&&".."!==t))},Pr.prototype.read_file=function(t){if(-1===(t=this.SearchPath(t)).id)return Promise.resolve(null);const e=this.GetInode(t.id);return this.Read(t.id,0,e.size)};var Nr={Debug:function(t){us([].slice.apply(arguments).join(" "),b)},Abort:function(){if(ot)throw Error("message.Abort()")}};var Br={Marshall:function(t,e,i,s){for(var r,a=0,n=0;n<t.length;n++)switch(r=e[n],t[n]){case"w":i[s++]=255&r,i[s++]=r>>8&255,i[s++]=r>>16&255,i[s++]=r>>24&255,a+=4;break;case"d":i[s++]=255&r,i[s++]=r>>8&255,i[s++]=r>>16&255,i[s++]=r>>24&255,i[s++]=0,i[s++]=0,i[s++]=0,i[s++]=0,a+=8;break;case"h":i[s++]=255&r,i[s++]=r>>8,a+=2;break;case"b":i[s++]=r,a+=1;break;case"s":var o=s,h=0;for(var _ of(i[s++]=0,i[s++]=0,a+=2,r))jr(_.charCodeAt(0)).forEach((function(t){i[s++]=t,a+=1,h++}));i[o+0]=255&h,i[o+1]=h>>8&255;break;case"Q":Br.Marshall(["b","w","d"],[r.type,r.version,r.path],i,s),s+=13,a+=13;break;default:Nr.Debug("Marshall: Unknown type="+t[n])}return a},Unmarshall:function(t,e,i){let s=i.offset;for(var r=[],a=0;a<t.length;a++)switch(t[a]){case"w":var n=e[s++];n+=e[s++]<<8,n+=e[s++]<<16,n+=e[s++]<<24>>>0,r.push(n);break;case"d":n=e[s++],n+=e[s++]<<8,n+=e[s++]<<16,n+=e[s++]<<24>>>0,s+=4,r.push(n);break;case"h":n=e[s++],r.push(n+(e[s++]<<8));break;case"b":r.push(e[s++]);break;case"s":n=e[s++],n+=e[s++]<<8;for(var o="",h=new Gr,_=0;_<n;_++){var d=h.Put(e[s++]);-1!=d&&(o+=String.fromCharCode(d))}r.push(o);break;case"Q":i.offset=s,n=Br.Unmarshall(["b","w","d"],e,i),s=i.offset,r.push({type:n[0],version:n[1],path:n[2]});break;default:Nr.Debug("Error in Unmarshall: Unknown type="+t[a])}return i.offset=s,r}},Wr={};function Gr(){this.stream=new Uint8Array(5),this.ofs=0,this.Put=function(t){switch(this.stream[this.ofs]=t,this.ofs++,this.ofs){case 1:if(128>this.stream[0])return this.ofs=0,this.stream[0];break;case 2:if(192==(224&this.stream[0])&&128==(192&this.stream[1]))return this.ofs=0,(31&this.stream[0])<<6|63&this.stream[1]}return-1}}function jr(t){return 128>t?[t]:2048>t?[192|t>>6&31,128|63&t]:void 0}Wr.UTF8Length=function(t){for(var e=0,i=0;i<t.length;i++){e+=128>t.charCodeAt(i)?1:2}return e}}).call(this);