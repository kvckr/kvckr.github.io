const param_types={"eye-gaze-mode":"bool","vertical-color-box-mode":"bool","speech-recognition-mode":"bool",local:"string",session:"string",load:"string"},exclusive_params=["local","session","load"];function get_all_url_params(){const e={};location.hash.replace(/^#/,"").split(/,/).forEach((t=>{const o=t.indexOf(":");if(-1===o){e[t]=!0}else{const a=t.slice(0,o),n=t.slice(o+1);e[a]=decodeURIComponent(n)}}));for(const[t,o]of Object.entries(param_types))"bool"!==o||e[t]||(e[t]=!1);return e}function get_url_param(e){return get_all_url_params()[e]}function change_url_param(e,t,{replace_history_state:o=!1}={}){change_some_url_params({[e]:t},{replace_history_state:o})}function change_some_url_params(e,{replace_history_state:t=!1}={}){for(const t of exclusive_params)e[t]&&exclusive_params.forEach((o=>{o!==t&&(e[o]=null)}));set_all_url_params(Object.assign({},get_all_url_params(),e),{replace_history_state:t})}function set_all_url_params(e,{replace_history_state:t=!1}={}){let o="";for(const[t,a]of Object.entries(param_types))e[t]&&(o.length&&(o+=","),o+=encodeURIComponent(t),"bool"!==a&&(o+=":"+encodeURIComponent(e[t])));const a=`${location.origin}${location.pathname}#${o}`;try{t?history.replaceState(null,document.title,a):history.pushState(null,document.title,a)}catch(e){location.hash=o}$G.triggerHandler("change-url-params")}function update_magnified_canvas_size(){$canvas.css("width",main_canvas.width*magnification),$canvas.css("height",main_canvas.height*magnification),update_canvas_rect()}function update_canvas_rect(){canvas_bounding_client_rect=main_canvas.getBoundingClientRect(),update_helper_layer()}let helper_layer_update_queued,info_for_updating_pointer,$custom_zoom_window;function update_helper_layer(e){e&&isFinite(e.clientX)&&(info_for_updating_pointer={clientX:e.clientX,clientY:e.clientY,devicePixelRatio}),helper_layer_update_queued||(helper_layer_update_queued=!0,requestAnimationFrame((()=>{helper_layer_update_queued=!1,update_helper_layer_immediately()})))}function update_helper_layer_immediately(){if(info_for_updating_pointer){const e=info_for_updating_pointer.devicePixelRatio/devicePixelRatio;info_for_updating_pointer.clientX*=e,info_for_updating_pointer.clientY*=e,info_for_updating_pointer.devicePixelRatio=devicePixelRatio,pointer=to_canvas_coords(info_for_updating_pointer)}const e=magnification*window.devicePixelRatio;helper_layer||(helper_layer=new OnCanvasHelperLayer(0,0,main_canvas.width,main_canvas.height,!1,e));const t=Math.floor(Math.max($canvas_area.scrollLeft()/magnification-15,0)),o=Math.floor(Math.max($canvas_area.scrollTop()/magnification-15,0)),a=Math.floor(Math.min(t+$canvas_area.width()/magnification+30,main_canvas.width))-t,n=Math.floor(Math.min(o+$canvas_area.height()/magnification+30,main_canvas.height))-o,i=a*e,l=n*e;if(helper_layer.canvas.width===i&&helper_layer.canvas.height===l||(helper_layer.canvas.width=i,helper_layer.canvas.height=l,helper_layer.canvas.ctx.disable_image_smoothing(),helper_layer.width=a,helper_layer.height=n),helper_layer.x=t,helper_layer.y=o,helper_layer.position(),render_canvas_view(helper_layer.canvas,e,t,o,!0),thumbnail_canvas&&$thumbnail_window.is(":visible")){const e=parseFloat($canvas_area.css("padding-left")),t=parseFloat($canvas_area.css("padding-top")),o=main_canvas.clientWidth+e-$canvas_area[0].clientWidth,a=main_canvas.clientHeight+t-$canvas_area[0].clientHeight;let n=$canvas_area[0].scrollLeft/Math.max(1,o),i=$canvas_area[0].scrollTop/Math.max(1,a);n=Math.min(n,1),i=Math.min(i,1);let l=Math.floor(Math.max(n*(main_canvas.width-thumbnail_canvas.width),0)),r=Math.floor(Math.max(i*(main_canvas.height-thumbnail_canvas.height),0));render_canvas_view(thumbnail_canvas,1,l,r,!1)}}function render_canvas_view(e,t,o,a,n){update_fill_and_stroke_colors_and_lineWidth(selected_tool);const i=show_grid&&magnification>=4&&window.devicePixelRatio*magnification>=4&&n,l=e.ctx;l.clearRect(0,0,e.width,e.height),n||l.drawImage(main_canvas,o,a,e.width,e.height,0,0,e.width,e.height);var r=[...selected_tools];$("body").hasClass("dragging")&&!pointer_active&&(r=r.filter((e=>e.id===TOOL_CURVE||e.id===TOOL_POLYGON))),r.sort(((e,t)=>e.selectBox&&!t.selectBox?-1:!e.selectBox&&t.selectBox?1:0));var s=r.findIndex((e=>e.selectBox));s>=0&&(r=r.filter(((e,t)=>!e.selectBox||t==s))),r.forEach((e=>{e.drawPreviewUnderGrid&&pointer&&pointers.length<2&&(l.save(),e.drawPreviewUnderGrid(l,pointer.x,pointer.y,i,t,-o,-a),l.restore())})),selection&&(l.save(),l.scale(t,t),l.translate(-o,-a),l.drawImage(selection.canvas,selection.x,selection.y),l.restore(),n||selection.dragging||draw_selection_box(l,selection.x,selection.y,selection.width,selection.height,t,-o,-a)),textbox&&(l.save(),l.scale(t,t),l.translate(-o,-a),l.drawImage(textbox.canvas,textbox.x,textbox.y),l.restore(),n||textbox.dragging||draw_selection_box(l,textbox.x,textbox.y,textbox.width,textbox.height,t,-o,-a)),i&&draw_grid(l,t),r.forEach((e=>{e.drawPreviewAboveGrid&&pointer&&pointers.length<2&&(l.save(),e.drawPreviewAboveGrid(l,pointer.x,pointer.y,i,t,-o,-a),l.restore())}))}function update_disable_aa(){const e=window.devicePixelRatio*magnification,t=Math.floor(e)===e;$canvas_area.toggleClass("disable-aa-for-things-at-main-canvas-scale",e>=3||t)}function set_magnification(e,t){t=t??{x:$canvas_area.scrollLeft()/magnification,y:$canvas_area.scrollTop()/magnification};const o=from_canvas_coords(t);magnification=e,1!==e&&(return_to_magnification=e),update_magnified_canvas_size();const a=from_canvas_coords(t);$canvas_area[0].scrollBy({left:a.clientX-o.clientX,top:a.clientY-o.clientY,behavior:"instant"}),$G.triggerHandler("resize"),$G.trigger("option-changed")}let $file_load_from_url_window,dev_custom_zoom=!1;try{dev_custom_zoom="true"===localStorage.dev_custom_zoom}catch(e){}function show_custom_zoom_window(){$custom_zoom_window&&$custom_zoom_window.close();const e=new $DialogWindow(localize("Custom Zoom"));$custom_zoom_window=e,e.addClass("custom-zoom-window"),e.$main.append(`<div class='current-zoom'>${localize("Current zoom:")} <bdi>${100*magnification}%</bdi></div>`);const t=$(E("fieldset")).appendTo(e.$main);t.append(`\n\t\t<legend>${localize("Zoom to")}</legend>\n\t\t<div class="fieldset-body">\n\t\t\t<input type="radio" name="custom-zoom-radio" id="zoom-option-1" value="1"/><label for="zoom-option-1">100%</label>\n\t\t\t<input type="radio" name="custom-zoom-radio" id="zoom-option-2" value="2"/><label for="zoom-option-2">200%</label>\n\t\t\t<input type="radio" name="custom-zoom-radio" id="zoom-option-4" value="4"/><label for="zoom-option-4">400%</label>\n\t\t\t<input type="radio" name="custom-zoom-radio" id="zoom-option-6" value="6"/><label for="zoom-option-6">600%</label>\n\t\t\t<input type="radio" name="custom-zoom-radio" id="zoom-option-8" value="8"/><label for="zoom-option-8">800%</label>\n\t\t\t<input type="radio" name="custom-zoom-radio" id="zoom-option-really-custom" value="really-custom"/><label for="zoom-option-really-custom"><input type="number" min="10" max="1000" name="really-custom-zoom-input" class="inset-deep no-spinner" value=""/>%</label>\n\t\t</div>\n\t`);let o=!0;t.find("input[type=radio]").get().forEach((e=>{parseFloat(e.value)===magnification&&(e.checked=!0,o=!1)}));const a=t.find("input[value='really-custom']"),n=t.find("input[name='really-custom-zoom-input']");n.closest("label").on("click",(()=>{a.prop("checked",!0),n[0].focus()})),o&&(n.val(100*magnification),a.prop("checked",!0)),t.find("label").css({display:"block"}),e.$Button(localize("OK"),(()=>{let o,a=t.find("input[name='custom-zoom-radio']:checked").val();if("really-custom"===a){if(a=n.val(),`${a}`.match(/\dx$/)?o=parseFloat(a):`${a}`.match(/\d%?$/)&&(o=parseFloat(a)/100),isNaN(o))return void please_enter_a_number()}else o=parseFloat(a);set_magnification(o),e.close()}))[0].focus(),e.$Button(localize("Cancel"),(()=>{e.close()})),e.center()}function toggle_grid(){show_grid=!show_grid,update_helper_layer()}function toggle_thumbnail(){show_thumbnail=!show_thumbnail,show_thumbnail?(thumbnail_canvas||(thumbnail_canvas=make_canvas(108,92),thumbnail_canvas.style.width="100%",thumbnail_canvas.style.height="100%"),$thumbnail_window||($thumbnail_window=new $Window({title:localize("Thumbnail"),toolWindow:!0,resizable:!0,innerWidth:thumbnail_canvas.width+4,innerHeight:thumbnail_canvas.height+4,minInnerWidth:56,minInnerHeight:40,minOuterWidth:0,minOuterHeight:0}),$thumbnail_window.addClass("thumbnail-window"),$thumbnail_window.$content.append(thumbnail_canvas),$thumbnail_window.$content.addClass("inset-deep"),$thumbnail_window.$content.css({marginTop:"1px"}),$thumbnail_window.maximize=()=>{},new ResizeObserver((e=>{const t=e[0];let o,a;"devicePixelContentBoxSize"in t?(o=t.devicePixelContentBoxSize[0].inlineSize,a=t.devicePixelContentBoxSize[0].blockSize):"contentBoxSize"in t?(o=Math.round(t.contentBoxSize[0].inlineSize*devicePixelRatio),a=Math.round(t.contentBoxSize[0].blockSize*devicePixelRatio)):(o=Math.round(t.contentRect.width*devicePixelRatio),a=Math.round(t.contentRect.height*devicePixelRatio)),o&&a&&(thumbnail_canvas.width=o,thumbnail_canvas.height=a),update_helper_layer_immediately()})).observe(thumbnail_canvas,{box:["device-pixel-content-box"]})),$thumbnail_window.show(),$thumbnail_window.on("close",(e=>{e.preventDefault(),$thumbnail_window.hide(),show_thumbnail=!1}))):$thumbnail_window.hide(),update_helper_layer()}function reset_selected_colors(){selected_colors={foreground:"#000000",background:"#ffffff",ternary:""},$G.trigger("option-changed")}function reset_file(){system_file_handle=null,file_name=localize("untitled"),file_format="image/png",saved=!0,update_title()}function reset_canvas_and_history(){undos.length=0,redos.length=0,current_history_node=root_history_node=make_history_node({name:localize("New"),icon:get_help_folder_icon("p_blank.png")}),history_node_to_cancel_to=null,main_canvas.width=Math.max(1,my_canvas_width),main_canvas.height=Math.max(1,my_canvas_height),main_ctx.disable_image_smoothing(),main_ctx.fillStyle=selected_colors.background,main_ctx.fillRect(0,0,main_canvas.width,main_canvas.height),current_history_node.image_data=main_ctx.getImageData(0,0,main_canvas.width,main_canvas.height),$canvas_area.trigger("resize"),$G.triggerHandler("history-update")}function make_history_node({parent:e=null,futures:t=[],timestamp:o=Date.now(),soft:a=!1,image_data:n=null,selection_image_data:i=null,selection_x:l,selection_y:r,textbox_text:s,textbox_x:c,textbox_y:d,textbox_width:_,textbox_height:m,text_tool_font:p=null,tool_transparent_mode:u,foreground_color:h,background_color:g,ternary_color:f,name:b,icon:w=null}){return{parent:e,futures:t,timestamp:o,soft:a,image_data:n,selection_image_data:i,selection_x:l,selection_y:r,textbox_text:s,textbox_x:c,textbox_y:d,textbox_width:_,textbox_height:m,text_tool_font:p,tool_transparent_mode:u,foreground_color:h,background_color:g,ternary_color:f,name:b,icon:w}}function update_title(){document.title=`${file_name} - ${is_pride_month?"June Solidarity ":""}${localize("Paint")}`,is_pride_month&&$("link[rel~='icon']").attr("href","./images/icons/gay-es-paint-16x16-light-outline.png"),window.setRepresentedFilename&&window.setRepresentedFilename(system_file_handle??""),window.setDocumentEdited&&window.setDocumentEdited(!saved)}function get_uris(e){const t=e.split(/[\n\r]+/).filter((e=>"#"!==e[0]&&e));if(t.length>15)return[];const o=[];for(let e=0;e<t.length;e++)try{const a=new URL(t[e]);o.push(a.href)}catch(e){}return o}async function load_image_from_uri(e){const t=e.match(/^blob:/i),o=!e.match(/^(blob|data|file):/i),a=e.match(/^(http|https):\/\/((127\.0\.0\.1|localhost)|.*(\.(local|localdomain|domain|lan|home|host|corp|invalid)))\b/i);if(t&&-1===e.indexOf(`blob:${location.origin}`)){const e=new Error("can't load blob: URI from another domain");throw e.code="cross-origin-blob-uri",e}const n=o&&!a?[e,`https://cors.bridged.cc/${e}`,`https://jspaint-cors-proxy.herokuapp.com/${e}`,`https://web.archive.org/${e}`]:[e],i=[];for(let e=0;e<n.length;e+=1){const t=n[e];try{o&&$status_text.text("Downloading picture...");const a=({loaded:e,total:t})=>{o&&$status_text.text(`Downloading picture... (${Math.round(e/t*100)}%)`)};o&&console.log(`Try loading image from URI (${e+1}/${n.length}): "${t}"`);const l=await fetch(t);let r=l;if(!l.ok){i.push({status:l.status,statusText:l.statusText,url:t});continue}if(l.body){const e=l.headers.get("content-encoding"),t=l.headers.get(e?"x-file-size":"content-length");if(null===t)o&&console.log("Response size header unavailable. Progress won't be shown for this image request.");else{const e=parseInt(t,10);let o=0;r=new Response(new ReadableStream({start(t){const n=l.body.getReader();!function i(){n.read().then((({done:n,value:l})=>{n?t.close():(o+=l.byteLength,a({loaded:o,total:e}),t.enqueue(l),i())})).catch((e=>{console.error(e),t.error(e)}))}()}}))}}else o&&console.log("ReadableStream not yet supported in this browser. Progress won't be shown for image requests.");const s=await r.blob();o&&(console.log("Download complete."),$status_text.text("Download complete."));const c=await new Promise(((e,t)=>{read_image_file(s,((o,a)=>{o?t(o):e(a)}))}));return c}catch(l){i.push({url:t,error:l})}}o&&$status_text.text("Failed to download picture.");const l=new Error(`failed to fetch image from any of ${n.length} URI(s):\n  ${i.map((e=>(e.statusText?`${e.status} ${e.statusText} `:"")+e.url+(e.error?`\n    ${e.error}`:""))).join("\n  ")}`);throw l.code="access-failure",l.fails=i,l}function open_from_image_info(e,t,o,a,n){are_you_sure((({canvas_modified_while_loading:o}={})=>{deselect(),cancel(),a||($G.triggerHandler("session-update"),new_local_session()),reset_file(),reset_selected_colors(),reset_canvas_and_history(),set_magnification(default_magnification),main_ctx.copy(e.image||e.image_data),apply_file_format_and_palette_info(e),transparency=has_any_transparency(main_ctx),$canvas_area.trigger("resize"),current_history_node.name=localize("Open"),current_history_node.image_data=main_ctx.getImageData(0,0,main_canvas.width,main_canvas.height),current_history_node.icon=get_help_folder_icon("p_open.png"),!o&&n||$G.triggerHandler("session-update"),$G.triggerHandler("history-update"),e.source_blob instanceof File&&(file_name=e.source_blob.name,system_file_handle=e.source_blob.path),e.source_file_handle&&(system_file_handle=e.source_file_handle),saved=!0,update_title(),t&&t()}),o,n)}function open_from_file(e,t){e.name.match(/\.theme(pack)?$/i)?e.text().then(load_theme_from_text,(e=>{show_error_message(localize("Paint cannot open this file."),e)})):read_image_file(e,((o,a)=>{o?AnyPalette.loadPalette(e,((e,t)=>{e?show_file_format_errors({as_image_error:o,as_palette_error:e}):(palette=t.map((e=>e.toString())),$colorbox.rebuild_palette(),window.console&&console.log(`Loaded palette: ${palette.map((()=>"%c█")).join("")}`,...palette.map((e=>`color: ${e};`))))})):(a.source_file_handle=t,open_from_image_info(a))}))}function apply_file_format_and_palette_info(e){file_format=e.file_format,enable_palette_loading_from_indexed_images&&(e.palette?(window.console&&console.log(`Loaded palette from image file: ${e.palette.map((()=>"%c█")).join("")}`,...e.palette.map((e=>`color: ${e};`))),palette=e.palette,selected_colors.foreground=palette[0],selected_colors.background=28===palette.length?palette[14]:palette[1],$G.trigger("option-changed")):monochrome&&!e.monochrome&&(palette=default_palette,reset_selected_colors()),$colorbox.rebuild_palette(),monochrome=e.monochrome)}function load_theme_from_text(e){var t=parseThemeFileString(e);t?(applyCSSProperties(t,{recurseIntoIframes:!0}),window.themeCSSProperties=t,$G.triggerHandler("theme-load")):show_error_message(localize("Paint cannot open this file."))}function file_new(){are_you_sure((()=>{deselect(),cancel(),$G.triggerHandler("session-update"),new_local_session(),reset_file(),reset_selected_colors(),reset_canvas_and_history(),set_magnification(default_magnification),$G.triggerHandler("session-update")}))}async function file_open(){const{file:e,fileHandle:t}=await systemHooks.showOpenFileDialog({formats:image_formats});open_from_file(e,t)}function file_load_from_url(){$file_load_from_url_window&&$file_load_from_url_window.close();const e=(new $DialogWindow).addClass("horizontal-buttons");$file_load_from_url_window=e,e.title("Load from URL"),e.$main.html('\n\t\t<div style=\'padding: 10px;\'>\n\t\t\t<label style="display: block; margin-bottom: 5px;" for="url-input">Paste or type the web address of an image:</label>\n\t\t\t<input type="url" required value="" id="url-input" class="inset-deep" style="width: 300px;"/></label>\n\t\t</div>\n\t');const t=e.$main.find("#url-input");e.$Button(localize("Open"),(()=>{const o=get_uris(t.val());o.length>0?(e.close(),change_url_param("load",o[0])):show_error_message("Invalid URL. It must include a protocol (https:// or http://)")})),e.$Button(localize("Cancel"),(()=>{e.close()})),e.center(),t[0].focus()}dev_custom_zoom&&$((()=>{show_custom_zoom_window(),$custom_zoom_window.css({left:80,top:50,opacity:.5})}));let acknowledged_overwrite_capability=!1;const confirmed_overwrite_key="jspaint confirmed overwrite capable";try{acknowledged_overwrite_capability="true"===localStorage[confirmed_overwrite_key]}catch(e){acknowledged_overwrite_capability=Date.now()>=2e12}async function confirm_overwrite_capability(){if(acknowledged_overwrite_capability)return!0;const{$window:e,promise:t}=showMessageBox({messageHTML:'\n\t\t\t<p>JS Paint can now save over existing files.</p>\n\t\t\t<p>Do you want to overwrite the file?</p>\n\t\t\t<p>\n\t\t\t\t<input type="checkbox" id="dont-ask-me-again-checkbox"/>\n\t\t\t\t<label for="dont-ask-me-again-checkbox">Don\'t ask me again</label>\n\t\t\t</p>\n\t\t',buttons:[{label:localize("Yes"),value:"overwrite",default:!0},{label:localize("Cancel"),value:"cancel"}]});if("overwrite"===await t){acknowledged_overwrite_capability=e.$content.find("#dont-ask-me-again-checkbox").prop("checked");try{localStorage[confirmed_overwrite_key]=acknowledged_overwrite_capability}catch(e){}return!0}return!1}function file_save(e=(()=>{}),t=!0){deselect();const o=system_file_handle;if(!o||file_name.match(/\.(svg|pdf)$/i))return file_save_as(e,t);write_image_file(main_canvas,file_format,(async a=>{await systemHooks.writeBlobToHandle(o,a),t&&update_from_saved_file(a),e()}))}function file_save_as(e=(()=>{}),t=!0){deselect(),systemHooks.showSaveFileDialog({dialogTitle:localize("Save As"),formats:image_formats,defaultFileName:file_name,defaultPath:"string"==typeof system_file_handle?system_file_handle:null,defaultFileFormatID:file_format,getBlob:e=>new Promise((t=>{write_image_file(main_canvas,e,(e=>{t(e)}))})),savedCallbackUnreliable:({newFileName:o,newFileFormatID:a,newFileHandle:n,newBlob:i})=>{saved=!0,system_file_handle=n,file_name=o,file_format=a,update_title(),e(),t&&update_from_saved_file(i)}})}function are_you_sure(e,t,o){saved?e():o?showMessageBox({message:localize("You've modified the document while an existing document was loading.\nSave the new document?",file_name),buttons:[{label:localize("Yes"),value:"save",default:!0},{label:localize("No"),value:"discard"}]}).then((t=>{"save"===t?file_save((()=>{e()}),!1):"discard"===t?e({canvas_modified_while_loading:!0}):e()})):showMessageBox({message:localize("Save changes to %1?",file_name),buttons:[{label:localize("Yes"),value:"save",default:!0},{label:localize("No"),value:"discard"},{label:localize("Cancel"),value:"cancel"}]}).then((o=>{"save"===o?file_save((()=>{e()}),!1):"discard"===o?e():t?.()}))}function please_enter_a_number(){showMessageBox({message:localize("Please enter a number.")})}function show_error_message(e,t){const{$message:o}=showMessageBox({iconID:"error",message:e});if(t){const e=$("<details><summary><span>Details</span></summary></details>").appendTo(o);let a=t.stack;a?t.message&&-1===a.indexOf(t.message)?a=`${t.toString()}\n\n${a}`:t.name&&-1===a.indexOf(t.name)&&(a=`${t.name}\n\n${a}`):a=t.toString(),$(E("pre")).text(a).appendTo(e).css({background:"white",color:"#333",fontFamily:"monospace",width:"500px",maxWidth:"100%",overflow:"auto"})}t?window.console?.error?.(e,t):window.console?.error?.(e)}function show_resource_load_error_message(e){const{$window:t,$message:o}=showMessageBox({}),a=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;"cross-origin-blob-uri"===e.code?o.html(`\n\t\t\t<p>Can't load image from address starting with "blob:".</p>\n\t\t\t${a?'<p>Try "Copy Image" instead of "Copy Image Location".</p>':'<p>Try "Copy image" instead of "Copy image address".</p>'}\n\t\t`):"html-not-image"===e.code?o.html("\n\t\t\t<p>Address points to a web page, not an image file.</p>\n\t\t\t<p>Try copying and pasting an image instead of a URL.</p>\n\t\t"):"decoding-failure"===e.code?o.html("\n\t\t\t<p>Address doesn't point to an image file of a supported format.</p>\n\t\t\t<p>Try copying and pasting an image instead of a URL.</p>\n\t\t"):"access-failure"===e.code?navigator.onLine?(o.html("\n\t\t\t\t<p>Failed to download image.</p>\n\t\t\t\t<p>Try copying and pasting an image instead of a URL.</p>\n\t\t\t"),e.fails&&$("<ul>").append(e.fails.map((({status:e,statusText:t,url:o})=>$("<li>").text(o).prepend($("<b>").text(`${e||""} ${t||"Failed"} `))))).appendTo(o)):o.html("\n\t\t\t\t<p>Failed to download image.</p>\n\t\t\t\t<p>You're offline. Connect to the internet and try again.</p>\n\t\t\t\t<p>Or copy and paste an image instead of a URL, if possible.</p>\n\t\t\t"):o.html("\n\t\t\t<p>Failed to load image from URL.</p>\n\t\t\t<p>Check your browser's devtools for details.</p>\n\t\t"),o.css({maxWidth:"500px"}),t.center()}function show_file_format_errors({as_image_error:e,as_palette_error:t}){let o=`\n\t\t<p>${localize("Paint cannot open this file.")}</p>\n\t`;e&&(o+=`\n\t\t\t<details>\n\t\t\t\t<summary>${localize("Bitmap Image")}</summary>\n\t\t\t\t<p>${localize("This is not a valid bitmap file, or its format is not currently supported.")}</p>\n\t\t\t</details>\n\t\t`);var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};const n=e=>String(e).replace(/[&<>"'`=/]/g,(e=>a[e])),i=t&&!e;if(t){let e="";e=t.errors?`<ul dir="ltr">${t.errors.map((e=>{const t=e.__PATCHED_LIB_TO_ADD_THIS__format;return t&&e.error?`<li><b>${n(`${t.name}`)}</b>: ${n((o=e.error.message,o.charAt(0).toUpperCase()+o.slice(1)))}</li>`:`<li>${n(e.message||e)}</li>`;var o})).join("\n")}</ul>`:`<p>${n(t.message||t)}</p>`,o+=`\n\t\t\t<details>\n\t\t\t\t<summary>${i?"Details":localize("Palette|*.pal|").split("|")[0]}</summary>\n\t\t\t\t<p>${localize("Unexpected file format.")}</p>\n\t\t\t\t${e}\n\t\t\t</details>\n\t\t`}showMessageBox({messageHTML:o})}let $about_paint_window;const $about_paint_content=$("#about-paint");function show_about_paint(){$about_paint_window&&$about_paint_window.close(),$about_paint_window=$Window({title:localize("About Paint"),resizable:!1,maximizeButton:!1,minimizeButton:!1}),$about_paint_window.addClass("about-paint squish"),is_pride_month&&$("#paint-32x32").attr("src","./images/icons/gay-es-paint-32x32-light-outline.png"),$about_paint_window.$content.append($about_paint_content.show()).css({padding:"15px"}),$about_paint_window.center(),$about_paint_window.center(),$about_paint_window.$Button(localize("OK"),(()=>{$about_paint_window.close()})).attr("id","close-about-paint").focus().css({float:"right",marginBottom:"10px"})}function exit_fullscreen_if_ios(){if($("body").hasClass("ios"))try{document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()}catch(e){}}function update_css_classes_for_conditional_messages(){$(".on-dev-host, .on-third-party-host, .on-official-host").hide(),location.hostname.match(/localhost|127.0.0.1/)?$(".on-dev-host").show():location.hostname.match(/jspaint.app/)?$(".on-official-host").show():$(".on-third-party-host").show(),$(".navigator-online, .navigator-offline").hide(),navigator.onLine?$(".navigator-online").show():$(".navigator-offline").show()}function paste_image_from_file(e){read_image_file(e,((e,t)=>{e?show_file_format_errors({as_image_error:e}):paste(t.image||make_canvas(t.image_data))}))}async function choose_file_to_paste(){const{file:e}=await systemHooks.showOpenFileDialog({formats:image_formats});e.type.match(/^image|application\/pdf/)?paste_image_from_file(e):show_error_message(localize("This is not a valid bitmap file, or its format is not currently supported."))}function paste(e){function t(){deselect(),select_tool(get_tool_by_id(TOOL_SELECT));const t=Math.max(0,Math.ceil($canvas_area.scrollLeft()/magnification)),o=Math.max(0,Math.ceil($canvas_area.scrollTop()/magnification));undoable({name:localize("Paste"),icon:get_help_folder_icon("p_paste.png"),soft:!0},(()=>{selection=new OnCanvasSelection(t,o,e.width,e.height,e)}))}e.width>main_canvas.width||e.height>main_canvas.height?showMessageBox({message:localize("The image in the clipboard is larger than the bitmap.")+"\n"+localize("Would you like the bitmap enlarged?"),iconID:"question",windowOptions:{icons:{16:"images/windows-16x16.png",32:"images/windows-32x32.png"}},buttons:[{label:localize("Yes"),value:"enlarge",default:!0},{label:localize("No"),value:"crop"},{label:localize("Cancel"),value:"cancel"}]}).then((o=>{"enlarge"===o?(resize_canvas_and_save_dimensions(Math.max(main_canvas.width,e.width),Math.max(main_canvas.height,e.height),{name:"Enlarge Canvas For Paste",icon:get_help_folder_icon("p_stretch_both.png")}),t(),$canvas_area.trigger("resize")):"crop"===o&&t()})):t()}function render_history_as_gif(){const e=$DialogWindow();e.title("Rendering GIF");const t=e.$main,o=$(E("progress")).appendTo(t).addClass("inset-deep"),a=$(E("span")).appendTo(t).css({width:"2.3em",display:"inline-block",textAlign:"center"});e.$main.css({padding:5});const n=e.$Button("Cancel",(()=>{e.close()})).focus();e.center();try{const i=main_canvas.width,l=main_canvas.height,r=new GIF({workerScript:"lib/gif.js/gif.worker.js",width:i,height:l});e.on("close",(()=>{r.abort()})),r.on("progress",(e=>{o.val(e),a.text(~~(100*e)+"%")})),r.on("finished",(o=>{e.title("Rendered GIF");const a=URL.createObjectURL(o);t.empty().append($(E("div")).addClass("inset-deep").append($(E("img")).attr({src:a,width:i,height:l}).css({display:"block"})).css({overflow:"auto",maxHeight:"70vh",maxWidth:"70vw"})),e.on("close",(()=>{URL.revokeObjectURL(a)})),e.$Button("Upload to Imgur",(()=>{e.close(),sanity_check_blob(o,(()=>{show_imgur_uploader(o)}))})).focus(),e.$Button(localize("Save"),(()=>{e.close(),sanity_check_blob(o,(()=>{const e=`${file_name.replace(/\.(bmp|dib|a?png|gif|jpe?g|jpe|jfif|tiff?|webp|raw)$/i,"")} history.gif`;systemHooks.showSaveFileDialog({dialogTitle:localize("Save As"),getBlob:()=>o,defaultFileName:e,defaultPath:"string"==typeof system_file_handle?`${system_file_handle.replace(/[/\\][^/\\]*/,"")}/${e}`:null,defaultFileFormatID:"image/gif",formats:[{formatID:"image/gif",mimeType:"image/gif",name:localize("Animated GIF (*.gif)").replace(/\s+\([^(]+$/,""),nameWithExtensions:localize("Animated GIF (*.gif)"),extensions:["gif"]}]})}))})),n.appendTo(e.$buttons),e.center()}));const s=make_canvas(i,l),c=[...undos,current_history_node];for(const e of c){if(s.ctx.clearRect(0,0,s.width,s.height),s.ctx.putImageData(e.image_data,0,0),e.selection_image_data){const t=make_canvas(e.selection_image_data);s.ctx.drawImage(t,e.selection_x,e.selection_y)}r.addFrame(s,{delay:200,copy:!0})}r.render()}catch(t){e.close(),show_error_message("Failed to render GIF.",t)}}function go_to_history_node(e,t,o){const a=current_history_node;if(!e.image_data)return void(t||(show_error_message("History entry has no image data."),window.console&&console.log("Target history entry has no image data:",e)));if(current_history_node=e,deselect(!0),t||cancel(!0),saved=!1,update_title(),main_ctx.copy(e.image_data),e.selection_image_data&&(selection&&selection.destroy(),e.name===localize("Free-Form Select")?select_tool(get_tool_by_id(TOOL_FREE_FORM_SELECT)):select_tool(get_tool_by_id(TOOL_SELECT)),selection=new OnCanvasSelection(e.selection_x,e.selection_y,e.selection_image_data.width,e.selection_image_data.height,e.selection_image_data)),null!=e.textbox_text){textbox&&textbox.destroy();for(const[t,o]of Object.entries(e.text_tool_font))text_tool_font[t]=o;selected_colors.foreground=e.foreground_color,selected_colors.background=e.background_color,tool_transparent_mode=e.tool_transparent_mode,$G.trigger("option-changed"),select_tool(get_tool_by_id(TOOL_TEXT)),textbox=new OnCanvasTextBox(e.textbox_x,e.textbox_y,e.textbox_width,e.textbox_height,e.textbox_text)}const n=get_history_ancestors(e);undos=[...n],undos.reverse();const i=redos.length>0?[redos[0],...get_history_ancestors(redos[0])]:[a,...get_history_ancestors(a)];redos.length=0;let l=e;for(;l.futures.length>0;){const e=[...l.futures];e.sort(((e,t)=>i.indexOf(e)>-1?-1:i.indexOf(t)>-1?1:0)),l=e[0],redos.unshift(l)}$canvas_area.trigger("resize"),$G.triggerHandler("session-update"),$G.triggerHandler("history-update")}function undoable({name:e,icon:t,use_loose_canvas_changes:o,soft:a},n){saved=!1,update_title();const i=current_history_node;n&&n(),current_history_node!==i&&(show_error_message(`History node switched during undoable callback for ${e}. This shouldn't happen.`),window.console&&console.log(`History node switched during undoable callback for ${e}, from`,i,"to",current_history_node));const l=main_ctx.getImageData(0,0,main_canvas.width,main_canvas.height);redos.length=0,undos.push(current_history_node);const r=make_history_node({image_data:l,selection_image_data:selection&&selection.canvas.ctx.getImageData(0,0,selection.canvas.width,selection.canvas.height),selection_x:selection&&selection.x,selection_y:selection&&selection.y,textbox_text:textbox&&textbox.$editor.val(),textbox_x:textbox&&textbox.x,textbox_y:textbox&&textbox.y,textbox_width:textbox&&textbox.width,textbox_height:textbox&&textbox.height,text_tool_font:JSON.parse(JSON.stringify(text_tool_font)),tool_transparent_mode,foreground_color:selected_colors.foreground,background_color:selected_colors.background,ternary_color:selected_colors.ternary,parent:current_history_node,name:e,icon:t,soft:a});current_history_node.futures.push(r),current_history_node=r,$G.triggerHandler("history-update"),$G.triggerHandler("session-update")}function make_or_update_undoable(e,t){0===current_history_node.futures.length&&e.match(current_history_node)?(t(),current_history_node.image_data=main_ctx.getImageData(0,0,main_canvas.width,main_canvas.height),current_history_node.selection_image_data=selection&&selection.canvas.ctx.getImageData(0,0,selection.canvas.width,selection.canvas.height),current_history_node.selection_x=selection&&selection.x,current_history_node.selection_y=selection&&selection.y,e.update_name&&(current_history_node.name=e.name),$G.triggerHandler("history-update")):undoable(e,t)}function undo(){if(undos.length<1)return!1;redos.push(current_history_node);let e=undos.pop();for(;e.soft&&undos.length;)redos.push(e),e=undos.pop();return go_to_history_node(e),!0}let $document_history_prompt_window,$document_history_window;function redo(){if(redos.length<1)return $document_history_prompt_window&&$document_history_prompt_window.close(),$document_history_window&&!$document_history_window.closed||($document_history_prompt_window=showMessageBox({title:"Redo",messageHTML:"To view all branches of the history tree, click <b>Edit > History</b>.",iconID:"info"}).$window),!1;undos.push(current_history_node);let e=redos.pop();for(;e.soft&&redos.length;)undos.push(e),e=redos.pop();return go_to_history_node(e),!0}function get_history_ancestors(e){const t=[];for(e=e.parent;e;e=e.parent)t.push(e);return t}function show_document_history(){$document_history_prompt_window&&$document_history_prompt_window.close(),$document_history_window&&$document_history_window.close();const e=$document_history_window=new $Window({title:"Document History",resizable:!1,maximizeButton:!1,minimizeButton:!1});e.addClass("history-window squish"),e.$content.html('\n\t\t<label>\n\t\t\t<select id="history-view-mode" class="inset-deep">\n\t\t\t\t<option value="linear">Linear timeline</option>\n\t\t\t\t<option value="tree">Tree</option>\n\t\t\t</select>\n\t\t</label>\n\t\t<div class="history-view" tabIndex="0"></div>\n\t');const t=e.$content.find(".history-view");t.focus();let o,a=0,n=[],i=e.$content.find("#history-view-mode");i.css({margin:"10px"});let l=i.val();function r(e){const i=$('\n\t\t\t<div class="history-entry">\n\t\t\t\t<div class="history-entry-icon-area"></div>\n\t\t\t\t<div class="history-entry-name"></div>\n\t\t\t</div>\n\t\t');if(i.find(".history-entry-name").text((e.name||"Unknown")+(e===root_history_node?" (Start of History)":"")),i.find(".history-entry-icon-area").append(e.icon),"tree"===l){let t=0;for(let o=e.parent;o;o=o.parent)t++;i.css({marginInlineStart:8*t+"px"})}if(e===current_history_node)i.addClass("current"),o=i,requestAnimationFrame((()=>{t[0].scrollTop=Math.min(i[0].offsetTop,Math.max(a,i[0].offsetTop-t[0].clientHeight+i.outerHeight()))}));else{get_history_ancestors(current_history_node).indexOf(e)>-1&&i.addClass("ancestor-of-current")}for(const t of e.futures)r(t);i.on("click",(()=>{go_to_history_node(e)})),i.history_node=e,n.push(i)}i.on("change",(()=>{l=i.val(),s()}));const s=()=>{a=t.scrollTop(),t.empty(),n=[],r(root_history_node),"linear"===l?n.sort(((e,t)=>e.history_node.timestamp<t.history_node.timestamp?-1:t.history_node.timestamp<e.history_node.timestamp?1:0)):n.reverse(),n.forEach((e=>{t.append(e)}))};s();const c=e=>{const t=n.indexOf(o)+e;n[t]&&n[t].click()};t.on("keydown",(e=>{e.ctrlKey||e.altKey||e.shiftKey||e.metaKey||("ArrowDown"===e.key||"Down"===e.key?(c(1),e.preventDefault()):"ArrowUp"!==e.key&&"Up"!==e.key||(c(-1),e.preventDefault()))})),$G.on("history-update",s),e.on("close",(()=>{$G.off("history-update",s)})),e.center()}function cancel(e,t){if(!history_node_to_cancel_to)return;const o=t&&current_history_node.parent&&current_history_node!==history_node_to_cancel_to&&0===current_history_node.futures.length?current_history_node:null;$G.triggerHandler("pointerup",["canceling",t]);for(const e of selected_tools)e.cancel&&e.cancel();if(!e&&(go_to_history_node(history_node_to_cancel_to,!0),o)){const e=o.parent.futures.indexOf(o);-1===e?(show_error_message("History node not found. Please report this bug."),console.log("history_node_to_discard",o),console.log("current_history_node",current_history_node),console.log("history_node_to_discard.parent",o.parent)):(o.parent.futures.splice(e,1),$G.triggerHandler("history-update"))}history_node_to_cancel_to=null,update_helper_layer()}function meld_selection_into_canvas(e){selection.draw(),selection.destroy(),selection=null,e||undoable({name:"Deselect",icon:get_icon_for_tool(get_tool_by_id(TOOL_SELECT)),use_loose_canvas_changes:!0},(()=>{}))}function meld_textbox_into_canvas(e){textbox.$editor.val()&&!e?(undoable({name:localize("Text"),icon:get_icon_for_tool(get_tool_by_id(TOOL_TEXT)),soft:!0},(()=>{})),undoable({name:"Finish Text",icon:get_icon_for_tool(get_tool_by_id(TOOL_TEXT))},(()=>{main_ctx.drawImage(textbox.canvas,textbox.x,textbox.y),textbox.destroy(),textbox=null}))):(textbox.destroy(),textbox=null)}function deselect(e){selection&&meld_selection_into_canvas(e),textbox&&meld_textbox_into_canvas(e);for(const e of selected_tools)e.end&&e.end(main_ctx)}function delete_selection(e={}){selection&&undoable({name:e.name||localize("Clear Selection"),icon:e.icon||get_help_folder_icon("p_delete.png")},(()=>{selection.destroy(),selection=null}))}function select_all(){deselect(),select_tool(get_tool_by_id(TOOL_SELECT)),undoable({name:localize("Select All"),icon:get_icon_for_tool(get_tool_by_id(TOOL_SELECT)),soft:!0},(()=>{selection=new OnCanvasSelection(0,0,main_canvas.width,main_canvas.height)}))}const ctrlOrCmd=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)?"⌘":"Ctrl",recommendationForClipboardAccess=`Please use the keyboard: ${ctrlOrCmd}+C to copy, ${ctrlOrCmd}+X to cut, ${ctrlOrCmd}+V to paste. If keyboard is not an option, try using Chrome version 76 or higher.`;function try_exec_command(e){return document.queryCommandEnabled(e)?(document.execCommand(e),navigator.userAgent.includes("Firefox")&&"paste"!==e?void 0:show_error_message(`That ${e} probably didn't work. ${recommendationForClipboardAccess}`)):show_error_message(`Cannot perform ${e}. ${recommendationForClipboardAccess}`)}function getSelectionText(){let e="";const t=document.activeElement,o=t?t.tagName.toLowerCase():null;return"textarea"==o||"input"==o&&/^(?:text|search|password|tel|url)$/i.test(t.type)&&"number"==typeof t.selectionStart?e=t.value.slice(t.selectionStart,t.selectionEnd):window.getSelection&&(e=window.getSelection().toString()),e}function edit_copy(e){const t=getSelectionText();if(t.length>0){if(!navigator.clipboard||!navigator.clipboard.writeText){if(e)return try_exec_command("copy");throw new Error(`${localize("Error getting the Clipboard Data!")} ${recommendationForClipboardAccess}`)}navigator.clipboard.writeText(t)}else if(selection&&selection.canvas){if(!navigator.clipboard||!navigator.clipboard.write){if(e)return try_exec_command("copy");throw new Error(`${localize("Error getting the Clipboard Data!")} ${recommendationForClipboardAccess}`)}selection.canvas.toBlob((e=>{sanity_check_blob(e,(()=>{navigator.clipboard.write([new ClipboardItem(Object.defineProperty({},e.type,{value:e,enumerable:!0}))]).then((()=>{window.console&&console.log("Copied image to the clipboard.")}),(e=>{show_error_message("Failed to copy to the Clipboard.",e)}))}))}))}}function edit_cut(e){if(!navigator.clipboard||!navigator.clipboard.write){if(e)return try_exec_command("cut");throw new Error(`${localize("Error getting the Clipboard Data!")} ${recommendationForClipboardAccess}`)}edit_copy(),delete_selection({name:localize("Cut"),icon:get_help_folder_icon("p_cut.png")})}async function edit_paste(e){if(document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement){if(!navigator.clipboard||!navigator.clipboard.readText){if(e)return try_exec_command("paste");throw new Error(`${localize("Error getting the Clipboard Data!")} ${recommendationForClipboardAccess}`)}const t=await navigator.clipboard.readText();document.execCommand("InsertText",!1,t)}else{if(!navigator.clipboard||!navigator.clipboard.read){if(e)return try_exec_command("paste");throw new Error(`${localize("Error getting the Clipboard Data!")} ${recommendationForClipboardAccess}`)}try{const e=await navigator.clipboard.read();paste_image_from_file(await e[0].getType("image/png"))}catch(e){if("NotFoundError"===e.name)try{const e=await navigator.clipboard.readText();if(e){const t=get_uris(e);t.length>0?load_image_from_uri(t[0]).then((e=>{paste(e.image||make_canvas(e.image_data))}),(e=>{show_resource_load_error_message(e)})):show_error_message("The information on the Clipboard can't be inserted into Paint.")}else show_error_message("The information on the Clipboard can't be inserted into Paint.")}catch(e){show_error_message(localize("Error getting the Clipboard Data!"),e)}else show_error_message(localize("Error getting the Clipboard Data!"),e)}}}function image_invert_colors(){apply_image_transformation({name:localize("Invert Colors"),icon:get_help_folder_icon("p_invert.png")},((e,t,o,a)=>{const n=monochrome&&detect_monochrome(t);monochrome&&n.isMonochrome?invert_monochrome(t,a,n):invert_rgb(t,a)}))}function clear(){deselect(),cancel(),undoable({name:localize("Clear Image"),icon:get_help_folder_icon("p_blank.png")},(()=>{saved=!1,update_title(),transparency?main_ctx.clearRect(0,0,main_canvas.width,main_canvas.height):(main_ctx.fillStyle=selected_colors.background,main_ctx.fillRect(0,0,main_canvas.width,main_canvas.height))}))}let cleanup_bitmap_view=()=>{};function view_bitmap(){let e;cleanup_bitmap_view(),bitmap_view_div=document.createElement("div"),bitmap_view_div.classList.add("bitmap-view","inset-deep"),document.body.appendChild(bitmap_view_div),$(bitmap_view_div).css({display:"flex",alignItems:"center",justifyContent:"center",position:"fixed",top:"0",left:"0",width:"100%",height:"100%",zIndex:"9999",background:"var(--Background)"}),bitmap_view_div.requestFullscreen?bitmap_view_div.requestFullscreen():bitmap_view_div.webkitRequestFullscreen&&bitmap_view_div.webkitRequestFullscreen();let t=!1,o=setInterval((()=>{document.fullscreenElement===bitmap_view_div||document.webkitFullscreenElement===bitmap_view_div?t=!0:t&&cleanup_bitmap_view()}),100);function a(){document.fullscreenElement!==bitmap_view_div&&document.webkitFullscreenElement!==bitmap_view_div&&cleanup_bitmap_view()}cleanup_bitmap_view=()=>{document.removeEventListener("fullscreenchange",a,{once:!0}),document.removeEventListener("webkitfullscreenchange",a,{once:!0}),document.removeEventListener("keydown",i),document.removeEventListener("mousedown",l),setTimeout((()=>{document.removeEventListener("contextmenu",r)}),100),URL.revokeObjectURL(e),clearInterval(o),document.fullscreenElement!==bitmap_view_div&&document.webkitFullscreenElement!==bitmap_view_div||(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()),bitmap_view_div.remove(),cleanup_bitmap_view=()=>{}},document.addEventListener("fullscreenchange",a,{once:!0}),document.addEventListener("webkitfullscreenchange",a,{once:!0}),document.addEventListener("keydown",i),document.addEventListener("mousedown",l),document.addEventListener("contextmenu",r);let n=!1;function i(e){n=n||e.repeat&&("f"===e.key||"F"===e.key),e.repeat||(!n||"f"!==e.key&&"F"!==e.key?(e.preventDefault(),cleanup_bitmap_view()):n=!1)}function l(e){cleanup_bitmap_view()}function r(e){e.preventDefault(),cleanup_bitmap_view()}main_canvas.toBlob((t=>{e=URL.createObjectURL(t);const o=document.createElement("img");o.src=e,bitmap_view_div.appendChild(o)}),"image/png")}function get_tool_by_id(e){for(let t=0;t<tools.length;t++)if(tools[t].id==e)return tools[t];for(let t=0;t<extra_tools.length;t++)if(extra_tools[t].id==e)return extra_tools[t]}function select_tools(e){for(let t=0;t<e.length;t++)select_tool(e[t],t>0);update_helper_layer()}function select_tool(e,t){if(deselect(),1===selected_tools.length&&selected_tool.deselect||(return_to_tools=[...selected_tools]),t){const t=selected_tools.indexOf(e);-1===t?(selected_tools.push(e),selected_tools.sort(((e,t)=>tools.indexOf(e)<tools.indexOf(t)?-1:tools.indexOf(e)>tools.indexOf(t)?1:0))):selected_tools.splice(t,1),selected_tools.length>0?selected_tool=selected_tools[selected_tools.length-1]:(selected_tool=default_tool,selected_tools=[selected_tool])}else selected_tool=e,selected_tools=[e];e.preload&&e.preload(),$toolbox.update_selected_tool()}function has_any_transparency(e){const t=e.getImageData(0,0,main_canvas.width,main_canvas.height);for(let e=0,o=t.data.length;e<o;e+=4)if(t.data[e+3]<253)return!0;return!1}function detect_monochrome(e){const t=e.getImageData(0,0,e.canvas.width,e.canvas.height),o=new Uint32Array(t.data.buffer),a=[],n=[];let i=!1;for(let e=0,l=o.length;e<l;e+=1)if(t.data[4*e+3]>1){if(!a.includes(o[e])){if(!(a.length<2))return{isMonochrome:!1};a.push(o[e]),n.push(t.data.slice(4*e,4*(e+1)))}}else i=!0;return{isMonochrome:!0,presentNonTransparentRGBAs:n,presentNonTransparentUint32s:a,monochromeWithTransparency:i}}function make_monochrome_pattern(e,t=[0,0,0,255],o=[255,255,255,255]){const a=Array.from({length:64},((e,t)=>{const o=t^t>>3;return((4&t)>>2|(4&o)>>1|(2&t)<<1|(2&o)<<2|(1&t)<<4|(1&o)<<5)/64})),n=document.createElement("canvas"),i=n.getContext("2d");n.width=8,n.height=8;const l=main_ctx.createImageData(n.width,n.height);for(let i=0;i<n.width;i+=1)for(let r=0;r<n.height;r+=1){const n=e>a[(7&i)+((7&r)<<3)],s=4*(r*l.width+i);l.data[s+0]=n?o[0]:t[0],l.data[s+1]=n?o[1]:t[1],l.data[s+2]=n?o[2]:t[2],l.data[s+3]=(n?o[3]:t[3])??255}return i.putImageData(l,0,0),main_ctx.createPattern(n,"repeat")}function make_monochrome_palette(e=[0,0,0,255],t=[255,255,255,255]){const o=[];for(let a=0;a<14;a++){let n=a/28;o.push(make_monochrome_pattern(n,e,t))}for(let a=0;a<14;a++){let n=1-a/28;o.push(make_monochrome_pattern(n,e,t))}return o}function make_stripe_pattern(e,t,o=4){const a=t.map(get_rgba_from_color),n=document.createElement("canvas"),i=n.getContext("2d");n.width=t.length*o,n.height=t.length*o;const l=main_ctx.createImageData(n.width,n.height);for(let i=0;i<n.width;i+=1)for(let r=0;r<n.height;r+=1){const n=4*(r*l.width+i),s=e?i-r:i+r,c=a[Math.floor((s+1e3)/o)%t.length];l.data[n+0]=c[0],l.data[n+1]=c[1],l.data[n+2]=c[2],l.data[n+3]=c[3]}return i.putImageData(l,0,0),main_ctx.createPattern(n,"repeat")}function switch_to_polychrome_palette(){}function make_opaque(){undoable({name:"Make Opaque",icon:get_help_folder_icon("p_make_opaque.png")},(()=>{main_ctx.save(),main_ctx.globalCompositeOperation="destination-atop",main_ctx.fillStyle=selected_colors.background,main_ctx.fillRect(0,0,main_canvas.width,main_canvas.height),main_ctx.fillStyle="white",main_ctx.fillRect(0,0,main_canvas.width,main_canvas.height),main_ctx.restore()}))}function resize_canvas_without_saving_dimensions(e,t,o={}){const a=Math.max(1,e),n=Math.max(1,t);main_canvas.width===a&&main_canvas.height===n||undoable({name:o.name||"Resize Canvas",icon:o.icon||get_help_folder_icon("p_stretch_both.png")},(()=>{try{const e=main_ctx.getImageData(0,0,a,n);main_canvas.width=a,main_canvas.height=n,main_ctx.disable_image_smoothing(),transparency||(main_ctx.fillStyle=selected_colors.background,main_ctx.fillRect(0,0,main_canvas.width,main_canvas.height));const t=make_canvas(e);main_ctx.drawImage(t,0,0)}catch(e){return void("NS_ERROR_FAILURE"===e.name?show_error_message(localize("Insufficient memory to perform operation."),e):show_error_message(localize("An unknown error has occurred."),e))}$canvas_area.trigger("resize")}))}function resize_canvas_and_save_dimensions(e,t,o={}){resize_canvas_without_saving_dimensions(e,t,o),storage.set({width:main_canvas.width,height:main_canvas.height},(()=>{}))}function image_attributes(){image_attributes.$window&&image_attributes.$window.close();const e=image_attributes.$window=new $DialogWindow(localize("Attributes"));e.addClass("attributes-window");const t=e.$main,o={[localize("File last saved:")]:localize("Not Available"),[localize("Size on disk:")]:localize("Not Available"),[localize("Resolution:")]:"72 x 72 dots per inch"},a=$(E("table")).appendTo(t);for(const e in o){const t=$(E("tr")).appendTo(a),n=($(E("td")).appendTo(t).text(e),$(E("td")).appendTo(t).text(o[e]));-1!==o[e].indexOf("72")&&n.css("direction","ltr")}const n={px:1,in:72,cm:28.3465};let i=image_attributes.unit=image_attributes.unit||"px",l=main_canvas.width,r=main_canvas.height;const s=$(E("label")).appendTo(t).text(localize("Width:")),c=$(E("label")).appendTo(t).text(localize("Height:")),d=$(E("input")).attr({type:"number",min:1}).addClass("no-spinner inset-deep").appendTo(s),_=$(E("input")).attr({type:"number",min:1}).addClass("no-spinner inset-deep").appendTo(c);t.find("input").css({width:"40px"}).on("change keyup keydown keypress pointerdown pointermove paste drop",(()=>{l=d.val()*n[i],r=_.val()*n[i]}));const m=$(E("fieldset")).appendTo(t).append(`\n\t\t<legend>${localize("Units")}</legend>\n\t\t<div class="fieldset-body">\n\t\t\t<input type="radio" name="units" id="unit-in" value="in"><label for="unit-in">${localize("Inches")}</label>\n\t\t\t<input type="radio" name="units" id="unit-cm" value="cm"><label for="unit-cm">${localize("Cm")}</label>\n\t\t\t<input type="radio" name="units" id="unit-px" value="px"><label for="unit-px">${localize("Pixels")}</label>\n\t\t</div>\n\t`);m.find(`[value=${i}]`).attr({checked:!0}),m.on("change",(()=>{const e=m.find(":checked").val();d.val(l/n[e]),_.val(r/n[e]),i=e})).triggerHandler("change");const p=$(E("fieldset")).appendTo(t).append(`\n\t\t<legend>${localize("Colors")}</legend>\n\t\t<div class="fieldset-body">\n\t\t\t<input type="radio" name="colors" id="attribute-monochrome" value="monochrome"><label for="attribute-monochrome">${localize("Black and white")}</label>\n\t\t\t<input type="radio" name="colors" id="attribute-polychrome" value="polychrome"><label for="attribute-polychrome">${localize("Colors")}</label>\n\t\t</div>\n\t`);p.find(`[value=${monochrome?"monochrome":"polychrome"}]`).attr({checked:!0});const u=$(E("fieldset")).appendTo(t).append(`\n\t\t<legend>${localize("Transparency")}</legend>\n\t\t<div class="fieldset-body">\n\t\t\t<input type="radio" name="transparency" id="attribute-transparent" value="transparent"><label for="attribute-transparent">${localize("Transparent")}</label>\n\t\t\t<input type="radio" name="transparency" id="attribute-opaque" value="opaque"><label for="attribute-opaque">${localize("Opaque")}</label>\n\t\t</div>\n\t`);u.find(`[value=${transparency?"transparent":"opaque"}]`).attr({checked:!0}),e.$Button(localize("OK"),(()=>{const e=u.find(":checked").val(),t=p.find(":checked").val(),o=m.find(":checked").val(),a=monochrome;let i;image_attributes.unit=o,transparency="transparent"==e,monochrome="monochrome"==t,monochrome!=a&&(selection&&meld_selection_into_canvas(),i=detect_monochrome(main_ctx),monochrome?i.isMonochrome&&2===i.presentNonTransparentRGBAs.length?palette=make_monochrome_palette(...i.presentNonTransparentRGBAs):palette=monochrome_palette:palette=polychrome_palette,selected_colors.foreground=palette[0],selected_colors.background=palette[14],selected_colors.ternary="",$colorbox.rebuild_palette(),$G.trigger("option-changed"));const l=n[o];resize_canvas_and_save_dimensions(~~(d.val()*l),~~(_.val()*l)),!transparency&&has_any_transparency(main_ctx)&&make_opaque(),monochrome!=a&&monochrome&&!i.isMonochrome&&show_convert_to_black_and_white(),image_attributes.$window.close()}))[0].focus(),e.$Button(localize("Cancel"),(()=>{image_attributes.$window.close()})),e.$Button(localize("Default"),(()=>{l=default_canvas_width,r=default_canvas_height,d.val(l/n[i]),_.val(r/n[i])})),image_attributes.$window.center()}function show_convert_to_black_and_white(){const e=new $DialogWindow("Convert to Black and White");e.addClass("convert-to-black-and-white"),e.$main.append("<fieldset><legend>Threshold:</legend><input type='range' min='0' max='1' step='0.01' value='0.5'></fieldset>");const t=e.$main.find("input[type='range']"),o=make_canvas(main_canvas);let a;const n=()=>{make_or_update_undoable({name:"Make Monochrome",match:e=>"Make Monochrome"===e.name,icon:get_help_folder_icon("p_monochrome.png")},(()=>{a=t.val(),main_ctx.copy(o),threshold_black_and_white(main_ctx,a)}))};n(),t.on("input",debounce(n,100)),e.$Button(localize("OK"),(()=>{e.close()})).focus(),e.$Button(localize("Cancel"),(()=>{"Make Monochrome"===current_history_node.name?undo():undoable({name:"Cancel Make Monochrome",icon:get_help_folder_icon("p_color.png")},(()=>{main_ctx.copy(o)})),e.close()})),e.center()}function image_flip_and_rotate(){const e=new $DialogWindow(localize("Flip and Rotate"));e.addClass("flip-and-rotate");const t=$(E("fieldset")).appendTo(e.$main);t.append(`\n\t\t<legend>${localize("Flip or rotate")}</legend>\n\t\t<div class="radio-wrapper">\n\t\t\t<input\n\t\t\t\ttype="radio"\n\t\t\t\tname="flip-or-rotate"\n\t\t\t\tid="flip-horizontal"\n\t\t\t\tvalue="flip-horizontal"\n\t\t\t\taria-keyshortcuts="Alt+F"\n\t\t\t\tchecked\n\t\t\t/><label for="flip-horizontal">${display_hotkey(localize("&Flip horizontal"))}</label>\n\t\t</div>\n\t\t<div class="radio-wrapper">\n\t\t\t<input\n\t\t\t\ttype="radio"\n\t\t\t\tname="flip-or-rotate"\n\t\t\t\tid="flip-vertical"\n\t\t\t\tvalue="flip-vertical"\n\t\t\t\taria-keyshortcuts="Alt+V"\n\t\t\t/><label for="flip-vertical">${display_hotkey(localize("Flip &vertical"))}</label>\n\t\t</div>\n\t\t<div class="radio-wrapper">\n\t\t\t<input\n\t\t\t\ttype="radio"\n\t\t\t\tname="flip-or-rotate"\n\t\t\t\tid="rotate-by-angle"\n\t\t\t\tvalue="rotate-by-angle"\n\t\t\t\taria-keyshortcuts="Alt+R"\n\t\t\t/><label for="rotate-by-angle">${display_hotkey(localize("&Rotate by angle"))}</label>\n\t\t</div>\n\t`);const o=$(E("div")).appendTo(t);o.addClass("sub-options");for(const e of["&90°","&180°","&270°"]){const t=parseInt(remove_hotkey(e),10);o.append(`\n\t\t\t<div class="radio-wrapper">\n\t\t\t\t<input\n\t\t\t\t\ttype="radio"\n\t\t\t\t\tname="rotate-by-angle"\n\t\t\t\t\tvalue="${t}"\n\t\t\t\t\tid="rotate-${t}"\n\t\t\t\t\taria-keyshortcuts="Alt+${get_hotkey(e).toUpperCase()}"\n\t\t\t\t/><label\n\t\t\t\t\tfor="rotate-${t}"\n\t\t\t\t>${display_hotkey(e)}</label>\n\t\t\t</div>\n\t\t`)}o.append(`\n\t\t<div class="radio-wrapper">\n\t\t\t<input\n\t\t\t\ttype="radio"\n\t\t\t\tname="rotate-by-angle"\n\t\t\t\tvalue="arbitrary"\n\t\t\t/><input\n\t\t\t\ttype="number"\n\t\t\t\tmin="-360"\n\t\t\t\tmax="360"\n\t\t\t\tname="rotate-by-arbitrary-angle"\n\t\t\t\tid="custom-degrees"\n\t\t\t\tvalue=""\n\t\t\t\tclass="no-spinner inset-deep"\n\t\t\t\tstyle="width: 50px"\n\t\t\t/>\n\t\t\t<label for="custom-degrees">${localize("Degrees")}</label>\n\t\t</div>\n\t`),o.find("#rotate-90").attr({checked:!0}),o.find("input").attr({disabled:!0}),t.find("input").on("change",(()=>{const e=t.find("input[name='flip-or-rotate']:checked").val();o.find("input").attr({disabled:"rotate-by-angle"!==e})})),o.find(".radio-wrapper").on("click",(e=>{t.find("input[value='rotate-by-angle']").prop("checked",!0),t.find("input").triggerHandler("change");const o=$(e.target).closest(".radio-wrapper"),a=o.find("input[type='number']")[0];a&&a.focus(),o.find("input[type='radio']").prop("checked",!0)})),t.find("input[name='rotate-by-arbitrary-angle']").on("input",(()=>{t.find("input[value='rotate-by-angle']").prop("checked",!0),t.find("input[value='arbitrary']").prop("checked",!0)})),e.$Button(localize("OK"),(()=>{switch(t.find("input[name='flip-or-rotate']:checked").val()){case"flip-horizontal":flip_horizontal();break;case"flip-vertical":flip_vertical();break;case"rotate-by-angle":{let e=t.find("input[name='rotate-by-angle']:checked").val();"arbitrary"===e&&(e=t.find("input[name='rotate-by-arbitrary-angle']").val());const o=parseFloat(e)/360*TAU;if(isNaN(o))return void please_enter_a_number();rotate(o);break}}$canvas_area.trigger("resize"),e.close()}))[0].focus(),e.$Button(localize("Cancel"),(()=>{e.close()})),e.center(),handle_keyshortcuts_alt_only(e)}function image_stretch_and_skew(){const e=new $DialogWindow(localize("Stretch and Skew"));e.addClass("stretch-and-skew");const t=$(E("fieldset")).appendTo(e.$main);t.append(`<legend>${localize("Stretch")}</legend><table></table>`);const o=$(E("fieldset")).appendTo(e.$main);o.append(`<legend>${localize("Skew")}</legend><table></table>`);const a=(e,t,o,a,n,i,l)=>{const r=$(E("tr")).appendTo(e),s=$(E("img")).attr({src:`images/transforms/${t}.png`,width:32,height:32}).css({marginRight:"20px"}),c=("input"+Math.random()+Math.random()).replace(/\./,""),d=$(E("input")).attr({type:"number",min:i,max:l,value:a,id:c,"aria-keyshortcuts":`Alt+${get_hotkey(o).toUpperCase()}`}).css({width:"40px"}).addClass("no-spinner inset-deep");return $(E("td")).appendTo(r).append(s),$(E("td")).appendTo(r).append($(E("label")).html(display_hotkey(o)).attr("for",c)),$(E("td")).appendTo(r).append(d),$(E("td")).appendTo(r).text(n),d},n=a(t.find("table"),"stretch-x",localize("&Horizontal:"),100,"%",1,5e3),i=a(t.find("table"),"stretch-y",localize("&Vertical:"),100,"%",1,5e3),l=a(o.find("table"),"skew-x",localize("H&orizontal:"),0,localize("Degrees"),-90,90),r=a(o.find("table"),"skew-y",localize("V&ertical:"),0,localize("Degrees"),-90,90);e.$Button(localize("OK"),(()=>{const t=parseFloat(n.val())/100,o=parseFloat(i.val())/100,a=parseFloat(l.val())/360*TAU,s=parseFloat(r.val())/360*TAU;if(isNaN(t)||isNaN(o)||isNaN(a)||isNaN(s))please_enter_a_number();else{try{stretch_and_skew(t,o,a,s)}catch(e){return void("NS_ERROR_FAILURE"===e.name?show_error_message(localize("Insufficient memory to perform operation."),e):show_error_message(localize("An unknown error has occurred."),e))}$canvas_area.trigger("resize"),e.close()}}))[0].focus(),e.$Button(localize("Cancel"),(()=>{e.close()})),e.center(),handle_keyshortcuts_alt_only(e)}function handle_keyshortcuts_alt_only(e){e.on("keydown",(t=>{if(t.altKey&&!t.ctrlKey&&!t.metaKey&&!t.shiftKey){let o=e.find(`[aria-keyshortcuts="Alt+${t.key.toUpperCase()}"]`)[0];o&&(t.preventDefault(),t.stopPropagation(),o.disabled&&(o=o.closest(".radio-wrapper")),o.click(),o.focus())}}))}function save_as_prompt({dialogTitle:e=localize("Save As"),defaultFileName:t="",defaultFileFormatID:o,formats:a,promptForName:n=!0}){return new Promise((i=>{const l=new $DialogWindow(e);l.addClass("save-as"),l.$content.attr("tabIndex",null),n&&l.$main.append('\n\t\t\t\t<label>\n\t\t\t\t\tFile name:\n\t\t\t\t\t<input type="text" class="file-name inset-deep"/>\n\t\t\t\t</label>\n\t\t\t'),l.$main.append('\n\t\t\t<label>\n\t\t\t\tSave as type:\n\t\t\t\t<select class="file-type-select inset-deep"></select>\n\t\t\t</label>\n\t\t');const r=l.$main.find(".file-type-select"),s=l.$main.find(".file-name");for(const e of a)r.append($("<option>").val(e.formatID).text(e.nameWithExtensions));n&&s.val(t);const c=()=>{const e=r.val();for(const t of a)if(t.formatID===e)return t},d=()=>{const e=(n?s.val():t).match(/\.([\w\d]+)$/);if(e){const t=c(),o=e[1].toLowerCase();if(t&&t.extensions.includes(o))return;for(const e of a)e.extensions.includes(o)&&r.val(e.formatID)}};n&&s.on("input",d),o&&a.some((e=>e.formatID===o))?r.val(o):d();const _=e=>{if(!n)return;let t=s.val();const o=c();if(!o)return;const a=o.extensions,i=a[0],l=t.replace(/\.(\w{1,3}|apng|jpeg|jfif|tiff|webp|psppalette|sketchpalette|gimp|colors|scss|sass|less|styl|html|theme|themepack)$/i,""),r=l!==t,d=t.slice(l.length+1).toLowerCase();(e||r)&&-1===a.indexOf(d)&&(t=`${l}.${i}`,s.val(t))};r.on("change",(()=>{_(!1)})),_(!1);const m=l.$Button(localize("Save"),(()=>{l.close(),_(!0),i({newFileName:n?s.val():t,newFileFormatID:r.val()})}));l.$Button(localize("Cancel"),(()=>{l.close()})),l.center(),(window.innerWidth<500||window.innerHeight<700)&&l.css({top:20}),n?s.focus().select():m.focus()}))}function write_image_file(e,t,o){const a=t.match(/^image\/(?:x-)?bmp\s*(?:-(\d+)bpp)?/);if(a){const t=encodeBMP(e.ctx.getImageData(0,0,e.width,e.height),parseInt(a[1]||"24",10)),n=new Blob([t]);sanity_check_blob(n,(()=>{o(n)}))}else if("image/png"===t){const t=e.ctx.getImageData(0,0,e.width,e.height),a=UPNG.encode([t.data.buffer],t.width,t.height),n=new Blob([a]);sanity_check_blob(n,(()=>{o(n)}))}else if("image/tiff"===t){const t=e.ctx.getImageData(0,0,e.width,e.height),a={t305:["jspaint (UTIF.js)"]},n=UTIF.encodeImage(t.data.buffer,t.width,t.height,a),i=new Blob([n]);sanity_check_blob(i,(()=>{o(i)}))}else e.toBlob((e=>{sanity_check_blob(e,(()=>{o(e)}),[137,80,78,71,13,10,26,10],"image/png"===t)}),t)}function read_image_file(e,t){let o,a,n=!1;e.arrayBuffer().then((i=>{const l={png:[137,80,78,71,13,10,26,10],bmp:[66,77],jpeg:[255,216,255],gif:[71,73,70,56],webp:[87,69,66,80],tiff_be:[77,77,0,42],tiff_le:[73,73,42,0],ico:[0,0,1,0],cur:[0,0,2,0],icns:[105,99,110,115]},r=new Uint8Array(i);let s;for(const[e,t]of Object.entries(l)){t.every(((e,t)=>e===r[t]))&&(s=e)}if(s||String.fromCharCode(...r.slice(0,1024)).includes("%PDF")&&(s="pdf"),"bmp"===s){const{colorTable:l,bitsPerPixel:r,imageData:s}=decodeBMP(i);o=24===r?"image/bmp":`image/bmp;bpp=${r}`,l.length>=2&&(2===l.length?(a=make_monochrome_palette(...l.map((e=>[e.r,e.g,e.b,255]))),n=!0):(a=l.map((e=>`rgb(${e.r}, ${e.g}, ${e.b})`)),n=!1)),t(null,{file_format:o,monochrome:n,palette:a,image_data:s,source_blob:e})}else if("png"===s){const l=UPNG.decode(i),r=UPNG.toRGBA8(l)[0],{width:s,height:c,tabs:d,ctype:_}=l;if(d.PLTE&&d.PLTE.length>=6&&3===_)if(6===d.PLTE.length)a=make_monochrome_palette([...d.PLTE.slice(0,3),d.tRNS?.[0]??255],[...d.PLTE.slice(3,6),d.tRNS?.[1]??255]),n=!0;else{a=new Array(d.PLTE.length/3);for(let e=0;e<a.length;e++)d.tRNS&&d.tRNS.length>=e+1?a[e]=`rgba(${d.PLTE[3*e+0]}, ${d.PLTE[3*e+1]}, ${d.PLTE[3*e+2]}, ${d.tRNS[e]/255})`:a[e]=`rgb(${d.PLTE[3*e+0]}, ${d.PLTE[3*e+1]}, ${d.PLTE[3*e+2]})`;n=!1}o="image/png";const m=new ImageData(new Uint8ClampedArray(r),s,c);t(null,{file_format:o,monochrome:n,palette:a,image_data:m,source_blob:e})}else if("tiff_be"===s||"tiff_le"===s){var c=UTIF.decode(i),d=c,_=0,m=d[0];c[0].subIFD&&(d=d.concat(c[0].subIFD));for(var p=0;p<d.length;p++){var u=d[p];if(!(null==u.t258||u.t258.length<3)){var h=u.t256*u.t257;h>_&&(_=h,m=u)}}UTIF.decodeImage(i,m,c);var g=UTIF.toRGBA8(m),f=new ImageData(new Uint8ClampedArray(g.buffer),m.width,m.height);o="image/tiff",t(null,{file_format:o,monochrome:n,palette:a,image_data:f,source_blob:e})}else if("pdf"===s){o="application/pdf";const l=window["pdfjs-dist/build/pdf"];l.GlobalWorkerOptions.workerSrc="lib/pdf.js/build/pdf.worker.js";const r=new Uint8Array(i);l.getDocument({data:r,cMapUrl:"lib/pdf.js/web/cmaps/",cMapPacked:!0}).promise.then((i=>{console.log("PDF loaded");i.getPage(1).then((i=>{console.log("Page loaded");var l=i.getViewport({scale:1.5}),r=make_canvas(l.width,l.height),s={canvasContext:r.ctx,viewport:l};i.render(s).promise.then((()=>{console.log("Page rendered");const i=r.ctx.getImageData(0,0,r.width,r.height);t(null,{file_format:o,monochrome:n,palette:a,image_data:i,source_blob:e})}))}))}),(e=>{t(new Error(`Failed to load PDF. ${e}`))}))}else{n=!1,o={png:"image/png",webp:"image/webp",jpeg:"image/jpeg",gif:"image/gif",tiff_be:"image/tiff",tiff_le:"image/tiff",ico:"image/x-icon",cur:"image/x-win-bitmap",icns:"image/icns"}[s]||e.type;const i=URL.createObjectURL(e),l=new Image,r=()=>{URL.revokeObjectURL(i),e.text().then((e=>{const o=new Error("failed to decode blob as an image");o.code=e.match(/^\s*<!doctype\s+html/i)?"html-not-image":"decoding-failure",t(o)}),(e=>{const o=new Error("failed to decode blob as image or text");o.code="decoding-failure",t(o)}))};l.onload=()=>{URL.revokeObjectURL(i),l.complete&&void 0!==l.naturalWidth&&0!==l.naturalWidth?t(null,{file_format:o,monochrome:n,palette:a,image:l,source_blob:e}):r()},l.onerror=r,l.src=i}}),(e=>{t(e)}))}function update_from_saved_file(e){read_image_file(e,((e,t)=>{if(e)return void show_error_message("The file has been saved, however... "+localize("Paint cannot read this file."),e);apply_file_format_and_palette_info(t);const o=image_formats.find((({mimeType:e})=>e===t.file_format));undoable({name:`${localize("Save As")} ${o?o.name:t.file_format}`,icon:get_help_folder_icon("p_save.png")},(()=>{main_ctx.copy(t.image||t.image_data)}))}))}function save_selection_to_file(){selection&&selection.canvas&&systemHooks.showSaveFileDialog({dialogTitle:localize("Save As"),defaultName:"selection.png",defaultFileFormatID:"image/png",formats:image_formats,getBlob:e=>new Promise((t=>{write_image_file(selection.canvas,e,(e=>{t(e)}))}))})}function sanity_check_blob(e,t,o,a=!0){e.size>0?o?e.arrayBuffer().then((e=>{const n=new Uint8Array(e);o.every(((e,t)=>e===n[t]))===a?t():showMessageBox({message:"Your browser does not support writing images in this file format.",iconID:"error"})}),(e=>{show_error_message(localize("An unknown error has occurred."),e)})):t():show_error_message(localize("Failed to save document."))}function show_multi_user_setup_dialog(e){const t=$DialogWindow().title("Multi-User Setup").addClass("horizontal-buttons");t.$main.html(`\n\t\t${e?"<p>This will make the current document public.</p>":""}\n\t\t<p>\n\t\t\t\x3c!-- Choose a name for the multi-user session, included in the URL for sharing: --\x3e\n\t\t\tEnter the session name that will be used in the URL for sharing:\n\t\t</p>\n\t\t<p>\n\t\t\t<label>\n\t\t\t\t<span class="partial-url-label">jspaint.app/#session:</span>\n\t\t\t\t<input\n\t\t\t\t\ttype="text"\n\t\t\t\t\tid="session-name"\n\t\t\t\t\taria-label="session name"\n\t\t\t\t\tpattern="[-0-9A-Za-z\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u02af\\u1d00-\\u1d25\\u1d62-\\u1d65\\u1d6b-\\u1d77\\u1d79-\\u1d9a\\u1e00-\\u1eff\\u2090-\\u2094\\u2184-\\u2184\\u2488-\\u2490\\u271d-\\u271d\\u2c60-\\u2c7c\\u2c7e-\\u2c7f\\ua722-\\ua76f\\ua771-\\ua787\\ua78b-\\ua78c\\ua7fb-\\ua7ff\\ufb00-\\ufb06]+"\n\t\t\t\t\ttitle="Numbers, letters, and hyphens are allowed."\n\t\t\t\t\tclass="inset-deep"\n\t\t\t\t>\n\t\t\t</label>\n\t\t</p>\n\t`);const o=t.$main.find("#session-name");t.$main.css({maxWidth:"500px"}),t.$Button("Start",(()=>{let a=o.val().trim();""==a?show_error_message("The session name cannot be empty."):o.is(":invalid")?show_error_message("The session name must be made from only numbers, letters, and hyphens."):(e?change_url_param("session",a):window.open(`${location.origin}${location.pathname}#session:${a}`),t.close())})),t.$Button(localize("Cancel"),(()=>{t.close()})),t.center(),o.focus()}