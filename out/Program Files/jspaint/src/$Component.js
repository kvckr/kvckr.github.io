(t=>{function e(t,e,o){return $(t).find(".component").not(o).toArray().map((o=>{const n={element:o};return"top"===e?(n.pos=o.offsetTop,n.length=o.clientHeight):"left"===e?(n.pos=o.offsetLeft,n.length=o.clientWidth):"right"===e&&(n.pos=t.scrollWidth-o.offsetLeft,n.length=o.clientWidth),n}))}function o(t,e){t.sort(((t,e)=>t.pos-e.pos));for(const o of t)o.pos=Math.max(o.pos,0),o.pos=Math.min(o.pos,e-o.length);for(let e=1;e<t.length;e++){const o=t[e],n=t[e-1],s=n.pos+n.length-o.pos;s>0&&(o.pos+=s)}for(const o of t)o.pos=Math.max(o.pos,0),o.pos=Math.min(o.pos,e-o.length);for(let e=t.length-2;e>=0;e--){const o=t[e],n=t[e+1],s=o.pos+o.length-n.pos;s>0&&(o.pos-=s)}}function n(t,e,o){let n=0;for(const t of o)t.margin_before=t.pos-n,n=t.length+t.pos;for(const n of o)t.appendChild(n.element),$(n.element).css(`margin-${e}`,n.margin_before)}window.$Component=function(t,s,i,l){const r=$(E("div")).addClass("component");r.addClass(s),r.addClass(i),r.append(l),r.css("touch-action","none");const c=new $ToolWindow(r);let d,a,h,p,g,f,m;c.title(t),c.hide(),c.$content.addClass({tall:"vertical",wide:"horizontal"}[i]),"colors-component"===s&&"wide"===i&&(r.css("position","relative"),r.css("margin-"+("rtl"===get_direction()?"right":"left"),"3px")),$("body").hasClass("eye-gaze-mode")&&(d=setInterval((()=>{r.css({transform:"scale(3)",transformOrigin:"0 0",marginRight:2*r[0].scrollWidth,marginBottom:2*r[0].scrollHeight})}),200));let u,w,C,v,b,y=0;u="tall"===i?"top":"rtl"===get_direction()?"right":"left";const B=t=>{c.hide();const s=e(t[0],u,r[0]);t.append(r),s.push({element:r[0],pos:y,length:r[0]["top"===u?"clientHeight":"clientWidth"]});o(s,"top"===u?t.height():t.width()),n(t[0],u,s),C=t,w=y},R=(t,s)=>{const i=r.closest(".component-area")[0],l=e(i,u,r[0]);r.css("position","relative"),r.css(`margin-${u}`,""),c.$content.append(r),c.show(),c.css({left:t,top:s});o(l,"top"===u?$(i).height():$(i).width()),n(i,u,l)};c.on("window-drag-start",(t=>{t.preventDefault()}));const M=()=>{const t=c.is(":visible");let e;c.show();let{offsetLeft:o,offsetTop:n}=r[0];if(0==r.closest(".tool-window").length){const t=getComputedStyle(r[0]);e=$(E("div")).addClass("component").css({width:t.width,height:t.height}),c.append(e),({offsetLeft:o,offsetTop:n}=e[0])}const s=c[0].getBoundingClientRect();e&&e.remove(),t||c.hide();const i=getComputedStyle(c[0]);return o+=parseFloat(i.borderLeftWidth),n+=parseFloat(i.borderTopWidth),{rect:s,offsetLeft:o,offsetTop:n}},T=(t=("top"===u?$left:$bottom))=>{if(0==r.closest(".tool-window").length)return{rect:r[0].getBoundingClientRect()};const e=getComputedStyle(r[0]),o=$(E("div")).addClass("component").css({width:e.width,height:e.height,flex:"0 0 auto"});t.prepend(o);const n=o[0].getBoundingClientRect();return o&&o.remove(),{rect:n}},W=t=>{const{rect:e}=v?T(v):M();f=2*~~(e.width/2)+1,m=2*~~(e.height/2)+1,b||(b=$(E("div")).addClass("component-ghost dock"),b.appendTo("body"));const o=v?0:3;b.css({position:"absolute",display:"block",width:f-2*o,height:m-2*o,left:t.clientX+(v?a:p)+o,top:t.clientY+(v?h:g)+o}),v?b.addClass("dock"):b.removeClass("dock")};r.add(c.$titlebar).on("pointerdown",(t=>{if(0!==t.button)return;if(!(r.is(t.target)||$(t.target).closest(c.$titlebar).length>0&&0===$(t.target).closest("button").length))return;if($("body").hasClass("eye-gaze-mode"))return;const e=T(),o=r[0].getBoundingClientRect();a=o.left-t.clientX,h=o.top-t.clientY,a=-Math.min(Math.max(-a,0),e.rect.width),h=-Math.min(Math.max(-h,0),e.rect.height);const{offsetLeft:n,offsetTop:s}=M();p=o.left-n-t.clientX,g=o.top-s-t.clientY,$("body").addClass("dragging"),$("body").css({cursor:"default"}).addClass("cursor-bully"),$G.on("pointermove",L),$G.one("pointerup",(t=>{$G.off("pointermove",L),k(t),$("body").removeClass("dragging"),$("body").css({cursor:""}).removeClass("cursor-bully"),$canvas.trigger("pointerleave")})),W(t),L(t),t.preventDefault()}));const L=t=>{b.css({left:t.clientX+a,top:t.clientY+h}),v=null;const{width:e,height:o}=T().rect,n=t.clientX+a,s=t.clientY+h,l=n+e,r=s+o;if("tall"===i?(u="top",n-5<$left[0].getBoundingClientRect().right&&(v=$left),l+5>$right[0].getBoundingClientRect().left&&(v=$right)):(u="rtl"===get_direction()?"right":"left",s-5<$top[0].getBoundingClientRect().bottom&&(v=$top),r+5>$bottom[0].getBoundingClientRect().top&&(v=$bottom)),v){const t=v[0].getBoundingClientRect();y=("top"===u?s:"right"===u?l:n)-t[u],"right"===u&&(y*=-1)}W(t),t.preventDefault()},k=t=>{c.hide(),r.parent().is(".component-area")&&(C=r.parent(),v&&(w=y)),v?B(v):R(t.clientX+p,t.clientY+g),b&&b.remove(),b=null,$G.trigger("resize")};return r.dock=t=>{y=w??0,B(t??C)},r.undock_to=R,r.show=()=>($(r[0]).show(),$.contains(c[0],r[0])&&c.show(),r),r.hide=()=>(r.add(c).hide(),r),r.toggle=()=>(r.is(":visible")?r.hide():r.show(),r),r.destroy=()=>{c.close(),r.remove(),clearInterval(d)},c.on("close",(t=>{t.preventDefault(),c.hide()})),r}})();