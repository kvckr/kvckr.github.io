const default_magnification=1,default_tool=get_tool_by_id(TOOL_PENCIL),default_canvas_width=683,default_canvas_height=384;let my_canvas_width=683,my_canvas_height=384,aliasing=!0,transparency=!1,monochrome=!1,magnification=1,return_to_magnification=4;const main_canvas=make_canvas();main_canvas.classList.add("main-canvas");const main_ctx=main_canvas.ctx,default_palette=["rgb(0,0,0)","rgb(128,128,128)","rgb(128,0,0)","rgb(128,128,0)","rgb(0,128,0)","rgb(0,128,128)","rgb(0,0,128)","rgb(128,0,128)","rgb(128,128,64)","rgb(0,64,64)","rgb(0,128,255)","rgb(0,64,128)","rgb(64,0,255)","rgb(128,64,0)","rgb(255,255,255)","rgb(192,192,192)","rgb(255,0,0)","rgb(255,255,0)","rgb(0,255,0)","rgb(0,255,255)","rgb(0,0,255)","rgb(255,0,255)","rgb(255,255,128)","rgb(0,255,128)","rgb(128,255,255)","rgb(128,128,255)","rgb(255,0,128)","rgb(255,128,64)"],monochrome_palette_as_colors=["rgb(0,0,0)","rgb(9,9,9)","rgb(18,18,18)","rgb(27,27,27)","rgb(37,37,37)","rgb(46,46,46)","rgb(55,55,55)","rgb(63,63,63)","rgb(73,73,73)","rgb(82,82,82)","rgb(92,92,92)","rgb(101,101,101)","rgb(110,110,110)","rgb(119,119,119)","rgb(255,255,255)","rgb(250,250,250)","rgb(242,242,242)","rgb(212,212,212)","rgb(201,201,201)","rgb(191,191,191)","rgb(182,182,182)","rgb(159,159,159)","rgb(128,128,128)","rgb(173,173,173)","rgb(164,164,164)","rgb(155,155,155)","rgb(146,146,146)","rgb(137,137,137)"];let palette=default_palette,polychrome_palette=palette,monochrome_palette=make_monochrome_palette();const basic_colors=["#FF8080","#FFFF80","#80FF80","#00FF80","#80FFFF","#0080FF","#FF80C0","#FF80FF","#FF0000","#FFFF00","#80FF00","#00FF40","#00FFFF","#0080C0","#8080C0","#FF00FF","#804040","#FF8040","#00FF00","#008080","#004080","#8080FF","#800040","#FF0080","#800000","#FF8000","#008000","#008040","#0000FF","#0000A0","#800080","#8000FF","#400000","#804000","#004000","#004040","#000080","#000040","#400040","#400080","#000000","#808000","#808040","#808080","#408080","#C0C0C0","#400040","#FFFFFF"];let custom_colors=["#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF"],enable_palette_loading_from_indexed_images=!1,enable_fs_access_api=!1;window.systemHooks=window.systemHooks||{},window.systemHookDefaults={showSaveFileDialog:async({formats:e,defaultFileName:t,defaultPath:o,defaultFileFormatID:a,getBlob:n,savedCallbackUnreliable:i,dialogTitle:r})=>{if(window.showSaveFilePicker&&!window.untrusted_gesture&&enable_fs_access_api){const{newFileFormatID:s}=await save_as_prompt({dialogTitle:r,defaultFileName:t,defaultFileFormatID:a,formats:e,promptForName:!1}),l=e.find((e=>e.formatID===s)),c=await n(l&&l.formatID);let d,_;e=[l];try{d=await showSaveFilePicker({types:e.map((e=>({description:e.name,accept:{[e.mimeType]:e.extensions.map((e=>"."+e))}})))}),_=d.name;const s=get_file_extension(_),p=async s=>{const p=await showMessageBox({message:`${s}\n\nTry adding .${l.extensions[0]} to the name. Sorry about this.`,iconID:"error",buttons:[{label:localize("Save As"),value:"show-save-as-dialog-again",default:!0},{label:localize("Save"),value:"save-without-extension"},{label:localize("Cancel"),value:"cancel"}]});if("show-save-as-dialog-again"===p)return window.systemHookDefaults.showSaveFileDialog({formats:e,defaultFileName:t,defaultPath:o,defaultFileFormatID:a,getBlob:n,savedCallbackUnreliable:i,dialogTitle:r});if("save-without-extension"===p){const e=await d.createWritable();await e.write(c),await e.close(),i&&i({newFileName:_,newFileFormatID:l&&l.formatID,newFileHandle:d,newBlob:c})}};if(!s)return await p(`'${_}' doesn't have an extension.`);if(!l.extensions.includes(s))return await p(`File extension '.${s}' does not match the selected file type ${l.name}.`);const m=await d.createWritable();await m.write(c),await m.close()}catch(e){if("AbortError"===e.name)return;return e.message.match(/gesture|activation/)?void show_error_message("Sorry, due to browser security measures, you must use the keyboard or mouse directly to save."):void show_error_message(localize("Failed to save document."),e)}i&&i({newFileName:_,newFileFormatID:l&&l.formatID,newFileHandle:d,newBlob:c})}else{const{newFileName:o,newFileFormatID:s}=await save_as_prompt({dialogTitle:r,defaultFileName:t,defaultFileFormatID:a,formats:e}),l=await n(s);saveAs(l,o),i&&i({newFileName:o,newFileFormatID:s,newFileHandle:null,newBlob:l})}},showOpenFileDialog:async({formats:e})=>{if(window.untrusted_gesture)throw show_error_message("Sorry, a file picker cannot be shown when using Speech Recognition or Eye Gaze Mode. You must click File > Open directly with the mouse, or press Ctrl+O on the keyboard."),new Error("can't show file picker reliably");if(window.showOpenFilePicker&&enable_fs_access_api){const[t]=await window.showOpenFilePicker({types:e.map((e=>({description:e.name,accept:{[e.mimeType]:e.extensions.map((e=>"."+e))}})))});return{file:await t.getFile(),fileHandle:t}}return new Promise((e=>{const t=$("<input type='file'>").on("change",(()=>{e({file:t[0].files[0]}),t.remove()})).appendTo($app).hide().trigger("click")}))},writeBlobToHandle:async(e,t)=>{if(e&&e.createWritable&&enable_fs_access_api){if(!await confirm_overwrite_capability())return;try{const o=await e.createWritable();await o.write(t),await o.close()}catch(e){if("AbortError"===e.name)return;if("NotAllowedError"===e.name)return void show_error_message(localize("Save was interrupted, so your file has not been saved."),e);if("SecurityError"===e.name)return void saveAs(t,file_name)}}else saveAs(t,file_name)},readBlobFromHandle:async e=>{if(e&&e.getFile){return await e.getFile()}throw new Error(`Unknown file handle (${e})`)},setWallpaperTiled:e=>{const t=make_canvas(screen.width,screen.height),o=t.ctx.createPattern(e,"repeat");t.ctx.fillStyle=o,t.ctx.fillRect(0,0,t.width,t.height),systemHooks.setWallpaperCentered(t)},setWallpaperCentered:e=>{systemHooks.showSaveFileDialog({dialogTitle:localize("Save As"),defaultName:`${file_name.replace(/\.(bmp|dib|a?png|gif|jpe?g|jpe|jfif|tiff?|webp|raw)$/i,"")} wallpaper.png`,defaultFileFormatID:"image/png",formats:image_formats,getBlob:t=>new Promise((o=>{write_image_file(e,t,(e=>{o(e)}))}))})}};for(const[e,t]of Object.entries(window.systemHookDefaults))window.systemHooks[e]=window.systemHooks[e]||t;function get_file_extension(e){return e.match(/\.([^./]+)$/)?.[1]||""}function get_format_from_extension(e,t){const o=t.match(/\.([^.]+)$/),a=o?o[1].toLowerCase():t;for(const t of e)if(t.extensions.includes(a))return t}window.image_formats=[];const add_image_format=(e,t,o=image_formats)=>{const a={formatID:e,mimeType:e,name:localize(t).replace(/\s+\([^(]+$/,""),nameWithExtensions:localize(t),extensions:[]},n=/\*\.([^);,]+)/g;if("rtl"===get_direction()){const e="‏",t="‎";a.nameWithExtensions=a.nameWithExtensions.replace(n,`${e}*.${t}$1${e}`)}let i;for(;i=n.exec(t);){const e=i[1];a.extensions.push(e)}o.push(a)};add_image_format("image/png","PNG (*.png)"),add_image_format("image/webp","WebP (*.webp)"),add_image_format("image/gif","GIF (*.gif)"),add_image_format("image/tiff","TIFF (*.tif;*.tiff)"),add_image_format("image/jpeg","JPEG (*.jpg;*.jpeg;*.jpe;*.jfif)"),add_image_format("image/x-bmp-1bpp","Monochrome Bitmap (*.bmp;*.dib)"),add_image_format("image/x-bmp-4bpp","16 Color Bitmap (*.bmp;*.dib)"),add_image_format("image/x-bmp-8bpp","256 Color Bitmap (*.bmp;*.dib)"),add_image_format("image/bmp","24-bit Bitmap (*.bmp;*.dib)");const formats_unique_per_file_extension=e=>(e=e.filter((e=>!e.extensions.includes("bmp")||"image/bmp"===e.mimeType))).filter(((t,o)=>!t.extensions.some((t=>e.some(((e,a)=>a<o&&e.extensions.includes(t))))))),palette_formats=[];for(const[e,t]of Object.entries(AnyPalette.formats))if(t.write){const o=t.fileExtensions.map((e=>`*.${e}`)).join(";");palette_formats.push({formatID:e,name:t.name,nameWithExtensions:`${t.name} (${o})`,extensions:t.fileExtensions})}palette_formats.sort(((e,t)=>("RIFF_PALETTE"===t.formatID)-("RIFF_PALETTE"===e.formatID)||("GIMP_PALETTE"===t.formatID)-("GIMP_PALETTE"===e.formatID)||0)),window.default_brush_shape="circle",window.default_brush_size=4,window.default_eraser_size=8,window.default_airbrush_size=9,window.default_pencil_size=1,window.default_stroke_size=1,window.brush_shape=default_brush_shape,window.brush_size=default_brush_size,window.eraser_size=default_eraser_size,window.airbrush_size=default_airbrush_size,window.pencil_size=default_pencil_size,window.stroke_size=default_stroke_size;let stroke_color,fill_color,selection,textbox,helper_layer,$thumbnail_window,thumbnail_canvas,tool_transparent_mode=!1,stroke_color_k="foreground",fill_color_k="background",selected_tool=default_tool,selected_tools=[selected_tool],return_to_tools=[selected_tool];window.selected_colors={foreground:"",background:"",ternary:""};let file_name,system_file_handle,pointer,pointer_start,pointer_previous,pointer_type,pointer_buttons,reverse,ctrl,button,show_grid=!1,show_thumbnail=!1,text_tool_font={family:'"Arial"',size:12,line_scale:20/12,bold:!1,italic:!1,underline:!1,vertical:!1,color:"",background:""},root_history_node=make_history_node({name:"App Not Loaded Properly - Please send a bug report."}),current_history_node=root_history_node,history_node_to_cancel_to=null,undos=[],redos=[],saved=!0,pointer_active=!1,pointer_over_canvas=!1,update_helper_layer_on_pointermove_active=!1,pointers=[];const update_from_url_params=()=>{location.hash.match(/eye-gaze-mode/i)?$("body").hasClass("eye-gaze-mode")||($("body").addClass("eye-gaze-mode"),$G.triggerHandler("eye-gaze-mode-toggled"),$G.triggerHandler("theme-load")):$("body").hasClass("eye-gaze-mode")&&($("body").removeClass("eye-gaze-mode"),$G.triggerHandler("eye-gaze-mode-toggled"),$G.triggerHandler("theme-load")),location.hash.match(/vertical-color-box-mode|eye-gaze-mode/i)?$("body").hasClass("vertical-color-box-mode")||($("body").addClass("vertical-color-box-mode"),$G.triggerHandler("vertical-color-box-mode-toggled"),$G.triggerHandler("theme-load")):$("body").hasClass("vertical-color-box-mode")&&($("body").removeClass("vertical-color-box-mode"),$G.triggerHandler("vertical-color-box-mode-toggled"),$G.triggerHandler("theme-load")),location.hash.match(/speech-recognition-mode/i)?window.enable_speech_recognition&&enable_speech_recognition():window.disable_speech_recognition&&disable_speech_recognition(),$("body").toggleClass("compare-reference",!!location.hash.match(/compare-reference/i)),$("body").toggleClass("compare-reference-tool-windows",!!location.hash.match(/compare-reference-tool-windows/i)),setTimeout((()=>{if(location.hash.match(/compare-reference/i)){select_tool(get_tool_by_id(TOOL_SELECT));const e=576,t=432;main_canvas.width===e&&main_canvas.height===t||resize_canvas_without_saving_dimensions(e,t),location.hash.match(/compare-reference-tool-windows/i)||($toolbox.dock($left),$colorbox.dock($bottom),window.debugKeepMenusOpen=!1)}location.hash.match(/compare-reference-tool-windows/i)&&($toolbox.undock_to(84,35),$colorbox.undock_to(239,195),window.debugKeepMenusOpen=!0,$(".help-menu-button")[0].dispatchEvent(new Event("pointerdown")),$(".help-menu-button")[0].dispatchEvent(new Event("pointerup")),$('[aria-label="About Paint"]')[0].dispatchEvent(new Event("pointerenter")))}),500)};update_from_url_params(),$G.on("hashchange popstate change-url-params",update_from_url_params),location.search.match(/eye-gaze-mode/)&&(change_url_param("eye-gaze-mode",!0,{replace_history_state:!0}),update_from_url_params()),location.search.match(/vertical-colors?-box/)&&(change_url_param("vertical-color-box",!0,{replace_history_state:!0}),update_from_url_params());const $app=$(E("div")).addClass("jspaint").appendTo("body"),$V=$(E("div")).addClass("vertical").appendTo($app),$H=$(E("div")).addClass("horizontal").appendTo($V),$canvas_area=$(E("div")).addClass("canvas-area inset-deep").appendTo($H),$canvas=$(main_canvas).appendTo($canvas_area);$canvas.css("touch-action","none");let canvas_bounding_client_rect=main_canvas.getBoundingClientRect();const canvas_handles=new Handles({$handles_container:$canvas_area,$object_container:$canvas_area,get_rect:()=>({x:0,y:0,width:main_canvas.width,height:main_canvas.height}),set_rect:({width:e,height:t})=>resize_canvas_and_save_dimensions(e,t),outset:4,get_handles_offset_left:()=>parseFloat($canvas_area.css("padding-left"))+1,get_handles_offset_top:()=>parseFloat($canvas_area.css("padding-top"))+1,get_ghost_offset_left:()=>parseFloat($canvas_area.css("padding-left"))+1,get_ghost_offset_top:()=>parseFloat($canvas_area.css("padding-top"))+1,size_only:!0}),$top=$(E("div")).addClass("component-area top").prependTo($V),$bottom=$(E("div")).addClass("component-area bottom").appendTo($V),$left=$(E("div")).addClass("component-area left").prependTo($H),$right=$(E("div")).addClass("component-area right").appendTo($H);"rtl"===get_direction()&&($left.appendTo($H),$right.prependTo($H));const $status_area=$(E("div")).addClass("status-area").appendTo($V),$status_text=$(E("div")).addClass("status-text status-field inset-shallow").appendTo($status_area),$status_position=$(E("div")).addClass("status-coordinates status-field inset-shallow").appendTo($status_area),$status_size=$(E("div")).addClass("status-coordinates status-field inset-shallow").appendTo($status_area);$status_text.default=()=>{$status_text.text(localize("For Help, click Help Topics on the Help Menu."))},$status_text.default();let menu_bar_outside_frame=!1;if(frameElement)try{parent.MenuBar&&(MenuBar=parent.MenuBar,menu_bar_outside_frame=!0)}catch(e){}const menu_bar=MenuBar(menus);menu_bar_outside_frame?$(menu_bar.element).insertBefore(frameElement):$(menu_bar.element).prependTo($V),$(menu_bar.element).on("info",(e=>{$status_text.text(e.detail?.description??"")})),$(menu_bar.element).on("default-info",(()=>{$status_text.default()}));let $toolbox=$ToolBox(tools),$colorbox=$ColorBox($("body").hasClass("vertical-color-box-mode"));$G.on("vertical-color-box-mode-toggled",(()=>{$colorbox.destroy(),$colorbox=$ColorBox($("body").hasClass("vertical-color-box-mode")),prevent_selection($colorbox)})),$G.on("eye-gaze-mode-toggled",(()=>{$colorbox.destroy(),$colorbox=$ColorBox($("body").hasClass("vertical-color-box-mode")),prevent_selection($colorbox),$toolbox.destroy(),$toolbox=$ToolBox(tools),prevent_selection($toolbox)})),$G.on("resize",(()=>{update_canvas_rect(),update_disable_aa()})),$canvas_area.on("scroll",(()=>{update_canvas_rect()})),$canvas_area.on("resize",(()=>{update_magnified_canvas_size()})),$G.on("scroll focusin",(()=>{window.scrollTo(0,0)})),$("body").on("dragover dragenter",(e=>{const t=e.originalEvent.dataTransfer;t&&Array.from(t.types).includes("Files")&&e.preventDefault()})).on("drop",(async e=>{if(e.isDefaultPrevented())return;const t=e.originalEvent.dataTransfer;if(t&&Array.from(t.types).includes("Files"))if(e.preventDefault(),window.FileSystemHandle&&!window.is_electron_app){for(const e of t.items)if("file"===e.kind){let t;try{t=await e.getAsFileSystemHandle()}catch(e){return void show_error_message(localize("File not found."),e)}if("file"===t.kind){let e;try{e=await t.getFile()}catch(e){return void show_error_message(localize("File not found."),e)}if(open_from_file(e,t),!window._open_images_serially)return;await new Promise((e=>setTimeout(e,500)))}}}else if(t.files&&t.files.length)if(window._open_images_serially){let e=0;const o=setInterval((()=>{console.log("opening",t.files[e].name),open_from_file(t.files[e]),e++,e>=t.files.length&&clearInterval(o)}),1500)}else open_from_file(t.files[0])})),$G.on("keydown",(e=>{if(!e.isDefaultPrevented()){if("Escape"===e.key&&textbox&&textbox.$editor.is(e.target)&&deselect(),(e.ctrlKey||e.metaKey)&&e.shiftKey&&!e.altKey&&"Y"===e.key.toUpperCase())return show_document_history(),void e.preventDefault();if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)){if(selection){const t=(e,t)=>{selection.x+=e,selection.y+=t,selection.position()};switch(e.key){case"ArrowLeft":t(-1,0),e.preventDefault();break;case"ArrowRight":t(1,0),e.preventDefault();break;case"ArrowDown":t(0,1),e.preventDefault();break;case"ArrowUp":t(0,-1),e.preventDefault()}}if("Escape"===e.key)selection?deselect():cancel(),window.stopSimulatingGestures&&window.stopSimulatingGestures(),window.trace_and_sketch_stop&&window.trace_and_sketch_stop();else if("Enter"===e.key)selection&&deselect();else if("F1"===e.key)show_help(),e.preventDefault();else if("F4"===e.key)redo();else if("Delete"===e.key||"Backspace"===e.key)"Delete"===e.key&&e.shiftKey?cut():"Backspace"===e.key&&e.altKey?undo():delete_selection(),e.preventDefault();else if("Insert"===e.key)e.ctrlKey?(copy(),e.preventDefault()):e.shiftKey&&(paste(),e.preventDefault());else{if("NumpadAdd"===e.code||"NumpadSubtract"===e.code||"+"===e.key||"-"===e.key||"="===e.key){const t=("NumpadAdd"===e.code||"+"===e.key||"="===e.key)-("NumpadSubtract"===e.code||"-"===e.key);return selection?selection.scale(2**t):(selected_tool.id===TOOL_BRUSH?brush_size=Math.max(1,Math.min(brush_size+t,500)):selected_tool.id===TOOL_ERASER?eraser_size=Math.max(1,Math.min(eraser_size+t,500)):selected_tool.id===TOOL_AIRBRUSH?airbrush_size=Math.max(1,Math.min(airbrush_size+t,500)):selected_tool.id===TOOL_PENCIL?pencil_size=Math.max(1,Math.min(pencil_size+t,50)):selected_tool.id!==TOOL_LINE&&selected_tool.id!==TOOL_CURVE&&selected_tool.id!==TOOL_RECTANGLE&&selected_tool.id!==TOOL_ROUNDED_RECTANGLE&&selected_tool.id!==TOOL_ELLIPSE&&selected_tool.id!==TOOL_POLYGON||(stroke_size=Math.max(1,Math.min(stroke_size+t,500))),$G.trigger("option-changed"),void 0!==button&&pointer&&selected_tools.forEach((e=>{tool_go(e)})),update_helper_layer()),void e.preventDefault()}if(e.ctrlKey||e.metaKey){if(textbox)switch(e.key.toUpperCase()){case"A":case"Z":case"Y":case"I":case"B":case"U":return}if("PageDown"===e.key)return set_magnification(4),void e.preventDefault();if("PageUp"===e.key)return set_magnification(1),void e.preventDefault();switch(e.key.toUpperCase()){case",":case"<":case"[":case"{":rotate(-TAU/4),$canvas_area.trigger("resize");break;case".":case">":case"]":case"}":rotate(+TAU/4),$canvas_area.trigger("resize");break;case"Z":e.shiftKey?redo():undo();break;case"Y":redo();break;case"G":e.shiftKey?render_history_as_gif():toggle_grid();break;case"F":e.repeat||e.originalEvent?.repeat||view_bitmap();break;case"O":file_open();break;case"S":e.shiftKey?file_save_as():file_save();break;case"A":select_all();break;case"I":image_invert_colors();break;case"E":image_attributes();break;case"N":e.shiftKey?clear():file_new();break;case"T":$toolbox.toggle();break;case"L":$colorbox.toggle();break;case"R":image_flip_and_rotate();break;case"W":image_stretch_and_skew();break;default:return}e.preventDefault()}}}}}));let alt_zooming=!1;addEventListener("keyup",(e=>{"Alt"===e.key&&alt_zooming&&e.preventDefault(),e.altKey||(alt_zooming=!1)})),addEventListener("wheel",(e=>{if(e.altKey){e.preventDefault();let t=magnification;return e.deltaY<0?t*=1.5:t/=1.5,t=Math.max(.5,Math.min(t,80)),set_magnification(t,to_canvas_coords(e)),void(alt_zooming=!0)}if(!e.ctrlKey&&!e.metaKey&&location.hash.match(/compare-reference/i)){const t=-.2*Math.sign(e.deltaY);let o=parseFloat($("body").attr("data-reference-opacity"));isFinite(o)||(o=.5);const a=Math.max(0,Math.min(1,o+t));$("body").attr("data-reference-opacity",a)}}),{passive:!1}),$G.on("cut copy paste",(e=>{if(e.isDefaultPrevented())return;if(document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement||!window.getSelection().isCollapsed)return;e.preventDefault();const t=e.originalEvent.clipboardData||window.clipboardData;if(t)if("copy"===e.type||"cut"===e.type){if(selection&&selection.canvas){const o=()=>{const o=selection.canvas.toDataURL();t.setData("text/x-data-uri; type=image/png",o),t.setData("text/uri-list",o),t.setData("URL",o),"cut"===e.type&&delete_selection({name:localize("Cut"),icon:get_help_folder_icon("p_cut.png")})};if(!navigator.clipboard||!navigator.clipboard.write)return o();try{"cut"===e.type?edit_cut():edit_copy()}catch(e){o()}}}else if("paste"===e.type)for(const e of t.items){if(e.type.match(/^text\/(?:x-data-uri|uri-list|plain)|URL$/)){e.getAsString((e=>{const t=get_uris(e);t.length>0?load_image_from_uri(t[0]).then((e=>{paste(e.image||make_canvas(e.image_data))}),(e=>{show_resource_load_error_message(e)})):show_error_message("The information on the Clipboard can't be inserted into Paint.")}));break}if(e.type.match(/^image\//)){paste_image_from_file(e.getAsFile());break}}})),reset_file(),reset_selected_colors(),reset_canvas_and_history(),set_magnification(1),storage.get({width:683,height:384},((e,t)=>{e||(my_canvas_width=t.width,my_canvas_height=t.height,make_or_update_undoable({match:e=>e.name===localize("New"),name:"Resize Canvas For New Document",icon:get_help_folder_icon("p_stretch_both.png")},(()=>{main_canvas.width=Math.max(1,my_canvas_width),main_canvas.height=Math.max(1,my_canvas_height),main_ctx.disable_image_smoothing(),transparency||(main_ctx.fillStyle=selected_colors.background,main_ctx.fillRect(0,0,main_canvas.width,main_canvas.height)),$canvas_area.trigger("resize")})))})),window.initial_system_file_handle&&systemHooks.readBlobFromHandle(window.initial_system_file_handle).then((e=>{e&&open_from_file(e,window.initial_system_file_handle)}),(e=>{show_error_message(`Failed to open file ${window.initial_system_file_handle}`,e)}));const lerp=(e,t,o)=>e+(t-e)*o,color_ramp=(e,t,o)=>Array(e).fill().map(((e,a,n)=>`hsla(${lerp(t[0],o[0],a/n.length)}deg, ${lerp(t[1],o[1],a/n.length)}%, ${lerp(t[2],o[2],a/n.length)}%, ${lerp(t[3],o[3],a/n.length)})`)),update_palette_from_theme=()=>{if("winter.css"===get_theme()){const a=e=>[make_stripe_pattern(e,["hsl(166, 93%, 38%)","white"]),make_stripe_pattern(e,["white","hsl(355, 78%, 46%)"]),make_stripe_pattern(e,["hsl(355, 78%, 46%)","white","white","hsl(355, 78%, 46%)","hsl(355, 78%, 46%)","hsl(355, 78%, 46%)","white","white","hsl(355, 78%, 46%)","white"],2),make_stripe_pattern(e,["hsl(166, 93%, 38%)","white","white","hsl(166, 93%, 38%)","hsl(166, 93%, 38%)","hsl(166, 93%, 38%)","white","white","hsl(166, 93%, 38%)","white"],2),make_stripe_pattern(e,["hsl(166, 93%, 38%)","white","hsl(355, 78%, 46%)","white"],2)];palette=["black","hsl(91, 55%, 81%)","hsl(142, 57%, 64%)","hsl(166, 93%, 38%)","#04ce1f","hsl(159, 93%, 16%)","hsl(2, 77%, 27%)","hsl(350, 100%, 50%)","hsl(356, 97%, 64%)","#ad4632","#5b3b1d",...a(!1),...(e=6,t=[200,100,100,100],o=[200,100,10,100],Array(e).fill().map(((e,a,n)=>`hsla(${lerp(t[0],o[0],a/n.length)}deg, ${lerp(t[1],o[1],a/n.length)}%, ${lerp(t[2],o[2],a/n.length)}%, ${lerp(t[3],o[3],a/n.length)})`))),"#fcbaf8","hsl(0, 0%, 90%)","hsl(22, 5%, 71%)","hsl(48, 82%, 54%)","hsl(49, 82%, 72%)",...a(!0)],$colorbox.rebuild_palette()}else palette=default_palette,$colorbox.rebuild_palette();var e,t,o};function to_canvas_coords({clientX:e,clientY:t}){if(void 0===e||void 0===t)throw new TypeError("clientX and clientY must be defined (not {x, y} or x, y or [x, y])");const o=canvas_bounding_client_rect;return{x:~~((e-o.left)/o.width*main_canvas.width),y:~~((t-o.top)/o.height*main_canvas.height)}}function from_canvas_coords({x:e,y:t}){const o=canvas_bounding_client_rect;return{clientX:~~(e/main_canvas.width*o.width+o.left),clientY:~~(t/main_canvas.height*o.height+o.top)}}function update_fill_and_stroke_colors_and_lineWidth(e){main_ctx.lineWidth=stroke_size;const t=e.$options&&e.$options.fill&&!e.$options.stroke;main_ctx.fillStyle=fill_color=main_ctx.strokeStyle=stroke_color=selected_colors[ctrl&&selected_colors.ternary&&pointer_active?"ternary":reverse^t?"background":"foreground"],fill_color_k=stroke_color_k=ctrl?"ternary":reverse^t?"background":"foreground",(e.shape||e.shape_colors)&&(e.stroke_only||(reverse^t?(fill_color_k="foreground",stroke_color_k="background"):(fill_color_k="background",stroke_color_k="foreground")),main_ctx.fillStyle=fill_color=selected_colors[fill_color_k],main_ctx.strokeStyle=stroke_color=selected_colors[stroke_color_k])}function tool_go(e,t){update_fill_and_stroke_colors_and_lineWidth(e),e[t]&&e[t](main_ctx,pointer.x,pointer.y),e.paint&&e.paint(main_ctx,pointer.x,pointer.y)}function canvas_pointer_move(e){if(ctrl=e.ctrlKey,shift=e.shiftKey,pointer=to_canvas_coords(e),pointers.length&&-1!=e.button){const t=4;if(e.pointerType!=pointer_type||(e.buttons|t)!=(pointer_buttons|t))return cancel(),void(pointer_active=!1)}if(e.shiftKey)if(selected_tool.id===TOOL_LINE||selected_tool.id===TOOL_CURVE){const e=Math.sqrt((pointer.y-pointer_start.y)*(pointer.y-pointer_start.y)+(pointer.x-pointer_start.x)*(pointer.x-pointer_start.x)),t=TAU/8,o=Math.atan2(pointer.y-pointer_start.y,pointer.x-pointer_start.x)/t,a=Math.round(o)*t;pointer.x=Math.round(pointer_start.x+Math.cos(a)*e),pointer.y=Math.round(pointer_start.y+Math.sin(a)*e)}else if(selected_tool.shape){const e=Math.abs(pointer.x-pointer_start.x),t=Math.abs(pointer.y-pointer_start.y);e<t?pointer.y>pointer_start.y?pointer.y=pointer_start.y+e:pointer.y=pointer_start.y-e:pointer.x>pointer_start.x?pointer.x=pointer_start.x+t:pointer.x=pointer_start.x-t}selected_tools.forEach((e=>{tool_go(e)})),pointer_previous=pointer}$G.on("theme-load",update_palette_from_theme),update_palette_from_theme(),$canvas.on("pointermove",(e=>{pointer=to_canvas_coords(e),$status_position.text(`${pointer.x},${pointer.y}`)})),$canvas.on("pointerenter",(e=>{pointer_over_canvas=!0,update_helper_layer(e),update_helper_layer_on_pointermove_active||($G.on("pointermove",update_helper_layer),update_helper_layer_on_pointermove_active=!0)})),$canvas.on("pointerleave",(e=>{pointer_over_canvas=!1,$status_position.text(""),update_helper_layer(e),!pointer_active&&update_helper_layer_on_pointermove_active&&($G.off("pointermove",update_helper_layer),update_helper_layer_on_pointermove_active=!1)}));let clean_up_eye_gaze_mode=()=>{};$G.on("eye-gaze-mode-toggled",(()=>{$("body").hasClass("eye-gaze-mode")?init_eye_gaze_mode():clean_up_eye_gaze_mode()})),$("body").hasClass("eye-gaze-mode")&&init_eye_gaze_mode();const eye_gaze_mode_config={targets:"\n\t\tbutton:not([disabled]),\n\t\tinput,\n\t\ttextarea,\n\t\tlabel,\n\t\ta,\n\t\t.flip-and-rotate .sub-options .radio-wrapper,\n\t\t.current-colors,\n\t\t.color-button,\n\t\t.edit-colors-window .swatch,\n\t\t.edit-colors-window .rainbow-canvas,\n\t\t.edit-colors-window .luminosity-canvas,\n\t\t.tool:not(.selected),\n\t\t.chooser-option,\n\t\t.menu-button:not(.active),\n\t\t.menu-item,\n\t\t.main-canvas,\n\t\t.selection canvas,\n\t\t.handle,\n\t\t.grab-region,\n\t\t.window:not(.maximized) .window-titlebar,\n\t\t.history-entry\n\t",noCenter:e=>e.matches('\n\t\t\t.main-canvas,\n\t\t\t.selection canvas,\n\t\t\t.window-titlebar,\n\t\t\t.rainbow-canvas,\n\t\t\t.luminosity-canvas,\n\t\t\tinput[type="range"]\n\t\t'),retarget:[{from:".canvas-area",to:".main-canvas",withinMargin:50},{from:e=>(e.closest(".menu-button")||e.matches(".menu-container"))&&null!=document.querySelector(".menu-button.active"),to:null}],isEquivalentTarget:(e,t)=>e.closest("label")===t||e.closest(".radio-wrapper")===t,dwellClickEvenIfPaused:e=>e.matches(".toggle-dwell-clicking"),shouldDrag:e=>e.matches(".window-titlebar, .window-titlebar *:not(button)")||e.matches(".selection, .selection *, .handle, .grab-region")||e===main_canvas&&selected_tool.id!==TOOL_PICK_COLOR&&selected_tool.id!==TOOL_FILL&&selected_tool.id!==TOOL_MAGNIFIER&&selected_tool.id!==TOOL_POLYGON&&selected_tool.id!==TOOL_CURVE,click:({target:e,x:t,y:o})=>{if(e.matches("button:not(.toggle)"))e.style.borderImage="var(--inset-deep-border-image)",setTimeout((()=>{e.style.borderImage="",window.untrusted_gesture=!0,e.click(),window.untrusted_gesture=!1}),100);else if(e.matches("input[type='range']")){const a=e.getBoundingClientRect(),n="vertical"===e.getAttribute("orient")||0!==function(e){const t=window.getComputedStyle(e,null),o=t.getPropertyValue("-webkit-transform")||t.getPropertyValue("-moz-transform")||t.getPropertyValue("-ms-transform")||t.getPropertyValue("-o-transform")||t.getPropertyValue("transform")||"none";if("none"!==o){const[e,t]=o.split("(")[1].split(")")[0].split(",");return Math.round(Math.atan2(e,t)*(180/Math.PI))}return 0}(e)||a.height>a.width,i=Number(e.min),r=Number(e.max),s=(n?(o-a.top)/a.height:(t-a.left)/a.width)*(r-i)+i;e.value=s,window.untrusted_gesture=!0,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),window.untrusted_gesture=!1}else window.untrusted_gesture=!0,e.click(),e.matches("input, textarea")&&e.focus(),window.untrusted_gesture=!1}};var tracky_mouse_deps_promise,enable_tracky_mouse=!1;async function init_eye_gaze_mode(){if(enable_tracky_mouse){tracky_mouse_deps_promise||(TrackyMouse.dependenciesRoot="lib/tracky-mouse",tracky_mouse_deps_promise=TrackyMouse.loadDependencies()),await tracky_mouse_deps_promise;const e=$Window({title:"Tracky Mouse",icon:"tracky-mouse"});e.addClass("tracky-mouse-window");const t=e.$content[0];let o;TrackyMouse.init(t),TrackyMouse.useCamera(),e.center(),TrackyMouse.onPointerMove=(e,t)=>{const a=document.elementFromPoint(e,t)||document.body;if(a!==o){if(o){window.untrusted_gesture=!0;const a=new $.Event("pointerleave",Object.assign(y({x:e,y:t}),{button:0,buttons:1,bubbles:!1,cancelable:!1}));$(o).trigger(a),window.untrusted_gesture=!1}window.untrusted_gesture=!0;const n=new $.Event("pointerenter",Object.assign(y({x:e,y:t}),{button:0,buttons:1,bubbles:!1,cancelable:!1}));$(a).trigger(n),window.untrusted_gesture=!1,o=a}window.untrusted_gesture=!0;const n=new PointerEvent("pointermove",Object.assign(y({x:e,y:t}),{button:0,buttons:1}));a.dispatchEvent(n),window.untrusted_gesture=!1}}const e=50,t=1e3;let o,a=[],n=Date.now(),i=!1,r=null;const s=e=>{n=Math.max(n,Date.now()+e)};s(1500);const l=document.createElement("div");l.className="hover-halo",l.style.display="none",document.body.appendChild(l);const c=document.createElement("div");c.className="dwell-indicator",c.style.width="50px",c.style.height="50px",c.style.display="none",document.body.appendChild(c);const d=e=>{a.push({x:e.clientX,y:e.clientY,time:Date.now()})},_=e=>{s(1e3),r=null};let p="visible"===document.visibilityState,m=!0;const u=()=>{p=!0,s(1e3)},g=()=>{p=!1},f=()=>{m=!1},h=()=>{m=!0};window.addEventListener("pointermove",d),window.addEventListener("pointerup",_),window.addEventListener("pointercancel",_),window.addEventListener("focus",u),window.addEventListener("blur",g),document.addEventListener("mouseleave",f),document.addEventListener("mouseenter",h);const b=(e,t)=>{if(!p||!m)return null;let o=document.elementFromPoint(e,t);if(!o)return null;let a={x:e,y:t,time:Date.now()},n=!1;for(const{from:e,to:t,withinMargin:i=1/0}of eye_gaze_mode_config.retarget)if(e instanceof Element?e===o:"function"==typeof e?e(o):o.matches(e)){const e=t instanceof Element||null===t?t:"function"==typeof t?t(o):o.closest(t)||o.querySelector(t);if(null===e)return null;if(e){const t=e.getBoundingClientRect();a.x>t.left-i&&a.y>t.top-i&&a.x<t.right+i&&a.y<t.bottom+i&&(o=e,a.x=Math.min(t.right-1,Math.max(t.left,a.x)),a.y=Math.min(t.bottom-1,Math.max(t.top,a.y)),n=!0)}}if(!n&&(o=o.closest(eye_gaze_mode_config.targets),!o))return null;if(!eye_gaze_mode_config.noCenter(o)){const e=o.getBoundingClientRect();a.x=e.left+e.width/2,a.y=e.top+e.height/2}return a.target=o,a},y=({x:e,y:t})=>({view:window,clientX:e,clientY:t,pointerId:1234567890,pointerType:"mouse",isPrimary:!0,bubbles:!0,cancelable:!0});let w;const v=()=>{w=requestAnimationFrame(v),(()=>{const d=Date.now();if(a=a.filter((e=>d<e.time+500)),a.length){const _=a[a.length-1];a.push({x:_.x,y:_.y,time:d});const p=average_points(a),m=Math.hypot(_.x-p.x,_.y-p.y);if(o&&!r){const e=b(o.x,o.y),a=e=>{const t=document.createElement("div"),o=e.getBoundingClientRect();t.style.pointerEvents="none",t.style.zIndex=1000001,t.style.display="block",t.style.position="fixed",t.style.left=`${o.left+4}px`,t.style.top=`${o.top+4}px`,t.style.width=o.width-8+"px",t.style.height=o.height-8+"px",t.style.outline="4px dashed red",t.style.boxShadow="0 0 4px 4px maroon",document.body.appendChild(t),setTimeout((()=>{t.remove()}),500)};if(e)e.target===o.target||eye_gaze_mode_config.isEquivalentTarget(e.target,o.target)||(o=null,s(t),a(e.target));else{let e=document.elementFromPoint(o.x,o.y);o=null,s(t),a(e||document.body)}}let u=_,g=0,f=0;o&&(u=o,g=.4,f=(o.time-d+500)/500*e,d>o.time+500&&(pointer_active||r?(window.untrusted_gesture=!0,o.target.dispatchEvent(new PointerEvent("pointerup",Object.assign(y(o),{button:0,buttons:0}))),window.untrusted_gesture=!1):(pointers=[],window.untrusted_gesture=!0,o.target.dispatchEvent(new PointerEvent("pointerdown",Object.assign(y(o),{button:0,buttons:1}))),window.untrusted_gesture=!1,eye_gaze_mode_config.shouldDrag(o.target)?r=o.target:(window.untrusted_gesture=!0,o.target.dispatchEvent(new PointerEvent("pointerup",Object.assign(y(o),{button:0,buttons:0}))),eye_gaze_mode_config.click(o),window.untrusted_gesture=!1)),o=null,s(1e3))),r?c.classList.add("for-release"):c.classList.remove("for-release"),c.style.display="",c.style.opacity=g,c.style.transform=`scale(${f/e})`,c.style.left=u.x-25+"px",c.style.top=u.y-25+"px";let h=r||(o||b(_.x,_.y)||{}).target;if(!h||i&&!eye_gaze_mode_config.dwellClickEvenIfPaused(h))l.style.display="none";else{let e=h.getBoundingClientRect();const t=getComputedStyle(h);let o=h,a=1;for(;o instanceof HTMLElement;){const t=getComputedStyle(o);if(t.transform){const e=t.transform.match(/(?:scale|matrix)\((\d+(?:\.\d+)?)/);e&&(a*=Number(e[1]))}if("visible"!==t.overflow){const t=o.getBoundingClientRect();e={left:Math.max(e.left,t.left),top:Math.max(e.top,t.top),right:Math.min(e.right,t.right),bottom:Math.min(e.bottom,t.bottom)},e.width=e.right-e.left,e.height=e.bottom-e.top}o=o.parentNode}l.style.display="block",l.style.position="fixed",l.style.left=`${e.left}px`,l.style.top=`${e.top}px`,l.style.width=`${e.width}px`,l.style.height=`${e.height}px`,l.style.borderTopRightRadius=parseFloat(t.borderTopRightRadius)*a+"px",l.style.borderTopLeftRadius=parseFloat(t.borderTopLeftRadius)*a+"px",l.style.borderBottomRightRadius=parseFloat(t.borderBottomRightRadius)*a+"px",l.style.borderBottomLeftRadius=parseFloat(t.borderBottomLeftRadius)*a+"px"}if(d<n)return;m<5&&(o||(o={x:p.x,y:p.y,time:Date.now(),target:r||null},r||(o=b(o.x,o.y)),o&&i&&!eye_gaze_mode_config.dwellClickEvenIfPaused(o.target)&&(o=null))),m>100&&r&&(window.untrusted_gesture=!0,window.dispatchEvent(new PointerEvent("pointerup",Object.assign(y(p),{button:0,buttons:0}))),window.untrusted_gesture=!1,pointers=[]),m>60&&(o=null)}})()};w=requestAnimationFrame(v);const F=$("<div class='eye-gaze-mode-floating-buttons'/>").appendTo("body");$("<button title='Undo' class='eye-gaze-mode-undo-button'/>").on("click",undo).appendTo(F).append($("<div class='button-icon'>"));const x="Pause Dwell Clicking",k=$('<button class="toggle-dwell-clicking"/>').attr("title",x).on("click",(()=>{i=!i,$("body").toggleClass("eye-gaze-mode-paused",i),k.attr("title",i?"Resume Dwell Clicking":x)})).appendTo(F).append($("<div class='button-icon'>"));clean_up_eye_gaze_mode=()=>{console.log("Cleaning up / disabling eye gaze mode"),cancelAnimationFrame(w),l.remove(),c.remove(),F.remove(),window.removeEventListener("pointermove",d),window.removeEventListener("pointerup",_),window.removeEventListener("pointercancel",_),window.removeEventListener("focus",u),window.removeEventListener("blur",g),document.removeEventListener("mouseleave",f),document.removeEventListener("mouseenter",h),clean_up_eye_gaze_mode=()=>{}}}let last_zoom_pointer_distance,pan_last_pos,pan_start_magnification,first_pointer_time;const discard_quick_undo_period=500;function average_points(e){const t={x:0,y:0};for(const o of e)t.x+=o.x,t.y+=o.y;return t.x/=e.length,t.y/=e.length,t}function prevent_selection(e){e.on("mousedown selectstart contextmenu",(e=>{e.isDefaultPrevented()||e.target instanceof HTMLSelectElement||e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLLabelElement&&"contextmenu"!==e.type||e.target instanceof HTMLInputElement&&"color"!==e.target.type||1!==e.button&&(e.preventDefault(),window.getSelection().removeAllRanges())}))}function iOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}$canvas_area.on("pointerdown",(e=>{if(document.activeElement&&document.activeElement!==document.body&&document.activeElement!==document.documentElement&&document.activeElement.blur(),pointers.every((e=>1234567890!==e.pointerId&&!(e.isPrimary&&("mouse"===e.pointerType||"pen"===e.pointerType))))&&pointers.push({pointerId:e.pointerId,pointerType:e.pointerType,isPrimary:e.originalEvent&&e.originalEvent.isPrimary||e.isPrimary,x:e.clientX,y:e.clientY}),1===pointers.length&&(first_pointer_time=performance.now()),2==pointers.length&&(last_zoom_pointer_distance=Math.hypot(pointers[0].x-pointers[1].x,pointers[0].y-pointers[1].y),pan_last_pos=average_points(pointers),pan_start_magnification=magnification),pointers.length>=2){const e=first_pointer_time&&performance.now()-first_pointer_time<500;return cancel(!1,e),void(pointer_active=!1)}})),$G.on("pointerup pointercancel",(e=>{pointers=pointers.filter((t=>t.pointerId!==e.pointerId))})),$G.on("pointermove",(e=>{for(const t of pointers)t.pointerId===e.pointerId&&(t.x=e.clientX,t.y=e.clientY);if(pointers.length>=2){const e=average_points(pointers),t=Math.hypot(pointers[0].x-pointers[1].x,pointers[0].y-pointers[1].y),o=t-last_zoom_pointer_distance;let a=magnification;Math.abs(o)>60&&(last_zoom_pointer_distance=t,o>0?a*=1.5:a/=1.5),a=Math.max(.5,Math.min(a,40)),a!=magnification&&set_magnification(a,to_canvas_coords({clientX:e.x,clientY:e.y}));const n=e.x-pan_last_pos.x,i=e.y-pan_last_pos.y;$canvas_area.scrollLeft($canvas_area.scrollLeft()-n),$canvas_area.scrollTop($canvas_area.scrollTop()-i),pan_last_pos=e}})),$canvas.on("pointerdown",(e=>{if(update_canvas_rect(),pointers.length>=1){const e=first_pointer_time&&performance.now()-first_pointer_time<500;return cancel(!1,e),pointer_active=!1,void(pointers=pointers.filter((e=>1234567890!==e.pointerId)))}if(history_node_to_cancel_to=current_history_node,pointer_active=!!(3&e.buttons),pointer_type=e.pointerType,pointer_buttons=e.buttons,$G.one("pointerup",(e=>{pointer_active=!1,update_helper_layer(e),!pointer_over_canvas&&update_helper_layer_on_pointermove_active&&($G.off("pointermove",update_helper_layer),update_helper_layer_on_pointermove_active=!1)})),0===e.button)reverse=!1;else{if(2!==e.button)return;reverse=!0}button=e.button,ctrl=e.ctrlKey,shift=e.shiftKey,pointer_start=pointer_previous=pointer=to_canvas_coords(e);(()=>{let e=[];selected_tools.forEach((t=>{(t.paint||t.pointerdown)&&tool_go(t,"pointerdown"),null!=t.paint_on_time_interval&&e.push(setInterval((()=>{tool_go(t)}),t.paint_on_time_interval))})),$G.on("pointermove",canvas_pointer_move),$G.one("pointerup",((t,o,a)=>{button=void 0,reverse=!1,void 0!==t.clientX&&(pointer=to_canvas_coords(t)),a||selected_tools.forEach((e=>{e.pointerup&&e.pointerup(main_ctx,pointer.x,pointer.y)})),1===selected_tools.length&&selected_tool.deselect&&select_tools(return_to_tools),$G.off("pointermove",canvas_pointer_move);for(const t of e)clearInterval(t);o||(history_node_to_cancel_to=null)}))})(),update_helper_layer(e)})),$canvas_area.on("pointerdown",(e=>{0===e.button&&$canvas_area.is(e.target)&&selection&&deselect()})),prevent_selection($app),prevent_selection($toolbox),prevent_selection($colorbox),$G.on("blur",(()=>{$G.triggerHandler("pointerup")})),$("html").toggleClass("ios",iOS()),$G.on("fullscreenchange webkitfullscreenchange",(()=>{const e=!(!document.fullscreenElement&&!document.webkitFullscreenElement);$("html").toggleClass("fullscreen",e)}));