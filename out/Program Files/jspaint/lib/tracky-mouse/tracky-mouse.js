const TrackyMouse={dependenciesRoot:"./tracky-mouse",loadDependencies:function(){TrackyMouse.dependenciesRoot=TrackyMouse.dependenciesRoot.replace(/\/+$/,"");const e=[`${TrackyMouse.dependenciesRoot}/lib/clmtrackr.js`,`${TrackyMouse.dependenciesRoot}/lib/facemesh/facemesh.js`,`${TrackyMouse.dependenciesRoot}/lib/stats.js`,`${TrackyMouse.dependenciesRoot}/lib/tf.js`];return Promise.all(e.map((e=>new Promise(((t,i)=>{const a=document.createElement("script");a.type="text/javascript",a.onload=t,a.onerror=i,a.src=e,document.head.append(a)})))))},init:function(e){var t=e||document.createElement("div");t.classList.add("tracky-mouse-ui"),t.innerHTML='\n\t\t<div class="tracky-mouse-controls">\n\t\t\t<button id="use-camera">Use my camera</button>\n\t\t\t<button id="use-demo">Use demo footage</button>\n\t\t\t<br>\n\t\t\t<br>\n\t\t\t<label><span class="label-text">Horizontal Sensitivity</span> <input type="range" min="0" max="100" value="25" id="sensitivity-x"></label>\n\t\t\t<label><span class="label-text">Vertical Sensitivity</span> <input type="range" min="0" max="100" value="50" id="sensitivity-y"></label>\n\t\t\t\x3c!-- <label><span class="label-text">Smoothing</span> <input type="range" min="0" max="100" value="50" id="smoothing"></label> --\x3e\n\t\t\t<label><span class="label-text">Acceleration</span> <input type="range" min="0" max="100" value="50" id="acceleration"></label>\n\t\t\t\x3c!-- <label><span class="label-text">Easy Stop (min distance to move)</span> <input type="range" min="0" max="100" value="50" id="min-distance"></label> --\x3e\n\t\t\t<br>\n\t\t\t<label><span class="label-text"><input type="checkbox" checked id="mirror"> Mirror</label>\n\t\t\t<br>\n\t\t</div>\n\t\t<canvas class="tracky-mouse-canvas" id="tracky-mouse-canvas"></canvas>\n\t',e||document.body.appendChild(t);var i=t.querySelector("#mirror"),a=t.querySelector("#sensitivity-x"),n=t.querySelector("#sensitivity-y"),o=t.querySelector("#acceleration"),r=t.querySelector("#use-camera"),s=t.querySelector("#use-demo"),c=t.querySelector("#tracky-mouse-canvas"),l=c.getContext("2d"),h=document.createElement("div");h.className="tracky-mouse-pointer",document.body.appendChild(h);var d=document.createElement("video");d.setAttribute("playsinline","");var u=new Stats;u.domElement.style.position="absolute",u.domElement.style.top="0px",u.domElement.style.right="0px",u.domElement.style.left="",document.body.appendChild(u.domElement);var m,p,y,g,v=1e3,f=0,w=0,b=0,k=0,M=!1,X=[],Y=0,C=.5,x=0,S=0,P=!1,T=!0;const E=!1;var R,F,L,I,j,D,A=!1,$=!1,U=!1,W=!0,q=W,H=!0,_={maxContinuousChecks:5,detectionConfidence:.9,maxFaces:1,iouThreshold:.3,scoreThreshold:.75},O=!1,N=!0,V=!1,K=0,B=.7,z=0;let G,J;const Q=()=>{J&&J.terminate(),V=!1,N=!0,O=!1,J=new Worker(`${TrackyMouse.dependenciesRoot}/facemesh.worker.js`),J.addEventListener("message",(e=>{"LOADED"===e.data.type&&(O=!0,I=()=>{const e=G;if(e)return J.postMessage({type:"ESTIMATE_FACES",imageData:e}),new Promise(((e,t)=>{J.addEventListener("message",(t=>{"ESTIMATED_FACES"===t.data.type&&e(t.data.predictions)}),{once:!0})}))})}),{once:!0}),J.postMessage({type:"LOAD",options:_})};H&&Q(),a.onchange=()=>{m=a.value/1e3},n.onchange=()=>{p=n.value/1e3},o.onchange=()=>{y=o.value/100},i.onchange=()=>{R=i.checked},i.onchange(),a.onchange(),n.onchange(),o.onchange();var Z=new clm.tracker({useWebGL:!1});Z.init();var ee=!1;const te=()=>{ee=!1,X.length=0,L&&(K=_.maxContinuousChecks),L=null,W=!0,q=!0,S=0,Y=0,x=0};r.onclick=TrackyMouse.useCamera=()=>{navigator.mediaDevices.getUserMedia({audio:!1,video:{width:640,height:480,facingMode:"user"}}).then((e=>{te();try{"srcObject"in d?d.srcObject=e:d.src=window.URL.createObjectURL(e)}catch(t){d.src=e}}),(e=>{console.log(e)}))},s.onclick=TrackyMouse.useDemoFootage=()=>{te(),d.srcObject=null,d.src=`${TrackyMouse.dependenciesRoot}/private/demo-input-footage.webm`,d.loop=!0},navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||console.log("getUserMedia not supported in this browser"),d.addEventListener("loadedmetadata",(()=>{d.play(),d.width=d.videoWidth,d.height=d.videoHeight,c.width=d.videoWidth,c.height=d.videoHeight,ie.width=d.videoWidth,ie.height=d.videoHeight,ne.width=d.videoWidth,ne.height=d.videoHeight,j=new se,H&&(D=new se)})),d.addEventListener("play",(()=>{Z.reset(),Z.initFaceDetector(d),ee=!0})),c.width=640,c.height=480,d.width=640,d.height=480;const ie=document.createElement("canvas");ie.width=c.width,ie.height=c.height;const ae=ie.getContext("2d"),ne=document.createElement("canvas");ne.width=c.width,ne.height=c.height;const oe=ne.getContext("2d"),re=7.5;class se{constructor(){this.curPyramid=new jsfeat.pyramid_t(3),this.prevPyramid=new jsfeat.pyramid_t(3),this.curPyramid.allocate(d.videoWidth,d.videoHeight,jsfeat.U8C1_t),this.prevPyramid.allocate(d.videoWidth,d.videoHeight,jsfeat.U8C1_t),this.pointCount=0,this.pointStatus=new Uint8Array(v),this.prevXY=new Float32Array(2e3),this.curXY=new Float32Array(2e3)}addPoint(e,t){if(this.pointCount<v){var i=2*this.pointCount;this.curXY[i]=e,this.curXY[i+1]=t,this.prevXY[i]=e,this.prevXY[i+1]=t,this.pointCount++}}filterPoints(e){for(var t=0,i=0;i<this.pointCount;i++)if(e(i)){if(t<i){var a=2*i,n=2*t;this.curXY[n]=this.curXY[a],this.curXY[n+1]=this.curXY[a+1],this.prevXY[n]=this.prevXY[a],this.prevXY[n+1]=this.prevXY[a+1]}t++}else{oe.fillStyle="red";a=2*i;he(oe,this.curXY[a],this.curXY[a+1],5),oe.fillText(e.toString(),5+this.curXY[a],this.curXY[a+1]),l.strokeStyle=l.fillStyle,l.beginPath(),l.moveTo(this.prevXY[a],this.prevXY[a+1]),l.lineTo(this.curXY[a],this.curXY[a+1]),l.stroke()}this.pointCount=t}prunePoints(){this.filterPoints((e=>1==this.pointStatus[e]));const e={};for(let t=0;t<this.pointCount;t++){const i=2*t;e[`${~~(this.curXY[i]/5)},${~~(this.curXY[i+1]/5)}`]=t}const t=Object.values(e);this.filterPoints((e=>t.includes(e)))}update(e){[this.prevXY,this.curXY]=[this.curXY,this.prevXY],[this.prevPyramid,this.curPyramid]=[this.curPyramid,this.prevPyramid];jsfeat.imgproc.grayscale(e.data,e.width,e.height,this.curPyramid.data[0]),this.curPyramid.build(this.curPyramid.data[0],!0),jsfeat.optical_flow_lk.track(this.prevPyramid,this.curPyramid,this.prevXY,this.curXY,this.pointCount,20,30,this.pointStatus,.01,.001),this.prunePoints()}draw(e){for(var t=0;t<this.pointCount;t++){var i=2*t;he(e,this.curXY[i],this.curXY[i+1],3),e.strokeStyle=e.fillStyle,e.beginPath(),e.moveTo(this.prevXY[i],this.prevXY[i+1]),e.lineTo(this.curXY[i],this.curXY[i+1]),e.stroke()}}getMovement(){for(var e=0,t=0,i=0,a=0;a<this.pointCount;a++){var n=2*a;e+=this.curXY[n]-this.prevXY[n],t+=this.curXY[n+1]-this.prevXY[n+1],i+=1}return i>0&&(e/=i,t/=i),[e,t]}}function ce(e,t,i){for(var a=0;a<e.pointCount;a++){var n=2*a;if(Math.abs(t-e.curXY[n])<=re||Math.abs(i-e.curXY[n+1])<=re)return}e.addPoint(t,i)}function le(e=!0){l.resetTransform(),l.clearRect(0,0,c.width,c.height),l.save(),l.drawImage(d,0,0,c.width,c.height);const t=l.getImageData(0,0,c.width,c.height);if(G=t,R&&(l.translate(c.width,0),l.scale(-1,1),l.drawImage(d,0,0,c.width,c.height)),j){if(e){if(ee){if(W||q){try{Z.track(d)}catch(e){console.warn("Error in clmTracker.track()",e),Z.getCurrentParameters().includes(NaN)&&console.warn("NaNs creeped in.")}g=Z.getCurrentPosition(),Y=Z.getScore(),x=Math.pow(Z.getConvergence(),.5)}O&&!V&&(V=!0,X=[],clearTimeout(F),F=setTimeout((()=>{W||(te(),Z.init(),Z.reset(),Z.initFaceDetector(d),ee=!0,console.warn("Falling back to clmtracker")),F=setInterval((()=>{try{document.createElement("canvas").getContext("webgl2"),clearInterval(F),setTimeout((()=>{console.warn("Re-initializing facemesh worker"),Q(),K=1}),1e3)}catch(e){}}),500)}),N?2e4:2e3),I().then((e=>{if(V=!1,N=!1,(K-=1)>0)return;if(L=e[0],W=!1,q=!1,clearTimeout(F),!L)return;D.filterPoints((()=>!1));const{annotations:t}=L;D.addPoint(t.noseLeftCorner[0][0],t.noseLeftCorner[0][1]),D.addPoint(t.noseRightCorner[0][0],t.noseRightCorner[0][1]),D.addPoint(t.midwayBetweenEyes[0][0],t.midwayBetweenEyes[0][1]),M&&(ae.clearRect(0,0,ie.width,ie.height),setTimeout((()=>{oe.clearRect(0,0,ne.width,ne.height)}),900),X.forEach(((e,t)=>{A&&(ae.save(),ae.globalAlpha=.1,frameCtx.putImageData(e,0,0),ae.drawImage(frameCanvas,0,0,c.width,c.height),ae.restore(),oe.fillStyle="aqua",D.draw(oe)),D.update(e)})));for(var i=0;i<D.pointCount;i++){const e=2*i;ce(j,D.curXY[e],D.curXY[e+1])}z=L.faceInViewConfidence,j.filterPoints((e=>{var i=2*e,a=Math.hypot(1.4*(t.noseTip[0][0]-j.curXY[i]),t.noseTip[0][1]-j.curXY[i+1]),n=Math.hypot(t.leftCheek[0][0]-t.rightCheek[0][0],t.leftCheek[0][1]-t.rightCheek[0][1]);return!(a>n)&&!((a=Math.min(Math.hypot(t.leftEyeLower0[0][0]-j.curXY[i],t.leftEyeLower0[0][1]-j.curXY[i+1]),Math.hypot(t.rightEyeLower0[0][0]-j.curXY[i],t.rightEyeLower0[0][1]-j.curXY[i+1])))<.42*n)}))}),(()=>{V=!1,N=!1})))}j.update(t)}if(L){l.fillStyle="red";const t=L.faceInViewConfidence<B;l.fillStyle=t?"rgb(255,255,0)":"rgb(130,255,50)",!t||j.pointCount<3||L.faceInViewConfidence>z+.05?(t&&(l.fillStyle="rgba(255,0,255)"),e&&H&&L.scaledMesh.forEach((e=>{e[0]+=b,e[1]+=k})),L.scaledMesh.forEach((([e,t,i])=>{l.fillRect(e,t,1,1)}))):e&&H&&(z-=.001)}if(g){const t=Y<C;l.strokeStyle=t?"rgb(255,255,0)":"rgb(130,255,50)",!t||j.pointCount<2||Y>S+.05?(t&&(l.strokeStyle="rgba(255,0,255)"),e&&W&&(S=Y,ce(j,g[42][0],g[42][1]),ce(j,g[43][0],g[43][1]),j.filterPoints((e=>{var t=2*e;return!(Math.hypot(1.4*(g[62][0]-j.curXY[t]),g[62][1]-j.curXY[t+1])>Math.hypot(g[23][0]-g[28][0],g[23][1]-g[28][1]))})))):e&&W&&(S-=.001),q&&Z.draw(c,void 0,void 0,!0)}if(A&&(l.save(),l.globalAlpha=.8,l.drawImage(ie,0,0),l.restore(),l.drawImage(ne,0,0)),l.fillStyle="lime",j.draw(l),oe.fillStyle="green",j.draw(oe),e){var[i,a]=j.getMovement(),n=(e,t)=>e/1*Math.abs(5*e)**y,o=(Math.hypot(i,a),n(i*m)),r=n(a*p);if($){const e=200,t=150,a=.2,o=.4,r=.01;l.save(),l.fillStyle="black",l.fillRect(0,0,e,t);const s=i*m;for(let i=0;i<e;i++){const c=i/e*a,h=n(c)/o*t,d=Math.abs(Math.abs(c)-Math.abs(s))<r;d&&(l.fillStyle="rgba(255, 255, 0, 0.3)",l.fillRect(i,0,1,t)),l.fillStyle=d?"yellow":"lime",l.fillRect(i,t-h,1,h)}l.restore()}if(!isFinite(o)||!isFinite(r))return;if(!P){const e=window.moveMouse?screen.width:innerWidth,t=window.moveMouse?screen.height:innerHeight;f-=o*e,w+=r*t,f=Math.min(Math.max(0,f),e),w=Math.min(Math.max(0,w),t),T&&(f=e/2,w=t/2,T=!1),window.moveMouse?(window.moveMouse(~~f,~~w),h.style.display="none"):(h.style.display="",h.style.left=`${f}px`,h.style.top=`${w}px`),TrackyMouse.onPointerMove&&TrackyMouse.onPointerMove(f,w)}if(b=i,k=a,M&&V){const e=getCameraImageData();e&&X.push(e),X.length>500&&(X.length=0)}}if(l.restore(),U){l.save(),l.fillStyle="#fff",l.strokeStyle="#000",l.lineWidth=3,l.font="20px sans-serif",l.beginPath();const e="Face convergence score: "+(H&&L?"N/A":x.toFixed(4)),t="Face tracking score: "+(H&&L?L.faceInViewConfidence:Y).toFixed(4),i="Points based on score: "+(H&&L?z:S).toFixed(4);l.strokeText(t,50,50),l.fillText(t,50,50),l.strokeText(i,50,70),l.fillText(i,50,70),l.strokeText(e,50,170),l.fillText(e,50,170),l.fillStyle="lime",l.fillRect(0,150,x,5),l.fillRect(0,0,Y*c.width,5),l.restore()}u.update()}}function he(e,t,i,a){e.beginPath(),e.arc(t,i,a,0,2*Math.PI),e.fill()}c.addEventListener("click",(e=>{if(!j)return;const t=c.getBoundingClientRect();R?j.addPoint((t.right-e.clientX)/t.width*c.width,(e.clientY-t.top)/t.height*c.height):j.addPoint((e.clientX-t.left)/t.width*c.width,(e.clientY-t.top)/t.height*c.height)})),function e(){requestAnimationFrame(e),le(!(E||P&&"visible"!==document.visibilityState))}(),E&&setInterval(le,200);let de=!1;try{de="true"===localStorage.trackyMouseAutoDemo}catch(e){}de?useDemoFootage():window.moveMouse&&useCamera();const ue=e=>{"toggle-tracking"===e&&(T=!0,(P=!P)&&(h.style.display="none"))};"undefined"!=typeof onShortcut?onShortcut(ue):addEventListener("keydown",(e=>{e.ctrlKey||e.metaKey||e.altKey||e.shiftKey||"F9"!==e.key||ue("toggle-tracking")}))}};