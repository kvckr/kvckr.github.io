import colorToRGB from"../colorToRGB.js";import{loadText,make1DTexture,makePassFBO,makePass}from"./utils.js";const makePalette=(r,o)=>{const a=2048,e=Array(a),t=o.slice().sort(((r,o)=>r.at-o.at)).map((r=>({rgb:colorToRGB(r.color),arrayIndex:Math.floor(2047*Math.max(Math.min(1,r.at),0))})));return t.unshift({rgb:t[0].rgb,arrayIndex:0}),t.push({rgb:t[t.length-1].rgb,arrayIndex:2047}),t.forEach(((r,o)=>{if(e[r.arrayIndex]=r.rgb.slice(),o+1<t.length){const a=t[o+1],l=a.arrayIndex-r.arrayIndex;for(let o=0;o<l;o++){const t=o/l;e[r.arrayIndex+o]=[r.rgb[0]*(1-t)+a.rgb[0]*t,r.rgb[1]*(1-t)+a.rgb[1]*t,r.rgb[2]*(1-t)+a.rgb[2]*t]}}})),make1DTexture(r,e.map((r=>[...r,1])))};export default({regl:r,config:o},a)=>{const e=makePassFBO(r,o.useHalfFloat),t=makePalette(r,o.palette),{backgroundColor:l,cursorColor:s,glintColor:g,ditherMagnitude:n,bloomStrength:m}=o,c=loadText("shaders/glsl/palettePass.frag.glsl"),b=r({frag:r.prop("frag"),uniforms:{backgroundColor:colorToRGB(l),cursorColor:colorToRGB(s),glintColor:colorToRGB(g),ditherMagnitude:n,bloomStrength:m,tex:a.primary,bloomTex:a.bloom,paletteTex:t},framebuffer:e});return makePass({primary:e},c.loaded,((r,o)=>e.resize(r,o)),(()=>b({frag:c.text()})))};