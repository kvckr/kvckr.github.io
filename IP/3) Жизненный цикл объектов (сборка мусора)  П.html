<html>
<head>
  <title>3) Жизненный цикл объектов (сборка мусора) / Привязка данных в WPF</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/274061; Windows/6.3.9600;"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="921"/>
<h1>3) Жизненный цикл объектов (сборка мусора) / Привязка данных в WPF</h1>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><b><span style="font-size:14pt">Жизненный цикл объектов</span></b></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Все типы платформы .NET делятся на ссылочные типы и типы значений. Переменные типов значений создаются в стеке, их время жизни ограничено тем блоком кода, в котором они объявляются. Например, если переменная типа значения объявлена в некотором методе, то после выхода из метода память в стеке, занимаемая переменной, автоматически освободится. Переменные ссылочного типа (объекты) располагаются в динамической памяти –</span> <span style="font-size:14pt"><i>управляемой куче</i></span> <span style="font-size:14pt">(managed heap). Размещение объектов в управляемой куче происходит последовательно. Для этого CLR поддерживает указатель на свободное место в куче, перемещая его на соответствующее количество байтов после выделения памяти очередному объекту</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><hr/><div><b style="font-size: 14pt; color: rgb(42, 42, 42); font-family: &apos;Times New Roman&apos;; text-indent: 10mm;">Алгоритм сборки мусора</b></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Если новый объект требует для размещения больше памяти, чем имеющийся свободный объем, CLR запускает процесс, называемый</span> <span style="font-size:14pt"><i>сборка мусора</i></span><span style="font-size:14pt"> (garbage collection). На первом этапе сборки мусора строится</span> <span style="font-size:14pt"><i>граф используемых объектов</i></span> <span style="font-size:14pt">. Отправными точками в построении графа являются</span> <span style="font-size:14pt"><i>корневые объекты</i></span> <span style="font-size:14pt">. Это объекты следующих категорий:</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">– локальная переменная или аргумент выполняемого метода (а также всех методов в стеке вызова);</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">– статическое поле;</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">– объект в</span> <span style="font-size:14pt"><i>очереди завершения</i></span> <span style="font-size:14pt">(этот термин будет разъяснён позже).</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">При помощи графа используемых объектов выясняется реально занимаемая этими объектами память. Затем происходит</span> <span style="font-size:14pt"><i>дефрагментация кучи</i></span> <span style="font-size:14pt">– используемые объекты перераспределяются так, чтобы занимаемая ими память составляла </span></font><span style="font-size: 14pt; color: rgb(1, 1, 1); font-family: &apos;Times New Roman&apos;; text-indent: 10mm;">единый блок в начале кучи. После этого сборка мусора завершается, и новый объект размещается в управляемой куче.</span></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">При размещении и удалении объектов CLR использует ряд оптимизаций. Во-первых, объекты размером 85000 и более байтов размещаются в отдельной управляемой</span> <span style="font-size:14pt"><i>куче больших объектов</i></span> <span style="font-size:14pt">(Large Object Heap). При сборке мусора данная куча не дефрагментируется, так как копирование больших блоков памяти снижает производительность. Во-вторых, в управляемой куче для малых объектов выделяется три поколения – Gen0, Gen1 и Gen2. Вначале все объекты относятся к поколению Gen0. После первой сборки мусора «пережившие» её объекты переходят в поколение Gen1. В дальнейшем сборка мусора будет работать с объектами поколения Gen1, только если освобождение памяти в Gen0 дало неудовлетворительный результат. Если в Gen1 произошла сборка мусора, то «пережившие» её объекты переходят в поколение Gen2. Отметим, что куча больших объектов всегда рассматривается как куча объектов поколения Gen2.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Сборщик мусора представлен статическим классом</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">GC</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">, который обладает несколькими полезными методами (приведён неполный список):</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">1.</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Collect()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">– вызывает принудительную сборку мусора в программе.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">2.</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">GetGeneration()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">– возвращает номер поколения для указанного объекта;</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">3.</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">SuppressFinalize()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">– подавляет вызов финализатора для объекта;</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">4.</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">WaitForPendingFinalizers()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">– приостанавливает текущий поток выполнения до тех пор, пока не будут выполнены все финализаторы освобождаемых объектов.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><b><span style="font-size:14pt">Финализаторы и интерфейс IDisposable</span></b></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><hr/></div></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Платформа .NET предлагает подход, обеспечивающий автоматическое освобождение ресурсов при уничтожении объекта. Тип</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">Object</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">содержит виртуальный метод</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Finalize()</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Класс (но не структура!) может переопределить этот метод для освобождения неуправляемых ресурсов. Объект такого класса обрабатывается особо при размещении в куче и при сборке мусора. При размещении ссылка на объект запоминается в специальной внутренней структуре CLR. При сборке мусора эта ссылка перемещается в</span> <span style="font-size:14pt"><i>очередь завершения</i></span> <span style="font-size:14pt">(freachable queue). Затем в отдельном программном потоке у объектов из очереди завершения происходит вызов метода</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Finalize()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">, после этого ссылка на объект удаляется из очереди завершения.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Язык C# не позволяет явно переопределить в пользовательском классе метод</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Finalize()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Вместо этого в классе описывается специальный</span> <span style="font-size:14pt"><i>финализатор</i></span><span style="font-size:14pt">. Имя финализатора имеет вид</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">~</span><span style="font-size:12pt"><i>имя-класса</i></span> <span style="font-size:12pt">()</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">, он не имеет параметров и модификаторов доступа (считается, что у него модификатор доступа</span></font> <font color="#0000FF" face="Consolas"><span style="font-size:12pt">protected</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">). При наследовании в финализатор класса-наследника автоматически подставляется вызов финализатора класса-предка.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Вызов метода</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Finalize()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">является недетерминированным. Для освобождения управляемых ресурсов (т. е. ресурсов платформы .NET) программист может описать в классе некий метод, который следует вызывать вручную, когда ресурс больше не нужен. Для унификации данного решения предлагается интерфейс</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">IDisposable</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">с единственным методом</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Dispose()</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Если класс или структура реализуют этот интерфейс,</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Dispose()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">содержит код освобождения управляемых ресурсов.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Язык C# имеет специальный оператор</span></font> <font color="#0000FF" face="Consolas"><span style="font-size:12pt">using</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">, который гарантирует вызов метода</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Dispose()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">для заданных переменных в конце блока кода. Синтаксис оператора</span></font> <font color="#0000FF" face="Consolas"><span style="font-size:12pt">using</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">следующий:</span></font></div><div><br/></div><div><font color="#0000FF" face="Consolas"><span style="font-size:12pt">using</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">(</span><span style="font-size:12pt"><i>получение-ресурса</i></span><span style="font-size:12pt">)</span> <span style="font-size:12pt"><i>вложенный-оператор</i></span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Здесь</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt"><i>получение-ресурса</i></span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">означает один из вариантов.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">1. Объявление и инициализацию локальной переменой (или списка переменных). Тип переменной должен реализовывать</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">IDisposable</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Такая переменная в блоке</span></font> <font color="#0000FF" face="Consolas"><span style="font-size:12pt">using</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">доступна только для чтения.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">2. Выражение, значение которого имеет тип, реализующий</span></font> <font face="Consolas"><span style="font-size: 12pt;"><font color="#2B91AF">IDisposable</font>.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><hr/><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><b><span style="font-size:14pt">Слабые ссылки</span></b></font></div></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"><i>Слабая ссылка</i></span> <span style="font-size:14pt">(weak reference) – особый вид ссылки на объект в системах со сборкой мусора. Если на объект имеются только слабые ссылки, он рассматривается алгоритмом сборки мусора как подлежащий удалению.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">В .NET слабые ссылки представлены классами</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">WeakReference</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">и</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">WeakReference</span></font><font color="#010101" face="Consolas"><span style="font-size:12pt">&lt;T&gt;</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Конструктор класса принимает объект, на который создаётся слабая ссылка. Свойство</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Target</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">указывает на этот объект или имеет значение</span></font> <font color="#0000FF" face="Consolas"><span style="font-size:12pt">null</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">, если объект был удалён сборщиком мусора.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><hr/></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div style="font-size: 19px;"><font color="#010101" face="Times New Roman"><b>Привязка данных</b></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"><i>Привязка данных</i></span> <span style="font-size:14pt">(data binding) – это отношение, которое используется для извлечения информации из</span> <span style="font-size:14pt"><i>источника данных</i></span> <span style="font-size:14pt">и установки свойства зависимостей в</span> <span style="font-size:14pt"><i>целевом объекте</i></span> <span style="font-size:14pt">. Целевой объект обычно является элементом управления. Источником данных может быть произвольный объект .NET. Привязка способна (при определённых условиях) автоматически обновлять целевое свойство при изменении данных источника.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Очевидно, что при определении привязки нужно указать</span> <span style="font-size:14pt"><b>целевое свойство</b></span><span style="font-size:14pt">,</span> <span style="font-size:14pt"><b>источник данных</b></span> <span style="font-size:14pt">и</span> <span style="font-size:14pt"><b>правило извлечения информации</b></span> <span style="font-size:14pt">из источника. Кроме этого, можно выполнить настройку следующих параметров:</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"><b>1. Направление привязки.</b></span> <span style="font-size:14pt">Привязка может быть</span> <span style="font-size:14pt"><i>однонаправленной</i></span> <span style="font-size:14pt">(целевое свойство меняется при изменении данных источника),</span> <span style="font-size:14pt"><i>двунаправленной</i></span> <span style="font-size:14pt">(изменения в источнике и целевом объекте влияют друг на друга) и</span> <span style="font-size:14pt"><i>от цели к источнику</i></span> <span style="font-size:14pt">(источник данных обновляется при изменении целевого свойства).</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"><b>2. Условие обновления источника.</b></span> <span style="font-size:14pt">Если привязка двунаправленная или от цели к источнику, можно настроить момент обновления источника данных.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"><b>3. Конвертеры значений.</b></span> <span style="font-size:14pt">Привязка может выполнять автоматическое преобразование данных при их перемещении от источника к целевому объекту и наоборот.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"><b>4. Правила проверки данных.</b></span> <span style="font-size:14pt">Привязка может включать правила проверки данных на корректность и поведение, выполняемое при нарушении этих правил.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">В WPF привязка данных описывается либо декларативно, либо в коде. В любом случае используется объект класса</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.Windows.Data.</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">Binding</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">(унаследованный от</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">MarkupExtension</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">).</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">Класс</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">System.Windows.Data.</span></font><font color="#2B91AF" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">BindingOperations</span></font> <font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">предоставляет набор статических методов для управления привязкой в коде. В частности, метод</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">GetBinding()</span></font> <font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">позволяет получить привязку для указанного целевого объекта и его свойства зависимостей, метод</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">SetBinding()</span></font> <font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">устанавливает привязку, а метод</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">ClearBinding()</span></font> <font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">удаляет привязку.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><hr/><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><b><span style="font-size:14pt">Источники и поставщики данных</span></b></font></div></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">Источник данных для привязки может быть задан при помощи следующих свойств объекта</span></font> <font color="#2B91AF" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">Binding</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">:</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">ElementName</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">,</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">Source</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">,</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">RelativeSource</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">. Эти свойства являются взаимоисключающими – установив одно из них, остальные следует сбросить, иначе при выполнении привязки генерируется исключение.</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"> </span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Строковое свойство</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">ElementName</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">удобно использовать, чтобы определить в качестве источника данных элемент, который принадлежит одному логическому дереву вместе с целевым объектом.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Свойство</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Source</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">даёт возможность указать в качестве источника привязки произвольный объект.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">Свойство привязки</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">RelativeSource</span></font> <font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">позволяет задать источник данных на основе отношения к целевому объекту.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">Если при описании привязки не задано ни одно из свойств</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">ElementName</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">,</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">Source</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">,</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">RelativeSource</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">, источник данных определяется на основе значения свойства</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">DataContext</span></font> <font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">целевого объекта. Если у целевого объекта это свойство не установлено, будет выполнен поиск по дереву элементов для нахождения первого родительского</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">DataContext</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">, не равного</span></font> <font color="#0000FF" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">null</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">Технология WPF поддерживает механизм</span> <span style="font-size:14pt"><i>поставщиков данных</i></span> <span style="font-size:14pt">(data providers), чтобы упростить декларативную настройку доступа к источникам данных. В настоящее время имеется два поставщика:</span></font> <font color="#2B91AF" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">ObjectDataProvider</span></font> <font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">получает информацию, вызывая заданный метод, а</span></font> <font color="#2B91AF" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">XmlDataProvideг</span></font> <font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">доставляет данные непосредственно из источника XML. Все поставщики данных унаследованы от класса</span></font> <font color="#010101" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">System.Windows.Data.</span></font><font color="#2B91AF" face="Consolas" style="text-indent: 10mm;"><span style="font-size:12pt">DataSourceProvider</span></font><font color="#010101" face="Times New Roman" size="4" style="text-indent: 10mm;"><span style="font-size:14pt">.</span></font></div><hr/><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><b><span style="font-size:14pt">Обновление данных и направление привязки</span></b></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Ранее было отмечено, что привязка способна автоматически обновлять целевое свойство при изменении источника данных. Чтобы реализовать этот функционал, можно поступить одним из следующих способов:</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">1. Сделать свойство источника данных свойством зависимостей.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">2. Генерировать при изменении источника событие</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt"><i>Имя-Свойства</i></span> <span style="font-size:12pt">Changed</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">3. Реализовать в источнике интерфейс</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">INotifyPropertyChanged</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">(пространство имён</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.ComponentModel</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">), содержащий событие</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">PropertyChanged</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Это событие нужно генерировать при изменении данных, указывая имя свойства.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Для того чтобы изменения в целевом свойстве попадали в источник данных, нужно установить режим привязки в</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">BindingMode</span></font><font color="#010101" face="Consolas"><span style="font-size:12pt">.TwoWay</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">или</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">BindingMode</span></font><font color="#010101" face="Consolas"><span style="font-size:12pt">.OneWayToSource</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><hr/><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><b><span style="font-size:14pt">Конвертеры значений</span></b></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"><i>Конвертер значений</i></span> <span style="font-size:14pt">отвечает за преобразование данных при переносе из источника в целевое свойство и за обратное преобразование в случае двунаправленной привязки.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Для создания конвертера значений требуется выполнить четыре шага.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">1. Создать класс, реализующий интерфейс</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">IValueConverter</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">2. Применить к классу атрибут</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">[</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">ValueConversion</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">]</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">и специфицировать исходный и целевой типы данных (необязательный шаг).</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">3. Реализовать метод</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Convert()</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">, выполняющий преобразование данных от источника к целевому объекту.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">4. Реализовать метод</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">ConvertBack()</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">, делающий обратное преобразование.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><hr/><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><b><span style="font-size:14pt">Проверка данных</span></b></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Для привязки, которая передаёт информацию в источник данных (режимы</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">BindingMode</span></font><font color="#010101" face="Consolas"><span style="font-size:12pt">.TwoWay</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">и</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">BindingMode</span></font><font color="#010101" face="Consolas"><span style="font-size:12pt">.OneWayToSource</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">) можно выполнить проверку данных перед помещением их в источник. Если данные не проходят проверку, то источник не обновляется.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Первый способ организации проверки заключается в создании и применении</span> <span style="font-size:14pt"><i>проверочных правил</i></span> <span style="font-size:14pt">. Каждое проверочное правило – это наследник класса</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.Windows.Controls.</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">ValidationRule</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">с перекрытым методом</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Validate()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Этот метод получает проверяемое значение и информацию о культуре, а возвращает объект</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">ValidationResult</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">с результатом проверки.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Второй способ организации проверки основан на генерации исключительной ситуации в методе установки свойства источника данных</span></font></div></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Исключительные ситуации, возникающие при передаче информации в источник, отлавливаются при помощи специального встроенного правила</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">ExceptionValidationRule</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Третий способ организации проверки основан на реализации источником данных интерфейса</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.ComponentModel.</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">IDataErrorInfo</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Интерфейс</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">IDataErrorInfo</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">содержит два элемента: строковое свойство</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Error</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">и строковый индексатор с ключом-строкой. Свойство</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">Error</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">– это общее описание ошибок объекта. Индексатор принимает имя свойства и возвращает соответствующую детальную информацию об ошибке. Ключевая идея в том, что вся логика обработки ошибок централизована в индексаторе.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">Четвёртый вариант организации проверки основан на реализации источником данных интерфейса</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">System.ComponentModel.</span></font><font color="#2B91AF" face="Consolas"><span style="font-size:12pt">INotifyDataErrorInfo</span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Этот интерфейс похож на гибрид интерфейсов</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">INotifyPropertyChanged</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">и</span></font> <font color="#2B91AF" face="Consolas"><span style="font-size:12pt">IDataErrorInfo</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">. Его булево свойство</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">HasErrors</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">указывает на наличие ошибок объекта. Метод</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">GetErrors()</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">позволяет получить список ошибок по строке с именем свойства. Событие</span></font> <font color="#010101" face="Consolas"><span style="font-size:12pt">ErrorsChanged</span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt">необходимо генерировать при изменении списка ошибок.</span></font></div><div align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:10mm; margin-top:0.00mm; margin-bottom:0.00mm;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:14pt"><br/></span></font></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>
</div></body></html> 